# 🎬 Simple Web Video Downloader

웹서핑 중 발견한 비디오를 **어떤 형식이든(MP4, M3U8 스트리밍 등) 가리지 않고, 갤러리 앱 등 어디서나 볼 수 있는 완전한 단일 MP4 파일로 저장**하는 것을 목표로 하는 강력한 안드로이드 비디오 다운로더입니다.

## 🎯 핵심 개발 목표 (Core Development Goal)

이 앱의 최종 목표는 명확합니다.

1.  **완벽한 호환성**: 현대 웹에서 널리 사용되는 **HLS(.m3u8) 스트리밍 비디오**를 포함하여, 웹페이지의 모든 비디오를 감지합니다.
2.  **완전한 파일**: 감지된 스트리밍 비디오를 수많은 조각 파일이 아닌, **하나의 표준 MP4 파일로 변환**하여 저장합니다.
3.  **자유로운 사용**: 다운로드한 영상은 **갤러리 앱, 비디오 편집 앱, PC 등 어디서든 자유롭게 사용**할 수 있도록 합니다.

---

## ✨ 주요 기능

- 🌐 **내장 웹 브라우저**: 완전한 웹 브라우징 경험
- 🕵️‍♂️ **강력한 비디오 감지 엔진**:
    - **MP4 직접 링크** 자동 탐지
    - **HLS/M3U8 스트리밍** 자동 탐지 (네트워크 요청 분석)
- ⬇️ **원클릭 MP4 변환 다운로드**: 감지된 모든 비디오를 표준 MP4 파일로 간편하게 다운로드
- 📱 **반응형 UI**: Jetpack Compose로 구현된 최적화된 사용자 경험
- 🎯 **전체화면 모드**: 몰입감 있는 브라우징 경험
- 🎨 **Material Design 3**: 현대적이고 직관적인 UI

## 🛠️ 기술 스택

- **언어**: Kotlin
- **UI 프레임워크**: Jetpack Compose
- **핵심 아키텍처**: MVVM with Compose State Management
- **비디오 감지**:
    - Android WebView with JavaScript injection
    - **네트워크 요청 가로채기 (Network Request Interception)**
- **비디오 처리**:
    - **FFmpeg**: HLS 스트림을 MP4로 변환 (Transmuxing)
- **다운로드**:
    - Android `DownloadManager` (MP4용)
    - **`ForegroundService` 기반 커스텀 다운로더** (HLS용)

## AAB + 최소 빌드 FFmpeg 개발 계획

### 📋 핵심 이해사항

**AAB (Android App Bundle)**
- Google Play가 사용자 기기에 맞는 최적화된 APK를 자동 생성
- 각 기기는 자신의 CPU 아키텍처에 맞는 FFmpeg 라이브러리만 다운로드
- 전체 라이브러리를 포함한 APK 대비 약 75% 크기 감소

**최소 빌드 FFmpeg**
- HLS to MP4 변환에 필요한 기능만 포함
- 불필요한 코덱, 필터, 프로토콜 제외
- 5~10MB로 크기 최소화

---

## 🚨 현재 구현 상태 및 개선 필요사항 (Current Status & Issues)

### ✅ 완료된 기능
1. **VideoAnalyzer.kt**: 기본 비디오 감지 엔진 구현 완료
   - 네트워크 요청 가로채기 (`shouldInterceptRequest`)
   - JavaScript 기반 DOM 분석
   - 다양한 비디오 형식 지원 (MP4, M3U8, DASH, WebM 등)
   - 중복 감지 방지 및 실시간 모니터링

방식 B: 완전한 '.mp4 파일'로 변환 다운로드 (고급 기능)

동작 방식:

.m3u8 파일을 분석해서 모든 .ts 영상 조각들의 URL 목록을 알아냅니다.

우리 앱이 이 URL 목록을 따라 모든 .ts 파일들을 순서대로 하나씩 다운로드합니다.

다운로드가 완료되면, FFmpeg 같은 전문 라이브러리를 사용하여 수백 개의 .ts 조각들을 **하나의 .mp4 파일로 합치고 변환(Stitching/Transmuxing)**합니다.

장점: 사용자가 원하는, 어디서든 재생 가능한 .mp4 파일을 만들어줄 수 있습니다.

단점: 구현이 훨씬 더 복잡합니다. FFmpeg 라이브러리를 앱에 추가해야 해서 앱 용량이 커지고, 모든 과정을 직접 코드로 제어해야 합니다.

웹사이트가 다른 플레이어를 사용하면 어떻게 되나요?

전혀 상관없습니다. 이것이 바로 '네트워크 요청 가로채기' 방식의 가장 큰 장점입니다.

우리의 감지 로직은 웹사이트가 어떤 비디오 플레이어(HLS.js, Video.js 등)를 사용하는지 전혀 신경 쓰지 않습니다.

원리: 어떤 플레이어든 HLS 영상을 재생하려면, 반드시 서버에 .m3u8 파일을 달라는 네트워크 요청을 보내야 합니다.

우리의 역할: 우리는 '플레이어'를 보는 것이 아니라, 웹뷰를 오가는 '네트워크 통신' 자체를 보고 있습니다. 마치 고속도로 톨게이트처럼, 어떤 차(플레이어)가 지나가든 .m3u8이라는 번호판(URL)을 단 차는 모두 잡아내는 것과 같습니다.

따라서 웹사이트가 자체 제작한 플레이어를 쓰든, 유명한 오픈소스 플레이어를 쓰든, .m3u8 주소를 요청하는 순간을 우리 EnhancedWebViewClient가 포착할 수 있으므로 아무런 문제가 없습니다.

방식 B (MP4 변환 다운로드) 구현에 대한 의견 및 로드맵

이 멋진 목표를 달성하기 위한 체계적인 로드맵을 제안해 드립니다.

[1단계] 기반 다지기: HLS 스트림 감지 및 분석

가장 먼저, 눈에 보이지 않는 HLS 스트림의 구조를 파악하는 능력을 갖춰야 합니다.

세부 목표:

EnhancedWebViewClient를 구현하여 웹페이지에서 .m3u8 URL을 안정적으로 감지합니다.

감지된 .m3u8 파일이 '마스터 플레이리스트'인지 확인하고, 만약 맞다면 그 안에 포함된 다양한 화질 옵션(예: 480p, 720p, 1080p) 목록을 추출합니다.

이 단계의 결과물: 앱이 사용자에게 "이 페이지에 HLS 영상이 있고, 3가지 화질로 다운로드할 수 있습니다"라고 목록을 보여줄 수 있게 됩니다. (아직 실제 다운로드는 하지 않습니다.)

[2단계] 핵심 기능 구현: 영상 조각(.ts) 다운로드

이제 사용자가 선택한 화질의 영상 조각들을 모두 내려받는 기능을 구현합니다. 이 과정은 앱이 백그라운드에 있거나 화면이 꺼져도 안정적으로 동작해야 합니다.

세부 목표:

사용자가 1단계에서 본 화질 목록 중 하나를 선택할 수 있는 UI를 제공합니다.

선택된 화질의 .m3u8 파일에 명시된 모든 .ts 영상 조각 파일들을 순서대로 전부 다운로드합니다.

ForegroundService를 구현하여 다운로드 과정이 안드로이드 OS에 의해 중단되지 않도록 보장하고, 사용자에게 알림(Notification)으로 진행 상황을 보여줍니다.

이 단계의 결과물: 수백 개의 .ts 파일들이 앱 내부의 임시 폴더에 모두 다운로드됩니다. 아직 .mp4 파일은 아니지만, 원본 영상의 모든 조각을 확보하게 됩니다.

[3단계] 최종 목표 달성: MP4 변환 및 저장

가장 어려운 마지막 단계입니다. 다운로드한 영상 조각들을 하나의 완전한 .mp4 파일로 조립합니다.

세부 목표:

.ts 파일을 .mp4로 변환하기 위해, 가장 널리 쓰이는 FFmpeg 라이브러리를 안드로이드 프로젝트에 통합합니다. (이 과정이 다소 복잡하며, 앱의 용량이 커집니다.)

2단계에서 다운로드한 모든 .ts 파일들을 FFmpeg를 이용해 하나의 .mp4 파일로 합치는 명령을 실행합니다.

완성된 .mp4 파일을 사용자의 공용 저장소(예: Downloads 또는 Movies 폴더)에 저장하여 갤러리 앱 등에서 바로 볼 수 있도록 합니다.

임시로 저장했던 .ts 파일들을 모두 삭제하여 저장 공간을 정리합니다.

이 단계의 결과물: 사용자가 그토록 원하던, 완전하고 공유 가능한 .mp4 파일이 생성됩니다. 프로젝트의 최종 목표가 달성됩니다.

이렇게 3단계로 나누어 진행하면, 복잡한 목표를 체계적으로 달성할 수 있습니다. 각 단계가 끝날 때마다 눈에 보이는 성과가 있어 개발 과정도 훨씬 즐거워질 겁니다.

어떠신가요? 이 로드맵에 동의하신다면, 가장 먼저 **[1단계]**인 'HLS 스트림 감지 및 분석' 기능 개발부터 함께 시작해 보겠습니다.

개발했을 때 ffmpeg를 포함하면 앱 크기가 얼마나 될지?

네, 앱 크기는 매우 중요한 문제이죠. FFmpeg를 포함했을 때 앱 크기가 얼마나 늘어날지에 대해 정확히 답변해 드리겠습니다.

결론부터 말씀드리면, 어떤 전략을 사용하느냐에 따라 다르지만 사용자가 실제로 다운로드하는 앱 크기는 약 5MB에서 15MB 사이로 증가할 것으로 예상할 수 있습니다.

왜 이렇게 범위가 넓은지, 그리고 어떻게 증가 폭을 최소화할 수 있는지 두 가지 핵심 요소를 통해 설명해 드리겠습니다.

1. CPU 아키텍처와 'Android App Bundle (AAB)' (가장 중요한 요소)

FFmpeg는 C언어로 만들어진 네이티브 라이브러리라서, 안드로이드 기기의 다양한 CPU 종류(설계도)에 맞춰 별도로 컴파일된 파일(libffmpeg.so)이 필요합니다.

arm64-v8a: 최신 64비트 ARM 기기 (대부분의 현대 스마트폰)

armeabi-v7a: 이전 32비트 ARM 기기

x86_64 / x86: 에뮬레이터 또는 일부 태블릿

만약 이 모든 CPU용 라이브러리를 하나의 APK 파일에 전부 넣는다면, FFmpeg 라이브러리 하나만으로 40~70MB 이상이 쉽게 추가될 수 있습니다. 하지만 사용자는 이 모든 파일이 필요 없습니다.

해결책은 바로 'Android App Bundle(AAB)'입니다.

AAB는 현재 Google Play의 표준 배포 방식입니다. 개발자가 모든 CPU용 라이브러리가 포함된 AAB 파일을 Play Store에 올리면, Google Play가 사용자의 기종을 파악해서 해당 기기에 딱 맞는 CPU용 라이브러리만 포함된 최적화된 APK를 자동으로 만들어 설치해 줍니다.

따라서 사용자가 실제로 다운로드하는 앱 크기 증가는 단일 CPU 아키텍처용 FFmpeg 라이브러리 크기만큼만 늘어납니다.

2. FFmpeg 빌드 구성 (크기를 줄이는 핵심 기술)

FFmpeg는 온갖 종류의 비디오/오디오 코덱과 기능을 다 갖춘 거대한 '공구함'과 같습니다. 하지만 우리는 .ts 파일들을 합쳐 .mp4로 만드는 특정 '공구' 몇 개만 필요합니다.

대부분의 안드로이드용 FFmpeg 라이브러리는 모든 기능이 다 들어있는 full 버전과, 필수 기능만 남긴 min 또는 light 버전을 함께 제공합니다.

우리가 필요한 기능만 포함된 '최소(min) 버전'을 선택하면, 단일 CPU 아키텍처 기준 라이브러리 크기를 5~10MB 수준까지 줄일 수 있습니다.

예상 크기 요약

방식

설명

사용자 실제 다운로드 크기 증가 예상

권장 방식 (AAB + 최소 빌드)

Google Play에 AAB로 게시. 우리에게 필요한 기능만 담은 FFmpeg 사용.

약 5MB ~ 10MB

AAB + 전체 기능 빌드

모든 기능이 포함된 FFmpeg 사용.

약 10MB ~ 20MB

비권장 방식 (구형 Fat APK)

하나의 APK 파일에 모든 CPU 버전을 포함하여 직접 배포.

약 40MB ~ 70MB+

결론

Android App Bundle(AAB)을 사용하고, 우리에게 꼭 필요한 기능만 포함된 최소 버전의 FFmpeg 라이브러리를 선택한다면, 앱 크기 증가는 5~10MB 수준으로 충분히 관리 가능합니다.

강력한 MP4 변환 기능을 얻는 대가로 충분히 감수할 만한 합리적인 크기라고 생각합니다. 이 방향으로 진행하는 것에 동의하시나요?