This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.claude/
  CLAUDE.md
  settings.local.json
  step-by-step.md
.cursor/
  rules/
    android-development-best-practices.mdc
    kotlin-compose-safety.mdc
    prompt-engineering-guidelines.mdc
app/
  src/
    androidTest/
      java/
        com/
          swvd/
            simplewebvideodownloader/
              ExampleInstrumentedTest.kt
    main/
      java/
        com/
          swvd/
            simplewebvideodownloader/
              download/
                DownloadHandler.kt
                HlsDownloader.kt
                VideoDownloadManager.kt
              models/
                Tab.kt
                VideoInfo.kt
              ui/
                components/
                  DialogComponents.kt
                  DownloadResultDialog.kt
                  NavigationBottomBar.kt
                  TabBar.kt
                  TabOverviewScreen.kt
                  UrlInputSection.kt
                  VideoListSection.kt
                  WebViewContainer.kt
                screens/
                  FullscreenScreen.kt
                theme/
                  Color.kt
                  Theme.kt
                  Type.kt
              usecase/
                DetectVideosUseCase.kt
                LoadUrlUseCase.kt
              utils/
                FullscreenManager.kt
              viewmodel/
                DownloadViewModel.kt
                MainViewModel.kt
                TabViewModel.kt
                VideoDetectionViewModel.kt
                WebViewViewModel.kt
              webview/
                Mp4Analyzer.kt
                VideoAnalyzer.kt
              MainActivity.kt
              MainActivityNew.kt
      res/
        drawable/
          ic_launcher_background.xml
          ic_launcher_foreground.xml
        mipmap-anydpi-v26/
          ic_launcher.xml
        values/
          colors.xml
          strings.xml
          themes.xml
        xml/
          backup_rules.xml
          data_extraction_rules.xml
      AndroidManifest.xml
    test/
      java/
        com/
          swvd/
            simplewebvideodownloader/
              download/
                DownloadHandlerTest.kt
              ExampleUnitTest.kt
  .gitignore
  build.gradle.kts
  proguard-rules.pro
docs/
  repomix-output.xml
gradle/
  wrapper/
    gradle-wrapper.properties
  libs.versions.toml
.gitignore
build.gradle.kts
CLAUDE.md
gradle.properties
gradlew
gradlew.bat
LICENSE
README.md
settings.gradle.kts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".claude/CLAUDE.md">
# Basic Rules
- You are a senior coding expert.

## General Guidelines
- Make a step-by-step plan and work it out.
- At the top of the file, include its role and brief description.
- Please include comments when writing the code.
- Please write the variable name so that the meaning is clear.
- Please include the error handling.
- Put readability and maintenance first.

## Description
- Please add an explanation to the complex logic.
- Please briefly explain the purpose of the code and how it works.
- If you can, answer in Korean.

# Using Gemini CLI for Large Codebase Analysis

When analyzing large codebases or multiple files that might exceed context limits, use the Gemini CLI with its massive
context window. Use `gemini -p` to leverage Google Gemini's large context capacity.

## File and Directory Inclusion Syntax

Use the `@` syntax to include files and directories in your Gemini prompts. The paths should be relative to WHERE you run the
  gemini command:

### Examples:

**Single file analysis:**
gemini -p "@src/main.py Explain this file's purpose and structure"

Multiple files:
gemini -p "@package.json @src/index.js Analyze the dependencies used in the code"

Entire directory:
gemini -p "@src/ Summarize the architecture of this codebase"

Multiple directories:
gemini -p "@src/ @tests/ Analyze test coverage for the source code"

Current directory and subdirectories:
gemini -p "@./ Give me an overview of this entire project"

# Or use --all_files flag:
gemini --all_files -p "Analyze the project structure and dependencies"

Implementation Verification Examples

Check if a feature is implemented:
gemini -p "@src/ @lib/ Has dark mode been implemented in this codebase? Show me the relevant files and functions"

Verify authentication implementation:
gemini -p "@src/ @middleware/ Is JWT authentication implemented? List all auth-related endpoints and middleware"

Check for specific patterns:
gemini -p "@src/ Are there any React hooks that handle WebSocket connections? List them with file paths"

Verify error handling:
gemini -p "@src/ @api/ Is proper error handling implemented for all API endpoints? Show examples of try-catch blocks"

Check for rate limiting:
gemini -p "@backend/ @middleware/ Is rate limiting implemented for the API? Show the implementation details"

Verify caching strategy:
gemini -p "@src/ @lib/ @services/ Is Redis caching implemented? List all cache-related functions and their usage"

Check for specific security measures:
gemini -p "@src/ @api/ Are SQL injection protections implemented? Show how user inputs are sanitized"

Verify test coverage for features:
gemini -p "@src/payment/ @tests/ Is the payment processing module fully tested? List all test cases"

When to Use Gemini CLI

Use gemini -p when:
- Analyzing entire codebases or large directories
- Comparing multiple large files
- Need to understand project-wide patterns or architecture
- Current context window is insufficient for the task
- Working with files totaling more than 100KB
- Verifying if specific features, patterns, or security measures are implemented
- Checking for the presence of certain coding patterns across the entire codebase

Important Notes

- Paths in @ syntax are relative to your current working directory when invoking gemini
- The CLI will include file contents directly in the context
- No need for --yolo flag for read-only analysis
- Gemini's context window can handle entire codebases that would overflow Claude's context
- When checking implementations, be specific about what you're looking for to get accurate results
</file>

<file path=".claude/settings.local.json">
{
  "permissions": {
    "allow": [
      "Bash(find:*)",
      "Bash(ls:*)",
      "Bash(grep:*)",
      "Bash(rg:*)",
      "Bash(node:*)",
      "Bash(npm run dev:*)",
      "Bash(npm install:*)",
      "Bash(curl:*)",
      "Bash(npx tsc:*)",
      "Bash(pyenv global:*)",
      "Bash(pip install:*)",
      "Bash(npm ls:*)",
      "Bash(mv:*)",
      "Bash(mkdir:*)",
      "Bash(supabase status:*)",
      "Bash(pkill:*)",
      "Bash(npx supabase migration:*)",
      "Bash(python:*)",
      "Bash(kill:*)",
      "Bash(./gradlew:*)",
      "Bash(gemini:*)",
      "mcp__ide__getDiagnostics",
      "Bash(rm:*)",
      "Bash(awk:*)"
    ],
    "deny": []
  }
}
</file>

<file path=".claude/step-by-step.md">
---
description:
globs:
alwaysApply: true
---

## Core Directive
You are a senior software engineer AI assistant. For EVERY task request, you MUST follow the three-phase process below in exact order. Each phase must be completed with expert-level precision and detail.

## Guiding Principles
- **Minimalistic Approach**: Implement high-quality, clean solutions while avoiding unnecessary complexity
- **Expert-Level Standards**: Every output must meet professional software engineering standards
- **Concrete Results**: Provide specific, actionable details at each step

---

## Phase 1: Codebase Exploration & Analysis
**REQUIRED ACTIONS:**
1. **Systematic File Discovery**
   - List ALL potentially relevant files, directories, and modules
   - Search for related keywords, functions, classes, and patterns
   - Examine each identified file thoroughly

2. **Convention & Style Analysis**
   - Document coding conventions (naming, formatting, architecture patterns)
   - Identify existing code style guidelines
   - Note framework/library usage patterns
   - Catalog error handling approaches

**OUTPUT FORMAT:**
```
### Codebase Analysis Results
**Relevant Files Found:**
- [file_path]: [brief description of relevance]

**Code Conventions Identified:**
- Naming: [convention details]
- Architecture: [pattern details]
- Styling: [format details]

**Key Dependencies & Patterns:**
- [library/framework]: [usage pattern]
```

---

## Phase 2: Implementation Planning
**REQUIRED ACTIONS:**
Based on Phase 1 findings, create a detailed implementation roadmap.

**OUTPUT FORMAT:**
```markdown
## Implementation Plan

### Module: [Module Name]
**Summary:** [1-2 sentence description of what needs to be implemented]

**Tasks:**
- [ ] [Specific implementation task]
- [ ] [Specific implementation task]

**Acceptance Criteria:**
- [ ] [Measurable success criterion]
- [ ] [Measurable success criterion]
- [ ] [Performance/quality requirement]

### Module: [Next Module Name]
[Repeat structure above]
```

---

## Phase 3: Implementation Execution
**REQUIRED ACTIONS:**
1. Implement each module following the plan from Phase 2
2. Verify ALL acceptance criteria are met before proceeding
3. Ensure code adheres to conventions identified in Phase 1

**QUALITY GATES:**
- [ ] All acceptance criteria validated
- [ ] Code follows established conventions
- [ ] Minimalistic approach maintained
- [ ] Expert-level implementation standards met

---

## Success Validation
Before completing any task, confirm:
- âœ… All three phases completed sequentially
- âœ… Each phase output meets specified format requirements
- âœ… Implementation satisfies all acceptance criteria
- âœ… Code quality meets professional standards

## Response Structure
Always structure your response as:
1. **Phase 1 Results**: [Codebase analysis findings]
2. **Phase 2 Plan**: [Implementation roadmap]
3. **Phase 3 Implementation**: [Actual code with validation]
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/download/HlsDownloader.kt">
package com.swvd.simplewebvideodownloader.download

import android.content.Context
import android.os.Environment
import android.util.Log
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import java.io.File
import java.io.FileOutputStream
import java.io.IOException
import java.net.HttpURLConnection
import java.net.URL
import java.util.concurrent.ConcurrentHashMap

/**
 * HLS (M3U8) ë‹¤ìš´ë¡œë“œ í•¸ë“¤ëŸ¬
 * HLS ìŠ¤íŠ¸ë¦¬ë° ë¹„ë””ì˜¤ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ëŠ” ê¸°ëŠ¥ì„ ë‹´ë‹¹
 */
class HlsDownloader(private val context: Context) {
    
    companion object {
        private const val TAG = "HlsDownloader"
        private const val USER_AGENT = "Mozilla/5.0 (Linux; Android 10; SM-G975F) AppleWebKit/537.36"
        private const val CONNECT_TIMEOUT = 10000
        private const val READ_TIMEOUT = 30000
    }
    
    /**
     * HLS ë‹¤ìš´ë¡œë“œ ìƒíƒœ
     */
    enum class DownloadStatus {
        PENDING,
        DOWNLOADING,
        COMPLETED,
        FAILED,
        PAUSED
    }
    
    /**
     * HLS ë‹¤ìš´ë¡œë“œ ì§„í–‰ ì •ë³´
     */
    data class DownloadProgress(
        val url: String,
        val status: DownloadStatus,
        val progress: Int = 0,
        val totalSegments: Int = 0,
        val downloadedSegments: Int = 0,
        val error: String? = null
    )
    
    private val downloadProgressMap = ConcurrentHashMap<String, DownloadProgress>()
    private var progressCallback: ((DownloadProgress) -> Unit)? = null
    
    /**
     * HLS ë‹¤ìš´ë¡œë“œ ì§„í–‰ ìƒí™© ì½œë°± ì„¤ì •
     */
    fun setProgressCallback(callback: (DownloadProgress) -> Unit) {
        progressCallback = callback
    }
    
    /**
     * HLS ìŠ¤íŠ¸ë¦¼ ë‹¤ìš´ë¡œë“œ ì‹œì‘
     * @param m3u8Url HLS ë§¤ë‹ˆí˜ìŠ¤íŠ¸ URL
     * @param filename ì €ì¥í•  íŒŒì¼ëª…
     * @param onComplete ì™„ë£Œ ì½œë°±
     */
    suspend fun downloadHls(
        m3u8Url: String,
        filename: String,
        onComplete: (Boolean, String?) -> Unit
    ) {
        withContext(Dispatchers.IO) {
            try {
                Log.d(TAG, "HLS ë‹¤ìš´ë¡œë“œ ì‹œì‘: $m3u8Url")
                
                // ë‹¤ìš´ë¡œë“œ ìƒíƒœ ì´ˆê¸°í™”
                updateProgress(m3u8Url, DownloadStatus.DOWNLOADING)
                
                // 1. M3U8 ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ
                val playlistContent = downloadPlaylist(m3u8Url)
                if (playlistContent.isNullOrEmpty()) {
                    updateProgress(m3u8Url, DownloadStatus.FAILED, error = "ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨")
                    onComplete(false, "ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨")
                    return@withContext
                }
                
                // 2. ì„¸ê·¸ë¨¼íŠ¸ URL ì¶”ì¶œ
                val segmentUrls = parsePlaylist(playlistContent, m3u8Url)
                if (segmentUrls.isEmpty()) {
                    updateProgress(m3u8Url, DownloadStatus.FAILED, error = "ì„¸ê·¸ë¨¼íŠ¸ URL ì¶”ì¶œ ì‹¤íŒ¨")
                    onComplete(false, "ì„¸ê·¸ë¨¼íŠ¸ URL ì¶”ì¶œ ì‹¤íŒ¨")
                    return@withContext
                }
                
                Log.d(TAG, "ì´ ${segmentUrls.size}ê°œ ì„¸ê·¸ë¨¼íŠ¸ ë°œê²¬")
                updateProgress(m3u8Url, DownloadStatus.DOWNLOADING, totalSegments = segmentUrls.size)
                
                // 3. ì¶œë ¥ íŒŒì¼ ì¤€ë¹„
                val outputFile = prepareOutputFile(filename)
                if (outputFile == null) {
                    updateProgress(m3u8Url, DownloadStatus.FAILED, error = "ì¶œë ¥ íŒŒì¼ ìƒì„± ì‹¤íŒ¨")
                    onComplete(false, "ì¶œë ¥ íŒŒì¼ ìƒì„± ì‹¤íŒ¨")
                    return@withContext
                }
                
                // 4. ì„¸ê·¸ë¨¼íŠ¸ ë‹¤ìš´ë¡œë“œ ë° ë³‘í•©
                val success = downloadAndMergeSegments(m3u8Url, segmentUrls, outputFile)
                
                if (success) {
                    updateProgress(m3u8Url, DownloadStatus.COMPLETED, progress = 100)
                    onComplete(true, "ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${outputFile.name}")
                } else {
                    updateProgress(m3u8Url, DownloadStatus.FAILED, error = "ì„¸ê·¸ë¨¼íŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨")
                    onComplete(false, "ì„¸ê·¸ë¨¼íŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨")
                }
                
            } catch (e: Exception) {
                Log.e(TAG, "HLS ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${e.message}", e)
                updateProgress(m3u8Url, DownloadStatus.FAILED, error = e.message)
                onComplete(false, "ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${e.message}")
            }
        }
    }
    
    /**
     * M3U8 ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ
     */
    private suspend fun downloadPlaylist(url: String): String? {
        return try {
            val connection = URL(url).openConnection() as HttpURLConnection
            connection.apply {
                requestMethod = "GET"
                setRequestProperty("User-Agent", USER_AGENT)
                connectTimeout = CONNECT_TIMEOUT
                readTimeout = READ_TIMEOUT
            }
            
            val responseCode = connection.responseCode
            if (responseCode == HttpURLConnection.HTTP_OK) {
                connection.inputStream.bufferedReader().use { it.readText() }
            } else {
                Log.e(TAG, "ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: HTTP $responseCode")
                null
            }
        } catch (e: Exception) {
            Log.e(TAG, "ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${e.message}")
            null
        }
    }
    
    /**
     * M3U8 í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ íŒŒì‹±í•˜ì—¬ ì„¸ê·¸ë¨¼íŠ¸ URL ì¶”ì¶œ
     */
    private fun parsePlaylist(content: String, baseUrl: String): List<String> {
        val segmentUrls = mutableListOf<String>()
        val baseUri = baseUrl.substringBeforeLast("/")
        
        content.lines().forEach { line ->
            val trimmedLine = line.trim()
            
            // ì„¸ê·¸ë¨¼íŠ¸ íŒŒì¼ì¸ì§€ í™•ì¸ (ì¼ë°˜ì ìœ¼ë¡œ .ts íŒŒì¼)
            if (trimmedLine.isNotEmpty() && 
                !trimmedLine.startsWith("#") && 
                (trimmedLine.endsWith(".ts") || 
                 trimmedLine.endsWith(".m4s") || 
                 trimmedLine.contains(".ts?") ||
                 trimmedLine.contains(".m4s?"))) {
                
                val segmentUrl = if (trimmedLine.startsWith("http")) {
                    trimmedLine
                } else if (trimmedLine.startsWith("/")) {
                    // ì ˆëŒ€ ê²½ë¡œ
                    val domain = baseUrl.substringBefore("/", baseUrl.substringAfter("://"))
                    val protocol = baseUrl.substringBefore("://")
                    "$protocol://$domain$trimmedLine"
                } else {
                    // ìƒëŒ€ ê²½ë¡œ
                    "$baseUri/$trimmedLine"
                }
                
                segmentUrls.add(segmentUrl)
            }
        }
        
        return segmentUrls
    }
    
    /**
     * ì¶œë ¥ íŒŒì¼ ì¤€ë¹„
     */
    private fun prepareOutputFile(filename: String): File? {
        return try {
            val downloadsDir = File(
                Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS),
                "SWVD"
            )
            
            if (!downloadsDir.exists()) {
                downloadsDir.mkdirs()
            }
            
            val safeFilename = filename.replace(Regex("[^a-zA-Z0-9._-]"), "_")
            val outputFile = File(downloadsDir, safeFilename)
            
            // ê¸°ì¡´ íŒŒì¼ì´ ìˆë‹¤ë©´ ì‚­ì œ
            if (outputFile.exists()) {
                outputFile.delete()
            }
            
            outputFile.createNewFile()
            outputFile
        } catch (e: Exception) {
            Log.e(TAG, "ì¶œë ¥ íŒŒì¼ ì¤€ë¹„ ì˜¤ë¥˜: ${e.message}")
            null
        }
    }
    
    /**
     * ì„¸ê·¸ë¨¼íŠ¸ ë‹¤ìš´ë¡œë“œ ë° ë³‘í•©
     */
    private suspend fun downloadAndMergeSegments(
        m3u8Url: String,
        segmentUrls: List<String>,
        outputFile: File
    ): Boolean {
        return try {
            FileOutputStream(outputFile).use { outputStream ->
                segmentUrls.forEachIndexed { index, segmentUrl ->
                    try {
                        // ì„¸ê·¸ë¨¼íŠ¸ ë‹¤ìš´ë¡œë“œ
                        val segmentData = downloadSegment(segmentUrl)
                        if (segmentData != null) {
                            outputStream.write(segmentData)
                            outputStream.flush()
                            
                            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                            val progress = ((index + 1) * 100) / segmentUrls.size
                            updateProgress(
                                m3u8Url, 
                                DownloadStatus.DOWNLOADING, 
                                progress = progress,
                                downloadedSegments = index + 1
                            )
                            
                            Log.d(TAG, "ì„¸ê·¸ë¨¼íŠ¸ ${index + 1}/${segmentUrls.size} ë‹¤ìš´ë¡œë“œ ì™„ë£Œ ($progress%)")
                        } else {
                            Log.e(TAG, "ì„¸ê·¸ë¨¼íŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: $segmentUrl")
                            return@use false
                        }
                    } catch (e: Exception) {
                        Log.e(TAG, "ì„¸ê·¸ë¨¼íŠ¸ ì²˜ë¦¬ ì˜¤ë¥˜: ${e.message}")
                        return@use false
                    }
                }
                true
            }
        } catch (e: Exception) {
            Log.e(TAG, "ì„¸ê·¸ë¨¼íŠ¸ ë³‘í•© ì˜¤ë¥˜: ${e.message}")
            false
        }
    }
    
    /**
     * ê°œë³„ ì„¸ê·¸ë¨¼íŠ¸ ë‹¤ìš´ë¡œë“œ
     */
    private fun downloadSegment(url: String): ByteArray? {
        return try {
            val connection = URL(url).openConnection() as HttpURLConnection
            connection.apply {
                requestMethod = "GET"
                setRequestProperty("User-Agent", USER_AGENT)
                connectTimeout = CONNECT_TIMEOUT
                readTimeout = READ_TIMEOUT
            }
            
            val responseCode = connection.responseCode
            if (responseCode == HttpURLConnection.HTTP_OK) {
                connection.inputStream.readBytes()
            } else {
                Log.e(TAG, "ì„¸ê·¸ë¨¼íŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: HTTP $responseCode for $url")
                null
            }
        } catch (e: IOException) {
            Log.e(TAG, "ì„¸ê·¸ë¨¼íŠ¸ ë‹¤ìš´ë¡œë“œ IO ì˜¤ë¥˜: ${e.message}")
            null
        } catch (e: Exception) {
            Log.e(TAG, "ì„¸ê·¸ë¨¼íŠ¸ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${e.message}")
            null
        }
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
     */
    private fun updateProgress(
        url: String,
        status: DownloadStatus,
        progress: Int = 0,
        totalSegments: Int = 0,
        downloadedSegments: Int = 0,
        error: String? = null
    ) {
        val currentProgress = downloadProgressMap[url] ?: DownloadProgress(url, status)
        
        val updatedProgress = currentProgress.copy(
            status = status,
            progress = progress,
            totalSegments = if (totalSegments > 0) totalSegments else currentProgress.totalSegments,
            downloadedSegments = downloadedSegments,
            error = error
        )
        
        downloadProgressMap[url] = updatedProgress
        progressCallback?.invoke(updatedProgress)
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ì§„í–‰ ìƒí™© ì¡°íšŒ
     */
    fun getDownloadProgress(url: String): DownloadProgress? {
        return downloadProgressMap[url]
    }
    
    /**
     * ëª¨ë“  ë‹¤ìš´ë¡œë“œ ì§„í–‰ ìƒí™© ì¡°íšŒ
     */
    fun getAllDownloadProgress(): Map<String, DownloadProgress> {
        return downloadProgressMap.toMap()
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ì·¨ì†Œ
     */
    fun cancelDownload(url: String) {
        downloadProgressMap.remove(url)
        // ì‹¤ì œ ë‹¤ìš´ë¡œë“œ ì·¨ì†Œ ë¡œì§ì€ ì¶”í›„ êµ¬í˜„
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/download/VideoDownloadManager.kt">
package com.swvd.simplewebvideodownloader.download

import android.content.Context
import android.util.Log
import com.swvd.simplewebvideodownloader.models.VideoInfo
import com.swvd.simplewebvideodownloader.models.VideoType
import com.swvd.simplewebvideodownloader.models.VideoDownloadProgress
import com.swvd.simplewebvideodownloader.models.VideoDownloadStatus
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.SupervisorJob
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import java.util.concurrent.ConcurrentHashMap

/**
 * ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ê´€ë¦¬ì
 * ë‹¤ì–‘í•œ ë¹„ë””ì˜¤ í˜•ì‹ì˜ ë‹¤ìš´ë¡œë“œë¥¼ í†µí•© ê´€ë¦¬
 */
class VideoDownloadManager(private val context: Context) {
    
    companion object {
        private const val TAG = "VideoDownloadManager"
    }
    
    private val downloadScope = CoroutineScope(SupervisorJob() + Dispatchers.IO)
    
    // ë‹¤ìš´ë¡œë“œ í•¸ë“¤ëŸ¬ë“¤
    private val downloadHandler = DownloadHandler(context)
    private val hlsDownloader = HlsDownloader(context)
    
    // ë‹¤ìš´ë¡œë“œ ì§„í–‰ ìƒí™© ê´€ë¦¬
    private val _downloadProgress = MutableStateFlow<Map<String, VideoDownloadProgress>>(emptyMap())
    val downloadProgress: StateFlow<Map<String, VideoDownloadProgress>> = _downloadProgress.asStateFlow()
    
    private val activeDownloads = ConcurrentHashMap<String, VideoDownloadProgress>()
    
    init {
        setupHlsDownloaderCallback()
    }
    
    /**
     * HLS ë‹¤ìš´ë¡œë” ì½œë°± ì„¤ì •
     */
    private fun setupHlsDownloaderCallback() {
        hlsDownloader.setProgressCallback { hlsProgress ->
            // HLS ì§„í–‰ ìƒí™©ì„ VideoDownloadProgressë¡œ ë³€í™˜
            val videoInfo = VideoInfo(
                url = hlsProgress.url,
                type = VideoType.HLS,
                title = "HLS ìŠ¤íŠ¸ë¦¬ë°"
            )
            
            val status = when (hlsProgress.status) {
                HlsDownloader.DownloadStatus.PENDING -> VideoDownloadStatus.PENDING
                HlsDownloader.DownloadStatus.DOWNLOADING -> VideoDownloadStatus.DOWNLOADING
                HlsDownloader.DownloadStatus.COMPLETED -> VideoDownloadStatus.COMPLETED
                HlsDownloader.DownloadStatus.FAILED -> VideoDownloadStatus.FAILED
                HlsDownloader.DownloadStatus.PAUSED -> VideoDownloadStatus.PAUSED
            }
            
            val progress = VideoDownloadProgress(
                videoInfo = videoInfo,
                status = status,
                progress = hlsProgress.progress,
                error = hlsProgress.error
            )
            
            updateDownloadProgress(hlsProgress.url, progress)
        }
    }
    
    /**
     * ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ì‹œì‘
     */
    fun startDownload(videoInfo: VideoInfo, onComplete: (Boolean, String?) -> Unit = { _, _ -> }) {
        Log.d(TAG, "ë‹¤ìš´ë¡œë“œ ì‹œì‘: ${videoInfo.type.displayName} - ${videoInfo.url}")
        
        // ì´ë¯¸ ë‹¤ìš´ë¡œë“œ ì¤‘ì¸ì§€ í™•ì¸
        if (activeDownloads.containsKey(videoInfo.url)) {
            Log.w(TAG, "ì´ë¯¸ ë‹¤ìš´ë¡œë“œ ì¤‘ì¸ ë¹„ë””ì˜¤: ${videoInfo.url}")
            return
        }
        
        // ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œì§€ í™•ì¸
        if (!isDownloadable(videoInfo)) {
            Log.w(TAG, "ë‹¤ìš´ë¡œë“œ ë¶ˆê°€ëŠ¥í•œ ë¹„ë””ì˜¤ í˜•ì‹: ${videoInfo.type}")
            onComplete(false, "ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¹„ë””ì˜¤ í˜•ì‹ì…ë‹ˆë‹¤")
            return
        }
        
        // ì´ˆê¸° ì§„í–‰ ìƒí™© ì„¤ì •
        val initialProgress = VideoDownloadProgress(
            videoInfo = videoInfo,
            status = VideoDownloadStatus.PENDING
        )
        updateDownloadProgress(videoInfo.url, initialProgress)
        
        // ë¹„ë””ì˜¤ íƒ€ì…ì— ë”°ë¥¸ ë‹¤ìš´ë¡œë“œ ì‹œì‘
        downloadScope.launch {
            try {
                when (videoInfo.type) {
                    VideoType.MP4, VideoType.WEBM, VideoType.MKV, 
                    VideoType.AVI, VideoType.MOV, VideoType.FLV -> {
                        downloadDirectVideo(videoInfo, onComplete)
                    }
                    VideoType.HLS -> {
                        downloadHlsVideo(videoInfo, onComplete)
                    }
                    VideoType.DASH -> {
                        onComplete(false, "DASH ìŠ¤íŠ¸ë¦¬ë°ì€ ì•„ì§ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤")
                    }
                    else -> {
                        onComplete(false, "ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¹„ë””ì˜¤ í˜•ì‹ì…ë‹ˆë‹¤")
                    }
                }
            } catch (e: Exception) {
                Log.e(TAG, "ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${e.message}", e)
                updateDownloadProgress(videoInfo.url, initialProgress.copy(
                    status = VideoDownloadStatus.FAILED,
                    error = e.message
                ))
                onComplete(false, "ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${e.message}")
            }
        }
    }
    
    /**
     * ì§ì ‘ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
     */
    private fun downloadDirectVideo(videoInfo: VideoInfo, onComplete: (Boolean, String?) -> Unit) {
        try {
            // ê¶Œí•œ í™•ì¸
            val permissions = downloadHandler.checkStoragePermissions()
            if (permissions.isNotEmpty()) {
                onComplete(false, "ì €ì¥ì†Œ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤")
                return
            }
            
            // ë‹¤ìš´ë¡œë“œ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
            updateDownloadProgress(videoInfo.url, VideoDownloadProgress(
                videoInfo = videoInfo,
                status = VideoDownloadStatus.DOWNLOADING
            ))
            
            // íŒŒì¼ëª… ìƒì„±
            val filename = generateFilename(videoInfo)
            
            // ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
            downloadHandler.downloadFile(videoInfo.url, filename)
            
            // ë‹¤ìš´ë¡œë“œ ì™„ë£Œ ì²˜ë¦¬
            updateDownloadProgress(videoInfo.url, VideoDownloadProgress(
                videoInfo = videoInfo,
                status = VideoDownloadStatus.COMPLETED,
                progress = 100
            ))
            
            onComplete(true, "ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: $filename")
            
        } catch (e: Exception) {
            Log.e(TAG, "ì§ì ‘ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${e.message}", e)
            updateDownloadProgress(videoInfo.url, VideoDownloadProgress(
                videoInfo = videoInfo,
                status = VideoDownloadStatus.FAILED,
                error = e.message
            ))
            onComplete(false, "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${e.message}")
        }
    }
    
    /**
     * HLS ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
     */
    private suspend fun downloadHlsVideo(videoInfo: VideoInfo, onComplete: (Boolean, String?) -> Unit) {
        try {
            val filename = generateFilename(videoInfo)
            
            hlsDownloader.downloadHls(videoInfo.url, filename) { success, message ->
                if (success) {
                    Log.d(TAG, "HLS ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: $message")
                } else {
                    Log.e(TAG, "HLS ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: $message")
                }
                onComplete(success, message)
            }
        } catch (e: Exception) {
            Log.e(TAG, "HLS ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${e.message}", e)
            onComplete(false, "HLS ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${e.message}")
        }
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
     */
    private fun isDownloadable(videoInfo: VideoInfo): Boolean {
        return when (videoInfo.type) {
            VideoType.MP4, VideoType.WEBM, VideoType.MKV, 
            VideoType.AVI, VideoType.MOV, VideoType.FLV -> true
            VideoType.HLS -> true
            VideoType.DASH -> false // ë³µì¡í•œ êµ¬í˜„ í•„ìš”
            VideoType.YOUTUBE, VideoType.VIMEO -> false // ë³„ë„ ì²˜ë¦¬ í•„ìš”
            VideoType.UNKNOWN -> videoInfo.url.contains("http") && 
                                 videoInfo.url.contains(".")
        }
    }
    
    /**
     * íŒŒì¼ëª… ìƒì„±
     */
    private fun generateFilename(videoInfo: VideoInfo): String {
        val title = videoInfo.title?.take(30)?.replace(Regex("[^a-zA-Z0-9ê°€-í£._-]"), "_")
        val extension = when (videoInfo.type) {
            VideoType.MP4 -> ".mp4"
            VideoType.WEBM -> ".webm"
            VideoType.MKV -> ".mkv"
            VideoType.AVI -> ".avi"
            VideoType.MOV -> ".mov"
            VideoType.FLV -> ".flv"
            VideoType.HLS -> ".mp4" // HLSëŠ” MP4ë¡œ ë³‘í•©
            else -> ".mp4"
        }
        
        return if (title.isNullOrBlank()) {
            "video_${System.currentTimeMillis()}$extension"
        } else {
            "${title}_${System.currentTimeMillis()}$extension"
        }
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
     */
    private fun updateDownloadProgress(url: String, progress: VideoDownloadProgress) {
        activeDownloads[url] = progress
        _downloadProgress.value = activeDownloads.toMap()
        
        // ì™„ë£Œë˜ê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš° ì¼ì • ì‹œê°„ í›„ ì œê±°
        if (progress.status == VideoDownloadStatus.COMPLETED || 
            progress.status == VideoDownloadStatus.FAILED) {
            downloadScope.launch {
                kotlinx.coroutines.delay(5000) // 5ì´ˆ í›„ ì œê±°
                activeDownloads.remove(url)
                _downloadProgress.value = activeDownloads.toMap()
            }
        }
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ì·¨ì†Œ
     */
    fun cancelDownload(url: String) {
        activeDownloads.remove(url)
        _downloadProgress.value = activeDownloads.toMap()
        
        // HLS ë‹¤ìš´ë¡œë“œ ì·¨ì†Œ
        hlsDownloader.cancelDownload(url)
        
        Log.d(TAG, "ë‹¤ìš´ë¡œë“œ ì·¨ì†Œ: $url")
    }
    
    /**
     * ëª¨ë“  ë‹¤ìš´ë¡œë“œ ì·¨ì†Œ
     */
    fun cancelAllDownloads() {
        val urls = activeDownloads.keys.toList()
        urls.forEach { cancelDownload(it) }
        Log.d(TAG, "ëª¨ë“  ë‹¤ìš´ë¡œë“œ ì·¨ì†Œ")
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ì§„í–‰ ìƒí™© ì¡°íšŒ
     */
    fun getDownloadProgress(url: String): VideoDownloadProgress? {
        return activeDownloads[url]
    }
    
    /**
     * í™œì„± ë‹¤ìš´ë¡œë“œ ìˆ˜ ì¡°íšŒ
     */
    fun getActiveDownloadCount(): Int {
        return activeDownloads.values.count { 
            it.status == VideoDownloadStatus.DOWNLOADING || 
            it.status == VideoDownloadStatus.PENDING 
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/models/VideoInfo.kt">
package com.swvd.simplewebvideodownloader.models

/**
 * ë¹„ë””ì˜¤ ì •ë³´ ë°ì´í„° í´ë˜ìŠ¤
 * ê°ì§€ëœ ë¹„ë””ì˜¤ì˜ ìƒì„¸ ì •ë³´ë¥¼ ì €ì¥
 */
data class VideoInfo(
    val url: String,
    val type: VideoType,
    val title: String? = null,
    val duration: String? = null,
    val quality: String? = null,
    val size: String? = null,
    val thumbnail: String? = null
)

/**
 * ì§€ì›í•˜ëŠ” ë¹„ë””ì˜¤ í˜•ì‹ íƒ€ì…
 */
enum class VideoType(
    val displayName: String, 
    val extensions: List<String>,
    val icon: String,
    val downloadable: Boolean = true
) {
    MP4("MP4 ë¹„ë””ì˜¤", listOf(".mp4"), "ğŸ¬", true),
    HLS("HLS ìŠ¤íŠ¸ë¦¬ë°", listOf(".m3u8", ".m3u"), "ğŸ“º", true),
    DASH("DASH ìŠ¤íŠ¸ë¦¬ë°", listOf(".mpd"), "ğŸï¸", false),
    WEBM("WebM ë¹„ë””ì˜¤", listOf(".webm"), "ğŸ¬", true),
    MKV("MKV ë¹„ë””ì˜¤", listOf(".mkv"), "ğŸ¬", true),
    AVI("AVI ë¹„ë””ì˜¤", listOf(".avi"), "ğŸ¬", true),
    MOV("QuickTime ë¹„ë””ì˜¤", listOf(".mov"), "ğŸ¬", true),
    FLV("Flash ë¹„ë””ì˜¤", listOf(".flv"), "ğŸ¬", true),
    YOUTUBE("YouTube ë¹„ë””ì˜¤", listOf("youtube.com"), "ğŸ”´", false),
    VIMEO("Vimeo ë¹„ë””ì˜¤", listOf("vimeo.com"), "ğŸ”µ", false),
    UNKNOWN("ì•Œ ìˆ˜ ì—†ëŠ” í˜•ì‹", emptyList(), "â“", false)
}

/**
 * ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ìƒíƒœ
 */
enum class VideoDownloadStatus {
    PENDING,     // ëŒ€ê¸° ì¤‘
    DOWNLOADING, // ë‹¤ìš´ë¡œë“œ ì¤‘
    COMPLETED,   // ì™„ë£Œ
    FAILED,      // ì‹¤íŒ¨
    PAUSED       // ì¼ì‹œì •ì§€
}

/**
 * ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ì§„í–‰ ì •ë³´
 */
data class VideoDownloadProgress(
    val videoInfo: VideoInfo,
    val status: VideoDownloadStatus,
    val progress: Int = 0,
    val totalBytes: Long = 0,
    val downloadedBytes: Long = 0,
    val downloadSpeed: String = "",
    val remainingTime: String = "",
    val error: String? = null
)
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/components/DownloadResultDialog.kt">
package com.swvd.simplewebvideodownloader.ui.components

import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.window.Dialog

/**
 * ë‹¤ìš´ë¡œë“œ ê²°ê³¼ ë‹¤ì´ì–¼ë¡œê·¸
 * ë‹¤ìš´ë¡œë“œ ì„±ê³µ/ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ í‘œì‹œ
 */
@Composable
fun DownloadResultDialog(
    show: Boolean,
    message: String?,
    onDismiss: () -> Unit
) {
    if (show) {
        Dialog(onDismissRequest = onDismiss) {
            Card(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(16.dp),
                elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)
            ) {
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(24.dp),
                    horizontalAlignment = Alignment.CenterHorizontally
                ) {
                    val messageText = message ?: "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"
                    
                    // ì•„ì´ì½˜
                    Text(
                        text = if (messageText.contains("ì„±ê³µ") || messageText.contains("ì™„ë£Œ")) "âœ…" else "âŒ",
                        style = MaterialTheme.typography.headlineLarge
                    )
                    
                    Spacer(modifier = Modifier.height(16.dp))
                    
                    // ì œëª©
                    Text(
                        text = if (messageText.contains("ì„±ê³µ") || messageText.contains("ì™„ë£Œ")) 
                            "ë‹¤ìš´ë¡œë“œ ì™„ë£Œ" else "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨",
                        style = MaterialTheme.typography.headlineSmall,
                        fontWeight = FontWeight.Bold
                    )
                    
                    Spacer(modifier = Modifier.height(12.dp))
                    
                    // ë©”ì‹œì§€
                    Text(
                        text = messageText,
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                    
                    Spacer(modifier = Modifier.height(24.dp))
                    
                    // í™•ì¸ ë²„íŠ¼
                    Button(
                        onClick = onDismiss,
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text("í™•ì¸")
                    }
                }
            }
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/components/NavigationBottomBar.kt">
package com.swvd.simplewebvideodownloader.ui.components

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.ArrowForward
import androidx.compose.material.icons.filled.Refresh
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp

/**
 * ë„¤ë¹„ê²Œì´ì…˜ í•˜ë‹¨ ë°” ì»´í¬ë„ŒíŠ¸
 * WebView ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ë“¤ì„ ì œê³µ
 */
@Composable
fun NavigationBottomBar(
    modifier: Modifier = Modifier,
    canGoBack: Boolean,
    canGoForward: Boolean,
    isAnalyzing: Boolean,
    onGoBack: () -> Unit,
    onGoForward: () -> Unit,
    onRefresh: () -> Unit,
    onFullscreen: () -> Unit
) {
    Card(
        modifier = modifier
            .fillMaxWidth()
            .windowInsetsPadding(WindowInsets.systemBars.only(WindowInsetsSides.Bottom))
            .padding(horizontal = 16.dp, vertical = 20.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 6.dp),
        shape = RoundedCornerShape(16.dp),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surfaceContainer
        )
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp, vertical = 8.dp),
            horizontalArrangement = Arrangement.SpaceEvenly,
            verticalAlignment = Alignment.CenterVertically
        ) {
            // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
            NavigationButton(
                onClick = onGoBack,
                enabled = canGoBack,
                icon = {
                    Icon(
                        imageVector = Icons.Default.ArrowBack,
                        contentDescription = "ë’¤ë¡œê°€ê¸°",
                        modifier = Modifier.size(20.dp)
                    )
                },
                containerColor = if (canGoBack) 
                    MaterialTheme.colorScheme.secondaryContainer 
                else 
                    MaterialTheme.colorScheme.surfaceVariant,
                contentColor = if (canGoBack) 
                    MaterialTheme.colorScheme.onSecondaryContainer 
                else 
                    MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.5f)
            )

            // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
            NavigationButton(
                onClick = onRefresh,
                enabled = !isAnalyzing,
                icon = {
                    if (isAnalyzing) {
                        CircularProgressIndicator(
                            modifier = Modifier.size(18.dp),
                            color = MaterialTheme.colorScheme.onTertiaryContainer
                        )
                    } else {
                        Icon(
                            imageVector = Icons.Default.Refresh,
                            contentDescription = "ìƒˆë¡œê³ ì¹¨",
                            modifier = Modifier.size(20.dp)
                        )
                    }
                },
                containerColor = MaterialTheme.colorScheme.tertiaryContainer,
                contentColor = MaterialTheme.colorScheme.onTertiaryContainer
            )

            // ì•ìœ¼ë¡œê°€ê¸° ë²„íŠ¼
            NavigationButton(
                onClick = onGoForward,
                enabled = canGoForward,
                icon = {
                    Icon(
                        imageVector = Icons.Default.ArrowForward,
                        contentDescription = "ì•ìœ¼ë¡œê°€ê¸°",
                        modifier = Modifier.size(20.dp)
                    )
                },
                containerColor = if (canGoForward) 
                    MaterialTheme.colorScheme.secondaryContainer 
                else 
                    MaterialTheme.colorScheme.surfaceVariant,
                contentColor = if (canGoForward) 
                    MaterialTheme.colorScheme.onSecondaryContainer 
                else 
                    MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.5f)
            )

            // ì „ì²´í™”ë©´ ë²„íŠ¼
            NavigationButton(
                onClick = onFullscreen,
                enabled = true,
                icon = {
                    Text(
                        text = "â›¶",
                        style = MaterialTheme.typography.headlineSmall
                    )
                },
                containerColor = MaterialTheme.colorScheme.primaryContainer,
                contentColor = MaterialTheme.colorScheme.onPrimaryContainer
            )
        }
    }
}

/**
 * ê°œë³„ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼
 */
@Composable
private fun NavigationButton(
    onClick: () -> Unit,
    enabled: Boolean,
    icon: @Composable () -> Unit,
    containerColor: androidx.compose.ui.graphics.Color,
    contentColor: androidx.compose.ui.graphics.Color,
    modifier: Modifier = Modifier
) {
    FloatingActionButton(
        onClick = onClick,
        modifier = modifier.size(44.dp),
        containerColor = containerColor,
        contentColor = contentColor
    ) {
        icon()
    }
}

/**
 * ì „ì²´í™”ë©´ìš© ë„¤ë¹„ê²Œì´ì…˜ ë°”
 */
@Composable
fun FullscreenNavigationBar(
    modifier: Modifier = Modifier,
    canGoBack: Boolean,
    canGoForward: Boolean,
    isAnalyzing: Boolean,
    onGoBack: () -> Unit,
    onGoForward: () -> Unit,
    onRefresh: () -> Unit,
    onExitFullscreen: () -> Unit,
    onShowMp4List: () -> Unit
) {
    Surface(
        modifier = modifier.fillMaxWidth(),
        color = MaterialTheme.colorScheme.surface.copy(alpha = 0.95f),
        shadowElevation = 8.dp
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            horizontalArrangement = Arrangement.SpaceEvenly,
            verticalAlignment = Alignment.CenterVertically
        ) {
            // ë’¤ë¡œê°€ê¸°
            IconButton(
                onClick = onGoBack,
                enabled = canGoBack
            ) {
                Icon(
                    imageVector = Icons.Default.ArrowBack,
                    contentDescription = "ë’¤ë¡œê°€ê¸°",
                    tint = if (canGoBack) 
                        MaterialTheme.colorScheme.primary 
                    else 
                        MaterialTheme.colorScheme.onSurface.copy(alpha = 0.3f)
                )
            }

            // ì•ìœ¼ë¡œê°€ê¸°
            IconButton(
                onClick = onGoForward,
                enabled = canGoForward
            ) {
                Icon(
                    imageVector = Icons.Default.ArrowForward,
                    contentDescription = "ì•ìœ¼ë¡œê°€ê¸°",
                    tint = if (canGoForward) 
                        MaterialTheme.colorScheme.primary 
                    else 
                        MaterialTheme.colorScheme.onSurface.copy(alpha = 0.3f)
                )
            }

            // ìƒˆë¡œê³ ì¹¨
            IconButton(
                onClick = onRefresh,
                enabled = !isAnalyzing
            ) {
                if (isAnalyzing) {
                    CircularProgressIndicator(
                        modifier = Modifier.size(24.dp),
                        color = MaterialTheme.colorScheme.primary
                    )
                } else {
                    Icon(
                        imageVector = Icons.Default.Refresh,
                        contentDescription = "ìƒˆë¡œê³ ì¹¨",
                        tint = MaterialTheme.colorScheme.primary
                    )
                }
            }

            // ë¹„ë””ì˜¤ ëª©ë¡
            IconButton(onClick = onShowMp4List) {
                Text(
                    text = "ğŸ¬",
                    style = MaterialTheme.typography.headlineSmall
                )
            }

            // ì „ì²´í™”ë©´ ì¢…ë£Œ
            IconButton(onClick = onExitFullscreen) {
                Text(
                    text = "â¤¹",
                    style = MaterialTheme.typography.headlineSmall,
                    color = MaterialTheme.colorScheme.primary
                )
            }
        }
    }
}

/**
 * ì»´íŒ©íŠ¸ ë„¤ë¹„ê²Œì´ì…˜ ë°” (ê³µê°„ì´ ë¶€ì¡±í•  ë•Œ)
 */
@Composable
fun CompactNavigationBar(
    modifier: Modifier = Modifier,
    canGoBack: Boolean,
    canGoForward: Boolean,
    isAnalyzing: Boolean,
    onGoBack: () -> Unit,
    onGoForward: () -> Unit,
    onRefresh: () -> Unit,
    onFullscreen: () -> Unit
) {
    Row(
        modifier = modifier
            .fillMaxWidth()
            .padding(8.dp),
        horizontalArrangement = Arrangement.SpaceEvenly,
        verticalAlignment = Alignment.CenterVertically
    ) {
        // ë’¤ë¡œ/ì•ìœ¼ë¡œ ê²°í•© ë²„íŠ¼
        Row(
            horizontalArrangement = Arrangement.spacedBy(4.dp)
        ) {
            FilledTonalIconButton(
                onClick = onGoBack,
                enabled = canGoBack,
                modifier = Modifier.size(32.dp)
            ) {
                Icon(
                    imageVector = Icons.Default.ArrowBack,
                    contentDescription = "ë’¤ë¡œê°€ê¸°",
                    modifier = Modifier.size(16.dp)
                )
            }

            FilledTonalIconButton(
                onClick = onGoForward,
                enabled = canGoForward,
                modifier = Modifier.size(32.dp)
            ) {
                Icon(
                    imageVector = Icons.Default.ArrowForward,
                    contentDescription = "ì•ìœ¼ë¡œê°€ê¸°",
                    modifier = Modifier.size(16.dp)
                )
            }
        }

        // ìƒˆë¡œê³ ì¹¨
        FilledTonalIconButton(
            onClick = onRefresh,
            enabled = !isAnalyzing,
            modifier = Modifier.size(36.dp)
        ) {
            if (isAnalyzing) {
                CircularProgressIndicator(
                    modifier = Modifier.size(16.dp),
                    strokeWidth = 2.dp
                )
            } else {
                Icon(
                    imageVector = Icons.Default.Refresh,
                    contentDescription = "ìƒˆë¡œê³ ì¹¨",
                    modifier = Modifier.size(18.dp)
                )
            }
        }

        // ì „ì²´í™”ë©´
        FilledIconButton(
            onClick = onFullscreen,
            modifier = Modifier.size(36.dp)
        ) {
            Text(
                text = "â›¶",
                style = MaterialTheme.typography.titleMedium
            )
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/components/TabBar.kt">
package com.swvd.simplewebvideodownloader.ui.components

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyRow
import androidx.compose.foundation.lazy.itemsIndexed
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Add
import androidx.compose.material.icons.filled.Close
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import com.swvd.simplewebvideodownloader.models.Tab

/**
 * íƒ­ë°” ì»´í¬ë„ŒíŠ¸
 * ì—¬ëŸ¬ íƒ­ì„ ê´€ë¦¬í•˜ê³  í‘œì‹œ
 */
@Composable
fun TabBar(
    tabs: List<Tab>,
    currentTabIndex: Int,
    onNewTab: () -> Unit,
    onCloseTab: (Int) -> Unit,
    onSwitchTab: (Int) -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier.fillMaxWidth(),
        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(8.dp),
            horizontalArrangement = Arrangement.spacedBy(8.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            // íƒ­ ëª©ë¡
            LazyRow(
                modifier = Modifier.weight(1f),
                horizontalArrangement = Arrangement.spacedBy(4.dp)
            ) {
                itemsIndexed(tabs) { index, tab ->
                    TabItem(
                        tab = tab,
                        isSelected = index == currentTabIndex,
                        onSelect = { onSwitchTab(index) },
                        onClose = if (tabs.size > 1) { 
                            { onCloseTab(index) } 
                        } else null
                    )
                }
            }
            
            // ìƒˆ íƒ­ ì¶”ê°€ ë²„íŠ¼
            FilledTonalIconButton(
                onClick = onNewTab,
                modifier = Modifier.size(32.dp)
            ) {
                Icon(
                    imageVector = Icons.Default.Add,
                    contentDescription = "ìƒˆ íƒ­",
                    modifier = Modifier.size(16.dp)
                )
            }
        }
    }
}

/**
 * ê°œë³„ íƒ­ ì•„ì´í…œ
 */
@Composable
private fun TabItem(
    tab: Tab,
    isSelected: Boolean,
    onSelect: () -> Unit,
    onClose: (() -> Unit)? = null
) {
    val containerColor = if (isSelected) {
        MaterialTheme.colorScheme.primaryContainer
    } else {
        MaterialTheme.colorScheme.surfaceContainer
    }
    
    val contentColor = if (isSelected) {
        MaterialTheme.colorScheme.onPrimaryContainer
    } else {
        MaterialTheme.colorScheme.onSurfaceVariant
    }
    
    Card(
        onClick = onSelect,
        colors = CardDefaults.cardColors(
            containerColor = containerColor
        ),
        modifier = Modifier.widthIn(max = 150.dp)
    ) {
        Row(
            modifier = Modifier
                .padding(horizontal = 12.dp, vertical = 6.dp),
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.spacedBy(4.dp)
        ) {
            // íƒ­ ì œëª©
            Text(
                text = tab.title.ifEmpty { "ìƒˆ íƒ­" },
                style = MaterialTheme.typography.bodySmall,
                color = contentColor,
                maxLines = 1,
                overflow = TextOverflow.Ellipsis,
                modifier = Modifier.weight(1f)
            )
            
            // ë‹«ê¸° ë²„íŠ¼ (ì—¬ëŸ¬ íƒ­ì´ ìˆì„ ë•Œë§Œ)
            if (onClose != null) {
                IconButton(
                    onClick = onClose,
                    modifier = Modifier.size(16.dp)
                ) {
                    Icon(
                        imageVector = Icons.Default.Close,
                        contentDescription = "íƒ­ ë‹«ê¸°",
                        tint = contentColor,
                        modifier = Modifier.size(12.dp)
                    )
                }
            }
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/components/TabOverviewScreen.kt">
package com.swvd.simplewebvideodownloader.ui.components

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.itemsIndexed
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Add
import androidx.compose.material.icons.filled.Close
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import com.swvd.simplewebvideodownloader.models.Tab

/**
 * íƒ­ ì˜¤ë²„ë·° í™”ë©´ ì»´í¬ë„ŒíŠ¸
 * ì „ì²´í™”ë©´ì—ì„œ íƒ­ ëª©ë¡ì„ í‘œì‹œí•˜ëŠ” í™”ë©´
 */
@Composable
fun TabOverviewScreen(
    tabs: List<Tab>,
    currentTabIndex: Int,
    onTabSelected: (Int) -> Unit,
    onTabClosed: (Int) -> Unit,
    onAddNewTab: () -> Unit,
    onBackToWebView: () -> Unit,
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier
            .fillMaxSize()
            .padding(16.dp)
    ) {
        // ìƒë‹¨ í—¤ë”
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = "íƒ­ ê´€ë¦¬",
                style = MaterialTheme.typography.headlineSmall
            )
            
            Row {
                // ìƒˆ íƒ­ ë²„íŠ¼
                IconButton(onClick = onAddNewTab) {
                    Icon(
                        imageVector = Icons.Default.Add,
                        contentDescription = "ìƒˆ íƒ­"
                    )
                }
                
                // ë‹«ê¸° ë²„íŠ¼
                IconButton(onClick = onBackToWebView) {
                    Icon(
                        imageVector = Icons.Default.Close,
                        contentDescription = "ë‹«ê¸°"
                    )
                }
            }
        }
        
        Spacer(modifier = Modifier.height(16.dp))
        
        // íƒ­ ëª©ë¡
        LazyColumn(
            verticalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            itemsIndexed(tabs) { index, tab ->
                TabOverviewItem(
                    tab = tab,
                    isSelected = index == currentTabIndex,
                    onSelect = { onTabSelected(index) },
                    onClose = if (tabs.size > 1) { 
                        { onTabClosed(index) } 
                    } else null
                )
            }
        }
    }
}

/**
 * íƒ­ ì˜¤ë²„ë·° ê°œë³„ ì•„ì´í…œ
 */
@Composable
private fun TabOverviewItem(
    tab: Tab,
    isSelected: Boolean,
    onSelect: () -> Unit,
    onClose: (() -> Unit)? = null
) {
    Card(
        onClick = onSelect,
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = if (isSelected) {
                MaterialTheme.colorScheme.primaryContainer
            } else {
                MaterialTheme.colorScheme.surface
            }
        )
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Column(
                modifier = Modifier.weight(1f)
            ) {
                Text(
                    text = tab.title.ifEmpty { "ìƒˆ íƒ­" },
                    style = MaterialTheme.typography.titleMedium,
                    maxLines = 1,
                    overflow = TextOverflow.Ellipsis
                )
                
                if (tab.url.isNotEmpty()) {
                    Text(
                        text = tab.url,
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant,
                        maxLines = 1,
                        overflow = TextOverflow.Ellipsis
                    )
                }
            }
            
            // ë‹«ê¸° ë²„íŠ¼
            if (onClose != null) {
                IconButton(onClick = onClose) {
                    Icon(
                        imageVector = Icons.Default.Close,
                        contentDescription = "íƒ­ ë‹«ê¸°"
                    )
                }
            }
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/components/UrlInputSection.kt">
package com.swvd.simplewebvideodownloader.ui.components

import androidx.compose.animation.AnimatedVisibility
import androidx.compose.animation.expandVertically
import androidx.compose.animation.shrinkVertically
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.text.KeyboardActions
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Close
import androidx.compose.material.icons.filled.Search
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalClipboardManager
import androidx.compose.ui.platform.LocalSoftwareKeyboardController
import androidx.compose.ui.text.input.ImeAction
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp

/**
 * URL ì…ë ¥ ì„¹ì…˜ ì»´í¬ë„ŒíŠ¸
 * URL ì…ë ¥ í•„ë“œì™€ ê´€ë ¨ ë²„íŠ¼ë“¤ì„ í¬í•¨
 */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun UrlInputSection(
    modifier: Modifier = Modifier,
    urlText: String,
    currentUrl: String,
    isAnalyzing: Boolean,
    urlSectionExpanded: Boolean,
    onUrlTextChange: (String) -> Unit,
    onLoadUrl: () -> Unit,
    onReset: () -> Unit,
    onRefresh: () -> Unit,
    onToggleExpanded: () -> Unit
) {
    val clipboardManager = LocalClipboardManager.current
    val keyboardController = LocalSoftwareKeyboardController.current

    Card(
        modifier = modifier.fillMaxWidth(),
        elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
    ) {
        Column(
            modifier = Modifier.padding(12.dp)
        ) {
            // ì„¹ì…˜ í—¤ë” (í´ë¦­ ê°€ëŠ¥)
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .clickable { onToggleExpanded() },
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = "ì›¹ í˜ì´ì§€ URL ì…ë ¥",
                    style = MaterialTheme.typography.titleMedium
                )
                Text(
                    text = if (urlSectionExpanded) "â–²" else "â–¼",
                    style = MaterialTheme.typography.titleMedium
                )
            }

            // ë¡œë“œëœ URLì´ ìˆê³  ì„¹ì…˜ì´ ì ‘í˜€ìˆì„ ë•Œ ê°„ë‹¨íˆ í‘œì‹œ
            if (!urlSectionExpanded && currentUrl.isNotEmpty()) {
                Spacer(modifier = Modifier.height(8.dp))
                Text(
                    text = currentUrl.let { url ->
                        if (url.length > 40) "...${url.takeLast(37)}" else url
                    },
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.primary,
                    maxLines = 1,
                    overflow = TextOverflow.Ellipsis
                )
            }

            // ì ‘í ìˆ˜ ìˆëŠ” ë‚´ìš©
            AnimatedVisibility(
                visible = urlSectionExpanded,
                enter = expandVertically(),
                exit = shrinkVertically()
            ) {
                Column {
                    Spacer(modifier = Modifier.height(6.dp))

                    // URL ì…ë ¥ í•„ë“œ
                    OutlinedTextField(
                        value = urlText,
                        onValueChange = onUrlTextChange,
                        label = { Text("URLì„ ì…ë ¥í•˜ì„¸ìš”") },
                        placeholder = { Text("https://example.com") },
                        modifier = Modifier.fillMaxWidth(),
                        maxLines = 3,
                        keyboardOptions = KeyboardOptions(
                            keyboardType = KeyboardType.Uri,
                            imeAction = ImeAction.Go
                        ),
                        keyboardActions = KeyboardActions(
                            onGo = { onLoadUrl() }
                        ),
                        trailingIcon = {
                            TextButton(
                                onClick = {
                                    clipboardManager.getText()?.text?.let { clipText ->
                                        if (clipText.contains(".")) {
                                            onUrlTextChange(clipText)
                                        }
                                    }
                                }
                            ) {
                                Text("ë¶™ì—¬ë„£ê¸°")
                            }
                        }
                    )

                    Spacer(modifier = Modifier.height(12.dp))

                    // ë²„íŠ¼ë“¤
                    Column(
                        verticalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        // ì²« ë²ˆì§¸ ì¤„: í˜ì´ì§€ ë¡œë“œ, ì´ˆê¸°í™”
                        Row(
                            modifier = Modifier.fillMaxWidth(),
                            horizontalArrangement = Arrangement.spacedBy(8.dp)
                        ) {
                            Button(
                                onClick = onLoadUrl,
                                modifier = Modifier.weight(1f),
                                enabled = urlText.isNotBlank() && !isAnalyzing
                            ) {
                                if (isAnalyzing) {
                                    CircularProgressIndicator(
                                        modifier = Modifier.size(18.dp),
                                        color = MaterialTheme.colorScheme.onPrimary
                                    )
                                    Spacer(modifier = Modifier.width(8.dp))
                                    Text("ë¶„ì„ ì¤‘...")
                                } else {
                                    Icon(
                                        imageVector = Icons.Default.Search,
                                        contentDescription = null,
                                        modifier = Modifier.size(18.dp)
                                    )
                                    Spacer(modifier = Modifier.width(8.dp))
                                    Text("í˜ì´ì§€ ë¡œë“œ")
                                }
                            }

                            Button(
                                onClick = onReset,
                                modifier = Modifier.weight(1f),
                                colors = ButtonDefaults.buttonColors(
                                    containerColor = MaterialTheme.colorScheme.secondary
                                )
                            ) {
                                Icon(
                                    imageVector = Icons.Default.Close,
                                    contentDescription = null,
                                    modifier = Modifier.size(18.dp)
                                )
                                Spacer(modifier = Modifier.width(8.dp))
                                Text("ì´ˆê¸°í™”")
                            }
                        }

                        // ë‘ ë²ˆì§¸ ì¤„: ìƒˆë¡œê³ ì¹¨ (í˜„ì¬ URLì´ ìˆì„ ë•Œë§Œ í‘œì‹œ)
                        if (currentUrl.isNotEmpty()) {
                            Button(
                                onClick = onRefresh,
                                modifier = Modifier.fillMaxWidth(),
                                enabled = !isAnalyzing,
                                colors = ButtonDefaults.buttonColors(
                                    containerColor = MaterialTheme.colorScheme.tertiary
                                )
                            ) {
                                if (isAnalyzing) {
                                    CircularProgressIndicator(
                                        modifier = Modifier.size(18.dp),
                                        color = MaterialTheme.colorScheme.onTertiary
                                    )
                                    Spacer(modifier = Modifier.width(8.dp))
                                    Text("ìƒˆë¡œê³ ì¹¨ ì¤‘...")
                                } else {
                                    Text("ğŸ”„ ìƒˆë¡œê³ ì¹¨ & ë¹„ë””ì˜¤ ê°ì§€")
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/components/VideoListSection.kt">
package com.swvd.simplewebvideodownloader.ui.components

import androidx.compose.animation.AnimatedVisibility
import androidx.compose.animation.expandVertically
import androidx.compose.animation.shrinkVertically
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.itemsIndexed
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import com.swvd.simplewebvideodownloader.models.VideoInfo
import com.swvd.simplewebvideodownloader.models.VideoType

/**
 * ë¹„ë””ì˜¤ ëª©ë¡ ì„¹ì…˜ ì»´í¬ë„ŒíŠ¸
 * ê°ì§€ëœ ë¹„ë””ì˜¤ ëª©ë¡ì„ í‘œì‹œí•˜ê³  ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì„ ì œê³µ
 */
@Composable
fun VideoListSection(
    modifier: Modifier = Modifier,
    hasAnalyzed: Boolean,
    videoList: List<VideoInfo>,
    mp4Links: List<String>, // ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€
    downloadingUrls: Set<String>,
    videoSectionExpanded: Boolean,
    onToggleExpanded: () -> Unit,
    onDownloadVideo: (VideoInfo) -> Unit,
    onDownloadMp4: (String) -> Unit // ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€
) {
    if (!hasAnalyzed) return

    Card(
        modifier = modifier.fillMaxWidth(),
        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.primaryContainer
        )
    ) {
        Column(modifier = Modifier.padding(12.dp)) {
            // ì„¹ì…˜ í—¤ë” (í´ë¦­ ê°€ëŠ¥)
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .clickable { onToggleExpanded() },
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = if (videoList.isEmpty()) {
                        "ğŸ¯ ê°ì§€ëœ ë¹„ë””ì˜¤ (ì—†ìŒ)"
                    } else {
                        "ğŸ¯ ê°ì§€ëœ ë¹„ë””ì˜¤ (${videoList.size}ê°œ)"
                    },
                    style = MaterialTheme.typography.titleMedium,
                    color = MaterialTheme.colorScheme.onPrimaryContainer
                )
                Text(
                    text = if (videoSectionExpanded) "â–²" else "â–¼",
                    style = MaterialTheme.typography.titleMedium,
                    color = MaterialTheme.colorScheme.onPrimaryContainer
                )
            }

            // ì ‘íŒ ìƒíƒœì—ì„œ ê°„ë‹¨í•œ ìš”ì•½ í‘œì‹œ
            if (!videoSectionExpanded) {
                Spacer(modifier = Modifier.height(8.dp))
                if (videoList.isEmpty()) {
                    Text(
                        text = "ì´ í˜ì´ì§€ì—ì„œ ë¹„ë””ì˜¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onPrimaryContainer
                    )
                } else {
                    val downloadableCount = videoList.count { isDownloadable(it) }
                    val typesSummary = videoList.groupBy { it.type }.entries
                        .take(3)
                        .joinToString(", ") { "${it.key.icon}${it.value.size}" }
                    
                    Text(
                        text = "ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥: ${downloadableCount}ê°œ | $typesSummary",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onPrimaryContainer
                    )
                }
            }

            // ì ‘í ìˆ˜ ìˆëŠ” ëª©ë¡ ë‚´ìš©
            AnimatedVisibility(
                visible = videoSectionExpanded,
                enter = expandVertically(),
                exit = shrinkVertically()
            ) {
                Column {
                    Spacer(modifier = Modifier.height(12.dp))

                    if (videoList.isEmpty()) {
                        // ë¹„ë””ì˜¤ê°€ ì—†ì„ ë•Œ í‘œì‹œ
                        Text(
                            text = "ì´ í˜ì´ì§€ì—ì„œ ë¹„ë””ì˜¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¹„ë””ì˜¤ê°€ iframeì´ë‚˜ ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ êµ¬í˜„ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onPrimaryContainer,
                            modifier = Modifier.padding(vertical = 16.dp)
                        )
                    } else {
                        // ë¹„ë””ì˜¤ íƒ€ì…ë³„ ë¶„ë¥˜ í‘œì‹œ
                        VideoTypesSummary(
                            videoList = videoList,
                            modifier = Modifier.padding(bottom = 12.dp)
                        )
                        
                        // ë¹„ë””ì˜¤ ëª©ë¡
                        LazyColumn(
                            modifier = Modifier.height(300.dp),
                            verticalArrangement = Arrangement.spacedBy(8.dp)
                        ) {
                            itemsIndexed(videoList) { index, video ->
                                VideoItem(
                                    index = index,
                                    video = video,
                                    isDownloading = downloadingUrls.contains(video.url),
                                    onDownload = { onDownloadVideo(video) }
                                )
                            }
                        }
                    }
                }
            }
        }
    }
}

/**
 * ë¹„ë””ì˜¤ íƒ€ì…ë³„ ìš”ì•½ í‘œì‹œ
 */
@Composable
private fun VideoTypesSummary(
    videoList: List<VideoInfo>,
    modifier: Modifier = Modifier
) {
    val typeCounts = videoList.groupBy { it.type }
        .mapValues { it.value.size }
        .toList()
        .sortedByDescending { it.second }

    if (typeCounts.isNotEmpty()) {
        Card(
            modifier = modifier.fillMaxWidth(),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surface
            )
        ) {
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(12.dp),
                horizontalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                typeCounts.take(4).forEach { (videoType, videoCount) ->
                    Column(
                        horizontalAlignment = Alignment.CenterHorizontally
                    ) {
                        Text(
                            text = videoType.icon,
                            style = MaterialTheme.typography.headlineSmall
                        )
                        Text(
                            text = "${videoCount}ê°œ",
                            style = MaterialTheme.typography.bodySmall
                        )
                        Text(
                            text = videoType.displayName,
                            style = MaterialTheme.typography.labelSmall,
                            maxLines = 1,
                            overflow = TextOverflow.Ellipsis
                        )
                    }
                }
            }
        }
    }
}

/**
 * ê°œë³„ ë¹„ë””ì˜¤ ì•„ì´í…œ
 */
@Composable
private fun VideoItem(
    index: Int,
    video: VideoInfo,
    isDownloading: Boolean,
    onDownload: () -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surface
        )
    ) {
        Column(modifier = Modifier.padding(12.dp)) {
            // ë¹„ë””ì˜¤ ì •ë³´ í—¤ë”
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(
                        text = video.type.icon,
                        style = MaterialTheme.typography.titleMedium
                    )
                    Spacer(modifier = Modifier.width(8.dp))
                    Text(
                        text = video.type.displayName,
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.primary
                    )
                }
                
                // ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥ ì—¬ë¶€ í‘œì‹œ
                if (isDownloadable(video)) {
                    Text(
                        text = "â¬‡ï¸",
                        style = MaterialTheme.typography.titleMedium
                    )
                }
            }
            
            Spacer(modifier = Modifier.height(8.dp))
            
            // ì œëª© í‘œì‹œ (ìˆëŠ” ê²½ìš°)
            if (!video.title.isNullOrBlank()) {
                Text(
                    text = "ì œëª©: ${video.title}",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                    maxLines = 2,
                    overflow = TextOverflow.Ellipsis
                )
                Spacer(modifier = Modifier.height(4.dp))
            }
            
            // URL í‘œì‹œ
            Text(
                text = "${index + 1}. ${if (video.url.length > 50) "...${video.url.takeLast(50)}" else video.url}",
                style = MaterialTheme.typography.bodySmall,
                modifier = Modifier.padding(bottom = 8.dp),
                maxLines = 2,
                overflow = TextOverflow.Ellipsis
            )

            // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ ê²½ìš°ë§Œ)
            if (isDownloadable(video)) {
                Button(
                    onClick = onDownload,
                    modifier = Modifier.fillMaxWidth(),
                    enabled = !isDownloading,
                    colors = ButtonDefaults.buttonColors(
                        containerColor = when (video.type) {
                            VideoType.HLS -> MaterialTheme.colorScheme.secondary
                            VideoType.MP4 -> MaterialTheme.colorScheme.tertiary
                            else -> MaterialTheme.colorScheme.primary
                        }
                    )
                ) {
                    if (isDownloading) {
                        CircularProgressIndicator(
                            modifier = Modifier.size(16.dp),
                            color = MaterialTheme.colorScheme.onPrimary
                        )
                        Spacer(modifier = Modifier.width(8.dp))
                        Text("ë‹¤ìš´ë¡œë“œ ì¤‘...")
                    } else {
                        Text("${video.type.icon} ë‹¤ìš´ë¡œë“œ")
                    }
                }
            } else {
                // ë‹¤ìš´ë¡œë“œ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° ì•ˆë‚´
                Text(
                    text = when (video.type) {
                        VideoType.DASH -> "DASH ìŠ¤íŠ¸ë¦¬ë°ì€ ì§€ì› ì˜ˆì •"
                        VideoType.YOUTUBE -> "YouTubeëŠ” ë³„ë„ ì²˜ë¦¬ í•„ìš”"
                        VideoType.VIMEO -> "VimeoëŠ” ë³„ë„ ì²˜ë¦¬ í•„ìš”"
                        else -> "ë‹¤ìš´ë¡œë“œ ì§€ì› ì•ˆí•¨"
                    },
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                    modifier = Modifier.padding(8.dp)
                )
            }
        }
    }
}

/**
 * ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
 */
private fun isDownloadable(video: VideoInfo): Boolean {
    return when (video.type) {
        VideoType.MP4,
        VideoType.WEBM,
        VideoType.MKV,
        VideoType.AVI,
        VideoType.MOV,
        VideoType.FLV,
        VideoType.HLS -> true
        else -> false
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/components/WebViewContainer.kt">
package com.swvd.simplewebvideodownloader.ui.components

import android.os.Bundle
import android.webkit.WebChromeClient
import android.webkit.WebView
import android.webkit.WebViewClient
import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import androidx.compose.ui.viewinterop.AndroidView

/**
 * WebView ì»¨í…Œì´ë„ˆ ì»´í¬ë„ŒíŠ¸
 * WebView ì„¤ì • ë° ê´€ë¦¬ë¥¼ ë‹´ë‹¹
 */
@Composable
fun WebViewContainer(
    modifier: Modifier = Modifier,
    currentUrl: String,
    webViewState: Bundle? = null,
    onWebViewCreated: (WebView) -> Unit = {},
    onUrlChanged: (String) -> Unit = {},
    onPageStarted: (String) -> Unit = {},
    onPageFinished: (String) -> Unit = {},
    onTitleReceived: (String) -> Unit = {},
    onProgressChanged: (Int) -> Unit = {}
) {
    if (currentUrl.isEmpty()) {
        // URLì´ ì—†ì„ ë•Œ í”Œë ˆì´ìŠ¤í™€ë” í‘œì‹œ
        Box(
            modifier = modifier
                .fillMaxSize()
                .padding(16.dp),
            contentAlignment = Alignment.Center
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.Center
            ) {
                Text(
                    text = "ğŸŒ",
                    style = MaterialTheme.typography.displayMedium
                )
                Spacer(modifier = Modifier.height(16.dp))
                Text(
                    text = "ì›¹ í˜ì´ì§€ë¥¼ ë¡œë“œí•˜ë©´ ì—¬ê¸°ì— ë¸Œë¼ìš°ì €ê°€ í‘œì‹œë©ë‹ˆë‹¤",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }
    } else {
        AndroidView(
            factory = { context ->
                WebView(context).apply {
                    // WebView ê¸°ë³¸ ì„¤ì •
                    settings.apply {
                        javaScriptEnabled = true
                        domStorageEnabled = true
                        loadWithOverviewMode = true
                        useWideViewPort = true
                        setSupportZoom(true)
                        builtInZoomControls = true
                        displayZoomControls = false
                        allowFileAccess = false
                        allowContentAccess = false
                        
                        // ì‚¬ìš©ì ì—ì´ì „íŠ¸ ì„¤ì •
                        userAgentString = "Mozilla/5.0 (Linux; Android 10; SM-G975F) " +
                                "AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Mobile Safari/537.36"
                    }
                    
                    // WebViewClient ì„¤ì •
                    webViewClient = object : WebViewClient() {
                        override fun shouldOverrideUrlLoading(view: WebView?, url: String?): Boolean {
                            url?.let { newUrl ->
                                onUrlChanged(newUrl)
                            }
                            return false
                        }

                        override fun onPageStarted(view: WebView?, url: String?, favicon: android.graphics.Bitmap?) {
                            super.onPageStarted(view, url, favicon)
                            url?.let { newUrl ->
                                onPageStarted(newUrl)
                                onUrlChanged(newUrl)
                            }
                        }

                        override fun onPageFinished(view: WebView?, url: String?) {
                            super.onPageFinished(view, url)
                            url?.let { newUrl ->
                                onPageFinished(newUrl)
                                onUrlChanged(newUrl)
                            }
                        }
                        
                        override fun onReceivedError(
                            view: WebView?, 
                            errorCode: Int, 
                            description: String?, 
                            failingUrl: String?
                        ) {
                            super.onReceivedError(view, errorCode, description, failingUrl)
                            // ì—ëŸ¬ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
                        }
                    }
                    
                    // WebChromeClient ì„¤ì •
                    webChromeClient = object : WebChromeClient() {
                        override fun onReceivedTitle(view: WebView?, title: String?) {
                            super.onReceivedTitle(view, title)
                            title?.let { onTitleReceived(it) }
                        }
                        
                        override fun onProgressChanged(view: WebView?, newProgress: Int) {
                            super.onProgressChanged(view, newProgress)
                            onProgressChanged(newProgress)
                        }
                        
                        override fun onReceivedIcon(view: WebView?, icon: android.graphics.Bitmap?) {
                            super.onReceivedIcon(view, icon)
                            // íŒŒë¹„ì½˜ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
                        }
                    }
                    
                    // WebView ìƒì„± ì½œë°± í˜¸ì¶œ
                    onWebViewCreated(this)
                    
                    // ìƒíƒœ ë³µì› ë˜ëŠ” URL ë¡œë“œ
                    webViewState?.let { bundle ->
                        restoreState(bundle)
                    } ?: run {
                        if (currentUrl.isNotEmpty()) {
                            loadUrl(currentUrl)
                        }
                    }
                }
            },
            update = { webView ->
                // URLì´ ë³€ê²½ë˜ì—ˆì„ ë•Œ ì—…ë°ì´íŠ¸
                if (currentUrl.isNotEmpty() && webView.url != currentUrl) {
                    webView.loadUrl(currentUrl)
                }
            },
            modifier = modifier.fillMaxSize()
        )
    }
}

/**
 * ì „ì²´í™”ë©´ WebView ì»¨í…Œì´ë„ˆ
 */
@Composable
fun FullscreenWebViewContainer(
    modifier: Modifier = Modifier,
    currentUrl: String,
    webViewState: Bundle? = null,
    syncWebView: WebView? = null,
    onWebViewCreated: (WebView) -> Unit = {},
    onUrlChanged: (String) -> Unit = {},
    onPageStarted: (String) -> Unit = {},
    onPageFinished: (String) -> Unit = {},
    onTitleReceived: (String) -> Unit = {},
    onProgressChanged: (Int) -> Unit = {}
) {
    if (currentUrl.isEmpty()) {
        Box(
            modifier = modifier.fillMaxSize(),
            contentAlignment = Alignment.Center
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Text(
                    text = "ğŸŒ",
                    style = MaterialTheme.typography.displayLarge
                )
                Spacer(modifier = Modifier.height(24.dp))
                Text(
                    text = "ì›¹ í˜ì´ì§€ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤",
                    style = MaterialTheme.typography.headlineSmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }
    } else {
        AndroidView(
            factory = { context ->
                WebView(context).apply {
                    // ì „ì²´í™”ë©´ìš© WebView ì„¤ì •
                    settings.apply {
                        javaScriptEnabled = true
                        domStorageEnabled = true
                        loadWithOverviewMode = true
                        useWideViewPort = true
                        setSupportZoom(true)
                        builtInZoomControls = true
                        displayZoomControls = false
                        allowFileAccess = false
                        allowContentAccess = false
                        
                        // ì „ì²´í™”ë©´ì— ìµœì í™”ëœ ì„¤ì •
                        supportMultipleWindows = false
                        mediaPlaybackRequiresUserGesture = false
                        
                        userAgentString = "Mozilla/5.0 (Linux; Android 10; SM-G975F) " +
                                "AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Mobile Safari/537.36"
                    }
                    
                    webViewClient = object : WebViewClient() {
                        override fun shouldOverrideUrlLoading(view: WebView?, url: String?): Boolean {
                            url?.let { newUrl -> onUrlChanged(newUrl) }
                            return false
                        }

                        override fun onPageStarted(view: WebView?, url: String?, favicon: android.graphics.Bitmap?) {
                            super.onPageStarted(view, url, favicon)
                            url?.let { newUrl ->
                                onPageStarted(newUrl)
                                onUrlChanged(newUrl)
                            }
                        }

                        override fun onPageFinished(view: WebView?, url: String?) {
                            super.onPageFinished(view, url)
                            url?.let { newUrl ->
                                onPageFinished(newUrl)
                                onUrlChanged(newUrl)
                            }
                        }
                    }
                    
                    webChromeClient = object : WebChromeClient() {
                        override fun onReceivedTitle(view: WebView?, title: String?) {
                            super.onReceivedTitle(view, title)
                            title?.let { onTitleReceived(it) }
                        }
                        
                        override fun onProgressChanged(view: WebView?, newProgress: Int) {
                            super.onProgressChanged(view, newProgress)
                            onProgressChanged(newProgress)
                        }
                    }
                    
                    onWebViewCreated(this)
                    
                    // ìƒíƒœ ë³µì› ë˜ëŠ” ë™ê¸°í™”
                    webViewState?.let { bundle ->
                        restoreState(bundle)
                    } ?: run {
                        val syncUrl = syncWebView?.url ?: currentUrl
                        if (syncUrl.isNotEmpty()) {
                            loadUrl(syncUrl)
                        }
                    }
                }
            },
            update = { webView ->
                if (currentUrl.isNotEmpty() && webView.url != currentUrl) {
                    webView.loadUrl(currentUrl)
                }
            },
            modifier = modifier.fillMaxSize()
        )
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/usecase/DetectVideosUseCase.kt">
package com.swvd.simplewebvideodownloader.usecase

import android.os.Handler
import android.os.Looper
import android.util.Log
import android.webkit.WebView
import com.swvd.simplewebvideodownloader.webview.VideoAnalyzer
import kotlinx.coroutines.suspendCancellableCoroutine
import kotlin.coroutines.resume

/**
 * ë¹„ë””ì˜¤ ê°ì§€ ìœ ìŠ¤ì¼€ì´ìŠ¤
 * ì›¹í˜ì´ì§€ì—ì„œ ë¹„ë””ì˜¤ë¥¼ ê°ì§€í•˜ê³  ë¶„ì„í•˜ëŠ” ê³¼ì •ì„ ê´€ë¦¬
 */
class DetectVideosUseCase {
    
    companion object {
        private const val TAG = "DetectVideosUseCase"
        private const val DEFAULT_DELAY = 1000L // ê¸°ë³¸ ì§€ì—° ì‹œê°„
        private const val RETRY_DELAY = 2000L // ì¬ì‹œë„ ì§€ì—° ì‹œê°„
        private const val MAX_RETRIES = 3 // ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜
    }
    
    private val videoAnalyzer = VideoAnalyzer()
    
    /**
     * ë¹„ë””ì˜¤ ê°ì§€ ì‹¤í–‰
     * @param webView ëŒ€ìƒ WebView
     * @param delayMs ê°ì§€ ì‹œì‘ ì „ ì§€ì—° ì‹œê°„
     * @param enableRetry ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ì—¬ë¶€
     * @return ê°ì§€ëœ ë¹„ë””ì˜¤ ëª©ë¡
     */
    suspend fun execute(
        webView: WebView?,
        delayMs: Long = DEFAULT_DELAY,
        enableRetry: Boolean = true
    ): Result<List<VideoAnalyzer.VideoInfo>> {
        return try {
            // 1. WebView ìœ íš¨ì„± í™•ì¸
            if (webView == null) {
                return Result.failure(Exception("WebViewê°€ nullì…ë‹ˆë‹¤"))
            }
            
            // 2. í˜ì´ì§€ ë¡œë”© ëŒ€ê¸°
            if (delayMs > 0) {
                kotlinx.coroutines.delay(delayMs)
            }
            
            // 3. ë¹„ë””ì˜¤ ê°ì§€ ì‹¤í–‰
            val videos = detectVideosWithRetry(webView, enableRetry)
            
            // 4. ê²°ê³¼ ê²€ì¦ ë° í•„í„°ë§
            val validVideos = filterValidVideos(videos)
            
            Log.d(TAG, "ë¹„ë””ì˜¤ ê°ì§€ ì™„ë£Œ: ${validVideos.size}ê°œ ë°œê²¬")
            Result.success(validVideos)
            
        } catch (e: Exception) {
            Log.e(TAG, "ë¹„ë””ì˜¤ ê°ì§€ ì‹¤íŒ¨: ${e.message}", e)
            Result.failure(e)
        }
    }
    
    /**
     * ì¬ì‹œë„ ê¸°ëŠ¥ì´ ìˆëŠ” ë¹„ë””ì˜¤ ê°ì§€
     */
    private suspend fun detectVideosWithRetry(
        webView: WebView,
        enableRetry: Boolean,
        currentRetry: Int = 0
    ): List<VideoAnalyzer.VideoInfo> {
        return try {
            val videos = performVideoDetection(webView)
            
            // ë¹„ë””ì˜¤ê°€ ë°œê²¬ë˜ì§€ ì•Šê³  ì¬ì‹œë„ê°€ í™œì„±í™”ëœ ê²½ìš°
            if (videos.isEmpty() && enableRetry && currentRetry < MAX_RETRIES) {
                Log.d(TAG, "ë¹„ë””ì˜¤ ë¯¸ë°œê²¬, ì¬ì‹œë„ ${currentRetry + 1}/${MAX_RETRIES}")
                kotlinx.coroutines.delay(RETRY_DELAY)
                return detectVideosWithRetry(webView, enableRetry, currentRetry + 1)
            }
            
            videos
            
        } catch (e: Exception) {
            if (enableRetry && currentRetry < MAX_RETRIES) {
                Log.w(TAG, "ê°ì§€ ì‹¤íŒ¨, ì¬ì‹œë„ ${currentRetry + 1}/${MAX_RETRIES}: ${e.message}")
                kotlinx.coroutines.delay(RETRY_DELAY)
                return detectVideosWithRetry(webView, enableRetry, currentRetry + 1)
            } else {
                throw e
            }
        }
    }
    
    /**
     * ì‹¤ì œ ë¹„ë””ì˜¤ ê°ì§€ ìˆ˜í–‰
     */
    private suspend fun performVideoDetection(webView: WebView): List<VideoAnalyzer.VideoInfo> {
        return suspendCancellableCoroutine { continuation ->
            try {
                videoAnalyzer.analyzeVideos(webView) { videos ->
                    continuation.resume(videos)
                }
            } catch (e: Exception) {
                continuation.cancel(e)
            }
        }
    }
    
    /**
     * ìœ íš¨í•œ ë¹„ë””ì˜¤ë§Œ í•„í„°ë§
     */
    private fun filterValidVideos(videos: List<VideoAnalyzer.VideoInfo>): List<VideoAnalyzer.VideoInfo> {
        return videos.filter { video ->
            isValidVideo(video)
        }.distinctBy { it.url } // ì¤‘ë³µ URL ì œê±°
    }
    
    /**
     * ë¹„ë””ì˜¤ ìœ íš¨ì„± ê²€ì‚¬
     */
    private fun isValidVideo(video: VideoAnalyzer.VideoInfo): Boolean {
        return when {
            video.url.isBlank() -> false
            video.url.contains("javascript:", ignoreCase = true) -> false
            video.url.contains("data:", ignoreCase = true) -> false
            video.url.length < 10 -> false
            !video.url.startsWith("http") -> false
            video.url.contains("error", ignoreCase = true) -> false
            else -> true
        }
    }
    
    /**
     * íŠ¹ì • íƒ€ì…ì˜ ë¹„ë””ì˜¤ë§Œ ê°ì§€
     */
    suspend fun detectSpecificType(
        webView: WebView?,
        targetType: VideoAnalyzer.VideoType,
        delayMs: Long = DEFAULT_DELAY
    ): Result<List<VideoAnalyzer.VideoInfo>> {
        return try {
            val allVideos = execute(webView, delayMs, enableRetry = true)
            if (allVideos.isSuccess) {
                val filteredVideos = allVideos.getOrNull()?.filter { it.type == targetType } ?: emptyList()
                Result.success(filteredVideos)
            } else {
                allVideos
            }
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ ë¹„ë””ì˜¤ë§Œ ê°ì§€
     */
    suspend fun detectDownloadableVideos(
        webView: WebView?,
        delayMs: Long = DEFAULT_DELAY
    ): Result<List<VideoAnalyzer.VideoInfo>> {
        return try {
            val allVideos = execute(webView, delayMs, enableRetry = true)
            if (allVideos.isSuccess) {
                val downloadableVideos = allVideos.getOrNull()?.filter { video ->
                    isDownloadableType(video.type)
                } ?: emptyList()
                Result.success(downloadableVideos)
            } else {
                allVideos
            }
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ íƒ€ì…ì¸ì§€ í™•ì¸
     */
    private fun isDownloadableType(type: VideoAnalyzer.VideoType): Boolean {
        return when (type) {
            VideoAnalyzer.VideoType.MP4,
            VideoAnalyzer.VideoType.WEBM,
            VideoAnalyzer.VideoType.MKV,
            VideoAnalyzer.VideoType.AVI,
            VideoAnalyzer.VideoType.MOV,
            VideoAnalyzer.VideoType.FLV,
            VideoAnalyzer.VideoType.HLS -> true
            else -> false
        }
    }
    
    /**
     * í˜ì´ì§€ ë³€ê²½ í›„ ìë™ ê°ì§€
     */
    suspend fun autoDetectOnPageChange(
        webView: WebView?,
        oldUrl: String,
        newUrl: String
    ): Result<List<VideoAnalyzer.VideoInfo>> {
        return try {
            // URLì´ ì‹¤ì œë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (oldUrl == newUrl) {
                return Result.success(emptyList())
            }
            
            // ìƒˆ í˜ì´ì§€ ë¡œë”© ëŒ€ê¸°
            kotlinx.coroutines.delay(1500)
            
            // ë¹„ë””ì˜¤ ê°ì§€ ì‹¤í–‰
            execute(webView, delayMs = 0, enableRetry = true)
            
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
    
    /**
     * ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì£¼ê¸°ì  ê°ì§€
     */
    fun startPeriodicDetection(
        webView: WebView?,
        intervalMs: Long = 30000L, // 30ì´ˆë§ˆë‹¤
        onVideosDetected: (List<VideoAnalyzer.VideoInfo>) -> Unit
    ) {
        val handler = Handler(Looper.getMainLooper())
        val runnable = object : Runnable {
            override fun run() {
                webView?.let { view ->
                    videoAnalyzer.analyzeVideos(view) { videos ->
                        val validVideos = filterValidVideos(videos)
                        if (validVideos.isNotEmpty()) {
                            onVideosDetected(validVideos)
                        }
                    }
                }
                handler.postDelayed(this, intervalMs)
            }
        }
        handler.post(runnable)
    }
    
    /**
     * ê°ì§€ ê²°ê³¼ ë¶„ì„
     */
    fun analyzeDetectionResult(videos: List<VideoAnalyzer.VideoInfo>): DetectionAnalysis {
        val totalCount = videos.size
        val typeCount = videos.groupBy { it.type }.mapValues { it.value.size }
        val downloadableCount = videos.count { isDownloadableType(it.type) }
        val hasTitle = videos.count { !it.title.isNullOrBlank() }
        
        return DetectionAnalysis(
            totalVideos = totalCount,
            videosByType = typeCount,
            downloadableVideos = downloadableCount,
            videosWithTitle = hasTitle,
            detectionQuality = calculateDetectionQuality(videos)
        )
    }
    
    /**
     * ê°ì§€ í’ˆì§ˆ ê³„ì‚°
     */
    private fun calculateDetectionQuality(videos: List<VideoAnalyzer.VideoInfo>): DetectionQuality {
        if (videos.isEmpty()) return DetectionQuality.POOR
        
        val downloadableRatio = videos.count { isDownloadableType(it.type) }.toFloat() / videos.size
        val titleRatio = videos.count { !it.title.isNullOrBlank() }.toFloat() / videos.size
        
        return when {
            downloadableRatio >= 0.8 && titleRatio >= 0.5 -> DetectionQuality.EXCELLENT
            downloadableRatio >= 0.6 && titleRatio >= 0.3 -> DetectionQuality.GOOD
            downloadableRatio >= 0.3 -> DetectionQuality.FAIR
            else -> DetectionQuality.POOR
        }
    }
}

/**
 * ê°ì§€ ë¶„ì„ ê²°ê³¼
 */
data class DetectionAnalysis(
    val totalVideos: Int,
    val videosByType: Map<VideoAnalyzer.VideoType, Int>,
    val downloadableVideos: Int,
    val videosWithTitle: Int,
    val detectionQuality: DetectionQuality
)

/**
 * ê°ì§€ í’ˆì§ˆ
 */
enum class DetectionQuality {
    EXCELLENT, GOOD, FAIR, POOR
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/usecase/LoadUrlUseCase.kt">
package com.swvd.simplewebvideodownloader.usecase

import android.util.Log
import android.webkit.WebView

/**
 * URL ë¡œë“œ ìœ ìŠ¤ì¼€ì´ìŠ¤
 * URL ìœ íš¨ì„± ê²€ì‚¬, ì •ê·œí™”, ë¡œë“œ ê³¼ì •ì„ ë‹´ë‹¹
 */
class LoadUrlUseCase {
    
    companion object {
        private const val TAG = "LoadUrlUseCase"
    }
    
    /**
     * URL ë¡œë“œ ì‹¤í–‰
     * @param webView ëŒ€ìƒ WebView
     * @param inputUrl ì…ë ¥ëœ URL
     * @param onUrlUpdated URL ì—…ë°ì´íŠ¸ ì½œë°±
     * @param onHistoryAdded íˆìŠ¤í† ë¦¬ ì¶”ê°€ ì½œë°±
     * @return ë¡œë“œ ì„±ê³µ ì—¬ë¶€
     */
    fun execute(
        webView: WebView?,
        inputUrl: String,
        onUrlUpdated: (String) -> Unit = {},
        onHistoryAdded: (String) -> Unit = {}
    ): Result<String> {
        return try {
            // 1. WebView ìœ íš¨ì„± í™•ì¸
            if (webView == null) {
                return Result.failure(Exception("WebViewê°€ nullì…ë‹ˆë‹¤"))
            }
            
            // 2. URL ìœ íš¨ì„± ê²€ì‚¬
            val validationResult = validateUrl(inputUrl)
            if (validationResult.isFailure) {
                return validationResult
            }
            
            // 3. URL ì •ê·œí™”
            val normalizedUrl = normalizeUrl(inputUrl)
            
            // 4. URL ë¡œë“œ
            webView.loadUrl(normalizedUrl)
            
            // 5. ì½œë°± ì‹¤í–‰
            onUrlUpdated(normalizedUrl)
            onHistoryAdded(normalizedUrl)
            
            Log.d(TAG, "URL ë¡œë“œ ì™„ë£Œ: $normalizedUrl")
            Result.success(normalizedUrl)
            
        } catch (e: Exception) {
            Log.e(TAG, "URL ë¡œë“œ ì‹¤íŒ¨: ${e.message}", e)
            Result.failure(e)
        }
    }
    
    /**
     * URL ìœ íš¨ì„± ê²€ì‚¬
     */
    private fun validateUrl(url: String): Result<String> {
        return when {
            url.isBlank() -> {
                Result.failure(Exception("URLì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"))
            }
            url.contains("javascript:") -> {
                Result.failure(Exception("JavaScript URLì€ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"))
            }
            url.contains(" ") && !url.startsWith("http") -> {
                Result.failure(Exception("ê³µë°±ì´ í¬í•¨ëœ ì˜ëª»ëœ URLì…ë‹ˆë‹¤"))
            }
            else -> Result.success(url)
        }
    }
    
    /**
     * URL ì •ê·œí™”
     * HTTP/HTTPS í”„ë¡œí† ì½œ ì¶”ê°€, ê³µë°± ì œê±° ë“±
     */
    private fun normalizeUrl(url: String): String {
        val trimmedUrl = url.trim()
        
        return when {
            trimmedUrl.startsWith("http://") || trimmedUrl.startsWith("https://") -> {
                trimmedUrl
            }
            trimmedUrl.startsWith("www.") -> {
                "https://$trimmedUrl"
            }
            trimmedUrl.contains(".") && !trimmedUrl.contains(" ") -> {
                "https://$trimmedUrl"
            }
            else -> {
                // ê²€ìƒ‰ì–´ë¡œ ì²˜ë¦¬
                "https://www.google.com/search?q=${trimmedUrl.replace(" ", "+")}"
            }
        }
    }
    
    /**
     * URL í”„ë¦¬ë¡œë“œ (ë¯¸ë¦¬ DNS ì¡°íšŒ ë“±)
     */
    fun preloadUrl(url: String): Boolean {
        return try {
            val normalizedUrl = normalizeUrl(url)
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” DNS í”„ë¦¬ë¡œë“œ ë“±ì„ ìˆ˜í–‰
            Log.d(TAG, "URL í”„ë¦¬ë¡œë“œ: $normalizedUrl")
            true
        } catch (e: Exception) {
            Log.e(TAG, "URL í”„ë¦¬ë¡œë“œ ì‹¤íŒ¨: ${e.message}")
            false
        }
    }
    
    /**
     * URLì—ì„œ ë„ë©”ì¸ ì¶”ì¶œ
     */
    fun extractDomain(url: String): String? {
        return try {
            val normalizedUrl = normalizeUrl(url)
            val urlPattern = Regex("https?://([^/]+)")
            urlPattern.find(normalizedUrl)?.groupValues?.get(1)
        } catch (e: Exception) {
            null
        }
    }
    
    /**
     * URL ë‹¨ì¶• ì—¬ë¶€ í™•ì¸
     */
    fun isShortUrl(url: String): Boolean {
        val shortUrlDomains = listOf(
            "bit.ly", "tinyurl.com", "t.co", "goo.gl", 
            "ow.ly", "short.link", "cutt.ly"
        )
        
        val domain = extractDomain(url)
        return domain?.let { d ->
            shortUrlDomains.any { d.contains(it, ignoreCase = true) }
        } ?: false
    }
    
    /**
     * ì•ˆì „í•œ URLì¸ì§€ í™•ì¸ (ê¸°ë³¸ì ì¸ ê²€ì‚¬)
     */
    fun isSafeUrl(url: String): Boolean {
        val unsafePatterns = listOf(
            "javascript:",
            "data:",
            "file:",
            "chrome:",
            "about:"
        )
        
        return unsafePatterns.none { pattern ->
            url.startsWith(pattern, ignoreCase = true)
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/viewmodel/DownloadViewModel.kt">
package com.swvd.simplewebvideodownloader.viewmodel

import android.content.Context
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.swvd.simplewebvideodownloader.download.VideoDownloadManager
import com.swvd.simplewebvideodownloader.models.VideoDownloadProgress
import com.swvd.simplewebvideodownloader.models.VideoDownloadStatus
import com.swvd.simplewebvideodownloader.webview.VideoAnalyzer
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch

/**
 * ë‹¤ìš´ë¡œë“œ ê´€ë¦¬ ë·°ëª¨ë¸
 * ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ì‘ì—… ë° ìƒíƒœë¥¼ ê´€ë¦¬
 */
class DownloadViewModel(context: Context) : ViewModel() {
    
    companion object {
        private const val TAG = "DownloadViewModel"
    }
    
    // ë‹¤ìš´ë¡œë“œ ê´€ë¦¬ì
    private val downloadManager = VideoDownloadManager(context)
    
    // ë‹¤ìš´ë¡œë“œ ì§„í–‰ ìƒí™©
    private val _downloadProgress = MutableStateFlow<Map<String, VideoDownloadProgress>>(emptyMap())
    val downloadProgress: StateFlow<Map<String, VideoDownloadProgress>> = _downloadProgress.asStateFlow()
    
    // ë‹¤ìš´ë¡œë“œ ì¤‘ì¸ URL ëª©ë¡
    private val _downloadingUrls = MutableStateFlow<Set<String>>(emptySet())
    val downloadingUrls: StateFlow<Set<String>> = _downloadingUrls.asStateFlow()
    
    // ë‹¤ìš´ë¡œë“œ ê²°ê³¼ ë©”ì‹œì§€
    private val _downloadResult = MutableStateFlow<String?>(null)
    val downloadResult: StateFlow<String?> = _downloadResult.asStateFlow()
    
    // ë‹¤ìš´ë¡œë“œ ê²°ê³¼ í‘œì‹œ ìƒíƒœ
    private val _showDownloadResult = MutableStateFlow(false)
    val showDownloadResult: StateFlow<Boolean> = _showDownloadResult.asStateFlow()
    
    // ë‹¤ìš´ë¡œë“œ í†µê³„
    private val _downloadStats = MutableStateFlow(DownloadStats())
    val downloadStats: StateFlow<DownloadStats> = _downloadStats.asStateFlow()
    
    init {
        // ë‹¤ìš´ë¡œë“œ ë§¤ë‹ˆì €ì˜ ì§„í–‰ ìƒí™©ì„ êµ¬ë…
        viewModelScope.launch {
            downloadManager.downloadProgress.collect { progressMap ->
                _downloadProgress.value = progressMap
                updateDownloadingUrls(progressMap)
                updateDownloadStats(progressMap)
            }
        }
    }
    
    /**
     * ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ì‹œì‘
     */
    fun downloadVideo(video: VideoAnalyzer.VideoInfo) {
        viewModelScope.launch {
            try {
                // ì´ë¯¸ ë‹¤ìš´ë¡œë“œ ì¤‘ì¸ì§€ í™•ì¸
                if (_downloadingUrls.value.contains(video.url)) {
                    showDownloadResult("ì´ë¯¸ ë‹¤ìš´ë¡œë“œ ì¤‘ì¸ ë¹„ë””ì˜¤ì…ë‹ˆë‹¤")
                    return@launch
                }
                
                // ë‹¤ìš´ë¡œë“œ ì‹œì‘
                downloadManager.startDownload(video) { success, message ->
                    handleDownloadResult(success, message, video.url)
                }
                
            } catch (e: Exception) {
                showDownloadResult("ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${e.message}")
            }
        }
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ê²°ê³¼ ì²˜ë¦¬
     */
    private fun handleDownloadResult(success: Boolean, message: String?, url: String) {
        val resultMessage = if (success) {
            "ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!\n$message"
        } else {
            "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨!\n$message"
        }
        
        showDownloadResult(resultMessage)
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        viewModelScope.launch {
            val currentStats = _downloadStats.value
            if (success) {
                _downloadStats.value = currentStats.copy(
                    completedCount = currentStats.completedCount + 1
                )
            } else {
                _downloadStats.value = currentStats.copy(
                    failedCount = currentStats.failedCount + 1
                )
            }
        }
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ê²°ê³¼ ë©”ì‹œì§€ í‘œì‹œ
     */
    fun showDownloadResult(message: String) {
        _downloadResult.value = message
        _showDownloadResult.value = true
        
        // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
        viewModelScope.launch {
            kotlinx.coroutines.delay(3000)
            hideDownloadResult()
        }
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ê²°ê³¼ ë©”ì‹œì§€ ìˆ¨ê¹€
     */
    fun hideDownloadResult() {
        _downloadResult.value = null
        _showDownloadResult.value = false
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ì¤‘ì¸ URL ëª©ë¡ ì—…ë°ì´íŠ¸
     */
    private fun updateDownloadingUrls(progressMap: Map<String, VideoDownloadProgress>) {
        val downloadingUrls = progressMap.filter { (_, progress) ->
            progress.status == VideoDownloadStatus.DOWNLOADING ||
            progress.status == VideoDownloadStatus.PENDING
        }.keys.toSet()
        
        _downloadingUrls.value = downloadingUrls
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ í†µê³„ ì—…ë°ì´íŠ¸
     */
    private fun updateDownloadStats(progressMap: Map<String, VideoDownloadProgress>) {
        val stats = DownloadStats(
            totalCount = progressMap.size,
            downloadingCount = progressMap.count { it.value.status == VideoDownloadStatus.DOWNLOADING },
            pendingCount = progressMap.count { it.value.status == VideoDownloadStatus.PENDING },
            completedCount = progressMap.count { it.value.status == VideoDownloadStatus.COMPLETED },
            failedCount = progressMap.count { it.value.status == VideoDownloadStatus.FAILED },
            pausedCount = progressMap.count { it.value.status == VideoDownloadStatus.PAUSED }
        )
        
        _downloadStats.value = stats
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ì·¨ì†Œ
     */
    fun cancelDownload(url: String) {
        downloadManager.cancelDownload(url)
        showDownloadResult("ë‹¤ìš´ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤")
    }
    
    /**
     * ëª¨ë“  ë‹¤ìš´ë¡œë“œ ì·¨ì†Œ
     */
    fun cancelAllDownloads() {
        downloadManager.cancelAllDownloads()
        showDownloadResult("ëª¨ë“  ë‹¤ìš´ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤")
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ì¼ì‹œì •ì§€ (ë¯¸ë˜ êµ¬í˜„)
     */
    fun pauseDownload(url: String) {
        // ì¶”í›„ êµ¬í˜„ ì˜ˆì •
        showDownloadResult("ì¼ì‹œì •ì§€ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤")
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ì¬ê°œ (ë¯¸ë˜ êµ¬í˜„)
     */
    fun resumeDownload(url: String) {
        // ì¶”í›„ êµ¬í˜„ ì˜ˆì •
        showDownloadResult("ì¬ê°œ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤")
    }
    
    /**
     * íŠ¹ì • ë‹¤ìš´ë¡œë“œ ì§„í–‰ ìƒí™© ì¡°íšŒ
     */
    fun getDownloadProgress(url: String): VideoDownloadProgress? {
        return _downloadProgress.value[url]
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ì¤‘ì¸ì§€ í™•ì¸
     */
    fun isDownloading(url: String): Boolean {
        return _downloadingUrls.value.contains(url)
    }
    
    /**
     * í™œì„± ë‹¤ìš´ë¡œë“œ ê°œìˆ˜ ì¡°íšŒ
     */
    fun getActiveDownloadCount(): Int {
        return downloadManager.getActiveDownloadCount()
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
     */
    fun canDownload(video: VideoAnalyzer.VideoInfo): Boolean {
        return !isDownloading(video.url) && isValidVideoType(video.type)
    }
    
    /**
     * ìœ íš¨í•œ ë¹„ë””ì˜¤ íƒ€ì…ì¸ì§€ í™•ì¸
     */
    private fun isValidVideoType(type: VideoAnalyzer.VideoType): Boolean {
        return when (type) {
            VideoAnalyzer.VideoType.MP4,
            VideoAnalyzer.VideoType.WEBM,
            VideoAnalyzer.VideoType.MKV,
            VideoAnalyzer.VideoType.AVI,
            VideoAnalyzer.VideoType.MOV,
            VideoAnalyzer.VideoType.FLV,
            VideoAnalyzer.VideoType.HLS -> true
            else -> false
        }
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
     */
    fun clearDownloadHistory() {
        _downloadProgress.value = emptyMap()
        _downloadingUrls.value = emptySet()
        _downloadStats.value = DownloadStats()
        showDownloadResult("ë‹¤ìš´ë¡œë“œ íˆìŠ¤í† ë¦¬ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤")
    }
    
    /**
     * ì™„ë£Œëœ ë‹¤ìš´ë¡œë“œ ì œê±°
     */
    fun clearCompletedDownloads() {
        val currentProgress = _downloadProgress.value.toMutableMap()
        val completedUrls = currentProgress.filter { 
            it.value.status == VideoDownloadStatus.COMPLETED 
        }.keys
        
        completedUrls.forEach { url ->
            currentProgress.remove(url)
        }
        
        _downloadProgress.value = currentProgress
        showDownloadResult("ì™„ë£Œëœ ë‹¤ìš´ë¡œë“œ ${completedUrls.size}ê°œê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤")
    }
    
    /**
     * ì‹¤íŒ¨í•œ ë‹¤ìš´ë¡œë“œ ì¬ì‹œë„
     */
    fun retryFailedDownloads() {
        val failedDownloads = _downloadProgress.value.filter { 
            it.value.status == VideoDownloadStatus.FAILED 
        }
        
        if (failedDownloads.isEmpty()) {
            showDownloadResult("ì¬ì‹œë„í•  ì‹¤íŒ¨í•œ ë‹¤ìš´ë¡œë“œê°€ ì—†ìŠµë‹ˆë‹¤")
            return
        }
        
        failedDownloads.forEach { (_, progress) ->
            downloadVideo(progress.videoInfo)
        }
        
        showDownloadResult("${failedDownloads.size}ê°œì˜ ì‹¤íŒ¨í•œ ë‹¤ìš´ë¡œë“œë¥¼ ì¬ì‹œë„í•©ë‹ˆë‹¤")
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ìš°ì„ ìˆœìœ„ ì„¤ì • (ë¯¸ë˜ êµ¬í˜„)
     */
    fun setDownloadPriority(url: String, priority: Int) {
        // ì¶”í›„ êµ¬í˜„ ì˜ˆì •
    }
    
    /**
     * ë™ì‹œ ë‹¤ìš´ë¡œë“œ ê°œìˆ˜ ì œí•œ ì„¤ì • (ë¯¸ë˜ êµ¬í˜„)
     */
    fun setMaxConcurrentDownloads(count: Int) {
        // ì¶”í›„ êµ¬í˜„ ì˜ˆì •
    }
}

/**
 * ë‹¤ìš´ë¡œë“œ í†µê³„ ë°ì´í„° í´ë˜ìŠ¤
 */
data class DownloadStats(
    val totalCount: Int = 0,
    val downloadingCount: Int = 0,
    val pendingCount: Int = 0,
    val completedCount: Int = 0,
    val failedCount: Int = 0,
    val pausedCount: Int = 0
) {
    val activeCount: Int
        get() = downloadingCount + pendingCount
    
    val completionRate: Float
        get() = if (totalCount > 0) (completedCount.toFloat() / totalCount) * 100 else 0f
    
    val failureRate: Float
        get() = if (totalCount > 0) (failedCount.toFloat() / totalCount) * 100 else 0f
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/viewmodel/MainViewModel.kt">
package com.swvd.simplewebvideodownloader.viewmodel

import android.content.Context
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.swvd.simplewebvideodownloader.download.DownloadHandler
import com.swvd.simplewebvideodownloader.download.HlsDownloader
import com.swvd.simplewebvideodownloader.download.VideoDownloadManager
import com.swvd.simplewebvideodownloader.webview.VideoAnalyzer
import com.swvd.simplewebvideodownloader.models.VideoInfo
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch

/**
 * ë©”ì¸ ë·°ëª¨ë¸
 * ì „ì²´ ì•±ì˜ ìƒíƒœì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ê´€ë¦¬
 */
class MainViewModel(context: Context) : ViewModel() {
    
    // ë‹¤ìš´ë¡œë“œ ê´€ë¦¬ìë“¤
    private val downloadHandler = DownloadHandler(context)
    private val hlsDownloader = HlsDownloader(context)
    private val videoDownloadManager = VideoDownloadManager(context)
    
    // ë¹„ë””ì˜¤ ë¶„ì„ê¸°
    private val videoAnalyzer = VideoAnalyzer()
    
    // UI ìƒíƒœ ê´€ë¦¬
    private val _uiState = MutableStateFlow(MainUiState())
    val uiState: StateFlow<MainUiState> = _uiState.asStateFlow()
    
    // ë‹¤ìš´ë¡œë“œ ê²°ê³¼ ë©”ì‹œì§€
    private val _downloadResult = MutableStateFlow<String?>(null)
    val downloadResult: StateFlow<String?> = _downloadResult.asStateFlow()
    
    // ê¶Œí•œ ìš”ì²­ ì½œë°±
    var onRequestPermissions: (() -> Unit)? = null
    
    /**
     * ë¹„ë””ì˜¤ ë¶„ì„ ì‹œì‘
     */
    fun startVideoAnalysis(webView: android.webkit.WebView?) {
        if (_uiState.value.isAnalyzing) return
        
        _uiState.value = _uiState.value.copy(
            isAnalyzing = true,
            hasAnalyzed = true
        )
        
        videoAnalyzer.analyzeVideos(webView) { videos ->
            _uiState.value = _uiState.value.copy(
                isAnalyzing = false,
                videoList = videos,
                mp4Links = videos.filter { it.type == VideoAnalyzer.VideoType.MP4 }
                    .map { it.url }
            )
        }
    }
    
    /**
     * ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ì‹œì‘
     */
    fun downloadVideo(videoInfo: VideoAnalyzer.VideoInfo) {
        viewModelScope.launch {
            try {
                // ë‹¤ìš´ë¡œë“œ ì¤‘ ìƒíƒœ ì¶”ê°€
                val currentDownloading = _uiState.value.downloadingUrls.toMutableSet()
                currentDownloading.add(videoInfo.url)
                _uiState.value = _uiState.value.copy(downloadingUrls = currentDownloading)
                
                // ë¹„ë””ì˜¤ íƒ€ì…ì— ë”°ë¥¸ ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
                when (videoInfo.type) {
                    VideoAnalyzer.VideoType.HLS -> {
                        downloadHlsVideo(videoInfo)
                    }
                    VideoAnalyzer.VideoType.MP4,
                    VideoAnalyzer.VideoType.WEBM,
                    VideoAnalyzer.VideoType.MKV -> {
                        downloadDirectVideo(videoInfo)
                    }
                    else -> {
                        showDownloadResult("ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¹„ë””ì˜¤ í˜•ì‹ì…ë‹ˆë‹¤")
                        removeFromDownloading(videoInfo.url)
                    }
                }
            } catch (e: Exception) {
                showDownloadResult("ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${e.message}")
                removeFromDownloading(videoInfo.url)
            }
        }
    }
    
    /**
     * ì§ì ‘ ë‹¤ìš´ë¡œë“œ
     */
    private fun downloadDirectVideo(videoInfo: VideoAnalyzer.VideoInfo) {
        try {
            // ê¶Œí•œ í™•ì¸
            val permissions = downloadHandler.checkStoragePermissions()
            if (permissions.isNotEmpty()) {
                showDownloadResult("ì €ì¥ì†Œ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤")
                onRequestPermissions?.invoke()
                removeFromDownloading(videoInfo.url)
                return
            }
            
            // URL ìœ íš¨ì„± ê²€ì‚¬
            if (!downloadHandler.isValidUrl(videoInfo.url)) {
                showDownloadResult("ìœ íš¨í•˜ì§€ ì•Šì€ URLì…ë‹ˆë‹¤")
                removeFromDownloading(videoInfo.url)
                return
            }
            
            // íŒŒì¼ëª… ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
            val filename = generateFilename(videoInfo)
            downloadHandler.downloadFile(videoInfo.url, filename)
            
            showDownloadResult("ë‹¤ìš´ë¡œë“œ ì‹œì‘!\níŒŒì¼: $filename")
            
        } catch (e: Exception) {
            showDownloadResult("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${e.message}")
        } finally {
            removeFromDownloading(videoInfo.url)
        }
    }
    
    /**
     * HLS ë‹¤ìš´ë¡œë“œ
     */
    private suspend fun downloadHlsVideo(videoInfo: VideoAnalyzer.VideoInfo) {
        val filename = generateFilename(videoInfo)
        
        hlsDownloader.downloadHls(videoInfo.url, filename) { success, message ->
            if (success) {
                showDownloadResult("HLS ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!\n$message")
            } else {
                showDownloadResult("HLS ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨!\n$message")
            }
            removeFromDownloading(videoInfo.url)
        }
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ê²°ê³¼ í‘œì‹œ
     */
    private fun showDownloadResult(message: String) {
        _downloadResult.value = message
        
        // 3ì´ˆ í›„ ë©”ì‹œì§€ ìë™ ìˆ¨ê¹€
        viewModelScope.launch {
            kotlinx.coroutines.delay(3000)
            _downloadResult.value = null
        }
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ì¤‘ ëª©ë¡ì—ì„œ ì œê±°
     */
    private fun removeFromDownloading(url: String) {
        val currentDownloading = _uiState.value.downloadingUrls.toMutableSet()
        currentDownloading.remove(url)
        _uiState.value = _uiState.value.copy(downloadingUrls = currentDownloading)
    }
    
    /**
     * íŒŒì¼ëª… ìƒì„±
     */
    private fun generateFilename(videoInfo: VideoAnalyzer.VideoInfo): String {
        val title = videoInfo.title?.take(30)?.replace(Regex("[^a-zA-Z0-9ê°€-í£._-]"), "_")
        val extension = when (videoInfo.type) {
            VideoAnalyzer.VideoType.MP4 -> ".mp4"
            VideoAnalyzer.VideoType.WEBM -> ".webm"
            VideoAnalyzer.VideoType.MKV -> ".mkv"
            VideoAnalyzer.VideoType.HLS -> ".mp4"
            else -> ".mp4"
        }
        
        return if (title.isNullOrBlank()) {
            "video_${System.currentTimeMillis()}$extension"
        } else {
            "${title}_${System.currentTimeMillis()}$extension"
        }
    }
    
    /**
     * ì´ˆê¸°í™”
     */
    fun resetState() {
        _uiState.value = MainUiState()
        _downloadResult.value = null
    }
    
    /**
     * ì„¹ì…˜ í™•ì¥/ì¶•ì†Œ í† ê¸€
     */
    fun toggleUrlSection() {
        _uiState.value = _uiState.value.copy(
            urlSectionExpanded = !_uiState.value.urlSectionExpanded
        )
    }
    
    fun toggleVideoSection() {
        _uiState.value = _uiState.value.copy(
            videoSectionExpanded = !_uiState.value.videoSectionExpanded
        )
    }
    
    /**
     * ê¶Œí•œ í™•ì¸
     */
    fun checkStoragePermissions(): List<String> {
        return downloadHandler.checkStoragePermissions()
    }
}

/**
 * ë©”ì¸ UI ìƒíƒœ
 */
data class MainUiState(
    val isAnalyzing: Boolean = false,
    val hasAnalyzed: Boolean = false,
    val videoList: List<VideoAnalyzer.VideoInfo> = emptyList(),
    val mp4Links: List<String> = emptyList(),
    val downloadingUrls: Set<String> = emptySet(),
    val urlSectionExpanded: Boolean = true,
    val videoSectionExpanded: Boolean = true
)
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/viewmodel/TabViewModel.kt">
package com.swvd.simplewebvideodownloader.viewmodel

import androidx.lifecycle.ViewModel
import com.swvd.simplewebvideodownloader.models.Tab
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow

/**
 * íƒ­ ê´€ë¦¬ ë·°ëª¨ë¸
 * ë‹¤ì¤‘ íƒ­ì˜ ìƒì„±, ì „í™˜, ë‹«ê¸° ê¸°ëŠ¥ì„ ë‹´ë‹¹
 */
class TabViewModel : ViewModel() {
    
    // íƒ­ ëª©ë¡ ìƒíƒœ
    private val _tabs = MutableStateFlow(listOf(Tab()))
    val tabs: StateFlow<List<Tab>> = _tabs.asStateFlow()
    
    // í˜„ì¬ ì„ íƒëœ íƒ­ ì¸ë±ìŠ¤
    private val _currentTabIndex = MutableStateFlow(0)
    val currentTabIndex: StateFlow<Int> = _currentTabIndex.asStateFlow()
    
    // íƒ­ ì˜¤ë²„ë·° í‘œì‹œ ìƒíƒœ
    private val _showTabOverview = MutableStateFlow(false)
    val showTabOverview: StateFlow<Boolean> = _showTabOverview.asStateFlow()
    
    // í˜„ì¬ ì„ íƒëœ íƒ­ ì •ë³´
    val currentTab: Tab?
        get() {
            val tabList = _tabs.value
            val index = _currentTabIndex.value
            return if (tabList.isNotEmpty() && index in tabList.indices) {
                tabList[index]
            } else null
        }
    
    /**
     * ìƒˆ íƒ­ ì¶”ê°€
     */
    fun addNewTab(url: String = "", title: String = "ìƒˆ íƒ­") {
        val newTab = Tab(url = url, title = title)
        val updatedTabs = _tabs.value + newTab
        _tabs.value = updatedTabs
        _currentTabIndex.value = updatedTabs.size - 1
    }
    
    /**
     * íƒ­ ë‹«ê¸°
     */
    fun closeTab(index: Int) {
        val currentTabs = _tabs.value.toMutableList()
        
        // ìµœì†Œ 1ê°œ íƒ­ ìœ ì§€
        if (currentTabs.size <= 1) {
            return
        }
        
        // ìœ íš¨í•œ ì¸ë±ìŠ¤ í™•ì¸
        if (index !in currentTabs.indices) {
            return
        }
        
        currentTabs.removeAt(index)
        _tabs.value = currentTabs
        
        // í˜„ì¬ íƒ­ ì¸ë±ìŠ¤ ì¡°ì •
        val currentIndex = _currentTabIndex.value
        when {
            index < currentIndex -> {
                _currentTabIndex.value = currentIndex - 1
            }
            index == currentIndex && currentIndex >= currentTabs.size -> {
                _currentTabIndex.value = currentTabs.size - 1
            }
        }
    }
    
    /**
     * íƒ­ ì „í™˜
     */
    fun switchTab(index: Int) {
        val currentTabs = _tabs.value
        if (index in currentTabs.indices) {
            _currentTabIndex.value = index
        }
    }
    
    /**
     * íƒ­ ì •ë³´ ì—…ë°ì´íŠ¸
     */
    fun updateTab(index: Int, updatedTab: Tab) {
        val currentTabs = _tabs.value.toMutableList()
        if (index in currentTabs.indices) {
            currentTabs[index] = updatedTab
            _tabs.value = currentTabs
        }
    }
    
    /**
     * í˜„ì¬ íƒ­ URL ì—…ë°ì´íŠ¸
     */
    fun updateCurrentTabUrl(url: String) {
        val currentIndex = _currentTabIndex.value
        val currentTabs = _tabs.value
        
        if (currentIndex in currentTabs.indices) {
            val updatedTab = currentTabs[currentIndex].copy(url = url)
            updateTab(currentIndex, updatedTab)
        }
    }
    
    /**
     * í˜„ì¬ íƒ­ ì œëª© ì—…ë°ì´íŠ¸
     */
    fun updateCurrentTabTitle(title: String) {
        val currentIndex = _currentTabIndex.value
        val currentTabs = _tabs.value
        
        if (currentIndex in currentTabs.indices) {
            val truncatedTitle = title.take(15)
            val updatedTab = currentTabs[currentIndex].copy(title = truncatedTitle)
            updateTab(currentIndex, updatedTab)
        }
    }
    
    /**
     * íƒ­ ì˜¤ë²„ë·° í‘œì‹œ/ìˆ¨ê¹€
     */
    fun toggleTabOverview() {
        _showTabOverview.value = !_showTabOverview.value
    }
    
    fun showTabOverview() {
        _showTabOverview.value = true
    }
    
    fun hideTabOverview() {
        _showTabOverview.value = false
    }
    
    /**
     * ëª¨ë“  íƒ­ ë‹«ê¸° (ìƒˆ íƒ­ í•˜ë‚˜ ìƒì„±)
     */
    fun closeAllTabs() {
        _tabs.value = listOf(Tab())
        _currentTabIndex.value = 0
        _showTabOverview.value = false
    }
    
    /**
     * ë‹¤ë¥¸ íƒ­ë“¤ ë‹«ê¸° (í˜„ì¬ íƒ­ë§Œ ìœ ì§€)
     */
    fun closeOtherTabs() {
        val currentTab = currentTab
        if (currentTab != null) {
            _tabs.value = listOf(currentTab)
            _currentTabIndex.value = 0
            _showTabOverview.value = false
        }
    }
    
    /**
     * íƒ­ ê°œìˆ˜ ì¡°íšŒ
     */
    val tabCount: Int
        get() = _tabs.value.size
    
    /**
     * ë¹ˆ íƒ­ ì—¬ë¶€ í™•ì¸
     */
    fun isCurrentTabEmpty(): Boolean {
        return currentTab?.url?.isEmpty() == true
    }
    
    /**
     * íƒ­ ë³µì œ
     */
    fun duplicateTab(index: Int) {
        val currentTabs = _tabs.value
        if (index in currentTabs.indices) {
            val tabToDuplicate = currentTabs[index]
            val duplicatedTab = Tab(
                url = tabToDuplicate.url,
                title = "${tabToDuplicate.title} (ë³µì‚¬)"
            )
            val updatedTabs = currentTabs.toMutableList()
            updatedTabs.add(index + 1, duplicatedTab)
            _tabs.value = updatedTabs
            _currentTabIndex.value = index + 1
        }
    }
    
    /**
     * íƒ­ ìˆœì„œ ë³€ê²½
     */
    fun moveTab(fromIndex: Int, toIndex: Int) {
        val currentTabs = _tabs.value.toMutableList()
        if (fromIndex in currentTabs.indices && toIndex in currentTabs.indices) {
            val tab = currentTabs.removeAt(fromIndex)
            currentTabs.add(toIndex, tab)
            _tabs.value = currentTabs
            
            // í˜„ì¬ íƒ­ ì¸ë±ìŠ¤ ì¡°ì •
            val currentIndex = _currentTabIndex.value
            when (currentIndex) {
                fromIndex -> _currentTabIndex.value = toIndex
                in (minOf(fromIndex, toIndex) until maxOf(fromIndex, toIndex)) -> {
                    _currentTabIndex.value = if (fromIndex < toIndex) {
                        currentIndex - 1
                    } else {
                        currentIndex + 1
                    }
                }
            }
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/viewmodel/VideoDetectionViewModel.kt">
package com.swvd.simplewebvideodownloader.viewmodel

import android.util.Log
import android.webkit.WebView
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.swvd.simplewebvideodownloader.webview.Mp4Analyzer
import com.swvd.simplewebvideodownloader.webview.VideoAnalyzer
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch

/**
 * ë¹„ë””ì˜¤ ê°ì§€ ë·°ëª¨ë¸
 * ì›¹í˜ì´ì§€ì—ì„œ ë¹„ë””ì˜¤ ë¶„ì„ ë° ê°ì§€ ê¸°ëŠ¥ì„ ë‹´ë‹¹
 */
class VideoDetectionViewModel : ViewModel() {
    
    companion object {
        private const val TAG = "VideoDetectionViewModel"
    }
    
    // ë¹„ë””ì˜¤ ë¶„ì„ê¸°ë“¤
    private val mp4Analyzer = Mp4Analyzer()
    private val videoAnalyzer = VideoAnalyzer()
    
    // ë¶„ì„ ìƒíƒœ
    private val _isAnalyzing = MutableStateFlow(false)
    val isAnalyzing: StateFlow<Boolean> = _isAnalyzing.asStateFlow()
    
    private val _hasAnalyzed = MutableStateFlow(false)
    val hasAnalyzed: StateFlow<Boolean> = _hasAnalyzed.asStateFlow()
    
    // ê°ì§€ëœ ë¹„ë””ì˜¤ ëª©ë¡
    private val _videoList = MutableStateFlow<List<VideoAnalyzer.VideoInfo>>(emptyList())
    val videoList: StateFlow<List<VideoAnalyzer.VideoInfo>> = _videoList.asStateFlow()
    
    // ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ MP4 ë§í¬
    private val _mp4Links = MutableStateFlow<List<String>>(emptyList())
    val mp4Links: StateFlow<List<String>> = _mp4Links.asStateFlow()
    
    // ë¶„ì„ ê²°ê³¼ í†µê³„
    private val _analysisStats = MutableStateFlow(AnalysisStats())
    val analysisStats: StateFlow<AnalysisStats> = _analysisStats.asStateFlow()
    
    // ë§ˆì§€ë§‰ ë¶„ì„ ì‹œê°„
    private val _lastAnalysisTime = MutableStateFlow(0L)
    val lastAnalysisTime: StateFlow<Long> = _lastAnalysisTime.asStateFlow()
    
    /**
     * ë¹„ë””ì˜¤ ë¶„ì„ ì‹œì‘
     */
    fun startAnalysis(webView: WebView?) {
        if (_isAnalyzing.value) {
            Log.w(TAG, "ì´ë¯¸ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤")
            return
        }
        
        if (webView == null) {
            Log.w(TAG, "WebViewê°€ nullì…ë‹ˆë‹¤")
            return
        }
        
        Log.d(TAG, "ë¹„ë””ì˜¤ ë¶„ì„ ì‹œì‘: ${webView.url}")
        
        _isAnalyzing.value = true
        _hasAnalyzed.value = true
        _lastAnalysisTime.value = System.currentTimeMillis()
        
        // í–¥ìƒëœ ë¹„ë””ì˜¤ ë¶„ì„ê¸° ì‚¬ìš©
        videoAnalyzer.analyzeVideos(webView) { videos ->
            processAnalysisResult(videos)
        }
    }
    
    /**
     * MP4 ì „ìš© ë¶„ì„ (ê¸°ì¡´ í˜¸í™˜ì„±)
     */
    fun startMp4Analysis(webView: WebView?) {
        if (_isAnalyzing.value) return
        
        Log.d(TAG, "MP4 ë¶„ì„ ì‹œì‘")
        
        _isAnalyzing.value = true
        _hasAnalyzed.value = true
        
        mp4Analyzer.analyzePageForMp4(webView) { mp4Links ->
            // MP4 ë§í¬ë¥¼ VideoInfoë¡œ ë³€í™˜
            val videoInfoList = mp4Links.map { url ->
                VideoAnalyzer.VideoInfo(
                    url = url,
                    type = VideoAnalyzer.VideoType.MP4,
                    title = extractTitleFromUrl(url)
                )
            }
            
            processAnalysisResult(videoInfoList)
        }
    }
    
    /**
     * ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬
     */
    private fun processAnalysisResult(videos: List<VideoAnalyzer.VideoInfo>) {
        viewModelScope.launch {
            try {
                _videoList.value = videos
                
                // ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ MP4 ë§í¬ ì¶”ì¶œ
                _mp4Links.value = videos.filter { it.type == VideoAnalyzer.VideoType.MP4 }
                    .map { it.url }
                
                // ë¶„ì„ í†µê³„ ì—…ë°ì´íŠ¸
                updateAnalysisStats(videos)
                
                _isAnalyzing.value = false
                
                Log.d(TAG, "ë¶„ì„ ì™„ë£Œ - ì´ ${videos.size}ê°œ ë¹„ë””ì˜¤ ê°ì§€")
                
            } catch (e: Exception) {
                Log.e(TAG, "ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬ ì˜¤ë¥˜: ${e.message}", e)
                _isAnalyzing.value = false
            }
        }
    }
    
    /**
     * ë¶„ì„ í†µê³„ ì—…ë°ì´íŠ¸
     */
    private fun updateAnalysisStats(videos: List<VideoAnalyzer.VideoInfo>) {
        val stats = AnalysisStats(
            totalVideos = videos.size,
            mp4Count = videos.count { it.type == VideoAnalyzer.VideoType.MP4 },
            hlsCount = videos.count { it.type == VideoAnalyzer.VideoType.HLS },
            dashCount = videos.count { it.type == VideoAnalyzer.VideoType.DASH },
            webmCount = videos.count { it.type == VideoAnalyzer.VideoType.WEBM },
            otherCount = videos.count { 
                it.type !in listOf(
                    VideoAnalyzer.VideoType.MP4,
                    VideoAnalyzer.VideoType.HLS,
                    VideoAnalyzer.VideoType.DASH,
                    VideoAnalyzer.VideoType.WEBM
                )
            },
            downloadableCount = videos.count { isDownloadable(it) }
        )
        
        _analysisStats.value = stats
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
     */
    fun isDownloadable(video: VideoAnalyzer.VideoInfo): Boolean {
        return when (video.type) {
            VideoAnalyzer.VideoType.MP4,
            VideoAnalyzer.VideoType.WEBM,
            VideoAnalyzer.VideoType.MKV,
            VideoAnalyzer.VideoType.AVI,
            VideoAnalyzer.VideoType.MOV,
            VideoAnalyzer.VideoType.FLV -> true
            VideoAnalyzer.VideoType.HLS -> true
            VideoAnalyzer.VideoType.DASH -> false
            VideoAnalyzer.VideoType.YOUTUBE,
            VideoAnalyzer.VideoType.VIMEO -> false
            VideoAnalyzer.VideoType.UNKNOWN -> 
                video.url.contains("http") && video.url.contains(".")
        }
    }
    
    /**
     * íŠ¹ì • íƒ€ì…ì˜ ë¹„ë””ì˜¤ë§Œ í•„í„°ë§
     */
    fun getVideosByType(type: VideoAnalyzer.VideoType): List<VideoAnalyzer.VideoInfo> {
        return _videoList.value.filter { it.type == type }
    }
    
    /**
     * ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ ë¹„ë””ì˜¤ë§Œ í•„í„°ë§
     */
    fun getDownloadableVideos(): List<VideoAnalyzer.VideoInfo> {
        return _videoList.value.filter { isDownloadable(it) }
    }
    
    /**
     * URLì—ì„œ ì œëª© ì¶”ì¶œ
     */
    private fun extractTitleFromUrl(url: String): String? {
        return try {
            val path = url.substringAfterLast("/")
            if (path.contains(".")) {
                path.substringBeforeLast(".")
            } else {
                path.take(20)
            }
        } catch (e: Exception) {
            null
        }
    }
    
    /**
     * ë¶„ì„ ì¬ì‹œë„
     */
    fun retryAnalysis(webView: WebView?) {
        Log.d(TAG, "ë¶„ì„ ì¬ì‹œë„")
        clearResults()
        startAnalysis(webView)
    }
    
    /**
     * ê²°ê³¼ ì´ˆê¸°í™”
     */
    fun clearResults() {
        _videoList.value = emptyList()
        _mp4Links.value = emptyList()
        _hasAnalyzed.value = false
        _isAnalyzing.value = false
        _analysisStats.value = AnalysisStats()
        Log.d(TAG, "ë¶„ì„ ê²°ê³¼ ì´ˆê¸°í™”")
    }
    
    /**
     * ë¶„ì„ ì¤‘ë‹¨
     */
    fun stopAnalysis() {
        _isAnalyzing.value = false
        Log.d(TAG, "ë¶„ì„ ì¤‘ë‹¨")
    }
    
    /**
     * íŠ¹ì • ë¹„ë””ì˜¤ URL ê²€ì¦
     */
    fun validateVideoUrl(url: String): Boolean {
        return try {
            url.isNotBlank() && 
            (url.startsWith("http://") || url.startsWith("https://")) &&
            !url.contains("javascript:") &&
            !url.contains("data:")
        } catch (e: Exception) {
            false
        }
    }
    
    /**
     * ë¹„ë””ì˜¤ ê²€ìƒ‰
     */
    fun searchVideos(query: String): List<VideoAnalyzer.VideoInfo> {
        if (query.isBlank()) return _videoList.value
        
        return _videoList.value.filter { video ->
            video.url.contains(query, ignoreCase = true) ||
            video.title?.contains(query, ignoreCase = true) == true ||
            video.type.displayName.contains(query, ignoreCase = true)
        }
    }
    
    /**
     * ë§ˆì§€ë§‰ ë¶„ì„ìœ¼ë¡œë¶€í„° ê²½ê³¼ ì‹œê°„ (ì´ˆ)
     */
    fun getTimeSinceLastAnalysis(): Long {
        return if (_lastAnalysisTime.value > 0) {
            (System.currentTimeMillis() - _lastAnalysisTime.value) / 1000
        } else {
            0
        }
    }
}

/**
 * ë¶„ì„ í†µê³„ ë°ì´í„° í´ë˜ìŠ¤
 */
data class AnalysisStats(
    val totalVideos: Int = 0,
    val mp4Count: Int = 0,
    val hlsCount: Int = 0,
    val dashCount: Int = 0,
    val webmCount: Int = 0,
    val otherCount: Int = 0,
    val downloadableCount: Int = 0
) {
    val downloadablePercentage: Float
        get() = if (totalVideos > 0) (downloadableCount.toFloat() / totalVideos) * 100 else 0f
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/viewmodel/WebViewViewModel.kt">
package com.swvd.simplewebvideodownloader.viewmodel

import android.os.Bundle
import android.util.Log
import android.webkit.WebView
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch

/**
 * WebView ê´€ë¦¬ ë·°ëª¨ë¸
 * WebViewì˜ ìƒíƒœ, ë„¤ë¹„ê²Œì´ì…˜, URL ì²˜ë¦¬ë¥¼ ë‹´ë‹¹
 */
class WebViewViewModel : ViewModel() {
    
    companion object {
        private const val TAG = "WebViewViewModel"
    }
    
    // URL ê´€ë ¨ ìƒíƒœ
    private val _urlText = MutableStateFlow("")
    val urlText: StateFlow<String> = _urlText.asStateFlow()
    
    private val _currentUrl = MutableStateFlow("")
    val currentUrl: StateFlow<String> = _currentUrl.asStateFlow()
    
    // ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ
    private val _canGoBack = MutableStateFlow(false)
    val canGoBack: StateFlow<Boolean> = _canGoBack.asStateFlow()
    
    private val _canGoForward = MutableStateFlow(false)
    val canGoForward: StateFlow<Boolean> = _canGoForward.asStateFlow()
    
    // ì „ì²´í™”ë©´ ìƒíƒœ
    private val _isFullscreen = MutableStateFlow(false)
    val isFullscreen: StateFlow<Boolean> = _isFullscreen.asStateFlow()
    
    // WebView ìƒíƒœ
    private val _webViewState = MutableStateFlow<Bundle?>(null)
    val webViewState: StateFlow<Bundle?> = _webViewState.asStateFlow()
    
    // URL íˆìŠ¤í† ë¦¬
    private val _urlHistory = MutableStateFlow<List<String>>(emptyList())
    val urlHistory: StateFlow<List<String>> = _urlHistory.asStateFlow()
    
    // í˜ì´ì§€ ë¡œë”© ìƒíƒœ
    private val _isPageLoading = MutableStateFlow(false)
    val isPageLoading: StateFlow<Boolean> = _isPageLoading.asStateFlow()
    
    // í˜ì´ì§€ ë¡œë”© ì§„í–‰ë¥ 
    private val _loadingProgress = MutableStateFlow(0)
    val loadingProgress: StateFlow<Int> = _loadingProgress.asStateFlow()
    
    // í˜ì´ì§€ ì œëª©
    private val _pageTitle = MutableStateFlow("")
    val pageTitle: StateFlow<String> = _pageTitle.asStateFlow()
    
    /**
     * URL í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
     */
    fun updateUrlText(text: String) {
        _urlText.value = text
    }
    
    /**
     * í˜„ì¬ URL ì—…ë°ì´íŠ¸
     */
    fun updateCurrentUrl(url: String) {
        if (url != _currentUrl.value && 
            !url.startsWith("data:") && 
            !url.startsWith("about:") &&
            url != "about:blank") {
            
            _currentUrl.value = url
            _urlText.value = url
            
            // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
            addToHistory(url)
            
            Log.d(TAG, "URL ì—…ë°ì´íŠ¸: $url")
        }
    }
    
    /**
     * URL íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
     */
    private fun addToHistory(url: String) {
        val currentHistory = _urlHistory.value.toMutableList()
        if (!currentHistory.contains(url)) {
            currentHistory.add(url)
            // ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ ìœ ì§€
            if (currentHistory.size > 20) {
                currentHistory.removeAt(0)
            }
            _urlHistory.value = currentHistory
        }
    }
    
    /**
     * URL ìœ íš¨ì„± ê²€ì‚¬ ë° ì •ê·œí™”
     */
    fun normalizeUrl(url: String): String {
        val trimmedUrl = url.trim()
        return if (!trimmedUrl.startsWith("http://") && !trimmedUrl.startsWith("https://")) {
            "https://$trimmedUrl"
        } else {
            trimmedUrl
        }
    }
    
    /**
     * ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
     */
    fun updateNavigationState(webView: WebView?) {
        webView?.let { view ->
            val oldCanGoBack = _canGoBack.value
            val oldCanGoForward = _canGoForward.value
            
            _canGoBack.value = view.canGoBack()
            _canGoForward.value = view.canGoForward()
            
            Log.d(TAG, "ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸ - ë’¤ë¡œ: $oldCanGoBack â†’ ${_canGoBack.value}, " +
                    "ì•ìœ¼ë¡œ: $oldCanGoForward â†’ ${_canGoForward.value}")
        }
    }
    
    /**
     * WebView ìƒíƒœ ì €ì¥
     */
    fun saveWebViewState(webView: WebView?) {
        webView?.let { view ->
            val bundle = Bundle()
            view.saveState(bundle)
            _webViewState.value = bundle
            
            // í˜„ì¬ URLë„ ì—…ë°ì´íŠ¸
            view.url?.let { url ->
                updateCurrentUrl(url)
            }
            
            Log.d(TAG, "WebView ìƒíƒœ ì €ì¥ ì™„ë£Œ")
        }
    }
    
    /**
     * WebView ìƒíƒœ ë³µì›
     */
    fun restoreWebViewState(webView: WebView?) {
        webView?.let { view ->
            _webViewState.value?.let { bundle ->
                view.restoreState(bundle)
                Log.d(TAG, "WebView ìƒíƒœ ë³µì› ì™„ë£Œ")
            }
        }
    }
    
    /**
     * ì „ì²´í™”ë©´ ëª¨ë“œ í† ê¸€
     */
    fun toggleFullscreen() {
        _isFullscreen.value = !_isFullscreen.value
    }
    
    fun setFullscreen(fullscreen: Boolean) {
        _isFullscreen.value = fullscreen
    }
    
    /**
     * í˜ì´ì§€ ë¡œë”© ìƒíƒœ ê´€ë¦¬
     */
    fun onPageStarted(url: String) {
        _isPageLoading.value = true
        _loadingProgress.value = 0
        updateCurrentUrl(url)
        Log.d(TAG, "í˜ì´ì§€ ë¡œë”© ì‹œì‘: $url")
    }
    
    fun onPageFinished(url: String) {
        _isPageLoading.value = false
        _loadingProgress.value = 100
        updateCurrentUrl(url)
        Log.d(TAG, "í˜ì´ì§€ ë¡œë”© ì™„ë£Œ: $url")
    }
    
    fun onProgressChanged(progress: Int) {
        _loadingProgress.value = progress
    }
    
    fun onReceivedTitle(title: String) {
        _pageTitle.value = title
    }
    
    /**
     * í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
     */
    fun refreshPage(webView: WebView?) {
        webView?.reload()
        Log.d(TAG, "í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨")
    }
    
    /**
     * ë’¤ë¡œ ê°€ê¸°
     */
    fun goBack(webView: WebView?) {
        webView?.let { view ->
            if (view.canGoBack()) {
                view.goBack()
                Log.d(TAG, "ë’¤ë¡œ ê°€ê¸° ì‹¤í–‰")
                
                // ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì§€ì—° ì‹¤í–‰
                viewModelScope.launch {
                    kotlinx.coroutines.delay(100)
                    updateNavigationState(view)
                }
            }
        }
    }
    
    /**
     * ì•ìœ¼ë¡œ ê°€ê¸°
     */
    fun goForward(webView: WebView?) {
        webView?.let { view ->
            if (view.canGoForward()) {
                view.goForward()
                Log.d(TAG, "ì•ìœ¼ë¡œ ê°€ê¸° ì‹¤í–‰")
                
                // ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì§€ì—° ì‹¤í–‰
                viewModelScope.launch {
                    kotlinx.coroutines.delay(100)
                    updateNavigationState(view)
                }
            }
        }
    }
    
    /**
     * URL ë¡œë“œ
     */
    fun loadUrl(webView: WebView?, url: String? = null) {
        webView?.let { view ->
            val targetUrl = url ?: normalizeUrl(_urlText.value)
            if (targetUrl.isNotBlank()) {
                view.loadUrl(targetUrl)
                updateCurrentUrl(targetUrl)
                Log.d(TAG, "URL ë¡œë“œ: $targetUrl")
            }
        }
    }
    
    /**
     * í˜ì´ì§€ ì •ì§€
     */
    fun stopLoading(webView: WebView?) {
        webView?.stopLoading()
        _isPageLoading.value = false
        Log.d(TAG, "í˜ì´ì§€ ë¡œë”© ì •ì§€")
    }
    
    /**
     * í™ˆ í˜ì´ì§€ë¡œ ì´ë™
     */
    fun goHome(webView: WebView?) {
        loadUrl(webView, "https://www.google.com")
    }
    
    /**
     * í˜„ì¬ í˜ì´ì§€ URL ë³µì‚¬
     */
    fun getCurrentPageUrl(): String {
        return _currentUrl.value
    }
    
    /**
     * URL íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
     */
    fun clearHistory() {
        _urlHistory.value = emptyList()
        Log.d(TAG, "URL íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”")
    }
    
    /**
     * ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”
     */
    fun resetAll() {
        _urlText.value = ""
        _currentUrl.value = ""
        _canGoBack.value = false
        _canGoForward.value = false
        _isFullscreen.value = false
        _webViewState.value = null
        _urlHistory.value = emptyList()
        _isPageLoading.value = false
        _loadingProgress.value = 0
        _pageTitle.value = ""
        Log.d(TAG, "ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”")
    }
    
    /**
     * ì‚¬ìš©ì ì—ì´ì „íŠ¸ ì„¤ì •
     */
    fun setupUserAgent(webView: WebView?) {
        webView?.let { view ->
            view.settings.userAgentString = "Mozilla/5.0 (Linux; Android 10; SM-G975F) " +
                    "AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Mobile Safari/537.36"
        }
    }
    
    /**
     * ìë°”ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
     */
    fun executeJavaScript(webView: WebView?, script: String, callback: ((String) -> Unit)? = null) {
        webView?.evaluateJavascript(script) { result ->
            callback?.invoke(result)
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/webview/VideoAnalyzer.kt">
package com.swvd.simplewebvideodownloader.webview

import android.util.Log
import android.webkit.WebView
import com.swvd.simplewebvideodownloader.models.VideoInfo
import com.swvd.simplewebvideodownloader.models.VideoType

/**
 * ë¹„ë””ì˜¤ ë¶„ì„ê¸° í´ë˜ìŠ¤
 * ë‹¤ì–‘í•œ ë¹„ë””ì˜¤ í˜•ì‹(MP4, HLS/M3U8, DASH, WebM ë“±)ì„ ê°ì§€í•˜ëŠ” ê¸°ëŠ¥ì„ ë‹´ë‹¹
 */
class VideoAnalyzer {
    
    /**
     * í–¥ìƒëœ ë¹„ë””ì˜¤ ê°ì§€ JavaScript ì½”ë“œ
     * ë‹¤ì–‘í•œ ë¹„ë””ì˜¤ í˜•ì‹ê³¼ ìŠ¤íŠ¸ë¦¬ë° URLì„ ê°ì§€
     */
    private val videoDetectionScript = """
        (function() {
            var results = [];
            var uniqueUrls = new Set();
            
            // ì§€ì›í•˜ëŠ” ë¹„ë””ì˜¤ í™•ì¥ì ëª©ë¡
            var videoExtensions = ['.mp4', '.m3u8', '.m3u', '.mpd', '.webm', '.mkv', '.avi', '.mov', '.flv'];
            
            try {
                // 1. ëª¨ë“  video íƒœê·¸ ë¶„ì„
                var videos = document.querySelectorAll('video');
                videos.forEach(function(video) {
                    // src ì†ì„± í™•ì¸
                    if (video.src) {
                        addVideoUrl(video.src, getVideoTitle(video));
                    }
                    
                    // currentSrc í™•ì¸
                    if (video.currentSrc) {
                        addVideoUrl(video.currentSrc, getVideoTitle(video));
                    }
                    
                    // data ì†ì„±ë“¤ í™•ì¸
                    ['data-src', 'data-url', 'data-video', 'data-stream'].forEach(function(attr) {
                        var value = video.getAttribute(attr);
                        if (value) {
                            addVideoUrl(value, getVideoTitle(video));
                        }
                    });
                    
                    // source íƒœê·¸ë“¤ í™•ì¸
                    var sources = video.querySelectorAll('source');
                    sources.forEach(function(source) {
                        if (source.src) {
                            addVideoUrl(source.src, getVideoTitle(video));
                        }
                    });
                });
                
                // 2. ëª¨ë“  source íƒœê·¸ ë¶„ì„
                var sources = document.querySelectorAll('source');
                sources.forEach(function(source) {
                    if (source.src) {
                        addVideoUrl(source.src);
                    }
                });
                
                // 3. ë§í¬ íƒœê·¸ ë¶„ì„
                var links = document.querySelectorAll('a[href]');
                links.forEach(function(link) {
                    if (link.href) {
                        addVideoUrl(link.href, link.textContent || link.title);
                    }
                });
                
                // 4. HTML ì „ì²´ì—ì„œ ì •ê·œì‹ìœ¼ë¡œ URL ê²€ìƒ‰
                var html = document.documentElement.outerHTML;
                
                // ë‹¤ì–‘í•œ ë¹„ë””ì˜¤ URL íŒ¨í„´ ê²€ìƒ‰
                videoExtensions.forEach(function(ext) {
                    var regex = new RegExp('https?:\\/\\/[^\\s"\'<>()]+\\' + ext + '[^\\s"\'<>()]*', 'gi');
                    var matches = html.match(regex);
                    if (matches) {
                        matches.forEach(function(match) {
                            var cleanUrl = match.replace(/['"<>()]+${'$'}/, '');
                            if (cleanUrl.length > 10) {
                                addVideoUrl(cleanUrl);
                            }
                        });
                    }
                });
                
                // 5. HLS ìŠ¤íŠ¸ë¦¬ë° íŠ¹ë³„ ê²€ìƒ‰
                // HLS ë§¤ë‹ˆí˜ìŠ¤íŠ¸ëŠ” ì¢…ì¢… ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ë¡œë“œë¨
                var hlsPatterns = [
                    /https?:\/\/[^\s"'<>()]+\.m3u8[^\s"'<>()]*/gi,
                    /https?:\/\/[^\s"'<>()]+\/playlist\.m3u8[^\s"'<>()]*/gi,
                    /https?:\/\/[^\s"'<>()]+\/index\.m3u8[^\s"'<>()]*/gi,
                    /https?:\/\/[^\s"'<>()]+\/master\.m3u8[^\s"'<>()]*/gi
                ];
                
                hlsPatterns.forEach(function(pattern) {
                    var matches = html.match(pattern);
                    if (matches) {
                        matches.forEach(function(match) {
                            var cleanUrl = match.replace(/['"<>()]+${'$'}/, '');
                            if (cleanUrl.length > 20) {
                                addVideoUrl(cleanUrl);
                            }
                        });
                    }
                });
                
                // 6. DASH ìŠ¤íŠ¸ë¦¬ë° ê²€ìƒ‰
                var dashPatterns = [
                    /https?:\/\/[^\s"'<>()]+\.mpd[^\s"'<>()]*/gi,
                    /https?:\/\/[^\s"'<>()]+\/manifest\.mpd[^\s"'<>()]*/gi
                ];
                
                dashPatterns.forEach(function(pattern) {
                    var matches = html.match(pattern);
                    if (matches) {
                        matches.forEach(function(match) {
                            var cleanUrl = match.replace(/['"<>()]+${'$'}/, '');
                            if (cleanUrl.length > 20) {
                                addVideoUrl(cleanUrl);
                            }
                        });
                    }
                });
                
                // 7. iframe ë‚´ ë¹„ë””ì˜¤ URL ê²€ìƒ‰
                var iframes = document.querySelectorAll('iframe');
                iframes.forEach(function(iframe) {
                    if (iframe.src) {
                        // YouTube, Vimeo ë“±ì˜ embed URLë„ í™•ì¸
                        if (iframe.src.includes('youtube.com') || 
                            iframe.src.includes('vimeo.com') ||
                            iframe.src.includes('dailymotion.com')) {
                            addVideoUrl(iframe.src, 'Embedded Video');
                        }
                    }
                });
                
                // 8. JavaScript ë³€ìˆ˜ì—ì„œ ë¹„ë””ì˜¤ URL ê²€ìƒ‰
                var scripts = document.querySelectorAll('script');
                scripts.forEach(function(script) {
                    if (script.textContent) {
                        var scriptText = script.textContent;
                        videoExtensions.forEach(function(ext) {
                            var regex = new RegExp('https?:\\/\\/[^\\s"\'<>()]+\\' + ext + '[^\\s"\'<>()]*', 'gi');
                            var matches = scriptText.match(regex);
                            if (matches) {
                                matches.forEach(function(match) {
                                    var cleanUrl = match.replace(/['"<>()]+${'$'}/, '');
                                    if (cleanUrl.length > 10) {
                                        addVideoUrl(cleanUrl);
                                    }
                                });
                            }
                        });
                    }
                });
                
                // URL ì¶”ê°€ í•¨ìˆ˜
                function addVideoUrl(url, title) {
                    if (!url || url.length < 10) return;
                    
                    // URL ì •ë¦¬
                    var cleanUrl = url.trim();
                    if (cleanUrl.startsWith('//')) {
                        cleanUrl = 'https:' + cleanUrl;
                    }
                    
                    // ë¹„ë””ì˜¤ URLì¸ì§€ í™•ì¸
                    var isVideo = videoExtensions.some(function(ext) {
                        return cleanUrl.toLowerCase().includes(ext);
                    });
                    
                    if (isVideo && !uniqueUrls.has(cleanUrl)) {
                        uniqueUrls.add(cleanUrl);
                        
                        // ë¹„ë””ì˜¤ íƒ€ì… ê²°ì •
                        var videoType = 'UNKNOWN';
                        if (cleanUrl.includes('.mp4')) videoType = 'MP4';
                        else if (cleanUrl.includes('.m3u8') || cleanUrl.includes('.m3u')) videoType = 'HLS';
                        else if (cleanUrl.includes('.mpd')) videoType = 'DASH';
                        else if (cleanUrl.includes('.webm')) videoType = 'WEBM';
                        else if (cleanUrl.includes('.mkv')) videoType = 'MKV';
                        else if (cleanUrl.includes('.avi')) videoType = 'AVI';
                        else if (cleanUrl.includes('.mov')) videoType = 'MOV';
                        else if (cleanUrl.includes('.flv')) videoType = 'FLV';
                        else if (cleanUrl.includes('youtube.com')) videoType = 'YOUTUBE';
                        else if (cleanUrl.includes('vimeo.com')) videoType = 'VIMEO';
                        
                        results.push({
                            url: cleanUrl,
                            type: videoType,
                            title: title || null
                        });
                    }
                }
                
                // ë¹„ë””ì˜¤ ì œëª© ì¶”ì¶œ í•¨ìˆ˜
                function getVideoTitle(videoElement) {
                    return videoElement.title || 
                           videoElement.getAttribute('data-title') ||
                           videoElement.getAttribute('aria-label') ||
                           null;
                }
                
                return JSON.stringify(results);
                
            } catch (e) {
                return JSON.stringify([{
                    url: 'JavaScript ì˜¤ë¥˜: ' + e.message,
                    type: 'UNKNOWN',
                    title: null
                }]);
            }
        })();
    """.trimIndent()
    
    /**
     * WebViewì—ì„œ ë¹„ë””ì˜¤ ë¶„ì„ ì‹¤í–‰
     * @param webView ë¶„ì„í•  WebView
     * @param onResult ê²°ê³¼ë¥¼ ë°›ì„ ì½œë°± í•¨ìˆ˜
     */
    fun analyzeVideos(
        webView: WebView?,
        onResult: (List<VideoInfo>) -> Unit
    ) {
        if (webView == null) {
            Log.d("VideoAnalyzer", "WebViewê°€ ì—†ìŒ")
            onResult(emptyList())
            return
        }
        
        Log.d("VideoAnalyzer", "ë¹„ë””ì˜¤ ë¶„ì„ ì‹œì‘: ${webView.url}")
        
        webView.evaluateJavascript(videoDetectionScript) { result ->
            try {
                val cleanResult = result?.replace("\\\"", "\"")?.removeSurrounding("\"") ?: "[]"
                Log.d("VideoAnalyzer", "ë¹„ë””ì˜¤ ê²€ìƒ‰ ê²°ê³¼: $cleanResult")

                val videos = parseVideoResults(cleanResult)
                Log.d("VideoAnalyzer", "ìµœì¢… ë¹„ë””ì˜¤ ${videos.size}ê°œ ë°œê²¬")
                onResult(videos)

            } catch (e: Exception) {
                Log.e("VideoAnalyzer", "ë¹„ë””ì˜¤ ë¶„ì„ ì˜¤ë¥˜: ${e.message}")
                onResult(listOf(VideoInfo("ë¶„ì„ ì˜¤ë¥˜: ${e.message}", VideoType.UNKNOWN)))
            }
        }
    }
    
    /**
     * JavaScript ê²°ê³¼ë¥¼ VideoInfo ë¦¬ìŠ¤íŠ¸ë¡œ íŒŒì‹±
     */
    private fun parseVideoResults(jsonResult: String): List<VideoInfo> {
        return try {
            if (!jsonResult.startsWith("[")) {
                return emptyList()
            }
            
            // ê°„ë‹¨í•œ JSON íŒŒì‹± (ë³µì¡í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´)
            val videos = mutableListOf<VideoInfo>()
            val jsonArray = jsonResult.removeSurrounding("[", "]")
            
            if (jsonArray.isBlank()) {
                return emptyList()
            }
            
            // ê° ë¹„ë””ì˜¤ ê°ì²´ íŒŒì‹±
            var currentObject = ""
            var braceCount = 0
            var inString = false
            var escapeNext = false
            
            for (char in jsonArray) {
                when {
                    escapeNext -> {
                        currentObject += char
                        escapeNext = false
                    }
                    char == '\\' -> {
                        currentObject += char
                        escapeNext = true
                    }
                    char == '"' -> {
                        inString = !inString
                        currentObject += char
                    }
                    !inString && char == '{' -> {
                        braceCount++
                        currentObject += char
                    }
                    !inString && char == '}' -> {
                        braceCount--
                        currentObject += char
                        if (braceCount == 0) {
                            // ê°ì²´ ì™„ì„±
                            val video = parseVideoObject(currentObject)
                            if (video != null) {
                                videos.add(video)
                            }
                            currentObject = ""
                        }
                    }
                    braceCount > 0 -> {
                        currentObject += char
                    }
                }
            }
            
            videos.filter { it.url.isNotEmpty() && !it.url.contains("JavaScript ì˜¤ë¥˜") }
        } catch (e: Exception) {
            Log.e("VideoAnalyzer", "JSON íŒŒì‹± ì˜¤ë¥˜: ${e.message}")
            emptyList()
        }
    }
    
    /**
     * ê°œë³„ ë¹„ë””ì˜¤ ê°ì²´ íŒŒì‹±
     */
    private fun parseVideoObject(jsonObject: String): VideoInfo? {
        return try {
            // ê°„ë‹¨í•œ JSON ê°ì²´ íŒŒì‹±
            val url = extractJsonValue(jsonObject, "url")
            val typeStr = extractJsonValue(jsonObject, "type")
            val title = extractJsonValue(jsonObject, "title")
            
            if (url.isBlank()) return null
            
            val type = try {
                VideoType.valueOf(typeStr)
            } catch (e: IllegalArgumentException) {
                VideoType.UNKNOWN
            }
            
            VideoInfo(
                url = url,
                type = type,
                title = title.takeIf { it.isNotBlank() }
            )
        } catch (e: Exception) {
            Log.e("VideoAnalyzer", "ë¹„ë””ì˜¤ ê°ì²´ íŒŒì‹± ì˜¤ë¥˜: ${e.message}")
            null
        }
    }
    
    /**
     * JSON ë¬¸ìì—´ì—ì„œ íŠ¹ì • í‚¤ì˜ ê°’ ì¶”ì¶œ
     */
    private fun extractJsonValue(json: String, key: String): String {
        return try {
            val pattern = "\"$key\"\\s*:\\s*\"([^\"]*)\""
            val regex = Regex(pattern)
            val match = regex.find(json)
            match?.groupValues?.get(1)?.replace("\\\"", "\"") ?: ""
        } catch (e: Exception) {
            ""
        }
    }
    
    /**
     * ë¹„ë””ì˜¤ íƒ€ì…ë³„ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
     */
    fun isDownloadable(video: VideoInfo): Boolean {
        return when (video.type) {
            VideoType.MP4, VideoType.WEBM, VideoType.MKV, 
            VideoType.AVI, VideoType.MOV, VideoType.FLV -> true
            VideoType.HLS -> true // HLSëŠ” ë³„ë„ ì²˜ë¦¬ í•„ìš”
            VideoType.DASH -> false // DASHëŠ” ë³µì¡í•œ ì²˜ë¦¬ í•„ìš”
            VideoType.YOUTUBE, VideoType.VIMEO -> false // ë³„ë„ ì²˜ë¦¬ í•„ìš”
            VideoType.UNKNOWN -> video.url.contains("http") && 
                                 (video.url.contains(".mp4") || video.url.contains(".webm"))
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/MainActivityNew.kt">
package com.swvd.simplewebvideodownloader

import android.os.Bundle
import android.webkit.WebView
import androidx.activity.ComponentActivity
import androidx.activity.compose.BackHandler
import androidx.activity.compose.setContent
import androidx.activity.enableEdgeToEdge
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import androidx.compose.ui.Alignment
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.window.Dialog
import androidx.lifecycle.ViewModelProvider

// ViewModels
import com.swvd.simplewebvideodownloader.viewmodel.*

// UI Components
import com.swvd.simplewebvideodownloader.ui.components.*
import com.swvd.simplewebvideodownloader.ui.theme.SimpleWebVideoDownloaderTheme
import com.swvd.simplewebvideodownloader.ui.screens.FullscreenUI

// Models
import com.swvd.simplewebvideodownloader.models.VideoInfo
import com.swvd.simplewebvideodownloader.models.VideoType

// Utils
import com.swvd.simplewebvideodownloader.utils.FullscreenManager

/**
 * ìƒˆë¡œìš´ MainActivity - ë¦¬íŒ©í† ë§ëœ ë²„ì „
 * MVVM ì•„í‚¤í…ì²˜ì™€ ì»´í¬ë„ŒíŠ¸ ê¸°ë°˜ìœ¼ë¡œ ê°„ì†Œí™”
 * ê¸°ì¡´ 1,286ë¼ì¸ì—ì„œ ì•½ 100ë¼ì¸ìœ¼ë¡œ ì¶•ì†Œ
 */
class MainActivityNew : ComponentActivity() {

    // ViewModels
    private lateinit var mainViewModel: MainViewModel
    private lateinit var tabViewModel: TabViewModel
    private lateinit var webViewViewModel: WebViewViewModel
    private lateinit var videoDetectionViewModel: VideoDetectionViewModel
    private lateinit var downloadViewModel: DownloadViewModel

    // ê¶Œí•œ ìš”ì²­ ì²˜ë¦¬
    private val requestPermissionLauncher = registerForActivityResult(
        ActivityResultContracts.RequestMultiplePermissions()
    ) { permissions ->
        if (!permissions.values.all { it }) {
            downloadViewModel.showDownloadResult("ì €ì¥ì†Œ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤")
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()
        
        // FullscreenManager ì„¤ì •
        FullscreenManager.enableEdgeToEdge(this)
        
        // ViewModels ì´ˆê¸°í™”
        initViewModels()
        
        setContent {
            SimpleWebVideoDownloaderTheme {
                MainScreen()
            }
        }
    }

    /**
     * ViewModels ì´ˆê¸°í™”
     */
    private fun initViewModels() {
        val factory = object : ViewModelProvider.Factory {
            @Suppress("UNCHECKED_CAST")
            override fun <T : androidx.lifecycle.ViewModel> create(modelClass: Class<T>): T {
                return when (modelClass) {
                    MainViewModel::class.java -> MainViewModel(applicationContext) as T
                    DownloadViewModel::class.java -> DownloadViewModel(applicationContext) as T
                    TabViewModel::class.java -> TabViewModel() as T
                    WebViewViewModel::class.java -> WebViewViewModel() as T
                    VideoDetectionViewModel::class.java -> VideoDetectionViewModel() as T
                    else -> throw IllegalArgumentException("Unknown ViewModel class: ${modelClass.name}")
                }
            }
        }
        
        mainViewModel = ViewModelProvider(this, factory)[MainViewModel::class.java]
        tabViewModel = ViewModelProvider(this, factory)[TabViewModel::class.java]
        webViewViewModel = ViewModelProvider(this, factory)[WebViewViewModel::class.java]
        videoDetectionViewModel = ViewModelProvider(this, factory)[VideoDetectionViewModel::class.java]
        downloadViewModel = ViewModelProvider(this, factory)[DownloadViewModel::class.java]
        
        // ê¶Œí•œ ìš”ì²­ ì½œë°± ì„¤ì •
        mainViewModel.onRequestPermissions = {
            val permissions = mainViewModel.checkStoragePermissions()
            if (permissions.isNotEmpty()) {
                requestPermissionLauncher.launch(permissions.toTypedArray())
            }
        }
    }

    /**
     * ë©”ì¸ í™”ë©´ ì»´í¬ì €ë¸”
     */
    @Composable
    private fun MainScreen() {
        // ViewModels ìƒíƒœ êµ¬ë…
        val mainUiState by mainViewModel.uiState.collectAsState()
        val downloadResult by mainViewModel.downloadResult.collectAsState()
        
        val tabs by tabViewModel.tabs.collectAsState()
        val currentTabIndex by tabViewModel.currentTabIndex.collectAsState()
        val showTabOverview by tabViewModel.showTabOverview.collectAsState()
        
        val urlText by webViewViewModel.urlText.collectAsState()
        val currentUrl by webViewViewModel.currentUrl.collectAsState()
        val canGoBack by webViewViewModel.canGoBack.collectAsState()
        val canGoForward by webViewViewModel.canGoForward.collectAsState()
        val isFullscreen by webViewViewModel.isFullscreen.collectAsState()
        val webViewState by webViewViewModel.webViewState.collectAsState()
        
        val videoList = mainUiState.videoList
        val isAnalyzing = mainUiState.isAnalyzing
        val hasAnalyzed = mainUiState.hasAnalyzed
        
        val downloadingUrls by downloadViewModel.downloadingUrls.collectAsState()
        val showDownloadResult by downloadViewModel.showDownloadResult.collectAsState()
        val downloadResultMessage by downloadViewModel.downloadResult.collectAsState()

        // WebView ì°¸ì¡° ê´€ë¦¬
        var mainWebView by remember { mutableStateOf<WebView?>(null) }
        var fullscreenWebView by remember { mutableStateOf<WebView?>(null) }

        // ì „ì²´í™”ë©´ ëª¨ë“œ BackHandler
        BackHandler(enabled = isFullscreen) {
            handleExitFullscreen(mainWebView, fullscreenWebView)
        }

        // ì „ì²´í™”ë©´ UI ë˜ëŠ” ì¼ë°˜ UI
        if (isFullscreen) {
            FullscreenModeScreen(
                currentUrl = currentUrl,
                webViewState = webViewState,
                canGoBack = canGoBack,
                canGoForward = canGoForward,
                isAnalyzing = isAnalyzing,
                onFullscreenWebViewCreated = { fullscreenWebView = it },
                onExitFullscreen = { handleExitFullscreen(mainWebView, fullscreenWebView) },
                onGoBack = { webViewViewModel.goBack(fullscreenWebView) },
                onGoForward = { webViewViewModel.goForward(fullscreenWebView) },
                onRefresh = { handleRefresh(fullscreenWebView) },
                onUrlChanged = { webViewViewModel.updateCurrentUrl(it) },
                onPageFinished = { handlePageFinished(fullscreenWebView) },
                onTitleReceived = { tabViewModel.updateCurrentTabTitle(it) }
            )
        } else {
            NormalScreen(
                mainWebView = mainWebView,
                onMainWebViewCreated = { mainWebView = it },
                onEnterFullscreen = { handleEnterFullscreen(mainWebView) }
            )
        }

        // ë‹¤ì´ì–¼ë¡œê·¸ë“¤
        if (showDownloadResult && downloadResultMessage != null) {
            DownloadResultDialog(
                show = showDownloadResult,
                message = downloadResultMessage,
                onDismiss = { downloadViewModel.hideDownloadResult() }
            )
        }
    }

    /**
     * ì¼ë°˜ ëª¨ë“œ í™”ë©´
     */
    @Composable
    private fun NormalScreen(
        mainWebView: WebView?,
        onMainWebViewCreated: (WebView) -> Unit,
        onEnterFullscreen: () -> Unit
    ) {
        val mainUiState by mainViewModel.uiState.collectAsState()
        val urlText by webViewViewModel.urlText.collectAsState()
        val currentUrl by webViewViewModel.currentUrl.collectAsState()
        val canGoBack by webViewViewModel.canGoBack.collectAsState()
        val canGoForward by webViewViewModel.canGoForward.collectAsState()
        val isAnalyzing = mainUiState.isAnalyzing
        val videoList = mainUiState.videoList
        val downloadingUrls by downloadViewModel.downloadingUrls.collectAsState()
        
        val tabs by tabViewModel.tabs.collectAsState()
        val currentTabIndex by tabViewModel.currentTabIndex.collectAsState()

        Surface(
            modifier = Modifier
                .fillMaxSize()
                .windowInsetsPadding(WindowInsets.systemBars.only(WindowInsetsSides.Top))
        ) {
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(16.dp)
            ) {
                // íƒ­ë°”
                TabBar(
                    tabs = tabs,
                    currentTabIndex = currentTabIndex,
                    onNewTab = { tabViewModel.addNewTab() },
                    onCloseTab = { tabViewModel.closeTab(it) },
                    onSwitchTab = { tabViewModel.switchTab(it) }
                )

                Spacer(modifier = Modifier.height(8.dp))

                // ì•± ì œëª©
                Text(
                    text = "Simple Web Video Downloader v5.8",
                    style = MaterialTheme.typography.titleMedium,
                    modifier = Modifier.padding(bottom = 12.dp)
                )

                // URL ì…ë ¥ ì„¹ì…˜
                UrlInputSection(
                    urlText = urlText,
                    currentUrl = currentUrl,
                    isAnalyzing = isAnalyzing,
                    urlSectionExpanded = mainUiState.urlSectionExpanded,
                    onUrlTextChange = { webViewViewModel.updateUrlText(it) },
                    onLoadUrl = { handleLoadUrl() },
                    onReset = { handleReset() },
                    onRefresh = { handleRefresh() },
                    onToggleExpanded = { mainViewModel.toggleUrlSection() }
                )

                Spacer(modifier = Modifier.height(12.dp))

                // ë¹„ë””ì˜¤ ëª©ë¡ ì„¹ì…˜
                VideoListSection(
                    hasAnalyzed = mainUiState.hasAnalyzed,
                    videoList = mainUiState.videoList,
                    mp4Links = mainUiState.mp4Links,
                    downloadingUrls = downloadingUrls,
                    videoSectionExpanded = mainUiState.videoSectionExpanded,
                    onToggleExpanded = { mainViewModel.toggleVideoSection() },
                    onDownloadVideo = { downloadViewModel.downloadVideo(it) },
                    onDownloadMp4 = { /* ê¸°ì¡´ í˜¸í™˜ì„± */ }
                )

                Spacer(modifier = Modifier.height(12.dp))

                // WebView ë° ë„¤ë¹„ê²Œì´ì…˜
                Box(modifier = Modifier.weight(1f)) {
                    Card(
                        modifier = Modifier
                            .fillMaxSize()
                            .padding(bottom = if (currentUrl.isNotEmpty()) 80.dp else 0.dp)
                    ) {
                        WebViewContainer(
                            currentUrl = currentUrl,
                            webViewState = webViewViewModel.webViewState.collectAsState().value,
                            onWebViewCreated = { onMainWebViewCreated(it) },
                            onUrlChanged = { webViewViewModel.updateCurrentUrl(it) },
                            onPageFinished = { handlePageFinished(mainWebView) },
                            onTitleReceived = { tabViewModel.updateCurrentTabTitle(it) }
                        )
                    }

                    // ë„¤ë¹„ê²Œì´ì…˜ ë°”
                    if (currentUrl.isNotEmpty()) {
                        NavigationBottomBar(
                            modifier = Modifier.align(androidx.compose.ui.Alignment.BottomCenter),
                            canGoBack = canGoBack,
                            canGoForward = canGoForward,
                            isAnalyzing = isAnalyzing,
                            onGoBack = { webViewViewModel.goBack(mainWebView) },
                            onGoForward = { webViewViewModel.goForward(mainWebView) },
                            onRefresh = { handleRefresh(mainWebView) },
                            onFullscreen = onEnterFullscreen
                        )
                    }
                }
            }
        }
    }

    /**
     * ì „ì²´í™”ë©´ ëª¨ë“œ í™”ë©´
     */
    @Composable
    private fun FullscreenModeScreen(
        currentUrl: String,
        webViewState: Bundle?,
        canGoBack: Boolean,
        canGoForward: Boolean,
        isAnalyzing: Boolean,
        onFullscreenWebViewCreated: (WebView) -> Unit,
        onExitFullscreen: () -> Unit,
        onGoBack: () -> Unit,
        onGoForward: () -> Unit,
        onRefresh: () -> Unit,
        onUrlChanged: (String) -> Unit,
        onPageFinished: (String) -> Unit,
        onTitleReceived: (String) -> Unit
    ) {
        Box(
            modifier = Modifier.fillMaxSize()
        ) {
            // ì „ì²´í™”ë©´ WebView
            FullscreenWebViewContainer(
                currentUrl = currentUrl,
                webViewState = webViewState,
                syncWebView = null, // ì „ì²´í™”ë©´ì—ì„œëŠ” sync ì—†ìŒ
                onWebViewCreated = onFullscreenWebViewCreated,
                onUrlChanged = onUrlChanged,
                onPageFinished = onPageFinished,
                onTitleReceived = onTitleReceived
            )
            
            // ì „ì²´í™”ë©´ ë„¤ë¹„ê²Œì´ì…˜ ë°”
            FullscreenNavigationBar(
                modifier = Modifier.align(androidx.compose.ui.Alignment.BottomCenter),
                canGoBack = canGoBack,
                canGoForward = canGoForward,
                isAnalyzing = isAnalyzing,
                onGoBack = onGoBack,
                onGoForward = onGoForward,
                onRefresh = onRefresh,
                onExitFullscreen = onExitFullscreen,
                onShowMp4List = { /* TODO: êµ¬í˜„ */ }
            )
        }
    }

    // Helper í•¨ìˆ˜ë“¤
    private fun handleLoadUrl() {
        webViewViewModel.loadUrl(null, webViewViewModel.urlText.value)
    }

    private fun handleReset() {
        mainViewModel.resetState()
        webViewViewModel.resetAll()
    }

    private fun handleRefresh(webView: WebView? = null) {
        webView?.let { 
            mainViewModel.startVideoAnalysis(it) 
        }
    }

    private fun handlePageFinished(webView: WebView? = null) {
        webView?.let { 
            mainViewModel.startVideoAnalysis(it) 
        }
    }

    private fun handleEnterFullscreen(mainWebView: WebView?) {
        webViewViewModel.saveWebViewState(mainWebView)
        webViewViewModel.setFullscreen(true)
        FullscreenManager.setFullscreenMode(this, true)
    }

    private fun handleExitFullscreen(mainWebView: WebView?, fullscreenWebView: WebView?) {
        webViewViewModel.saveWebViewState(fullscreenWebView)
        webViewViewModel.setFullscreen(false)
        FullscreenManager.setFullscreenMode(this, false)
    }
}
</file>

<file path="app/src/test/java/com/swvd/simplewebvideodownloader/download/DownloadHandlerTest.kt">
package com.swvd.simplewebvideodownloader.download

import android.content.Context
import android.content.pm.PackageManager
import android.os.Build
import androidx.core.content.ContextCompat
import io.mockk.every
import io.mockk.mockk
import io.mockk.mockkStatic
import io.mockk.unmockkStatic
import org.junit.After
import org.junit.Assert.*
import org.junit.Before
import org.junit.Test
import org.junit.runner.RunWith
import org.robolectric.RobolectricTestRunner
import org.robolectric.annotation.Config

/**
 * DownloadHandler ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
 * ë‹¤ìš´ë¡œë“œ í•¸ë“¤ëŸ¬ì˜ í•µì‹¬ ê¸°ëŠ¥ì„ ê²€ì¦
 */
@RunWith(RobolectricTestRunner::class)
@Config(sdk = [Build.VERSION_CODES.P])
class DownloadHandlerTest {

    private lateinit var downloadHandler: DownloadHandler
    private val mockContext: Context = mockk()

    @Before
    fun setUp() {
        mockkStatic(ContextCompat::class)
        downloadHandler = DownloadHandler(mockContext)
    }

    @After
    fun tearDown() {
        unmockkStatic(ContextCompat::class)
    }

    @Test
    fun `URL ìœ íš¨ì„± ê²€ì‚¬ - ì˜¬ë°”ë¥¸ HTTP URL`() {
        // Given
        val validHttpUrl = "http://example.com/video.mp4"
        
        // When
        val result = downloadHandler.isValidUrl(validHttpUrl)
        
        // Then
        assertTrue("HTTP URLì€ ìœ íš¨í•´ì•¼ í•¨", result)
    }

    @Test
    fun `URL ìœ íš¨ì„± ê²€ì‚¬ - ì˜¬ë°”ë¥¸ HTTPS URL`() {
        // Given
        val validHttpsUrl = "https://example.com/video.mp4"
        
        // When
        val result = downloadHandler.isValidUrl(validHttpsUrl)
        
        // Then
        assertTrue("HTTPS URLì€ ìœ íš¨í•´ì•¼ í•¨", result)
    }

    @Test
    fun `URL ìœ íš¨ì„± ê²€ì‚¬ - ì˜ëª»ëœ URL`() {
        // Given
        val invalidUrls = listOf(
            "ftp://example.com/video.mp4",
            "example.com/video.mp4",
            "//example.com/video.mp4",
            "",
            "   ",
            "invalid-url"
        )
        
        // When & Then
        invalidUrls.forEach { url ->
            val result = downloadHandler.isValidUrl(url)
            assertFalse("ì˜ëª»ëœ URLì€ ë¬´íš¨í•´ì•¼ í•¨: $url", result)
        }
    }

    @Test
    fun `íŒŒì¼ëª… ìƒì„± - ì •ìƒì ì¸ MP4 URL`() {
        // Given
        val urlWithMp4 = "https://example.com/videos/sample.mp4"
        
        // When
        val filename = downloadHandler.generateFilename(urlWithMp4)
        
        // Then
        assertEquals("sample.mp4", filename)
    }

    @Test
    fun `íŒŒì¼ëª… ìƒì„± - MP4 í™•ì¥ì ì—†ëŠ” URL`() {
        // Given
        val urlWithoutMp4 = "https://example.com/videos/sample"
        
        // When
        val filename = downloadHandler.generateFilename(urlWithoutMp4)
        
        // Then
        assertEquals("sample.mp4", filename)
    }

    @Test
    fun `íŒŒì¼ëª… ìƒì„± - ê²½ë¡œ ì—†ëŠ” URL`() {
        // Given
        val urlWithoutPath = "https://example.com"
        
        // When
        val filename = downloadHandler.generateFilename(urlWithoutPath)
        
        // Then
        assertTrue("íƒ€ì„ìŠ¤íƒ¬í”„ê°€ í¬í•¨ëœ íŒŒì¼ëª… ìƒì„±", filename.startsWith("video_"))
        assertTrue("MP4 í™•ì¥ì í¬í•¨", filename.endsWith(".mp4"))
    }

    @Test
    fun `íŒŒì¼ëª… ìƒì„± - ì˜ëª»ëœ URL`() {
        // Given
        val invalidUrl = "invalid-url"
        
        // When
        val filename = downloadHandler.generateFilename(invalidUrl)
        
        // Then
        assertTrue("ì˜ëª»ëœ URLë„ ì•ˆì „í•œ íŒŒì¼ëª… ìƒì„±", filename.startsWith("video_"))
        assertTrue("MP4 í™•ì¥ì í¬í•¨", filename.endsWith(".mp4"))
    }

    @Test
    fun `ê¶Œí•œ í™•ì¸ - Android 10 ì´í•˜ì—ì„œ ê¶Œí•œ ì—†ìŒ`() {
        // Given
        every { 
            ContextCompat.checkSelfPermission(mockContext, android.Manifest.permission.WRITE_EXTERNAL_STORAGE) 
        } returns PackageManager.PERMISSION_DENIED
        
        // When
        val permissions = downloadHandler.checkStoragePermissions()
        
        // Then
        assertTrue("WRITE_EXTERNAL_STORAGE ê¶Œí•œì´ í•„ìš”í•¨", 
            permissions.contains(android.Manifest.permission.WRITE_EXTERNAL_STORAGE))
    }

    @Test
    fun `ê¶Œí•œ í™•ì¸ - Android 10 ì´í•˜ì—ì„œ ê¶Œí•œ ìˆìŒ`() {
        // Given
        every { 
            ContextCompat.checkSelfPermission(mockContext, android.Manifest.permission.WRITE_EXTERNAL_STORAGE) 
        } returns PackageManager.PERMISSION_GRANTED
        
        // When
        val permissions = downloadHandler.checkStoragePermissions()
        
        // Then
        assertTrue("ê¶Œí•œì´ ìˆìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜", permissions.isEmpty())
    }

    @Test
    fun `íŒŒì¼ëª… ìƒì„± - ê³µë°± ë¬¸ì í¬í•¨ URL`() {
        // Given
        val urlWithSpaces = "  https://example.com/video file.mp4  "
        
        // When
        val filename = downloadHandler.generateFilename(urlWithSpaces)
        
        // Then
        assertEquals("video file.mp4", filename)
    }

    @Test
    fun `íŒŒì¼ëª… ìƒì„± - íŠ¹ìˆ˜ ë¬¸ì í¬í•¨ URL`() {
        // Given
        val urlWithSpecialChars = "https://example.com/video%20file.mp4"
        
        // When
        val filename = downloadHandler.generateFilename(urlWithSpecialChars)
        
        // Then
        assertEquals("video%20file.mp4", filename)
    }
}
</file>

<file path="docs/repomix-output.xml">
This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.cursor/
  rules/
    android-development-best-practices.mdc
    kotlin-compose-safety.mdc
    prompt-engineering-guidelines.mdc
app/
  src/
    androidTest/
      java/
        com/
          swvd/
            simplewebvideodownloader/
              ExampleInstrumentedTest.kt
    main/
      java/
        com/
          swvd/
            simplewebvideodownloader/
              download/
                DownloadHandler.kt
              models/
                Tab.kt
              ui/
                components/
                  DialogComponents.kt
                  TabComponents.kt
                screens/
                  FullscreenScreen.kt
                theme/
                  Color.kt
                  Theme.kt
                  Type.kt
              utils/
                FullscreenManager.kt
              webview/
                Mp4Analyzer.kt
              MainActivity.kt
      res/
        drawable/
          ic_launcher_background.xml
          ic_launcher_foreground.xml
        mipmap-anydpi-v26/
          ic_launcher.xml
        values/
          colors.xml
          strings.xml
          themes.xml
        xml/
          backup_rules.xml
          data_extraction_rules.xml
      AndroidManifest.xml
    test/
      java/
        com/
          swvd/
            simplewebvideodownloader/
              ExampleUnitTest.kt
  .gitignore
  build.gradle.kts
  proguard-rules.pro
gradle/
  wrapper/
    gradle-wrapper.properties
  libs.versions.toml
.gitignore
build.gradle.kts
CLAUDE.md
gradle.properties
gradlew
gradlew.bat
LICENSE
README.md
settings.gradle.kts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".cursor/rules/android-development-best-practices.mdc">
---
description: 
globs: 
alwaysApply: false
---
# Android Development Best Practices & Error Prevention

## Critical Function Context Awareness

### 1. Function Reference vs Lambda Distinction
**ALWAYS** verify function signature compatibility when using function references (`::functionName`):
- âŒ WRONG: `onLoadUrl = ::loadUrl` when loadUrl() takes no parameters but callback expects (String) -> Unit
- âœ… CORRECT: `onLoadUrl = { url -> loadUrl(url) }` or implement proper parameter handling

**Rule**: Before using `::` function reference, verify parameter count and types match exactly.

### 2. Composable Context Validation
**NEVER** call @Composable functions outside of @Composable context:
- âŒ WRONG: Calling Composable functions inside AndroidView factory lambdas
- âœ… CORRECT: Use WebView.loadUrl() method explicitly with `this.loadUrl(url)`

**Template for WebView factory**:
```kotlin
AndroidView(
    factory = { context ->
        WebView(context).apply {
            // Use this.loadUrl() for WebView method
            // NOT loadUrl() which might reference @Composable function
        }
    }
)
```

## Build System & Import Management

### 3. Progressive Import Addition
When adding new UI components, add imports incrementally:
1. First add core UI imports (BorderStroke, icons)
2. Test compilation after each major component addition
3. Never add all imports at once without verification

**Required imports checklist for new UI components**:
- `androidx.compose.foundation.BorderStroke` for Card borders
- `androidx.compose.material.icons.filled.*` for specific icons
- `androidx.compose.foundation.lazy.grid.*` for grid layouts

### 4. Version Management Strategy
**ALWAYS** increment version numbers when adding major features:
- Minor UI changes: patch version (5.2.1)
- New feature components: minor version (5.3.0)
- Major UI overhauls: major version (6.0.0)

## UI Component Architecture

### 5. Component Parameter Validation
When creating new @Composable functions with many parameters:
1. **ALWAYS** verify all callback functions are properly typed
2. Use explicit lambda syntax for complex callbacks
3. Test component isolation before integration

**Template for complex UI components**:
```kotlin
@Composable
fun ComplexUI(
    // State parameters first
    state: UIState,
    // Simple callbacks second  
    onSimpleAction: () -> Unit,
    // Complex callbacks with explicit types
    onComplexAction: (param: Type) -> Unit,
    // Content composables last
    content: @Composable () -> Unit
)
```

### 6. State Management Validation
Before implementing new UI features:
1. Identify ALL state variables needed
2. Define state update functions explicitly
3. Verify state synchronization between components

**State checklist for tabbed UI**:
- Tab list state
- Current tab index
- Tab overview visibility
- URL editing state
- History dropdown state

## Error Recovery Patterns

### 7. Compilation Error Debugging Process
When compilation fails:
1. **STOP** and read error messages completely
2. Identify error categories: type mismatch, context issues, missing imports
3. Fix ONE category at a time
4. Test compilation after each fix category

### 8. WebView Integration Safety
**ALWAYS** distinguish between:
- WebView native methods (use `this.methodName()`)
- Custom Composable functions (use proper context)
- State management functions (verify @Composable context)

## Code Review Checklist

Before committing new UI features:
- [ ] All function references use correct syntax
- [ ] No @Composable functions called outside @Composable context  
- [ ] All required imports are present
- [ ] Version number is incremented appropriately
- [ ] Build succeeds without errors
- [ ] UI components are properly isolated and testable

## Emergency Rollback Protocol

If major UI changes cause compilation issues:
1. **IMMEDIATELY** test build after each significant change
2. Use git tags for stable versions (`v5.1`, `v5.2`)
3. Keep incremental commits for easy rollback
4. Never combine multiple major changes in single commit

**Rollback command template**:
```bash
git reset --hard v[last-working-version]
git checkout -b fix/[issue-description]
# Implement changes incrementally
```

## Learning Integration

### Apply Error Analysis
1. **Document** each error type encountered
2. **Categorize** errors: syntax, context, architecture
3. **Create** specific rules for each error category
4. **Review** rules before similar development tasks

This rule system ensures systematic error prevention and promotes clean, maintainable Android Compose code architecture.
</file>

<file path=".cursor/rules/kotlin-compose-safety.mdc">
---
description: 
globs: 
alwaysApply: true
---
# Kotlin Compose Safety Guidelines & Error Prevention

## Function Reference Safety Patterns

### 1. Method Reference Validation Protocol
**CRITICAL**: Always verify parameter signatures before using `::` syntax

**Safe Pattern**:
```kotlin
// âŒ DANGEROUS - Parameter mismatch
onCallback = ::functionWithNoParams  // when callback expects (String) -> Unit

// âœ… SAFE - Explicit lambda with proper parameters
onCallback = { param -> functionWithNoParams() }
// OR implement function to accept parameters
onCallback = ::functionWithCorrectSignature
```

**Verification Checklist**:
- [ ] Count parameters: callback signature vs function signature
- [ ] Check parameter types: exact type matching required
- [ ] Verify return types: Unit vs specific return types
- [ ] Test with simple lambda first, then optimize to method reference

### 2. Composable Context Isolation
**NEVER** mix Android View methods with Composable functions

**Reference pattern in [MainActivity.kt](mdc:app/src/main/java/com/swvd/simplewebvideodownloader/MainActivity.kt)**:
```kotlin
AndroidView(
    factory = { context ->
        WebView(context).apply {
            // âœ… CORRECT - Use Android View methods explicitly
            this.loadUrl(url)
            
            // âŒ WRONG - Don't call Composable functions here
            // loadUrl(url)  // This might reference @Composable function
        }
    }
)
```

## State Management Safety

### 3. State Synchronization Validation
When managing complex UI state, ensure all state variables are properly initialized:

**Required state variables for complex UI (based on FullscreenUI implementation)**:
```kotlin
// Tab management state
var tabs by remember { mutableStateOf(listOf(Tab())) }
var currentTabIndex by remember { mutableIntStateOf(0) }

// UI mode state  
var showTabOverview by remember { mutableStateOf(false) }
var isEditingUrl by remember { mutableStateOf(false) }

// Content state
var urlText by remember { mutableStateOf("") }
var currentUrl by remember { mutableStateOf("") }
```

### 4. Lambda Parameter Handling
For complex callback implementations, use explicit parameter handling:

**Template from successful FullscreenUI implementation**:
```kotlin
onLoadUrl = { url ->
    // Step 1: Input validation and URL formatting
    val finalUrl = if (!url.startsWith("http://") && !url.startsWith("https://")) {
        "https://$url"
    } else {
        url
    }
    
    // Step 2: State updates
    currentUrl = finalUrl
    urlText = finalUrl
    
    // Step 3: Complex state synchronization
    currentTab?.let { tab ->
        tabs = tabs.map {
            if (it.id == tab.id) it.copy(url = finalUrl)
            else it
        }
    }
    
    // Step 4: Side effects (WebView, history, etc.)
    fullscreenWebView?.loadUrl(finalUrl)
    
    // Step 5: Async operations
    Handler(Looper.getMainLooper()).postDelayed({
        analyzePageForMp4()
    }, 1000)
}
```

## Import Management Safety

### 5. Progressive Import Strategy
Add imports in dependency order to avoid missing import errors:

**Phase 1 - Foundation**:
```kotlin
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
```

**Phase 2 - Layout**:
```kotlin
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
```

**Phase 3 - Material**:
```kotlin
import androidx.compose.material.icons.filled.Check
import androidx.compose.material.icons.filled.Info
import androidx.compose.material3.*
```

### 6. Icon Compatibility Safety
**WARNING**: Some Material Icons are deprecated. Use safe alternatives:

```kotlin
// âš ï¸  DEPRECATED (causes warnings)
Icons.Filled.ArrowBack
Icons.Filled.ArrowForward

// âœ… SAFE ALTERNATIVES
Icons.Default.ArrowBack  // Generic version
Icons.AutoMirrored.Filled.ArrowBack  // New recommended version
```

## Component Architecture Safety

### 7. Large Component Parameter Validation
For components with many parameters (like FullscreenUI), group parameters logically:

**Safe parameter grouping pattern**:
```kotlin
@Composable
fun ComplexComponent(
    // Group 1: Core state
    tabs: List<Tab>,
    currentTabIndex: Int,
    currentUrl: String,
    
    // Group 2: UI state  
    showOverview: Boolean,
    isEditing: Boolean,
    
    // Group 3: Simple callbacks
    onSimpleAction: () -> Unit,
    onStateChange: (Boolean) -> Unit,
    
    // Group 4: Complex callbacks with explicit types
    onComplexAction: (String) -> Unit,
    onMultiParamAction: (Int, String) -> Unit,
    
    // Group 5: Composable content
    content: @Composable () -> Unit
)
```

### 8. WebView Integration Safety
**ALWAYS** distinguish between WebView instance methods and app functions:

```kotlin
// âœ… SAFE - WebView instance method
webView.loadUrl(url)
this.loadUrl(url)  // Inside WebView.apply block

// âŒ DANGEROUS - Might reference wrong function
loadUrl(url)  // Could be Composable function

// âœ… SAFE - App function with proper context
loadUrlInApp(url)  // Clear naming prevents confusion
```

## Error Recovery Patterns

### 9. Compilation Error Triage
When build fails, fix errors in this priority order:

1. **Import errors** - Missing or incorrect imports
2. **Type mismatch errors** - Function signature incompatibilities  
3. **Context errors** - @Composable function calls in wrong context
4. **Scope errors** - Variable access outside proper scope

### 10. Git Safety for Complex UI Changes
Before implementing complex UI features:

```bash
# Create feature branch
git checkout -b feature/new-ui-component

# Commit working state first
git add .
git commit -m "Working state before UI changes"

# Tag for easy rollback
git tag before-ui-changes

# Implement changes incrementally with frequent commits
git commit -m "Add basic component structure"
git commit -m "Add state management"  
git commit -m "Add interactions"
```

## Testing & Validation Safety

### 11. Incremental Build Validation
After each major change:
- [ ] Clean build: `./gradlew clean`
- [ ] Compile check: `./gradlew compileDebugKotlin`
- [ ] Full build: `./gradlew assembleDebug`
- [ ] Runtime test: Install and basic functionality check

### 12. Component Isolation Testing
Before integrating complex components:
1. Create minimal test implementation
2. Verify basic rendering
3. Test state changes
4. Validate callbacks
5. Check error conditions

This safety framework prevents common Kotlin Compose errors and ensures reliable development progression.
</file>

<file path=".cursor/rules/prompt-engineering-guidelines.mdc">
---
description: 
globs: 
alwaysApply: true
---
# Prompt Engineering Guidelines for AI-Assisted Development

## Structured Communication Patterns

### 1. Requirement Specification Template
When requesting new features, ALWAYS use this structure:

```
CONTEXT: [Current state/version]
GOAL: [Specific desired outcome]
CONSTRAINTS: [Technical limitations, existing architecture]
ACCEPTANCE CRITERIA: [Measurable success conditions]
PRIORITY: [Critical/High/Medium/Low]
```

**Example**:
```
CONTEXT: v5.2 with basic tab functionality
GOAL: Full-screen UI with 5-button navigation layout
CONSTRAINTS: Must preserve existing WebView functionality
ACCEPTANCE CRITERIA: URL editing, tab overview, 5 navigation buttons working
PRIORITY: High
```

### 2. Progressive Feature Development Protocol
**NEVER** request complex features in single iteration:

1. **Phase 1**: Core structure and basic UI
2. **Phase 2**: State management and interactions  
3. **Phase 3**: Advanced features and polish
4. **Phase 4**: Testing and optimization

### 3. Error Context Enrichment
When reporting errors, provide:
- **Exact error messages** (copy-paste)
- **File location** (line numbers)
- **Expected behavior** vs actual behavior
- **Recent changes** that might be related

## AI Collaboration Optimization

### 4. Code Review Request Format
Structure code review requests with specific focus areas:

```
REVIEW FOCUS:
- [ ] Function signature compatibility
- [ ] @Composable context safety
- [ ] Import completeness
- [ ] State management patterns
- [ ] Error handling coverage

SPECIFIC CONCERNS:
[List specific areas of uncertainty]
```

### 5. Incremental Validation Strategy
**ALWAYS** request AI to:
1. Validate approach BEFORE implementation
2. Break complex changes into reviewable chunks
3. Provide checkpoint verification steps
4. Include rollback instructions for each phase

### 6. Knowledge Transfer Documentation
When AI provides solutions, request:
- **Why** this approach was chosen
- **What** alternatives were considered
- **How** to modify for similar future cases
- **When** this pattern should/shouldn't be used

## Quality Assurance Integration

### 7. Pre-Implementation Verification
Before requesting implementation, AI should confirm:
- [ ] Understanding of current architecture (reference [MainActivity.kt](mdc:app/src/main/java/com/swvd/simplewebvideodownloader/MainActivity.kt))
- [ ] Compatibility with existing build system (reference [build.gradle.kts](mdc:app/build.gradle.kts))
- [ ] Import requirements identification
- [ ] Testing strategy for new features

### 8. Build Verification Protocol
After each significant change, request AI to:
1. Predict potential compilation issues
2. Verify all required imports are present
3. Check function signature compatibility
4. Validate @Composable context usage

## Learning & Adaptation Patterns

### 9. Error Pattern Recognition
Maintain ongoing dialogue about:
- **Recurring error types** and their root causes
- **Successful patterns** that prevented errors
- **Architecture decisions** that simplified development
- **Tool usage** that improved efficiency

### 10. Contextual Memory Management
Help AI maintain context by:
- **Referencing** previous successful solutions
- **Linking** current issues to past similar problems
- **Updating** AI on project evolution and changes
- **Confirming** AI's understanding before complex operations

## Communication Efficiency Rules

### 11. Clarity Over Brevity
- Use specific technical terms correctly
- Provide complete context rather than assuming knowledge
- Ask for clarification when requirements are ambiguous
- Confirm understanding before proceeding with implementation

### 12. Iterative Refinement Process
Structure conversations for continuous improvement:
1. **Initial request** with clear requirements
2. **AI proposal** with approach explanation
3. **Human feedback** with specific adjustments
4. **Refined solution** with implementation plan
5. **Validation** of results and lessons learned

## Meta-Learning Integration

### 13. Rule Evolution Protocol
Regularly update these rules based on:
- **New error patterns** discovered in development
- **Successful collaboration** techniques that emerge
- **Tool capabilities** that improve over time
- **Project complexity** changes requiring adaptation

### 14. Knowledge Consolidation
After major development phases:
- Document successful patterns for reuse
- Identify ineffective approaches to avoid
- Update architectural guidelines based on experience
- Create project-specific rule extensions

This prompt engineering framework ensures efficient, error-free AI-assisted development while building cumulative knowledge for future projects.
</file>

<file path="app/src/androidTest/java/com/swvd/simplewebvideodownloader/ExampleInstrumentedTest.kt">
package com.swvd.simplewebvideodownloader

import androidx.test.platform.app.InstrumentationRegistry
import androidx.test.ext.junit.runners.AndroidJUnit4

import org.junit.Test
import org.junit.runner.RunWith

import org.junit.Assert.*

/**
 * Instrumented test, which will execute on an Android device.
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
@RunWith(AndroidJUnit4::class)
class ExampleInstrumentedTest {
    @Test
    fun useAppContext() {
        // Context of the app under test.
        val appContext = InstrumentationRegistry.getInstrumentation().targetContext
        assertEquals("com.swvd.simplewebvideodownloader", appContext.packageName)
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/download/DownloadHandler.kt">
package com.swvd.simplewebvideodownloader.download

import android.Manifest
import android.app.DownloadManager
import android.content.Context
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Environment
import android.widget.Toast
import androidx.core.content.ContextCompat

/**
 * íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬ í´ë˜ìŠ¤
 * MP4 ë¹„ë””ì˜¤ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì„ ë‹´ë‹¹
 */
class DownloadHandler(private val context: Context) {
    
    /**
     * ì €ì¥ì†Œ ê¶Œí•œ í™•ì¸
     * Android 10 ì´í•˜ì—ì„œë§Œ WRITE_EXTERNAL_STORAGE ê¶Œí•œ í•„ìš”
     */
    fun checkStoragePermissions(): List<String> {
        val permissions = mutableListOf<String>()
        
        // Android 10 (API 29) ì´í•˜ì—ì„œë§Œ WRITE_EXTERNAL_STORAGE ê¶Œí•œ í•„ìš”
        if (android.os.Build.VERSION.SDK_INT <= android.os.Build.VERSION_CODES.P) {
            if (ContextCompat.checkSelfPermission(context, Manifest.permission.WRITE_EXTERNAL_STORAGE)
                != PackageManager.PERMISSION_GRANTED) {
                permissions.add(Manifest.permission.WRITE_EXTERNAL_STORAGE)
            }
        }
        
        return permissions
    }
    
    /**
     * íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
     * @param url ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ URL
     * @param filename ì €ì¥í•  íŒŒì¼ëª…
     */
    fun downloadFile(url: String, filename: String) {
        try {
            // íŒŒì¼ëª…ì—ì„œ íŠ¹ìˆ˜ë¬¸ì ì œê±°
            val safeFilename = filename.replace(Regex("[^a-zA-Z0-9._-]"), "_")

            val request = DownloadManager.Request(Uri.parse(url))
                .setTitle("ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ")
                .setDescription("$safeFilename ë‹¤ìš´ë¡œë“œ ì¤‘...")
                .setNotificationVisibility(DownloadManager.Request.VISIBILITY_VISIBLE_NOTIFY_COMPLETED)
                .setAllowedOverMetered(true)
                .setAllowedOverRoaming(true)

            // Android 10 ì´ìƒì—ì„œëŠ” Downloads í´ë”ì— ì €ì¥
            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.Q) {
                request.setDestinationInExternalPublicDir(Environment.DIRECTORY_DOWNLOADS, safeFilename)
            } else {
                request.setDestinationInExternalPublicDir(Environment.DIRECTORY_DOWNLOADS, safeFilename)
            }

            val downloadManager = context.getSystemService(Context.DOWNLOAD_SERVICE) as DownloadManager
            val downloadId = downloadManager.enqueue(request)

            Toast.makeText(context, "ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤\níŒŒì¼: $safeFilename\nDownloads í´ë”ì— ì €ì¥ë©ë‹ˆë‹¤", Toast.LENGTH_LONG).show()

        } catch (e: Exception) {
            Toast.makeText(context, "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${e.message}", Toast.LENGTH_LONG).show()
        }
    }
    
    /**
     * URL ìœ íš¨ì„± ê²€ì‚¬
     * @param url ê²€ì‚¬í•  URL
     * @return ìœ íš¨í•œ URLì¸ì§€ ì—¬ë¶€
     */
    fun isValidUrl(url: String): Boolean {
        val cleanUrl = url.trim()
        return cleanUrl.startsWith("http://") || cleanUrl.startsWith("https://")
    }
    
    /**
     * íŒŒì¼ëª… ìƒì„±
     * URLì—ì„œ ì ì ˆí•œ íŒŒì¼ëª…ì„ ìƒì„±
     */
    fun generateFilename(url: String): String {
        return try {
            val uri = Uri.parse(url.trim())
            val pathSegment = uri.lastPathSegment
            when {
                pathSegment != null && pathSegment.contains(".mp4") -> pathSegment
                pathSegment != null -> "${pathSegment}.mp4"
                else -> "video_${System.currentTimeMillis()}.mp4"
            }
        } catch (e: Exception) {
            "video_${System.currentTimeMillis()}.mp4"
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/models/Tab.kt">
package com.swvd.simplewebvideodownloader.models

import java.util.UUID

/**
 * íƒ­ ë°ì´í„° ëª¨ë¸
 * ë¸Œë¼ìš°ì € íƒ­ì˜ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ë°ì´í„° í´ë˜ìŠ¤
 */
data class Tab(
    val id: String = UUID.randomUUID().toString(),
    var title: String = "ìƒˆ íƒ­",
    var url: String = "https://www.google.com"
)
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/components/DialogComponents.kt">
package com.swvd.simplewebvideodownloader.ui.components

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.interaction.MutableInteractionSource
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.itemsIndexed
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Check
import androidx.compose.material.icons.filled.Close
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp

/**
 * MP4 ëª©ë¡ ë‹¤ì´ì–¼ë¡œê·¸
 * ê°ì§€ëœ MP4 ë¹„ë””ì˜¤ ëª©ë¡ì„ í‘œì‹œí•˜ê³  ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆëŠ” ë‹¤ì´ì–¼ë¡œê·¸
 */
@Composable
fun Mp4ListDialog(
    mp4Links: List<String>,
    downloadingUrls: Set<String>,
    onDownload: (String) -> Unit,
    onDismiss: () -> Unit
) {
    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.Black.copy(alpha = 0.5f))
            .clickable(
                interactionSource = remember { MutableInteractionSource() },
                indication = null
            ) { onDismiss() },
        contentAlignment = Alignment.Center
    ) {
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp)
                .heightIn(max = 400.dp),
            shape = RoundedCornerShape(16.dp),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surface
            ),
            elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)
        ) {
            Column(
                modifier = Modifier.padding(16.dp)
            ) {
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(
                        text = "MP4 ë¹„ë””ì˜¤ ëª©ë¡",
                        style = MaterialTheme.typography.titleMedium,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                    Text(
                        text = "(${mp4Links.size}ê°œ)",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.7f)
                    )
                }
                
                Spacer(modifier = Modifier.height(16.dp))
                
                if (mp4Links.isEmpty()) {
                    Text(
                        text = "MP4 ë¹„ë””ì˜¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë‹¤ë¥¸ í˜ì´ì§€ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.7f),
                        modifier = Modifier.padding(vertical = 16.dp)
                    )
                } else {
                    LazyColumn(
                        verticalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        itemsIndexed(mp4Links) { index, url ->
                            val isDownloading = downloadingUrls.contains(url)
                            
                            Card(
                                modifier = Modifier.fillMaxWidth(),
                                colors = CardDefaults.cardColors(
                                    containerColor = if (isDownloading) 
                                        MaterialTheme.colorScheme.primaryContainer.copy(alpha = 0.3f)
                                    else 
                                        MaterialTheme.colorScheme.surfaceVariant
                                )
                            ) {
                                Column(
                                    modifier = Modifier.padding(12.dp)
                                ) {
                                    Text(
                                        text = "ë¹„ë””ì˜¤ ${index + 1}",
                                        style = MaterialTheme.typography.titleSmall,
                                        color = MaterialTheme.colorScheme.onSurfaceVariant,
                                        modifier = Modifier.padding(bottom = 4.dp)
                                    )
                                    
                                    Text(
                                        text = url.let { 
                                            when {
                                                it.length <= 50 -> it
                                                else -> "${it.take(25)}...${it.takeLast(22)}"
                                            }
                                        },
                                        style = MaterialTheme.typography.bodySmall,
                                        color = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.8f),
                                        maxLines = 2,
                                        overflow = TextOverflow.Ellipsis,
                                        modifier = Modifier.padding(bottom = 8.dp)
                                    )
                                    
                                    Button(
                                        onClick = { onDownload(url) },
                                        enabled = !isDownloading,
                                        modifier = Modifier.fillMaxWidth()
                                    ) {
                                        if (isDownloading) {
                                            CircularProgressIndicator(
                                                modifier = Modifier.size(16.dp),
                                                color = MaterialTheme.colorScheme.onPrimary
                                            )
                                            Spacer(modifier = Modifier.width(8.dp))
                                            Text("ë‹¤ìš´ë¡œë“œ ì¤‘...")
                                        } else {
                                            Text("ë‹¤ìš´ë¡œë“œ")
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                Spacer(modifier = Modifier.height(16.dp))
                
                Button(
                    onClick = onDismiss,
                    modifier = Modifier.fillMaxWidth()
                ) {
                    Text("ë‹«ê¸°")
                }
            }
        }
    }
}

/**
 * ë‹¤ìš´ë¡œë“œ ê²°ê³¼ ì•Œë¦¼ ë‹¤ì´ì–¼ë¡œê·¸
 * ë‹¤ìš´ë¡œë“œ ì„±ê³µ/ì‹¤íŒ¨ ê²°ê³¼ë¥¼ í‘œì‹œí•˜ëŠ” ë‹¤ì´ì–¼ë¡œê·¸
 */
@Composable
fun DownloadResultDialog(
    message: String,
    onDismiss: () -> Unit
) {
    // ìë™ìœ¼ë¡œ ì‚¬ë¼ì§€ë„ë¡ LaunchedEffect ì‚¬ìš©
    LaunchedEffect(message) {
        kotlinx.coroutines.delay(if (message.contains("ì‹¤íŒ¨")) 5000 else 3000)
        onDismiss()
    }

    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.Black.copy(alpha = 0.4f))
            .clickable(
                interactionSource = remember { MutableInteractionSource() },
                indication = null
            ) { onDismiss() },
        contentAlignment = Alignment.Center
    ) {
        Card(
            modifier = Modifier
                .padding(32.dp)
                .widthIn(min = 280.dp, max = 400.dp)
                .clickable(
                    interactionSource = remember { MutableInteractionSource() },
                    indication = null
                ) { /* ì¹´ë“œ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€ */ },
            shape = RoundedCornerShape(16.dp),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surface
            ),
            elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)
        ) {
            Column(
                modifier = Modifier.padding(24.dp),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                // ì•„ì´ì½˜ (ì„±ê³µ/ì‹¤íŒ¨ì— ë”°ë¼)
                Icon(
                    imageVector = if (message.contains("ì‹¤íŒ¨")) Icons.Default.Close else Icons.Default.Check,
                    contentDescription = null,
                    modifier = Modifier.size(48.dp),
                    tint = if (message.contains("ì‹¤íŒ¨")) 
                        MaterialTheme.colorScheme.error 
                    else 
                        MaterialTheme.colorScheme.primary
                )
                
                Spacer(modifier = Modifier.height(16.dp))
                
                // ë©”ì‹œì§€
                Text(
                    text = message,
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurface,
                    textAlign = TextAlign.Center,
                    lineHeight = 20.sp
                )
                
                Spacer(modifier = Modifier.height(20.dp))
                
                // í™•ì¸ ë²„íŠ¼
                Button(
                    onClick = onDismiss,
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.buttonColors(
                        containerColor = if (message.contains("ì‹¤íŒ¨")) 
                            MaterialTheme.colorScheme.error 
                        else 
                            MaterialTheme.colorScheme.primary
                    )
                ) {
                    Text("í™•ì¸")
                }
            }
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/components/TabComponents.kt">
package com.swvd.simplewebvideodownloader.ui.components

import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyRow
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
import androidx.compose.foundation.lazy.grid.itemsIndexed
import androidx.compose.foundation.lazy.itemsIndexed
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Add
import androidx.compose.material.icons.filled.Close
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.swvd.simplewebvideodownloader.models.Tab

/**
 * íƒ­ë°” ì»´í¬ë„ŒíŠ¸
 * ìƒë‹¨ì— í‘œì‹œë˜ëŠ” íƒ­ ëª©ë¡ê³¼ ìƒˆ íƒ­ ë²„íŠ¼
 */
@Composable
fun TabBar(
    tabs: List<Tab>,
    currentTabIndex: Int,
    onNewTab: () -> Unit,
    onCloseTab: (Int) -> Unit,
    onSwitchTab: (Int) -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier.fillMaxWidth(),
        elevation = CardDefaults.cardElevation(defaultElevation = 4.dp),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surfaceContainer
        )
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(8.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            // íƒ­ ëª©ë¡
            LazyRow(
                modifier = Modifier.weight(1f),
                horizontalArrangement = Arrangement.spacedBy(4.dp)
            ) {
                itemsIndexed(tabs) { index, tab ->
                    TabItem(
                        tab = tab,
                        isSelected = index == currentTabIndex,
                        onClick = { onSwitchTab(index) },
                        onClose = if (tabs.size > 1) { { onCloseTab(index) } } else null
                    )
                }
            }
            
            // ìƒˆ íƒ­ ë²„íŠ¼
            IconButton(
                onClick = onNewTab,
                modifier = Modifier.padding(start = 8.dp)
            ) {
                Icon(
                    Icons.Default.Add, 
                    contentDescription = "ìƒˆ íƒ­",
                    tint = MaterialTheme.colorScheme.primary
                )
            }
            
            // íƒ­ ê°œìˆ˜ í‘œì‹œ
            Card(
                modifier = Modifier.padding(start = 4.dp),
                colors = CardDefaults.cardColors(
                    containerColor = MaterialTheme.colorScheme.primary
                )
            ) {
                Text(
                    text = "${tabs.size}",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onPrimary,
                    modifier = Modifier.padding(horizontal = 8.dp, vertical = 4.dp)
                )
            }
        }
    }
}

/**
 * ê°œë³„ íƒ­ ì•„ì´í…œ ì»´í¬ë„ŒíŠ¸
 * íƒ­ë°”ì—ì„œ ê° íƒ­ì„ í‘œì‹œí•˜ëŠ” ì»´í¬ë„ŒíŠ¸
 */
@Composable
fun TabItem(
    tab: Tab,
    isSelected: Boolean,
    onClick: () -> Unit,
    onClose: (() -> Unit)?,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier
            .clickable { onClick() }
            .widthIn(min = 100.dp, max = 180.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = if (isSelected) 4.dp else 2.dp),
        colors = CardDefaults.cardColors(
            containerColor = if (isSelected) 
                MaterialTheme.colorScheme.primaryContainer 
            else 
                MaterialTheme.colorScheme.surface
        )
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(8.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Column(
                modifier = Modifier.weight(1f)
            ) {
                Text(
                    text = if (tab.title.isNotBlank() && tab.title != "ìƒˆ íƒ­") tab.title else "ìƒˆ íƒ­",
                    style = MaterialTheme.typography.bodySmall,
                    maxLines = 1,
                    overflow = TextOverflow.Ellipsis,
                    fontSize = 11.sp,
                    color = if (isSelected) 
                        MaterialTheme.colorScheme.onPrimaryContainer 
                    else 
                        MaterialTheme.colorScheme.onSurface
                )
                Text(
                    text = tab.url.take(25) + if (tab.url.length > 25) "..." else "",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                    maxLines = 1,
                    overflow = TextOverflow.Ellipsis,
                    fontSize = 9.sp
                )
            }
            
            onClose?.let {
                IconButton(
                    onClick = it,
                    modifier = Modifier.size(18.dp)
                ) {
                    Icon(
                        Icons.Default.Close,
                        contentDescription = "íƒ­ ë‹«ê¸°",
                        modifier = Modifier.size(12.dp),
                        tint = MaterialTheme.colorScheme.error
                    )
                }
            }
        }
    }
}

/**
 * íƒ­ ì˜¤ë²„ë·° í™”ë©´
 * ëª¨ë“  íƒ­ì„ ê²©ìë¡œ í‘œì‹œí•˜ëŠ” í™”ë©´
 */
@Composable
fun TabOverviewScreen(
    tabs: List<Tab>,
    currentTabIndex: Int,
    onTabSelected: (Int) -> Unit,
    onTabClosed: (Int) -> Unit,
    onAddNewTab: () -> Unit,
    onBackToWebView: () -> Unit
) {
    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(MaterialTheme.colorScheme.background)
            .windowInsetsPadding(WindowInsets.systemBars)
            .padding(16.dp)
    ) {
        // ìƒë‹¨ ë°”
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = "íƒ­ ${tabs.size}ê°œ",
                style = MaterialTheme.typography.headlineSmall
            )
            IconButton(onClick = onBackToWebView) {
                Icon(Icons.Default.Close, "ë‹«ê¸°")
            }
        }

        Spacer(modifier = Modifier.height(16.dp))

        // íƒ­ ê·¸ë¦¬ë“œ
        LazyVerticalGrid(
            columns = GridCells.Fixed(2),
            verticalArrangement = Arrangement.spacedBy(16.dp),
            horizontalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // ê¸°ì¡´ íƒ­ë“¤
            itemsIndexed(tabs) { index, tab ->
                TabCard(
                    tab = tab,
                    isCurrentTab = index == currentTabIndex,
                    onClick = { onTabSelected(index) },
                    onClose = { onTabClosed(index) }
                )
            }

            // ìƒˆ íƒ­ ì¶”ê°€ ì¹´ë“œ
            item {
                AddTabCard(onClick = onAddNewTab)
            }
        }
    }
}

/**
 * íƒ­ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸
 * íƒ­ ì˜¤ë²„ë·°ì—ì„œ ê° íƒ­ì„ í‘œì‹œí•˜ëŠ” ì¹´ë“œ
 */
@Composable
fun TabCard(
    tab: Tab,
    isCurrentTab: Boolean,
    onClick: () -> Unit,
    onClose: () -> Unit
) {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .height(120.dp)
            .clickable { onClick() },
        colors = CardDefaults.cardColors(
            containerColor = if (isCurrentTab) 
                MaterialTheme.colorScheme.primaryContainer 
            else 
                MaterialTheme.colorScheme.surfaceVariant
        )
    ) {
        Box(modifier = Modifier.fillMaxSize()) {
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(12.dp),
                verticalArrangement = Arrangement.SpaceBetween
            ) {
                Text(
                    text = tab.title,
                    style = MaterialTheme.typography.bodyMedium,
                    maxLines = 2,
                    overflow = TextOverflow.Ellipsis,
                    color = if (isCurrentTab) 
                        MaterialTheme.colorScheme.onPrimaryContainer 
                    else 
                        MaterialTheme.colorScheme.onSurfaceVariant
                )
                
                Text(
                    text = tab.url.takeIf { it.isNotEmpty() } ?: "ìƒˆ íƒ­",
                    style = MaterialTheme.typography.bodySmall,
                    maxLines = 1,
                    overflow = TextOverflow.Ellipsis,
                    color = if (isCurrentTab) 
                        MaterialTheme.colorScheme.onPrimaryContainer.copy(alpha = 0.7f) 
                    else 
                        MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.7f)
                )
            }

            // ë‹«ê¸° ë²„íŠ¼
            IconButton(
                onClick = onClose,
                modifier = Modifier.align(Alignment.TopEnd)
            ) {
                Icon(
                    Icons.Default.Close,
                    contentDescription = "íƒ­ ë‹«ê¸°",
                    modifier = Modifier.size(16.dp),
                    tint = MaterialTheme.colorScheme.error
                )
            }

            // í˜„ì¬ íƒ­ í‘œì‹œ
            if (isCurrentTab) {
                Surface(
                    modifier = Modifier
                        .align(Alignment.BottomStart)
                        .padding(8.dp),
                    shape = RoundedCornerShape(4.dp),
                    color = MaterialTheme.colorScheme.primary
                ) {
                    Text(
                        text = "í˜„ì¬",
                        modifier = Modifier.padding(horizontal = 6.dp, vertical = 2.dp),
                        style = MaterialTheme.typography.labelSmall,
                        color = MaterialTheme.colorScheme.onPrimary
                    )
                }
            }
        }
    }
}

/**
 * ìƒˆ íƒ­ ì¶”ê°€ ì¹´ë“œ
 * íƒ­ ì˜¤ë²„ë·°ì—ì„œ ìƒˆ íƒ­ì„ ì¶”ê°€í•  ìˆ˜ ìˆëŠ” ì¹´ë“œ
 */
@Composable
fun AddTabCard(onClick: () -> Unit) {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .height(120.dp)
            .clickable { onClick() },
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.secondaryContainer
        ),
        border = BorderStroke(
            1.dp, 
            MaterialTheme.colorScheme.outline.copy(alpha = 0.3f)
        )
    ) {
        Box(
            modifier = Modifier.fillMaxSize(),
            contentAlignment = Alignment.Center
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Icon(
                    Icons.Default.Add,
                    "ìƒˆ íƒ­ ì¶”ê°€",
                    modifier = Modifier.size(32.dp),
                    tint = MaterialTheme.colorScheme.onSecondaryContainer
                )
                Spacer(modifier = Modifier.height(8.dp))
                Text(
                    text = "ìƒˆ íƒ­",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSecondaryContainer
                )
            }
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/screens/FullscreenScreen.kt">
package com.swvd.simplewebvideodownloader.ui.screens

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.KeyboardActions
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.input.ImeAction
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import com.swvd.simplewebvideodownloader.models.Tab
import com.swvd.simplewebvideodownloader.ui.components.TabOverviewScreen

/**
 * ì „ì²´í™”ë©´ UI ì»´í¬ë„ŒíŠ¸
 * ì›¹ë·°ë¥¼ ì „ì²´í™”ë©´ìœ¼ë¡œ í‘œì‹œí•  ë•Œ ì‚¬ìš©í•˜ëŠ” UI
 */
@Composable
fun FullscreenUI(
    tabs: List<Tab>,
    currentTabIndex: Int,
    currentUrl: String,
    urlText: String,
    onUrlTextChange: (String) -> Unit,
    onLoadUrl: (String) -> Unit,
    showTabOverview: Boolean,
    onShowTabOverview: (Boolean) -> Unit,
    onAddNewTab: () -> Unit,
    canGoBack: Boolean,
    canGoForward: Boolean,
    isAnalyzing: Boolean,
    mp4Links: List<String>,
    downloadingUrls: Set<String>,
    urlHistory: List<String>,
    onGoBack: () -> Unit,
    onGoForward: () -> Unit,
    onRefresh: () -> Unit,
    onShowMp4List: () -> Unit,
    onSwitchTab: (Int) -> Unit,
    onCloseTab: (Int) -> Unit,
    onDownloadVideo: (String) -> Unit,
    onExitFullscreen: () -> Unit,
    webViewContent: @Composable () -> Unit
) {
    var isEditingUrl by remember { mutableStateOf(false) }
    var editUrlText by remember { mutableStateOf("") }
    var showHistoryDropdown by remember { mutableStateOf(false) }

    Box(modifier = Modifier.fillMaxSize()) {
        if (showTabOverview) {
            // íƒ­ ì˜¤ë²„ë·° í™”ë©´
            TabOverviewScreen(
                tabs = tabs,
                currentTabIndex = currentTabIndex,
                onTabSelected = { index ->
                    onSwitchTab(index)
                    onShowTabOverview(false)
                },
                onTabClosed = { index ->
                    onCloseTab(index)
                    if (tabs.size == 1) {
                        onShowTabOverview(false)
                    }
                },
                onAddNewTab = {
                    onAddNewTab()
                    onShowTabOverview(false)
                },
                onBackToWebView = { onShowTabOverview(false) }
            )
        } else {
            // ì›¹ë·° í™”ë©´
            Column(modifier = Modifier.fillMaxSize()) {
                // ìƒë‹¨ ë°”
                FullscreenTopBar(
                    currentUrl = currentUrl,
                    isEditingUrl = isEditingUrl,
                    editUrlText = editUrlText,
                    tabs = tabs,
                    urlHistory = urlHistory,
                    showHistoryDropdown = showHistoryDropdown,
                    onEditUrlTextChange = { editUrlText = it },
                    onStartEditingUrl = { 
                        editUrlText = currentUrl
                        isEditingUrl = true 
                    },
                    onStopEditingUrl = { isEditingUrl = false },
                    onShowHistoryDropdown = { showHistoryDropdown = it },
                    onLoadUrl = onLoadUrl,
                    onAddNewTab = onAddNewTab,
                    onShowTabOverview = { onShowTabOverview(true) },
                    onExitFullscreen = onExitFullscreen
                )

                // ì›¹ë·° ì½˜í…ì¸ 
                Box(modifier = Modifier.weight(1f)) {
                    webViewContent()
                }

                // í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°”
                FullscreenBottomBar(
                    canGoBack = canGoBack,
                    canGoForward = canGoForward,
                    isAnalyzing = isAnalyzing,
                    urlHistory = urlHistory,
                    onGoBack = onGoBack,
                    onGoForward = onGoForward,
                    onRefresh = onRefresh,
                    onShowMp4List = onShowMp4List,
                    onShowHistory = { showHistoryDropdown = !showHistoryDropdown }
                )
            }
        }
    }
}

/**
 * ì „ì²´í™”ë©´ ìƒë‹¨ ë°”
 */
@Composable
private fun FullscreenTopBar(
    currentUrl: String,
    isEditingUrl: Boolean,
    editUrlText: String,
    tabs: List<Tab>,
    urlHistory: List<String>,
    showHistoryDropdown: Boolean,
    onEditUrlTextChange: (String) -> Unit,
    onStartEditingUrl: () -> Unit,
    onStopEditingUrl: () -> Unit,
    onShowHistoryDropdown: (Boolean) -> Unit,
    onLoadUrl: (String) -> Unit,
    onAddNewTab: () -> Unit,
    onShowTabOverview: () -> Unit,
    onExitFullscreen: () -> Unit
) {
    Surface(
        modifier = Modifier
            .fillMaxWidth()
            .windowInsetsPadding(WindowInsets.systemBars.only(WindowInsetsSides.Top)),
        color = MaterialTheme.colorScheme.surface.copy(alpha = 0.95f),
        tonalElevation = 4.dp
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp, vertical = 12.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            // ì¢Œì¸¡: URL í‘œì‹œ/í¸ì§‘
            if (isEditingUrl) {
                OutlinedTextField(
                    value = editUrlText,
                    onValueChange = onEditUrlTextChange,
                    modifier = Modifier.weight(1f),
                    placeholder = { Text("URL ì…ë ¥") },
                    keyboardOptions = KeyboardOptions(imeAction = ImeAction.Go),
                    keyboardActions = KeyboardActions(
                        onGo = {
                            if (editUrlText.isNotBlank()) {
                                val url = if (!editUrlText.startsWith("http")) {
                                    "https://$editUrlText"
                                } else {
                                    editUrlText
                                }
                                onLoadUrl(url)
                            }
                            onStopEditingUrl()
                        }
                    ),
                    trailingIcon = {
                        Row {
                            IconButton(
                                onClick = {
                                    if (editUrlText.isNotBlank()) {
                                        val url = if (!editUrlText.startsWith("http")) {
                                            "https://$editUrlText"
                                        } else {
                                            editUrlText
                                        }
                                        onLoadUrl(url)
                                    }
                                    onStopEditingUrl()
                                }
                            ) {
                                Icon(Icons.Default.Check, "í™•ì¸")
                            }
                            IconButton(onClick = onStopEditingUrl) {
                                Icon(Icons.Default.Close, "ì·¨ì†Œ")
                            }
                            IconButton(onClick = { onShowHistoryDropdown(!showHistoryDropdown) }) {
                                Icon(Icons.Default.Info, "ê¸°ë¡")
                            }
                        }
                    },
                    singleLine = true
                )
            } else {
                Surface(
                    modifier = Modifier
                        .weight(1f)
                        .clickable { onStartEditingUrl() },
                    shape = RoundedCornerShape(8.dp),
                    color = MaterialTheme.colorScheme.surfaceVariant
                ) {
                    Text(
                        text = currentUrl.takeIf { it.isNotEmpty() } ?: "URLì„ ì…ë ¥í•˜ì„¸ìš”",
                        modifier = Modifier.padding(12.dp),
                        style = MaterialTheme.typography.bodyMedium,
                        maxLines = 1,
                        overflow = TextOverflow.Ellipsis
                    )
                }
            }

            Spacer(modifier = Modifier.width(16.dp))

            // ìš°ì¸¡: ìƒˆ íƒ­ ì¶”ê°€, íƒ­ ê°œìˆ˜, ì „ì²´í™”ë©´ ì¢…ë£Œ (3ê°œ ë²„íŠ¼)
            Row(
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                // 1. ìƒˆ íƒ­ ì¶”ê°€ ë²„íŠ¼
                IconButton(onClick = onAddNewTab) {
                    Icon(
                        Icons.Default.Add, 
                        contentDescription = "ìƒˆ íƒ­",
                        tint = MaterialTheme.colorScheme.onSurface
                    )
                }
                
                // 2. íƒ­ ê°œìˆ˜ (íƒ­ ì˜¤ë²„ë·°ë¡œ ì´ë™)
                Surface(
                    modifier = Modifier.clickable { onShowTabOverview() },
                    shape = RoundedCornerShape(16.dp),
                    color = MaterialTheme.colorScheme.primary
                ) {
                    Text(
                        text = tabs.size.toString(),
                        modifier = Modifier.padding(horizontal = 12.dp, vertical = 6.dp),
                        style = MaterialTheme.typography.labelLarge,
                        color = MaterialTheme.colorScheme.onPrimary
                    )
                }
                
                // 3. ì „ì²´í™”ë©´ ì¢…ë£Œ ë²„íŠ¼
                IconButton(onClick = onExitFullscreen) {
                    Icon(
                        Icons.Default.Close,
                        contentDescription = "ì „ì²´í™”ë©´ ì¢…ë£Œ",
                        tint = MaterialTheme.colorScheme.error
                    )
                }
            }
        }

        // URL íˆìŠ¤í† ë¦¬ ë“œë¡­ë‹¤ìš´
        if (showHistoryDropdown && urlHistory.isNotEmpty()) {
            LazyColumn(
                modifier = Modifier
                    .fillMaxWidth()
                    .heightIn(max = 200.dp)
                    .background(MaterialTheme.colorScheme.surfaceVariant)
                    .padding(8.dp)
            ) {
                items(urlHistory.reversed()) { url ->
                    Text(
                        text = url,
                        modifier = Modifier
                            .fillMaxWidth()
                            .clickable {
                                onLoadUrl(url)
                                onShowHistoryDropdown(false)
                            }
                            .padding(12.dp),
                        style = MaterialTheme.typography.bodySmall,
                        maxLines = 1,
                        overflow = TextOverflow.Ellipsis
                    )
                }
            }
        }
    }
}

/**
 * ì „ì²´í™”ë©´ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°”
 */
@Composable
private fun FullscreenBottomBar(
    canGoBack: Boolean,
    canGoForward: Boolean,
    isAnalyzing: Boolean,
    urlHistory: List<String>,
    onGoBack: () -> Unit,
    onGoForward: () -> Unit,
    onRefresh: () -> Unit,
    onShowMp4List: () -> Unit,
    onShowHistory: () -> Unit
) {
    Surface(
        modifier = Modifier
            .fillMaxWidth()
            .windowInsetsPadding(WindowInsets.systemBars.only(WindowInsetsSides.Bottom)),
        color = MaterialTheme.colorScheme.surface.copy(alpha = 0.95f),
        tonalElevation = 4.dp
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp, vertical = 12.dp),
            horizontalArrangement = Arrangement.SpaceEvenly,
            verticalAlignment = Alignment.CenterVertically
        ) {
            // 1. ë’¤ë¡œê°€ê¸°
            IconButton(
                onClick = onGoBack,
                enabled = canGoBack
            ) {
                Icon(
                    Icons.Default.ArrowBack,
                    "ë’¤ë¡œê°€ê¸°",
                    tint = if (canGoBack) 
                        MaterialTheme.colorScheme.onSurface 
                    else 
                        MaterialTheme.colorScheme.onSurface.copy(alpha = 0.3f)
                )
            }

            // 2. ìƒˆë¡œê³ ì¹¨ ë° MP4 ê°ì§€
            IconButton(
                onClick = onRefresh
            ) {
                if (isAnalyzing) {
                    CircularProgressIndicator(
                        modifier = Modifier.size(24.dp),
                        color = MaterialTheme.colorScheme.primary
                    )
                } else {
                    Icon(Icons.Default.Refresh, "ìƒˆë¡œê³ ì¹¨")
                }
            }

            // 3. MP4 ëª©ë¡ ë³´ê¸°
            IconButton(
                onClick = onShowMp4List
            ) {
                Icon(Icons.Default.PlayArrow, "MP4 ëª©ë¡")
            }

            // 4. ìµœê·¼ ë°©ë¬¸í•œ í˜ì´ì§€ ëª©ë¡
            IconButton(
                onClick = onShowHistory,
                enabled = urlHistory.isNotEmpty()
            ) {
                Icon(
                    Icons.Default.Info,
                    "ë°©ë¬¸ ê¸°ë¡",
                    tint = if (urlHistory.isNotEmpty()) 
                        MaterialTheme.colorScheme.onSurface 
                    else 
                        MaterialTheme.colorScheme.onSurface.copy(alpha = 0.3f)
                )
            }

            // 5. ì•ìœ¼ë¡œê°€ê¸°
            IconButton(
                onClick = onGoForward,
                enabled = canGoForward
            ) {
                Icon(
                    Icons.Default.ArrowForward,
                    "ì•ìœ¼ë¡œê°€ê¸°",
                    tint = if (canGoForward) 
                        MaterialTheme.colorScheme.onSurface 
                    else 
                        MaterialTheme.colorScheme.onSurface.copy(alpha = 0.3f)
                )
            }
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/theme/Color.kt">
package com.swvd.simplewebvideodownloader.ui.theme

import androidx.compose.ui.graphics.Color

val Purple80 = Color(0xFFD0BCFF)
val PurpleGrey80 = Color(0xFFCCC2DC)
val Pink80 = Color(0xFFEFB8C8)

val Purple40 = Color(0xFF6650a4)
val PurpleGrey40 = Color(0xFF625b71)
val Pink40 = Color(0xFF7D5260)
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/theme/Theme.kt">
package com.swvd.simplewebvideodownloader.ui.theme

import android.app.Activity
import android.os.Build
import androidx.compose.foundation.isSystemInDarkTheme
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.darkColorScheme
import androidx.compose.material3.dynamicDarkColorScheme
import androidx.compose.material3.dynamicLightColorScheme
import androidx.compose.material3.lightColorScheme
import androidx.compose.runtime.Composable
import androidx.compose.ui.platform.LocalContext

private val DarkColorScheme = darkColorScheme(
    primary = Purple80,
    secondary = PurpleGrey80,
    tertiary = Pink80
)

private val LightColorScheme = lightColorScheme(
    primary = Purple40,
    secondary = PurpleGrey40,
    tertiary = Pink40

    /* Other default colors to override
    background = Color(0xFFFFFBFE),
    surface = Color(0xFFFFFBFE),
    onPrimary = Color.White,
    onSecondary = Color.White,
    onTertiary = Color.White,
    onBackground = Color(0xFF1C1B1F),
    onSurface = Color(0xFF1C1B1F),
    */
)

@Composable
fun SimpleWebVideoDownloaderTheme(
    darkTheme: Boolean = isSystemInDarkTheme(),
    // Dynamic color is available on Android 12+
    dynamicColor: Boolean = true,
    content: @Composable () -> Unit
) {
    val colorScheme = when {
        dynamicColor && Build.VERSION.SDK_INT >= Build.VERSION_CODES.S -> {
            val context = LocalContext.current
            if (darkTheme) dynamicDarkColorScheme(context) else dynamicLightColorScheme(context)
        }

        darkTheme -> DarkColorScheme
        else -> LightColorScheme
    }

    MaterialTheme(
        colorScheme = colorScheme,
        typography = Typography,
        content = content
    )
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/theme/Type.kt">
package com.swvd.simplewebvideodownloader.ui.theme

import androidx.compose.material3.Typography
import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.font.FontFamily
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.sp

// Set of Material typography styles to start with
val Typography = Typography(
    bodyLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = 16.sp,
        lineHeight = 24.sp,
        letterSpacing = 0.5.sp
    )
    /* Other default text styles to override
    titleLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = 22.sp,
        lineHeight = 28.sp,
        letterSpacing = 0.sp
    ),
    labelSmall = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Medium,
        fontSize = 11.sp,
        lineHeight = 16.sp,
        letterSpacing = 0.5.sp
    )
    */
)
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/utils/FullscreenManager.kt">
package com.swvd.simplewebvideodownloader.utils

import android.app.Activity
import android.view.View
import android.view.WindowInsetsController
import androidx.core.view.WindowCompat
import androidx.core.view.WindowInsetsCompat

/**
 * ì „ì²´í™”ë©´ ëª¨ë“œ ê´€ë¦¬ ìœ í‹¸ë¦¬í‹°
 * ëª°ì…í˜• ì „ì²´í™”ë©´ ëª¨ë“œ ì„¤ì •ì„ ë‹´ë‹¹
 */
object FullscreenManager {
    
    /**
     * ì „ì²´í™”ë©´ ëª°ì…í˜• ëª¨ë“œ ì„¤ì •/í•´ì œ
     * @param activity ëŒ€ìƒ ì•¡í‹°ë¹„í‹°
     * @param enable ì „ì²´í™”ë©´ ëª¨ë“œ í™œì„±í™” ì—¬ë¶€
     */
    fun setFullscreenMode(activity: Activity, enable: Boolean) {
        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.R) {
            if (enable) {
                // Android 11+ ì—ì„œ ëª°ì…í˜• ëª¨ë“œ
                activity.window.insetsController?.let { controller ->
                    controller.hide(WindowInsetsCompat.Type.systemBars())
                    controller.systemBarsBehavior = WindowInsetsController.BEHAVIOR_SHOW_TRANSIENT_BARS_BY_SWIPE
                }
            } else {
                // ëª°ì…í˜• ëª¨ë“œ í•´ì œ
                activity.window.insetsController?.show(WindowInsetsCompat.Type.systemBars())
            }
        } else {
            @Suppress("DEPRECATION")
            if (enable) {
                // Android 10 ì´í•˜ì—ì„œ ëª°ì…í˜• ëª¨ë“œ
                activity.window.decorView.systemUiVisibility = (
                    View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY
                    or View.SYSTEM_UI_FLAG_LAYOUT_STABLE
                    or View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
                    or View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
                    or View.SYSTEM_UI_FLAG_HIDE_NAVIGATION
                    or View.SYSTEM_UI_FLAG_FULLSCREEN
                )
            } else {
                // ëª°ì…í˜• ëª¨ë“œ í•´ì œ
                activity.window.decorView.systemUiVisibility = View.SYSTEM_UI_FLAG_VISIBLE
            }
        }
    }
    
    /**
     * Edge-to-Edge ëª¨ë“œ í™œì„±í™”
     * @param activity ëŒ€ìƒ ì•¡í‹°ë¹„í‹°
     */
    fun enableEdgeToEdge(activity: Activity) {
        WindowCompat.setDecorFitsSystemWindows(activity.window, false)
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/webview/Mp4Analyzer.kt">
package com.swvd.simplewebvideodownloader.webview

import android.util.Log
import android.webkit.WebView

/**
 * MP4 ë¹„ë””ì˜¤ ë¶„ì„ í´ë˜ìŠ¤
 * ì›¹í˜ì´ì§€ì—ì„œ MP4 ë¹„ë””ì˜¤ ë§í¬ë¥¼ ê°ì§€í•˜ëŠ” ê¸°ëŠ¥ì„ ë‹´ë‹¹
 */
class Mp4Analyzer {
    
    /**
     * JavaScript ì½”ë“œë¡œ í˜ì´ì§€ì—ì„œ MP4 ë§í¬ ì¶”ì¶œ
     * ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ MP4 URLì„ ì°¾ì•„ì„œ ë°˜í™˜
     */
    private val mp4DetectionScript = """
        (function() {
            var results = [];
            var uniqueUrls = new Set();
            
            try {
                // 1. ëª¨ë“  video íƒœê·¸ì˜ src í™•ì¸
                var videos = document.querySelectorAll('video');
                videos.forEach(function(v) {
                    if (v.src && v.src.includes('.mp4')) {
                        uniqueUrls.add(v.src);
                    }
                    if (v.currentSrc && v.currentSrc.includes('.mp4')) {
                        uniqueUrls.add(v.currentSrc);
                    }
                });
                
                // 2. ëª¨ë“  source íƒœê·¸ì˜ src í™•ì¸
                var sources = document.querySelectorAll('source');
                sources.forEach(function(s) {
                    if (s.src && s.src.includes('.mp4')) {
                        uniqueUrls.add(s.src);
                    }
                });
                
                // 3. ëª¨ë“  a íƒœê·¸ì˜ href í™•ì¸ (ë§í¬)
                var links = document.querySelectorAll('a[href]');
                links.forEach(function(a) {
                    if (a.href && a.href.includes('.mp4')) {
                        uniqueUrls.add(a.href);
                    }
                });
                
                // 4. í˜ì´ì§€ HTMLì—ì„œ MP4 URL ì •ê·œì‹ ê²€ìƒ‰
                var html = document.documentElement.outerHTML;
                var mp4Regex = /https?:\/\/[^\s"'<>()]+\.mp4[^\s"'<>()]*/gi;
                var matches = html.match(mp4Regex);
                if (matches) {
                    matches.forEach(function(match) {
                        // URL ì •ë¦¬
                        var cleanUrl = match.replace(/['"<>()]+${'$'}/, '');
                        if (cleanUrl.length > 20) { // ë„ˆë¬´ ì§§ì€ URL ì œì™¸
                            uniqueUrls.add(cleanUrl);
                        }
                    });
                }
                
                // 5. ëª¨ë“  img íƒœê·¸ì˜ data ì†ì„± í™•ì¸ (ë•Œë¡œëŠ” ë¹„ë””ì˜¤ ì¸ë„¤ì¼ì´ data ì†ì„±ì— ìˆìŒ)
                var imgs = document.querySelectorAll('img[data-src], img[data-url]');
                imgs.forEach(function(img) {
                    var dataSrc = img.getAttribute('data-src') || img.getAttribute('data-url');
                    if (dataSrc && dataSrc.includes('.mp4')) {
                        uniqueUrls.add(dataSrc);
                    }
                });
                
                // 6. ëª¨ë“  divì˜ data ì†ì„± í™•ì¸
                var divs = document.querySelectorAll('div[data-video], div[data-src], div[data-url]');
                divs.forEach(function(div) {
                    var dataVideo = div.getAttribute('data-video') || div.getAttribute('data-src') || div.getAttribute('data-url');
                    if (dataVideo && dataVideo.includes('.mp4')) {
                        uniqueUrls.add(dataVideo);
                    }
                });
                
                // ê²°ê³¼ ì •ë¦¬
                uniqueUrls.forEach(function(url) {
                    results.push(url);
                });
                
                return JSON.stringify(results);
                
            } catch (e) {
                return JSON.stringify(['JavaScript ì˜¤ë¥˜: ' + e.message]);
            }
        })();
    """.trimIndent()
    
    /**
     * WebViewì—ì„œ MP4 ë§í¬ ë¶„ì„ ì‹¤í–‰
     * @param webView ë¶„ì„í•  WebView
     * @param onResult ê²°ê³¼ë¥¼ ë°›ì„ ì½œë°± í•¨ìˆ˜
     */
    fun analyzePageForMp4(
        webView: WebView?,
        onResult: (List<String>) -> Unit
    ) {
        if (webView == null) {
            Log.d("Mp4Analyzer", "WebViewê°€ ì—†ìŒ")
            onResult(emptyList())
            return
        }
        
        Log.d("Mp4Analyzer", "MP4 ê°ì§€ ì‹œì‘: ${webView.url}")
        
        webView.evaluateJavascript(mp4DetectionScript) { result ->
            try {
                val cleanResult = result?.replace("\\\"", "\"")?.removeSurrounding("\"") ?: "[]"
                Log.d("Mp4Analyzer", "MP4 ê²€ìƒ‰ ê²°ê³¼: $cleanResult")

                val videoLinks = if (cleanResult.startsWith("[")) {
                    cleanResult.removeSurrounding("[", "]")
                        .split(",")
                        .map { it.trim().removeSurrounding("\"") }
                        .filter { it.isNotEmpty() && it.contains(".mp4") && !it.contains("JavaScript ì˜¤ë¥˜") }
                } else {
                    emptyList()
                }

                Log.d("Mp4Analyzer", "ìµœì¢… MP4 ë§í¬ ${videoLinks.size}ê°œ ë°œê²¬")
                onResult(videoLinks)

            } catch (e: Exception) {
                Log.e("Mp4Analyzer", "MP4 ë¶„ì„ ì˜¤ë¥˜: ${e.message}")
                onResult(listOf("ë¶„ì„ ì˜¤ë¥˜: ${e.message}"))
            }
        }
    }
}
</file>

<file path="app/src/main/res/drawable/ic_launcher_background.xml">
<?xml version="1.0" encoding="utf-8"?>
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="108dp"
    android:height="108dp"
    android:viewportWidth="108"
    android:viewportHeight="108">
    <path
        android:fillColor="#3DDC84"
        android:pathData="M0,0h108v108h-108z" />
    <path
        android:fillColor="#00000000"
        android:pathData="M9,0L9,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,0L19,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M29,0L29,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M39,0L39,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M49,0L49,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M59,0L59,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M69,0L69,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M79,0L79,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M89,0L89,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M99,0L99,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,9L108,9"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,19L108,19"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,29L108,29"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,39L108,39"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,49L108,49"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,59L108,59"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,69L108,69"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,79L108,79"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,89L108,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,99L108,99"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,29L89,29"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,39L89,39"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,49L89,49"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,59L89,59"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,69L89,69"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,79L89,79"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M29,19L29,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M39,19L39,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M49,19L49,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M59,19L59,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M69,19L69,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M79,19L79,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
</vector>
</file>

<file path="app/src/main/res/drawable/ic_launcher_foreground.xml">
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:aapt="http://schemas.android.com/aapt"
    android:width="108dp"
    android:height="108dp"
    android:viewportWidth="108"
    android:viewportHeight="108">
    <path android:pathData="M31,63.928c0,0 6.4,-11 12.1,-13.1c7.2,-2.6 26,-1.4 26,-1.4l38.1,38.1L107,108.928l-32,-1L31,63.928z">
        <aapt:attr name="android:fillColor">
            <gradient
                android:endX="85.84757"
                android:endY="92.4963"
                android:startX="42.9492"
                android:startY="49.59793"
                android:type="linear">
                <item
                    android:color="#44000000"
                    android:offset="0.0" />
                <item
                    android:color="#00000000"
                    android:offset="1.0" />
            </gradient>
        </aapt:attr>
    </path>
    <path
        android:fillColor="#FFFFFF"
        android:fillType="nonZero"
        android:pathData="M65.3,45.828l3.8,-6.6c0.2,-0.4 0.1,-0.9 -0.3,-1.1c-0.4,-0.2 -0.9,-0.1 -1.1,0.3l-3.9,6.7c-6.3,-2.8 -13.4,-2.8 -19.7,0l-3.9,-6.7c-0.2,-0.4 -0.7,-0.5 -1.1,-0.3C38.8,38.328 38.7,38.828 38.9,39.228l3.8,6.6C36.2,49.428 31.7,56.028 31,63.928h46C76.3,56.028 71.8,49.428 65.3,45.828zM43.4,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2c-0.3,-0.7 -0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C45.3,56.528 44.5,57.328 43.4,57.328L43.4,57.328zM64.6,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2s-0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C66.5,56.528 65.6,57.328 64.6,57.328L64.6,57.328z"
        android:strokeWidth="1"
        android:strokeColor="#00000000" />
</vector>
</file>

<file path="app/src/main/res/values/colors.xml">
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="purple_200">#FFBB86FC</color>
    <color name="purple_500">#FF6200EE</color>
    <color name="purple_700">#FF3700B3</color>
    <color name="teal_200">#FF03DAC5</color>
    <color name="teal_700">#FF018786</color>
    <color name="black">#FF000000</color>
    <color name="white">#FFFFFFFF</color>
</resources>
</file>

<file path="app/src/main/res/values/strings.xml">
<resources>
    <string name="app_name">SimpleWebVideoDownloader</string>
</resources>
</file>

<file path="app/src/main/res/values/themes.xml">
<?xml version="1.0" encoding="utf-8"?>
<resources>

    <style name="Theme.SimpleWebVideoDownloader" parent="android:Theme.Material.Light.NoActionBar" />
</resources>
</file>

<file path="app/src/main/res/xml/backup_rules.xml">
<?xml version="1.0" encoding="utf-8"?><!--
   Sample backup rules file; uncomment and customize as necessary.
   See https://developer.android.com/guide/topics/data/autobackup
   for details.
   Note: This file is ignored for devices older than API 31
   See https://developer.android.com/about/versions/12/backup-restore
-->
<full-backup-content>
    <!--
   <include domain="sharedpref" path="."/>
   <exclude domain="sharedpref" path="device.xml"/>
-->
</full-backup-content>
</file>

<file path="app/src/main/res/xml/data_extraction_rules.xml">
<?xml version="1.0" encoding="utf-8"?><!--
   Sample data extraction rules file; uncomment and customize as necessary.
   See https://developer.android.com/about/versions/12/backup-restore#xml-changes
   for details.
-->
<data-extraction-rules>
    <cloud-backup>
        <!-- TODO: Use <include> and <exclude> to control what is backed up.
        <include .../>
        <exclude .../>
        -->
    </cloud-backup>
    <!--
    <device-transfer>
        <include .../>
        <exclude .../>
    </device-transfer>
    -->
</data-extraction-rules>
</file>

<file path="app/src/test/java/com/swvd/simplewebvideodownloader/ExampleUnitTest.kt">
package com.swvd.simplewebvideodownloader

import org.junit.Test

import org.junit.Assert.*

/**
 * Example local unit test, which will execute on the development machine (host).
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
class ExampleUnitTest {
    @Test
    fun addition_isCorrect() {
        assertEquals(4, 2 + 2)
    }
}
</file>

<file path="app/.gitignore">
/build
</file>

<file path="app/proguard-rules.pro">
# Add project specific ProGuard rules here.
# You can control the set of applied configuration files using the
# proguardFiles setting in build.gradle.
#
# For more details, see
#   http://developer.android.com/guide/developing/tools/proguard.html

# If your project uses WebView with JS, uncomment the following
# and specify the fully qualified class name to the JavaScript interface
# class:
#-keepclassmembers class fqcn.of.javascript.interface.for.webview {
#   public *;
#}

# Uncomment this to preserve the line number information for
# debugging stack traces.
#-keepattributes SourceFile,LineNumberTable

# If you keep the line number information, uncomment this to
# hide the original source file name.
#-renamesourcefileattribute SourceFile
</file>

<file path="gradle/wrapper/gradle-wrapper.properties">
#Thu Jun 12 16:09:15 KST 2025
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.11.1-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
</file>

<file path="gradle/libs.versions.toml">
[versions]
agp = "8.10.1"
kotlin = "2.0.21"
coreKtx = "1.16.0"
junit = "4.13.2"
junitVersion = "1.2.1"
espressoCore = "3.6.1"
lifecycleRuntimeKtx = "2.9.1"
activityCompose = "1.10.1"
composeBom = "2024.09.00"

[libraries]
androidx-core-ktx = { group = "androidx.core", name = "core-ktx", version.ref = "coreKtx" }
junit = { group = "junit", name = "junit", version.ref = "junit" }
androidx-junit = { group = "androidx.test.ext", name = "junit", version.ref = "junitVersion" }
androidx-espresso-core = { group = "androidx.test.espresso", name = "espresso-core", version.ref = "espressoCore" }
androidx-lifecycle-runtime-ktx = { group = "androidx.lifecycle", name = "lifecycle-runtime-ktx", version.ref = "lifecycleRuntimeKtx" }
androidx-activity-compose = { group = "androidx.activity", name = "activity-compose", version.ref = "activityCompose" }
androidx-compose-bom = { group = "androidx.compose", name = "compose-bom", version.ref = "composeBom" }
androidx-ui = { group = "androidx.compose.ui", name = "ui" }
androidx-ui-graphics = { group = "androidx.compose.ui", name = "ui-graphics" }
androidx-ui-tooling = { group = "androidx.compose.ui", name = "ui-tooling" }
androidx-ui-tooling-preview = { group = "androidx.compose.ui", name = "ui-tooling-preview" }
androidx-ui-test-manifest = { group = "androidx.compose.ui", name = "ui-test-manifest" }
androidx-ui-test-junit4 = { group = "androidx.compose.ui", name = "ui-test-junit4" }
androidx-material3 = { group = "androidx.compose.material3", name = "material3" }

[plugins]
android-application = { id = "com.android.application", version.ref = "agp" }
kotlin-android = { id = "org.jetbrains.kotlin.android", version.ref = "kotlin" }
kotlin-compose = { id = "org.jetbrains.kotlin.plugin.compose", version.ref = "kotlin" }
</file>

<file path=".gitignore">
# Android Studio and Gradle files
*.iml
.gradle
/local.properties
/.idea/caches
/.idea/libraries
/.idea/modules.xml
/.idea/workspace.xml
/.idea/navEditor.xml
/.idea/assetWizardSettings.xml
.DS_Store
/build
/captures
.externalNativeBuild
.cxx
local.properties

# Android APK files
*.apk
*.aab

# Keystore files
*.jks
*.keystore

# Log files
*.log

# Android Studio Navigation editor temp files
.navigation/

# Android Studio captures folder
captures/

# IntelliJ
*.iws
/out/

# User-specific configurations
.idea/libraries/
.idea/workspace.xml
.idea/tasks.xml
.idea/.name
.idea/compiler.xml
.idea/copyright/profiles_settings.xml
.idea/encodings.xml
.idea/misc.xml
.idea/modules.xml
.idea/scopes/scope_settings.xml
.idea/dictionaries
.idea/vcs.xml
.idea/jsLibraryMappings.xml
.idea/datasources.xml
.idea/dataSources.ids
.idea/sqlDataSources.xml
.idea/dynamic.xml
.idea/uiDesigner.xml

# OS-specific files
Thumbs.db
ehthumbs.db
Desktop.ini
$RECYCLE.BIN/
*~

# Gradle Wrapper
!gradle/wrapper/gradle-wrapper.jar

# Maven
target/
pom.xml.tag
pom.xml.releaseBackup
pom.xml.versionsBackup
pom.xml.next
release.properties
dependency-reduced-pom.xml
buildNumber.properties
.mvn/timing.properties

# Avoid ignoring Maven wrapper jar file (.jar files are usually ignored)
!/.mvn/wrapper/maven-wrapper.jar
</file>

<file path="build.gradle.kts">
// Top-level build file where you can add configuration options common to all sub-projects/modules.
plugins {
    alias(libs.plugins.android.application) apply false
    alias(libs.plugins.kotlin.android) apply false
    alias(libs.plugins.kotlin.compose) apply false
}
</file>

<file path="CLAUDE.md">
# Basic Rules
- You are a senior coding expert.

## General Guidelines
- Make a step-by-step plan and work it out.
- At the top of the file, include its role and brief description.
- Please include comments when writing the code.
- Please write the variable name so that the meaning is clear.
- Please include the error handling.
- Put readability and maintenance first.

## Description
- Please add an explanation to the complex logic.
- Please briefly explain the purpose of the code and how it works.
</file>

<file path="gradle.properties">
# Project-wide Gradle settings.
# IDE (e.g. Android Studio) users:
# Gradle settings configured through the IDE *will override*
# any settings specified in this file.
# For more details on how to configure your build environment visit
# http://www.gradle.org/docs/current/userguide/build_environment.html
# Specifies the JVM arguments used for the daemon process.
# The setting is particularly useful for tweaking memory settings.
org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
# When configured, Gradle will run in incubating parallel mode.
# This option should only be used with decoupled projects. For more details, visit
# https://developer.android.com/r/tools/gradle-multi-project-decoupled-projects
# org.gradle.parallel=true
# AndroidX package structure to make it clearer which packages are bundled with the
# Android operating system, and which are packaged with your app's APK
# https://developer.android.com/topic/libraries/support-library/androidx-rn
android.useAndroidX=true
# Kotlin code style for this project: "official" or "obsolete":
kotlin.code.style=official
# Enables namespacing of each library's R class so that its R class includes only the
# resources declared in the library itself and none from the library's dependencies,
# thereby reducing the size of the R class for that library
android.nonTransitiveRClass=true
</file>

<file path="gradlew">
#!/usr/bin/env sh

#
# Copyright 2015 the original author or authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

##############################################################################
##
##  Gradle start up script for UN*X
##
##############################################################################

# Attempt to set APP_HOME
# Resolve links: $0 may be a link
PRG="$0"
# Need this for relative symlinks.
while [ -h "$PRG" ] ; do
    ls=`ls -ld "$PRG"`
    link=`expr "$ls" : '.*-> \(.*\)$'`
    if expr "$link" : '/.*' > /dev/null; then
        PRG="$link"
    else
        PRG=`dirname "$PRG"`"/$link"
    fi
done
SAVED="`pwd`"
cd "`dirname \"$PRG\"`/" >/dev/null
APP_HOME="`pwd -P`"
cd "$SAVED" >/dev/null

APP_NAME="Gradle"
APP_BASE_NAME=`basename "$0"`

# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'

# Use the maximum available, or set MAX_FD != -1 to use that value.
MAX_FD="maximum"

warn () {
    echo "$*"
}

die () {
    echo
    echo "$*"
    echo
    exit 1
}

# OS specific support (must be 'true' or 'false').
cygwin=false
msys=false
darwin=false
nonstop=false
case "`uname`" in
  CYGWIN* )
    cygwin=true
    ;;
  Darwin* )
    darwin=true
    ;;
  MINGW* )
    msys=true
    ;;
  NONSTOP* )
    nonstop=true
    ;;
esac

CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar


# Determine the Java command to use to start the JVM.
if [ -n "$JAVA_HOME" ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
        # IBM's JDK on AIX uses strange locations for the executables
        JAVACMD="$JAVA_HOME/jre/sh/java"
    else
        JAVACMD="$JAVA_HOME/bin/java"
    fi
    if [ ! -x "$JAVACMD" ] ; then
        die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
    fi
else
    JAVACMD="java"
    which java >/dev/null 2>&1 || die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
fi

# Increase the maximum file descriptors if we can.
if [ "$cygwin" = "false" -a "$darwin" = "false" -a "$nonstop" = "false" ] ; then
    MAX_FD_LIMIT=`ulimit -H -n`
    if [ $? -eq 0 ] ; then
        if [ "$MAX_FD" = "maximum" -o "$MAX_FD" = "max" ] ; then
            MAX_FD="$MAX_FD_LIMIT"
        fi
        ulimit -n $MAX_FD
        if [ $? -ne 0 ] ; then
            warn "Could not set maximum file descriptor limit: $MAX_FD"
        fi
    else
        warn "Could not query maximum file descriptor limit: $MAX_FD_LIMIT"
    fi
fi

# For Darwin, add options to specify how the application appears in the dock
if $darwin; then
    GRADLE_OPTS="$GRADLE_OPTS \"-Xdock:name=$APP_NAME\" \"-Xdock:icon=$APP_HOME/media/gradle.icns\""
fi

# For Cygwin or MSYS, switch paths to Windows format before running java
if [ "$cygwin" = "true" -o "$msys" = "true" ] ; then
    APP_HOME=`cygpath --path --mixed "$APP_HOME"`
    CLASSPATH=`cygpath --path --mixed "$CLASSPATH"`

    JAVACMD=`cygpath --unix "$JAVACMD"`

    # We build the pattern for arguments to be converted via cygpath
    ROOTDIRSRAW=`find -L / -maxdepth 1 -mindepth 1 -type d 2>/dev/null`
    SEP=""
    for dir in $ROOTDIRSRAW ; do
        ROOTDIRS="$ROOTDIRS$SEP$dir"
        SEP="|"
    done
    OURCYGPATTERN="(^($ROOTDIRS))"
    # Add a user-defined pattern to the cygpath arguments
    if [ "$GRADLE_CYGPATTERN" != "" ] ; then
        OURCYGPATTERN="$OURCYGPATTERN|($GRADLE_CYGPATTERN)"
    fi
    # Now convert the arguments - kludge to limit ourselves to /bin/sh
    i=0
    for arg in "$@" ; do
        CHECK=`echo "$arg"|egrep -c "$OURCYGPATTERN" -`
        CHECK2=`echo "$arg"|egrep -c "^-"`                                 ### Determine if an option

        if [ $CHECK -ne 0 ] && [ $CHECK2 -eq 0 ] ; then                    ### Added a condition
            eval `echo args$i`=`cygpath --path --ignore --mixed "$arg"`
        else
            eval `echo args$i`="\"$arg\""
        fi
        i=`expr $i + 1`
    done
    case $i in
        0) set -- ;;
        1) set -- "$args0" ;;
        2) set -- "$args0" "$args1" ;;
        3) set -- "$args0" "$args1" "$args2" ;;
        4) set -- "$args0" "$args1" "$args2" "$args3" ;;
        5) set -- "$args0" "$args1" "$args2" "$args3" "$args4" ;;
        6) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" ;;
        7) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" ;;
        8) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" ;;
        9) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" "$args8" ;;
    esac
fi

# Escape application args
save () {
    for i do printf %s\\n "$i" | sed "s/'/'\\\\''/g;1s/^/'/;\$s/\$/' \\\\/" ; done
    echo " "
}
APP_ARGS=`save "$@"`

# Collect all arguments for the java command, following the shell quoting and substitution rules
eval set -- $DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS "\"-Dorg.gradle.appname=$APP_BASE_NAME\"" -classpath "\"$CLASSPATH\"" org.gradle.wrapper.GradleWrapperMain "$APP_ARGS"

exec "$JAVACMD" "$@"
</file>

<file path="gradlew.bat">
@rem
@rem Copyright 2015 the original author or authors.
@rem
@rem Licensed under the Apache License, Version 2.0 (the "License");
@rem you may not use this file except in compliance with the License.
@rem You may obtain a copy of the License at
@rem
@rem      https://www.apache.org/licenses/LICENSE-2.0
@rem
@rem Unless required by applicable law or agreed to in writing, software
@rem distributed under the License is distributed on an "AS IS" BASIS,
@rem WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@rem See the License for the specific language governing permissions and
@rem limitations under the License.
@rem

@if "%DEBUG%" == "" @echo off
@rem ##########################################################################
@rem
@rem  Gradle startup script for Windows
@rem
@rem ##########################################################################

@rem Set local scope for the variables with windows NT shell
if "%OS%"=="Windows_NT" setlocal

set DIRNAME=%~dp0
if "%DIRNAME%" == "" set DIRNAME=.
set APP_BASE_NAME=%~n0
set APP_HOME=%DIRNAME%

@rem Resolve any "." and ".." in APP_HOME to make it shorter.
for %%i in ("%APP_HOME%") do set APP_HOME=%%~fi

@rem Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
set DEFAULT_JVM_OPTS="-Xmx64m" "-Xms64m"

@rem Find java.exe
if defined JAVA_HOME goto findJavaFromJavaHome

set JAVA_EXE=java.exe
%JAVA_EXE% -version >NUL 2>&1
if "%ERRORLEVEL%" == "0" goto execute

echo.
echo ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:findJavaFromJavaHome
set JAVA_HOME=%JAVA_HOME:"=%
set JAVA_EXE=%JAVA_HOME%/bin/java.exe

if exist "%JAVA_EXE%" goto execute

echo.
echo ERROR: JAVA_HOME is set to an invalid directory: %JAVA_HOME%
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:execute
@rem Setup the command line

set CLASSPATH=%APP_HOME%\gradle\wrapper\gradle-wrapper.jar


@rem Execute Gradle
"%JAVA_EXE%" %DEFAULT_JVM_OPTS% %JAVA_OPTS% %GRADLE_OPTS% "-Dorg.gradle.appname=%APP_BASE_NAME%" -classpath "%CLASSPATH%" org.gradle.wrapper.GradleWrapperMain %*

:end
@rem End local scope for the variables with windows NT shell
if "%ERRORLEVEL%"=="0" goto mainEnd

:fail
rem Set variable GRADLE_EXIT_CONSOLE if you need the _script_ return code instead of
rem the _cmd.exe /c_ return code!
if  not "" == "%GRADLE_EXIT_CONSOLE%" exit 1
exit /b 1

:mainEnd
if "%OS%"=="Windows_NT" endlocal

:omega
</file>

<file path="LICENSE">
MIT License

Copyright (c) 2025 JaemyeongBae

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</file>

<file path="README.md">
# ğŸ¬ Simple Web Video Downloader

Android ì›¹ ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë” ì•±ìœ¼ë¡œ, ì›¹ í˜ì´ì§€ì—ì„œ MP4 ë¹„ë””ì˜¤ë¥¼ ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³  ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆëŠ” ì‚¬ìš©ì ì¹œí™”ì ì¸ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

## âœ¨ ì£¼ìš” ê¸°ëŠ¥

- ğŸŒ **ë‚´ì¥ ì›¹ ë¸Œë¼ìš°ì €**: ì™„ì „í•œ ì›¹ ë¸Œë¼ìš°ì§• ê²½í—˜
- ğŸ” **ìë™ MP4 ê°ì§€**: í˜ì´ì§€ì˜ ëª¨ë“  MP4 ë¹„ë””ì˜¤ ë§í¬ë¥¼ ìë™ìœ¼ë¡œ íƒì§€
- â¬‡ï¸ **ê°„í¸í•œ ë‹¤ìš´ë¡œë“œ**: ì›í´ë¦­ìœ¼ë¡œ ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
- ğŸ“± **ë°˜ì‘í˜• UI**: ë‹¤ì–‘í•œ Android ê¸°ê¸°ì—ì„œ ìµœì í™”ëœ ì‚¬ìš©ì ê²½í—˜
- ğŸ¯ **ì „ì²´í™”ë©´ ëª¨ë“œ**: ëª°ì…í˜• ë¸Œë¼ìš°ì§• ê²½í—˜
- ğŸ“œ **ë¸Œë¼ìš°ì§• íˆìŠ¤í† ë¦¬**: ìµœê·¼ ë°©ë¬¸í•œ URL ê´€ë¦¬
- ğŸ¨ **Material Design 3**: í˜„ëŒ€ì ì´ê³  ì§ê´€ì ì¸ UI

## ğŸ“± ìŠ¤í¬ë¦°ìƒ·

> ìŠ¤í¬ë¦°ìƒ·ì€ ì¶”í›„ ì¶”ê°€ ì˜ˆì •

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ

- **ì–¸ì–´**: Kotlin
- **UI í”„ë ˆì„ì›Œí¬**: Jetpack Compose
- **ì•„í‚¤í…ì²˜**: MVVM with Compose State Management
- **ì›¹ë·°**: Android WebView with JavaScript injection
- **HTML íŒŒì‹±**: Jsoup
- **ìµœì†Œ SDK**: API 24 (Android 7.0)
- **íƒ€ê²Ÿ SDK**: API 35 (Android 15)

## ğŸ“‹ ìš”êµ¬ì‚¬í•­

- Android 7.0 (API 24) ì´ìƒ
- ì¸í„°ë„· ì—°ê²°
- ì €ì¥ì†Œ ê¶Œí•œ (ë‹¤ìš´ë¡œë“œìš©)

## ğŸš€ ì„¤ì¹˜ ë°©ë²•

### APK ë‹¤ìš´ë¡œë“œ (ì¶”í›„ ì œê³µ)
1. [Releases](https://github.com/JaemyeongBae/SimpleWebVideoDownloader/releases) í˜ì´ì§€ì—ì„œ ìµœì‹  APK ë‹¤ìš´ë¡œë“œ
2. Android ê¸°ê¸°ì—ì„œ "ì•Œ ìˆ˜ ì—†ëŠ” ì†ŒìŠ¤" í—ˆìš©
3. APK íŒŒì¼ ì„¤ì¹˜

### ì†ŒìŠ¤ ì½”ë“œì—ì„œ ë¹Œë“œ
```bash
# ì €ì¥ì†Œ ë³µì œ
git clone https://github.com/JaemyeongBae/SimpleWebVideoDownloader.git

# í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd SimpleWebVideoDownloader

# Android Studioì—ì„œ í”„ë¡œì íŠ¸ ì—´ê¸°
# ë˜ëŠ” ëª…ë ¹ì¤„ì—ì„œ ë¹Œë“œ
./gradlew assembleDebug
```

## ğŸ¯ ì‚¬ìš© ë°©ë²•

1. **URL ì…ë ¥**: ìƒë‹¨ URL ì…ë ¥ì°½ì— ì›¹ì‚¬ì´íŠ¸ ì£¼ì†Œ ì…ë ¥
2. **í˜ì´ì§€ íƒìƒ‰**: ë‚´ì¥ ë¸Œë¼ìš°ì €ë¡œ ì›í•˜ëŠ” í˜ì´ì§€ ë°©ë¬¸
3. **ë¹„ë””ì˜¤ ê°ì§€**: ì•±ì´ ìë™ìœ¼ë¡œ MP4 ë¹„ë””ì˜¤ ë§í¬ íƒì§€
4. **ë‹¤ìš´ë¡œë“œ**: ê°ì§€ëœ ë¹„ë””ì˜¤ ëª©ë¡ì—ì„œ ì›í•˜ëŠ” ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
5. **ì „ì²´í™”ë©´**: ì „ì²´í™”ë©´ ëª¨ë“œë¡œ ë” ë‚˜ì€ ë¸Œë¼ìš°ì§• ê²½í—˜

## ğŸ”§ ê°œë°œ í™˜ê²½ ì„¤ì •

### í•„ìˆ˜ ë„êµ¬
- Android Studio Hedgehog | 2023.1.1 ì´ìƒ
- JDK 11 ì´ìƒ
- Android SDK 35

### í”„ë¡œì íŠ¸ ì„¤ì •
```bash
# ì˜ì¡´ì„± ë™ê¸°í™”
./gradlew sync

# ë””ë²„ê·¸ ë¹Œë“œ
./gradlew assembleDebug

# ë¦´ë¦¬ì¦ˆ ë¹Œë“œ
./gradlew assembleRelease
```

## ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
app/
â”œâ”€â”€ src/main/
â”‚   â”œâ”€â”€ java/com/swvd/simplewebvideodownloader/
â”‚   â”‚   â”œâ”€â”€ MainActivity.kt          # ë©”ì¸ ì•¡í‹°ë¹„í‹°
â”‚   â”‚   â””â”€â”€ ui/theme/               # UI í…Œë§ˆ ì„¤ì •
â”‚   â”œâ”€â”€ res/                        # ë¦¬ì†ŒìŠ¤ íŒŒì¼
â”‚   â””â”€â”€ AndroidManifest.xml         # ì•± ë§¤ë‹ˆí˜ìŠ¤íŠ¸
â”œâ”€â”€ build.gradle.kts                # ì•± ë ˆë²¨ ë¹Œë“œ ì„¤ì •
â””â”€â”€ proguard-rules.pro             # ProGuard ì„¤ì •
```

## ğŸ¤ ê¸°ì—¬í•˜ê¸°

í”„ë¡œì íŠ¸ì— ê¸°ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¼ì£¼ì„¸ìš”:

1. ì´ ì €ì¥ì†Œë¥¼ Forkí•©ë‹ˆë‹¤
2. ìƒˆë¡œìš´ ê¸°ëŠ¥ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤ (`git checkout -b feature/AmazingFeature`)
3. ë³€ê²½ì‚¬í•­ì„ ì»¤ë°‹í•©ë‹ˆë‹¤ (`git commit -m 'Add some AmazingFeature'`)
4. ë¸Œëœì¹˜ì— Pushí•©ë‹ˆë‹¤ (`git push origin feature/AmazingFeature`)
5. Pull Requestë¥¼ ìƒì„±í•©ë‹ˆë‹¤

### ê°œë°œ ê°€ì´ë“œë¼ì¸
- Kotlin ì½”ë”© ì»¨ë²¤ì…˜ ì¤€ìˆ˜
- Jetpack Compose ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ ì ìš©
- ëª¨ë“  ìƒˆ ê¸°ëŠ¥ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì‘ì„±
- ì»¤ë°‹ ë©”ì‹œì§€ëŠ” ëª…í™•í•˜ê³  ì„¤ëª…ì ìœ¼ë¡œ ì‘ì„±

## ğŸ“ ë¼ì´ì„ ìŠ¤

ì´ í”„ë¡œì íŠ¸ëŠ” MIT ë¼ì´ì„ ìŠ¤ í•˜ì— ë°°í¬ë©ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ [LICENSE](LICENSE) íŒŒì¼ì„ ì°¸ì¡°í•˜ì„¸ìš”.

## ğŸ› ë²„ê·¸ ë¦¬í¬íŠ¸ ë° ê¸°ëŠ¥ ìš”ì²­

ë²„ê·¸ë¥¼ ë°œê²¬í•˜ê±°ë‚˜ ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì œì•ˆí•˜ê³  ì‹¶ìœ¼ì‹œë©´ [Issues](https://github.com/JaemyeongBae/SimpleWebVideoDownloader/issues) í˜ì´ì§€ì—ì„œ ìƒˆë¡œìš´ ì´ìŠˆë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

### ë²„ê·¸ ë¦¬í¬íŠ¸ ì‹œ í¬í•¨í•  ì •ë³´
- Android ë²„ì „
- ê¸°ê¸° ëª¨ë¸
- ì•± ë²„ì „
- ì¬í˜„ ë‹¨ê³„
- ì˜ˆìƒ ë™ì‘ vs ì‹¤ì œ ë™ì‘

## ğŸ“ ì—°ë½ì²˜

í”„ë¡œì íŠ¸ì— ëŒ€í•œ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ì—°ë½ì£¼ì„¸ìš”:

- GitHub: [@JaemyeongBae](https://github.com/JaemyeongBae)
- ì´ìŠˆ: [GitHub Issues](https://github.com/JaemyeongBae/SimpleWebVideoDownloader/issues)

## ğŸ™ ê°ì‚¬ì˜ ë§

- [Jsoup](https://jsoup.org/) - HTML íŒŒì‹± ë¼ì´ë¸ŒëŸ¬ë¦¬
- [Jetpack Compose](https://developer.android.com/jetpack/compose) - í˜„ëŒ€ì ì¸ Android UI íˆ´í‚·
- [Material Design 3](https://m3.material.io/) - ë””ìì¸ ì‹œìŠ¤í…œ

---

â­ ì´ í”„ë¡œì íŠ¸ê°€ ìœ ìš©í•˜ë‹¤ë©´ ë³„í‘œë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!
</file>

<file path="settings.gradle.kts">
pluginManagement {
    repositories {
        google {
            content {
                includeGroupByRegex("com\\.android.*")
                includeGroupByRegex("com\\.google.*")
                includeGroupByRegex("androidx.*")
            }
        }
        mavenCentral()
        gradlePluginPortal()
    }
}
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}

rootProject.name = "SimpleWebVideoDownloader"
include(":app")
</file>

<file path="app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml">
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
  <background android:drawable="@mipmap/ic_launcher_adaptive_back"/>
  <foreground android:drawable="@mipmap/ic_launcher_adaptive_fore"/>
</adaptive-icon>
</file>

<file path="app/src/main/AndroidManifest.xml">
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">

    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <!-- ë‹¤ìš´ë¡œë“œ ê¶Œí•œ ì¶”ê°€ -->
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"
        android:maxSdkVersion="28" />
    <!-- Android 13+ ì—ì„œëŠ” ì´ ê¶Œí•œì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ -->
    <uses-permission android:name="android.permission.READ_MEDIA_VIDEO" />

    <application
        android:allowBackup="true"
        android:dataExtractionRules="@xml/data_extraction_rules"
        android:fullBackupContent="@xml/backup_rules"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher"
        android:supportsRtl="true"
        android:theme="@style/Theme.SimpleWebVideoDownloader"
        android:usesCleartextTraffic="true"
        android:requestLegacyExternalStorage="true"
        tools:targetApi="31">
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:label="@string/app_name"
            android:theme="@style/Theme.SimpleWebVideoDownloader"
            android:configChanges="orientation|screenSize|keyboardHidden"
            android:hardwareAccelerated="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>

</manifest>
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/MainActivity.kt">
package com.swvd.simplewebvideodownloader

import android.os.Bundle
import android.os.Handler
import android.os.Looper
import android.util.Log
import android.webkit.WebView
import android.webkit.WebViewClient
import android.webkit.WebChromeClient
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.enableEdgeToEdge
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.animation.AnimatedVisibility
import androidx.compose.animation.expandVertically
import androidx.compose.animation.shrinkVertically
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.itemsIndexed
import androidx.compose.foundation.text.KeyboardActions
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Search
import androidx.compose.material.icons.filled.Close
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.ArrowForward
import androidx.compose.material.icons.filled.Refresh
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.foundation.background
import androidx.compose.ui.platform.LocalClipboardManager
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalSoftwareKeyboardController
import androidx.compose.ui.text.input.ImeAction
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.viewinterop.AndroidView
import androidx.activity.compose.BackHandler
import androidx.core.view.WindowCompat


// Import separated components and utilities
import com.swvd.simplewebvideodownloader.models.Tab
import com.swvd.simplewebvideodownloader.download.DownloadHandler
import com.swvd.simplewebvideodownloader.webview.Mp4Analyzer
import com.swvd.simplewebvideodownloader.utils.FullscreenManager
import com.swvd.simplewebvideodownloader.ui.components.*
import com.swvd.simplewebvideodownloader.ui.screens.FullscreenUI

/**
 * MainActivity - ë¶„ë¦¬ëœ êµ¬ì¡°ë¡œ ë¦¬íŒ©í† ë§
 * ê° ê¸°ëŠ¥ì´ ë³„ë„ í´ë˜ìŠ¤/ì»´í¬ë„ŒíŠ¸ë¡œ ë¶„ë¦¬ë˜ì–´ ê´€ë¦¬ê°€ ìš©ì´í•¨
 */
class MainActivity : ComponentActivity() {

    // ë‹¤ìš´ë¡œë“œ ê´€ë ¨ ê¸°ëŠ¥ì„ ë‹´ë‹¹í•˜ëŠ” í•¸ë“¤ëŸ¬
    private lateinit var downloadHandler: DownloadHandler
    
    // MP4 ë¶„ì„ ê¸°ëŠ¥ì„ ë‹´ë‹¹í•˜ëŠ” ì• ë„ë¼ì´ì €
    private val mp4Analyzer = Mp4Analyzer()

    // ê¶Œí•œ ìš”ì²­ ì²˜ë¦¬
    private val requestPermissionLauncher = registerForActivityResult(
        ActivityResultContracts.RequestMultiplePermissions()
    ) { permissions ->
        val allGranted = permissions.values.all { it }
        if (!allGranted && this::downloadHandler.isInitialized) {
            // ê¶Œí•œ ìš”ì²­ ê²°ê³¼ë¥¼ DownloadHandlerì—ê²Œ ìœ„ì„í•  ìˆ˜ ìˆë„ë¡ ì¶”í›„ í™•ì¥ ê°€ëŠ¥
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()
        
        // ë¶„ë¦¬ëœ FullscreenManager ì‚¬ìš©
        FullscreenManager.enableEdgeToEdge(this)
        
        // DownloadHandler ì´ˆê¸°í™”
        downloadHandler = DownloadHandler(this)
        
        setContent {
            MaterialTheme {
                Surface(
                    modifier = Modifier
                        .fillMaxSize()
                        .windowInsetsPadding(WindowInsets.systemBars.only(WindowInsetsSides.Top))
                ) {
                    MainScreen(
                        downloadHandler = downloadHandler,
                        mp4Analyzer = mp4Analyzer,
                        onRequestPermissions = { requestStoragePermissions() },
                        onFullscreenModeChange = { isFullscreen -> 
                            FullscreenManager.setFullscreenMode(this@MainActivity, isFullscreen) 
                        }
                    )
                }
            }
        }
    }

    /**
     * ì €ì¥ì†Œ ê¶Œí•œ ìš”ì²­
     * DownloadHandlerë¡œ ê¶Œí•œ í™•ì¸ ë¡œì§ ìœ„ì„
     */
    private fun requestStoragePermissions() {
        val permissions = downloadHandler.checkStoragePermissions()
        if (permissions.isNotEmpty()) {
            requestPermissionLauncher.launch(permissions.toTypedArray())
        }
    }
}

/**
 * ë©”ì¸ í™”ë©´ ì»´í¬ì €ë¸”
 * ë¶„ë¦¬ëœ ì»´í¬ë„ŒíŠ¸ë“¤ì„ ì¡°í•©í•˜ì—¬ ì „ì²´ í™”ë©´ì„ êµ¬ì„±
 */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MainScreen(
    modifier: Modifier = Modifier,
    downloadHandler: DownloadHandler,
    mp4Analyzer: Mp4Analyzer,
    onRequestPermissions: () -> Unit,
    onFullscreenModeChange: (Boolean) -> Unit
) {
    // íƒ­ ê´€ë ¨ ìƒíƒœ
    var tabs by remember { mutableStateOf(listOf(Tab())) }
    var currentTabIndex by remember { mutableIntStateOf(0) }
    var showTabOverview by remember { mutableStateOf(false) }
    
    var urlText by remember { mutableStateOf("") }
    var currentUrl by remember { mutableStateOf("") }
    var webView by remember { mutableStateOf<WebView?>(null) }
    var fullscreenWebView by remember { mutableStateOf<WebView?>(null) }
    var mp4Links by remember { mutableStateOf<List<String>>(emptyList()) }
    var isAnalyzing by remember { mutableStateOf(false) }
    var hasAnalyzed by remember { mutableStateOf(false) }
    var downloadingUrls by remember { mutableStateOf<Set<String>>(emptySet()) }
    var urlSectionExpanded by remember { mutableStateOf(true) }
    
    // ë‹¤ìš´ë¡œë“œ ê²°ê³¼ ì•Œë¦¼ ìƒíƒœ
    var downloadResultMessage by remember { mutableStateOf<String?>(null) }
    var showDownloadResult by remember { mutableStateOf(false) }
    var mp4SectionExpanded by remember { mutableStateOf(true) }
    var isWebViewFullscreen by remember { mutableStateOf(false) }
    var canGoBack by remember { mutableStateOf(false) }
    var canGoForward by remember { mutableStateOf(false) }
    var webViewState by remember { mutableStateOf<Bundle?>(null) }
    var urlHistory by remember { mutableStateOf<List<String>>(emptyList()) }
    var showMp4List by remember { mutableStateOf(false) }
    val clipboardManager = LocalClipboardManager.current
    val keyboardController = LocalSoftwareKeyboardController.current
    val context = LocalContext.current
    val currentTab = if (tabs.isNotEmpty() && currentTabIndex in tabs.indices) tabs[currentTabIndex] else null

    // íƒ­ ê´€ë¦¬ í•¨ìˆ˜ë“¤
    fun addNewTab() {
        val newTab = Tab()
        tabs = tabs + newTab
        currentTabIndex = tabs.size - 1
    }
    
    fun closeTab(index: Int) {
        if (tabs.size <= 1) return // ìµœì†Œ 1ê°œ íƒ­ ìœ ì§€
        
        tabs = tabs.filterIndexed { i, _ -> i != index }
        if (index <= currentTabIndex && currentTabIndex > 0) {
            currentTabIndex--
        }
        if (currentTabIndex >= tabs.size) {
            currentTabIndex = tabs.size - 1
        }
    }
    
    fun switchTab(index: Int) {
        if (index in tabs.indices) {
            currentTabIndex = index
            // íƒ­ ì „í™˜ì‹œ URL ë™ê¸°í™”
            currentTab?.let { tab ->
                urlText = tab.url
                currentUrl = tab.url
            }
        }
    }

    // ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    fun updateNavigationState() {
        val activeWebView = if (isWebViewFullscreen) fullscreenWebView else webView
        val oldCanGoBack = canGoBack
        val oldCanGoForward = canGoForward
        
        canGoBack = activeWebView?.canGoBack() ?: false
        canGoForward = activeWebView?.canGoForward() ?: false
        
        Log.d("Navigation", "ìƒíƒœ ì—…ë°ì´íŠ¸ - ì „ì²´í™”ë©´: $isWebViewFullscreen")
        Log.d("Navigation", "í™œì„± WebView: ${activeWebView != null}")
        Log.d("Navigation", "ë’¤ë¡œê°€ê¸°: $oldCanGoBack â†’ $canGoBack")
        Log.d("Navigation", "ì•ìœ¼ë¡œê°€ê¸°: $oldCanGoForward â†’ $canGoForward")
    }

    // ì „ì²´í™”ë©´ ëª¨ë“œì—ì„œ ë’¤ë¡œê°€ê¸° ì²˜ë¦¬ ë° ìƒíƒœ ë™ê¸°í™”
    BackHandler(enabled = isWebViewFullscreen) {
        // ì „ì²´í™”ë©´ WebViewì˜ ìƒíƒœ ì €ì¥
        fullscreenWebView?.let { fsWebView ->
            val bundle = Bundle()
            fsWebView.saveState(bundle)
            webViewState = bundle
            
            // í˜„ì¬ URLë„ ì—…ë°ì´íŠ¸
            fsWebView.url?.let { url ->
                if (url != currentUrl && 
                    !url.startsWith("data:") && 
                    !url.startsWith("about:") &&
                    url != "about:blank") {
                    currentUrl = url
                    urlText = url
                }
            }
        }
        
        // ì „ì²´í™”ë©´ ëª¨ë“œ ì¢…ë£Œ í›„ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
        isWebViewFullscreen = false
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì§€ì—° ì‹¤í–‰
        Handler(Looper.getMainLooper()).postDelayed({
            updateNavigationState()
        }, 100)
    }

    fun analyzePageForMp4() {
        if (isAnalyzing) return
        
        // í˜„ì¬ í™œì„±í™”ëœ WebView ì‚¬ìš© (ì „ì²´í™”ë©´ ëª¨ë“œì¼ ë•ŒëŠ” fullscreenWebView ìš°ì„ )
        val activeWebView = if (isWebViewFullscreen) {
            fullscreenWebView ?: webView
        } else {
            webView ?: fullscreenWebView
        }
        
        Log.d("WebView", "MP4 ê°ì§€ ì‹œì‘ (ì „ì²´í™”ë©´: $isWebViewFullscreen)")
        
        isAnalyzing = true
        hasAnalyzed = true
        
        // ë¶„ë¦¬ëœ Mp4Analyzer ì‚¬ìš©
        mp4Analyzer.analyzePageForMp4(activeWebView) { videoLinks ->
            mp4Links = videoLinks
            isAnalyzing = false
        }
    }

    fun loadUrl() {
        if (urlText.isNotBlank()) {
            val url = if (!urlText.startsWith("http://") && !urlText.startsWith("https://")) {
                "https://$urlText"
            } else {
                urlText
            }
            currentUrl = url
            
            // í˜„ì¬ íƒ­ì˜ URL ì—…ë°ì´íŠ¸
            currentTab?.let { tab ->
                tabs = tabs.map { if (it.id == tab.id) it.copy(url = url) else it }
            }
            
            // íˆìŠ¤í† ë¦¬ì— URL ì¶”ê°€ (ì¤‘ë³µ ì œê±°)
            if (!urlHistory.contains(url)) {
                urlHistory = urlHistory + url
            }
            
            webView?.loadUrl(url)
            keyboardController?.hide()
            urlSectionExpanded = false  // ë¡œë“œ í›„ ì ‘ê¸°
            
            // URL ë¡œë“œ í›„ 1íšŒ MP4 ê°ì§€ (1ì´ˆ ë”œë ˆì´)
            Handler(Looper.getMainLooper()).postDelayed({
                analyzePageForMp4()
            }, 1000)
        }
    }

    fun downloadVideo(url: String) {
        val cleanUrl = url.trim()

        // URL ìœ íš¨ì„± ê²€ì‚¬
        if (!downloadHandler.isValidUrl(cleanUrl)) {
            downloadResultMessage = "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨!\nìœ íš¨í•˜ì§€ ì•Šì€ URLì…ë‹ˆë‹¤"
            showDownloadResult = true
            
            Handler(Looper.getMainLooper()).postDelayed({
                showDownloadResult = false
                downloadResultMessage = null
            }, 3000)
            return
        }

        // ê¶Œí•œ í™•ì¸
        val permissions = downloadHandler.checkStoragePermissions()
        if (permissions.isNotEmpty()) {
            downloadResultMessage = "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨!\nì €ì¥ì†Œ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤"
            showDownloadResult = true
            
            Handler(Looper.getMainLooper()).postDelayed({
                showDownloadResult = false
                downloadResultMessage = null
            }, 3000)
            
            onRequestPermissions()
            return
        }

        // íŒŒì¼ëª… ìƒì„±
        val filename = downloadHandler.generateFilename(cleanUrl)

        try {
            downloadingUrls = downloadingUrls + cleanUrl
            downloadHandler.downloadFile(cleanUrl, filename)
            
            // ë‹¤ìš´ë¡œë“œ ì„±ê³µ ì•Œë¦¼
            downloadResultMessage = "ë‹¤ìš´ë¡œë“œ ì‹œì‘!\níŒŒì¼: $filename\nDownloads í´ë”ì— ì €ì¥ë©ë‹ˆë‹¤"
            showDownloadResult = true
            
            Handler(Looper.getMainLooper()).postDelayed({
                showDownloadResult = false
                downloadResultMessage = null
            }, 3000)
            
        } catch (e: Exception) {
            // ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ì—ëŸ¬ ì•Œë¦¼
            downloadingUrls = downloadingUrls - cleanUrl
            downloadResultMessage = "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨!\nì˜¤ë¥˜: ${e.message}"
            showDownloadResult = true
            
            Handler(Looper.getMainLooper()).postDelayed({
                showDownloadResult = false
                downloadResultMessage = null
            }, 5000)
            
            Log.e("Download", "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${e.message}")
        }
    }

    // URL ë³€ê²½ ë° 1íšŒ MP4 ê°ì§€ í•¨ìˆ˜
    fun updateUrlIfChanged(newUrl: String) {
        if (newUrl != currentUrl && 
            !newUrl.startsWith("data:") && 
            !newUrl.startsWith("about:") &&
            newUrl != "about:blank") {
            currentUrl = newUrl
            urlText = newUrl
            
            // íˆìŠ¤í† ë¦¬ì— URL ì¶”ê°€ (ì¤‘ë³µ ì œê±°)
            if (!urlHistory.contains(newUrl)) {
                urlHistory = urlHistory + newUrl
            }
            
            // ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateNavigationState()
            
            // URL ë³€ê²½ ì‹œ 1íšŒ MP4 ê°ì§€ (1ì´ˆ ë”œë ˆì´)
            Handler(Looper.getMainLooper()).postDelayed({
                analyzePageForMp4()
            }, 1000)
        }
    }

    // ë„¤ë¹„ê²Œì´ì…˜ í›„ URL ë™ê¸°í™” ë° 1íšŒ MP4 ê°ì§€
    fun handleNavigation(targetWebView: WebView?) {
        // ì¦‰ì‹œ URL ì²´í¬ ë° ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
        targetWebView?.url?.let { newUrl ->
            updateUrlIfChanged(newUrl)
        }
        updateNavigationState()
        
        // 500ms í›„ ë‹¤ì‹œ ì²´í¬ (í˜ì´ì§€ ë¡œë”© ì™„ë£Œ ëŒ€ê¸°)
        Handler(Looper.getMainLooper()).postDelayed({
            targetWebView?.url?.let { newUrl ->
                updateUrlIfChanged(newUrl)
            }
            updateNavigationState()
        }, 500)
        
        // ë„¤ë¹„ê²Œì´ì…˜ í›„ ì¶”ê°€ MP4 ê°ì§€ (í˜ì´ì§€ ì™„ì „ ë¡œë”© í›„)
        Handler(Looper.getMainLooper()).postDelayed({
            analyzePageForMp4()
        }, 2000)
    }

    // ë‹¤ìš´ë¡œë”© ìƒíƒœ ê´€ë¦¬
    LaunchedEffect(downloadingUrls) {
        if (downloadingUrls.isNotEmpty()) {
            kotlinx.coroutines.delay(3000)
            downloadingUrls = emptySet()
        }
    }

    // ì „ì²´í™”ë©´ ëª¨ë“œ ë³€ê²½ ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
    LaunchedEffect(isWebViewFullscreen) {
        updateNavigationState()
        // ì „ì²´í™”ë©´ ëª¨ë“œ ì‹œ ëª°ì…í˜• ëª¨ë“œ í™œì„±í™”
        onFullscreenModeChange(isWebViewFullscreen)
        
        // ì „ì²´í™”ë©´ ëª¨ë“œ ì „í™˜ í›„ ì¶”ê°€ì ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸ (WebView ë¡œë”© ëŒ€ê¸°)
        kotlinx.coroutines.delay(500)
        updateNavigationState()
        kotlinx.coroutines.delay(1000)
        updateNavigationState()
    }

    // íƒ­ ì „í™˜ì‹œ URL ë™ê¸°í™”
    LaunchedEffect(currentTabIndex) {
        currentTab?.let { tab ->
            urlText = tab.url
            currentUrl = tab.url
        }
    }

    // URL ë³€ê²½ ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
    LaunchedEffect(currentUrl) {
        if (currentUrl.isNotEmpty()) {
            kotlinx.coroutines.delay(1000) // í˜ì´ì§€ ë¡œë”© ëŒ€ê¸°
            updateNavigationState()
        }
    }

            // ì „ì²´í™”ë©´ ëª¨ë“œì¼ ë•Œ ë¶„ë¦¬ëœ FullscreenUI ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©
        if (isWebViewFullscreen) {
            FullscreenUI(
            tabs = tabs,
            currentTabIndex = currentTabIndex,
            currentUrl = currentUrl,
            urlText = urlText,
            onUrlTextChange = { urlText = it },
            onLoadUrl = { url ->
                val finalUrl = if (!url.startsWith("http://") && !url.startsWith("https://")) {
                    "https://$url"
                } else {
                    url
                }
                currentUrl = finalUrl
                urlText = finalUrl
                
                // í˜„ì¬ íƒ­ì˜ URLë„ ì—…ë°ì´íŠ¸
                currentTab?.let { tab ->
                    tabs = tabs.map {
                        if (it.id == tab.id) it.copy(url = finalUrl)
                        else it
                    }
                }
                
                // íˆìŠ¤í† ë¦¬ì— URL ì¶”ê°€ (ì¤‘ë³µ ì œê±°)
                if (!urlHistory.contains(finalUrl)) {
                    urlHistory = urlHistory + finalUrl
                }
                
                // WebViewì— URL ë¡œë“œ
                fullscreenWebView?.loadUrl(finalUrl)
                
                // URL ë³€ê²½ í›„ MP4 ê°ì§€
                Handler(Looper.getMainLooper()).postDelayed({
                    analyzePageForMp4()
                }, 1000)
            },
            showTabOverview = showTabOverview,
            onShowTabOverview = { showTabOverview = it },
            onAddNewTab = ::addNewTab,
            canGoBack = canGoBack,
            canGoForward = canGoForward,
            isAnalyzing = isAnalyzing,
            mp4Links = mp4Links,
            downloadingUrls = downloadingUrls,
            urlHistory = urlHistory,
            onGoBack = {
                Log.d("Navigation", "ë’¤ë¡œê°€ê¸° í´ë¦­ - canGoBack: $canGoBack, fullscreenWebView: ${fullscreenWebView != null}")
                fullscreenWebView?.let { webView ->
                    Log.d("Navigation", "WebView canGoBack: ${webView.canGoBack()}")
                    if (webView.canGoBack()) {
                        webView.goBack()
                        // ì¦‰ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                        Handler(Looper.getMainLooper()).postDelayed({
                            updateNavigationState()
                            Log.d("Navigation", "ë’¤ë¡œê°€ê¸° í›„ ìƒíƒœ - canGoBack: $canGoBack, canGoForward: $canGoForward")
                        }, 100)
                    }
                }
            },
            onGoForward = {
                Log.d("Navigation", "ì•ìœ¼ë¡œê°€ê¸° í´ë¦­ - canGoForward: $canGoForward, fullscreenWebView: ${fullscreenWebView != null}")
                fullscreenWebView?.let { webView ->
                    Log.d("Navigation", "WebView canGoForward: ${webView.canGoForward()}")
                    if (webView.canGoForward()) {
                        webView.goForward()
                        // ì¦‰ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                        Handler(Looper.getMainLooper()).postDelayed({
                            updateNavigationState()
                            Log.d("Navigation", "ì•ìœ¼ë¡œê°€ê¸° í›„ ìƒíƒœ - canGoBack: $canGoBack, canGoForward: $canGoForward")
                        }, 100)
                    }
                }
            },
            onRefresh = {
                fullscreenWebView?.reload()
                Handler(Looper.getMainLooper()).postDelayed({
                    analyzePageForMp4()
                }, 1500)
            },
            onShowMp4List = { showMp4List = !showMp4List },
            onSwitchTab = ::switchTab,
            onCloseTab = ::closeTab,
            onDownloadVideo = ::downloadVideo,
            onExitFullscreen = { 
                // ì „ì²´í™”ë©´ WebViewì˜ ìƒíƒœ ì €ì¥
                fullscreenWebView?.let { fsWebView ->
                    val bundle = Bundle()
                    fsWebView.saveState(bundle)
                    webViewState = bundle
                    
                    // í˜„ì¬ URLë„ ì—…ë°ì´íŠ¸
                    fsWebView.url?.let { url ->
                        if (url != currentUrl && 
                            !url.startsWith("data:") && 
                            !url.startsWith("about:") &&
                            url != "about:blank") {
                            currentUrl = url
                            urlText = url
                        }
                    }
                }
                
                // ì „ì²´í™”ë©´ ëª¨ë“œ ì¢…ë£Œ í›„ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                isWebViewFullscreen = false
                
                // ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì§€ì—° ì‹¤í–‰
                Handler(Looper.getMainLooper()).postDelayed({
                    updateNavigationState()
                }, 100)
            },
            webViewContent = {
                // ì „ì²´í™”ë©´ WebView
                if (currentUrl.isNotEmpty()) {
                    AndroidView(
                        factory = { context ->
                            WebView(context).apply {
                                webViewClient = object : WebViewClient() {
                                    override fun shouldOverrideUrlLoading(view: WebView?, url: String?): Boolean {
                                        url?.let { newUrl ->
                                            updateUrlIfChanged(newUrl)
                                        }
                                        return false
                                    }

                                    override fun onPageStarted(view: WebView?, url: String?, favicon: android.graphics.Bitmap?) {
                                        super.onPageStarted(view, url, favicon)
                                        url?.let { newUrl ->
                                            updateUrlIfChanged(newUrl)
                                        }
                                    }

                                    override fun onPageFinished(view: WebView?, url: String?) {
                                        super.onPageFinished(view, url)
                                        url?.let { newUrl ->
                                            updateUrlIfChanged(newUrl)
                                        }
                                        
                                        // í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„ MP4 ê°ì§€
                                        Handler(Looper.getMainLooper()).postDelayed({
                                            analyzePageForMp4()
                                        }, 1000)
                                    }
                                }
                                webChromeClient = object : WebChromeClient() {
                                    override fun onReceivedTitle(view: WebView?, title: String?) {
                                        super.onReceivedTitle(view, title)
                                        // íƒ­ ì œëª© ì—…ë°ì´íŠ¸
                                        title?.let { 
                                            currentTab?.let { tab ->
                                                tabs = tabs.map { 
                                                    if (it.id == tab.id) it.copy(title = title.take(15)) 
                                                    else it 
                                                }
                                            }
                                        }
                                    }
                                }
                                settings.javaScriptEnabled = true
                                settings.domStorageEnabled = true
                                settings.loadWithOverviewMode = true
                                settings.useWideViewPort = true
                                
                                // ì „ì²´í™”ë©´ WebView ì°¸ì¡° ì„¤ì •
                                fullscreenWebView = this
                                
                                // ì €ì¥ëœ WebView ìƒíƒœ ë³µì› (íˆìŠ¤í† ë¦¬ í¬í•¨)
                                webViewState?.let { bundle ->
                                    restoreState(bundle)
                                    // ìƒíƒœ ë³µì› í›„ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                                    Handler(Looper.getMainLooper()).postDelayed({
                                        updateNavigationState()
                                    }, 500)
                                } ?: run {
                                    // ì €ì¥ëœ ìƒíƒœê°€ ì—†ìœ¼ë©´ í˜„ì¬ URLë¡œ ë¡œë“œ
                                    val syncUrl = webView?.url ?: currentUrl
                                    if (syncUrl.isNotEmpty()) {
                                        this.loadUrl(syncUrl)
                                        // URL ë¡œë“œ í›„ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                                        Handler(Looper.getMainLooper()).postDelayed({
                                            updateNavigationState()
                                        }, 1000)
                                    }
                                }
                            }
                        },
                        update = { view ->
                            if (currentUrl.isNotEmpty() && view.url != currentUrl) {
                                view.loadUrl(currentUrl)
                            }
                        },
                        modifier = Modifier.fillMaxSize()
                    )
                } else {
                    Box(
                        modifier = Modifier.fillMaxSize(),
                        contentAlignment = Alignment.Center
                    ) {
                        Text(
                            text = "ì›¹ í˜ì´ì§€ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
            }
        )
        
        // MP4 ëª©ë¡ í‘œì‹œ ë‹¤ì´ì–¼ë¡œê·¸
        if (showMp4List) {
            Mp4ListDialog(
                mp4Links = mp4Links,
                downloadingUrls = downloadingUrls,
                onDownload = { url -> downloadVideo(url) },
                onDismiss = { showMp4List = false }
            )
        }
        
        // ë‹¤ìš´ë¡œë“œ ê²°ê³¼ ì•Œë¦¼ íŒì—…
        if (showDownloadResult && downloadResultMessage != null) {
            DownloadResultDialog(
                message = downloadResultMessage!!,
                onDismiss = { 
                    showDownloadResult = false
                    downloadResultMessage = null
                }
            )
        }
        
        return
    }

    // ì¼ë°˜ ëª¨ë“œ ë ˆì´ì•„ì›ƒ
    Column(
        modifier = modifier
            .fillMaxSize()
            .windowInsetsPadding(WindowInsets.systemBars)
            .padding(16.dp),
        verticalArrangement = Arrangement.Top
    ) {
        // íƒ­ë°”
        TabBar(
            tabs = tabs,
            currentTabIndex = currentTabIndex,
            onNewTab = ::addNewTab,
            onCloseTab = ::closeTab,
            onSwitchTab = ::switchTab,
            modifier = Modifier.padding(bottom = 8.dp)
        )

        // ì•± ì œëª©
        Text(
                            text = "Simple Web Video Downloader v5.8",
            style = MaterialTheme.typography.titleMedium,
            modifier = Modifier.padding(bottom = 12.dp),
            maxLines = 1,
            overflow = androidx.compose.ui.text.style.TextOverflow.Ellipsis
        )

        // URL ì…ë ¥ ì„¹ì…˜
        Card(
            modifier = Modifier.fillMaxWidth(),
            elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
        ) {
            Column(
                modifier = Modifier.padding(12.dp)
            ) {
                // ì„¹ì…˜ í—¤ë” (í´ë¦­ ê°€ëŠ¥)
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .clickable { urlSectionExpanded = !urlSectionExpanded },
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(
                        text = "ì›¹ í˜ì´ì§€ URL ì…ë ¥",
                        style = MaterialTheme.typography.titleMedium
                    )
                    Text(
                        text = if (urlSectionExpanded) "â–²" else "â–¼",
                        style = MaterialTheme.typography.titleMedium
                    )
                }

                // ë¡œë“œëœ URLì´ ìˆê³  ì„¹ì…˜ì´ ì ‘í˜€ìˆì„ ë•Œ ê°„ë‹¨íˆ í‘œì‹œ
                if (!urlSectionExpanded && currentUrl.isNotEmpty()) {
                    Spacer(modifier = Modifier.height(8.dp))
                    Text(
                        text = currentUrl.let { url ->
                            if (url.length > 40) "...${url.takeLast(37)}" else url
                        },
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.primary,
                        maxLines = 1,
                        overflow = androidx.compose.ui.text.style.TextOverflow.Ellipsis
                    )
                }

                // ì ‘í ìˆ˜ ìˆëŠ” ë‚´ìš©
                AnimatedVisibility(
                    visible = urlSectionExpanded,
                    enter = expandVertically(),
                    exit = shrinkVertically()
                ) {
                    Column {
                        Spacer(modifier = Modifier.height(6.dp))

                        // URL ì…ë ¥ í•„ë“œ
                        OutlinedTextField(
                            value = urlText,
                            onValueChange = { urlText = it },
                            label = { Text("URLì„ ì…ë ¥í•˜ì„¸ìš”") },
                            placeholder = { Text("https://example.com") },
                            modifier = Modifier.fillMaxWidth(),
                            maxLines = 3,
                            keyboardOptions = KeyboardOptions(
                                keyboardType = KeyboardType.Uri,
                                imeAction = ImeAction.Go
                            ),
                            keyboardActions = KeyboardActions(
                                onGo = { loadUrl() }
                            ),
                            trailingIcon = {
                                TextButton(
                                    onClick = {
                                        clipboardManager.getText()?.text?.let { clipText ->
                                            if (clipText.contains(".")) {
                                                urlText = clipText
                                            }
                                        }
                                    }
                                ) {
                                    Text("ë¶™ì—¬ë„£ê¸°")
                                }
                            }
                        )

                        Spacer(modifier = Modifier.height(12.dp))

                        // ë²„íŠ¼ë“¤
                        Column(
                            verticalArrangement = Arrangement.spacedBy(8.dp)
                        ) {
                            // ì²« ë²ˆì§¸ ì¤„: í˜ì´ì§€ ë¡œë“œ, ì´ˆê¸°í™”
                            Row(
                                modifier = Modifier.fillMaxWidth(),
                                horizontalArrangement = Arrangement.spacedBy(8.dp)
                            ) {
                                Button(
                                    onClick = { loadUrl() },
                                    modifier = Modifier.weight(1f),
                                    enabled = urlText.isNotBlank() && !isAnalyzing
                                ) {
                                    if (isAnalyzing) {
                                        CircularProgressIndicator(
                                            modifier = Modifier.size(18.dp),
                                            color = MaterialTheme.colorScheme.onPrimary
                                        )
                                        Spacer(modifier = Modifier.width(8.dp))
                                        Text("MP4 ê°ì§€ ì¤‘...")
                                    } else {
                                        Icon(
                                            imageVector = Icons.Default.Search,
                                            contentDescription = null,
                                            modifier = Modifier.size(18.dp)
                                        )
                                        Spacer(modifier = Modifier.width(8.dp))
                                        Text("í˜ì´ì§€ ë¡œë“œ")
                                    }
                                }

                                Button(
                                                                    onClick = { 
                                    // ì´ˆê¸°í™” ê¸°ëŠ¥
                                    urlText = ""
                                    currentUrl = ""
                                    mp4Links = emptyList()
                                    webView = null
                                    fullscreenWebView = null
                                    urlSectionExpanded = true
                                    mp4SectionExpanded = true
                                    isAnalyzing = false
                                    hasAnalyzed = false
                                    downloadingUrls = emptySet()
                                },
                                    modifier = Modifier.weight(1f),
                                    colors = ButtonDefaults.buttonColors(
                                        containerColor = MaterialTheme.colorScheme.secondary
                                    )
                                ) {
                                    Icon(
                                        imageVector = Icons.Default.Close,
                                        contentDescription = null,
                                        modifier = Modifier.size(18.dp)
                                    )
                                    Spacer(modifier = Modifier.width(8.dp))
                                    Text("ì´ˆê¸°í™”")
                                }
                            }

                            // ë‘ ë²ˆì§¸ ì¤„: ìƒˆë¡œê³ ì¹¨ & MP4 ê°ì§€ (í˜„ì¬ URLì´ ìˆì„ ë•Œë§Œ í‘œì‹œ)
                            if (currentUrl.isNotEmpty()) {
                                Button(
                                    onClick = { 
                                        webView?.reload()
                                        Handler(Looper.getMainLooper()).postDelayed({
                                            analyzePageForMp4()
                                        }, 1000)
                                    },
                                    modifier = Modifier.fillMaxWidth(),
                                    enabled = !isAnalyzing,
                                    colors = ButtonDefaults.buttonColors(
                                        containerColor = MaterialTheme.colorScheme.tertiary
                                    )
                                ) {
                                    if (isAnalyzing) {
                                        CircularProgressIndicator(
                                            modifier = Modifier.size(18.dp),
                                            color = MaterialTheme.colorScheme.onTertiary
                                        )
                                        Spacer(modifier = Modifier.width(8.dp))
                                        Text("ìƒˆë¡œê³ ì¹¨ ì¤‘...")
                                    } else {
                                        Text("ğŸ”„ ìƒˆë¡œê³ ì¹¨ & MP4 ê°ì§€")
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        Spacer(modifier = Modifier.height(12.dp))

        // ê°ì§€ëœ MP4 ëª©ë¡ ë° ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
        if (hasAnalyzed) {
            Card(
                modifier = Modifier.fillMaxWidth(),
                elevation = CardDefaults.cardElevation(defaultElevation = 2.dp),
                colors = CardDefaults.cardColors(
                    containerColor = MaterialTheme.colorScheme.primaryContainer
                )
            ) {
                Column(modifier = Modifier.padding(12.dp)) {
                    // ì„¹ì…˜ í—¤ë” (í´ë¦­ ê°€ëŠ¥)
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .clickable { mp4SectionExpanded = !mp4SectionExpanded },
                        horizontalArrangement = Arrangement.SpaceBetween,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Text(
                            text = if (mp4Links.isEmpty()) {
                                "ğŸ¯ ê°ì§€ëœ MP4 ë¹„ë””ì˜¤ (ì—†ìŒ)"
                            } else {
                                "ğŸ¯ ê°ì§€ëœ MP4 ë¹„ë””ì˜¤ (${mp4Links.size}ê°œ)"
                            },
                            style = MaterialTheme.typography.titleMedium,
                            color = MaterialTheme.colorScheme.onPrimaryContainer
                        )
                        Text(
                            text = if (mp4SectionExpanded) "â–²" else "â–¼",
                            style = MaterialTheme.typography.titleMedium,
                            color = MaterialTheme.colorScheme.onPrimaryContainer
                        )
                    }

                    // ì ‘íŒ ìƒíƒœì—ì„œ ê°„ë‹¨í•œ ìš”ì•½ í‘œì‹œ
                    if (!mp4SectionExpanded) {
                        Spacer(modifier = Modifier.height(8.dp))
                        if (mp4Links.isEmpty()) {
                            Text(
                                text = "ì´ í˜ì´ì§€ì—ì„œ MP4 ë¹„ë””ì˜¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
                                style = MaterialTheme.typography.bodySmall,
                                color = MaterialTheme.colorScheme.onPrimaryContainer
                            )
                        } else {
                            val downloadableCount = mp4Links.count { it.contains(".mp4") && it.contains("http") }
                            Text(
                                text = "ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ ë¹„ë””ì˜¤: ${downloadableCount}ê°œ",
                                style = MaterialTheme.typography.bodySmall,
                                color = MaterialTheme.colorScheme.onPrimaryContainer
                            )
                        }
                    }

                    // ì ‘í ìˆ˜ ìˆëŠ” ëª©ë¡ ë‚´ìš©
                    AnimatedVisibility(
                        visible = mp4SectionExpanded,
                        enter = expandVertically(),
                        exit = shrinkVertically()
                    ) {
                        Column {
                            Spacer(modifier = Modifier.height(12.dp))

                            if (mp4Links.isEmpty()) {
                                // MP4ê°€ ì—†ì„ ë•Œ í‘œì‹œ
                                Text(
                                    text = "ì´ í˜ì´ì§€ì—ì„œ MP4 ë¹„ë””ì˜¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¹„ë””ì˜¤ê°€ iframeì´ë‚˜ ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ êµ¬í˜„ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                                    style = MaterialTheme.typography.bodyMedium,
                                    color = MaterialTheme.colorScheme.onPrimaryContainer,
                                    modifier = Modifier.padding(vertical = 16.dp)
                                )
                            } else {
                                LazyColumn(
                                    modifier = Modifier.height(200.dp),
                                    verticalArrangement = Arrangement.spacedBy(8.dp)
                                ) {
                                    itemsIndexed(mp4Links) { index, link ->
                                    if (link.contains(".mp4") && link.contains("http")) {
                                        Card(
                                            modifier = Modifier.fillMaxWidth(),
                                            colors = CardDefaults.cardColors(
                                                containerColor = MaterialTheme.colorScheme.surface
                                            )
                                        ) {
                                            Column(modifier = Modifier.padding(12.dp)) {
                                                Text(
                                                    text = "${index + 1}. ${if (link.length > 50) "...${link.takeLast(50)}" else link}",
                                                    style = MaterialTheme.typography.bodySmall,
                                                    modifier = Modifier.padding(bottom = 8.dp)
                                                )

                                                Button(
                                                    onClick = { downloadVideo(link) },
                                                    modifier = Modifier.fillMaxWidth(),
                                                    enabled = !downloadingUrls.contains(link),
                                                    colors = ButtonDefaults.buttonColors(
                                                        containerColor = MaterialTheme.colorScheme.tertiary
                                                    )
                                                ) {
                                                    if (downloadingUrls.contains(link)) {
                                                        CircularProgressIndicator(
                                                            modifier = Modifier.size(16.dp),
                                                            color = MaterialTheme.colorScheme.onTertiary
                                                        )
                                                        Spacer(modifier = Modifier.width(8.dp))
                                                        Text("ë‹¤ìš´ë¡œë“œ ì¤‘...")
                                                    } else {
                                                        Text("â¬‡ï¸ ë‹¤ìš´ë¡œë“œ")
                                                    }
                                                }
                                            }
                                        }
                                    } else {
                                        Text(
                                            text = "${index + 1}. $link",
                                            style = MaterialTheme.typography.bodySmall,
                                            color = MaterialTheme.colorScheme.onPrimaryContainer,
                                            modifier = Modifier.padding(vertical = 2.dp)
                                        )
                                    }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            // MP4ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ì„ ë•ŒëŠ” í•˜ë‹¨ ì—¬ë°± ì—†ìŒ
            if (mp4Links.isNotEmpty()) {
                Spacer(modifier = Modifier.height(12.dp))
            }
        }

        // WebView ì˜ì—­ - ê°œì„ ëœ ë ˆì´ì•„ì›ƒ
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .weight(1f)
        ) {
            // WebView ì¹´ë“œ
            Card(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(bottom = if (currentUrl.isNotEmpty()) 100.dp else 0.dp), // ë„¤ë¹„ê²Œì´ì…˜ ë°”ë¥¼ ìœ„í•œ í•˜ë‹¨ ì—¬ë°± ì¦ê°€ (80dp â†’ 100dp)
                elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
            ) {
                if (currentUrl.isEmpty()) {
                    Box(
                        modifier = Modifier
                            .fillMaxSize()
                            .padding(16.dp),
                        contentAlignment = Alignment.Center
                    ) {
                        Text(
                            text = "ì›¹ í˜ì´ì§€ë¥¼ ë¡œë“œí•˜ë©´ ì—¬ê¸°ì— ë¸Œë¼ìš°ì €ê°€ í‘œì‹œë©ë‹ˆë‹¤",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                } else {
                    AndroidView(
                        factory = { context ->
                            // ì¼ë°˜ ëª¨ë“œ WebView ìƒì„± ë˜ëŠ” ì¬ì‚¬ìš©
                            webView ?: WebView(context).apply {
                                webViewClient = object : WebViewClient() {
                                    override fun shouldOverrideUrlLoading(view: WebView?, url: String?): Boolean {
                                        url?.let { newUrl ->
                                            updateUrlIfChanged(newUrl)
                                        }
                                        return false
                                    }

                                    override fun onPageStarted(view: WebView?, url: String?, favicon: android.graphics.Bitmap?) {
                                        super.onPageStarted(view, url, favicon)
                                        url?.let { newUrl ->
                                            updateUrlIfChanged(newUrl)
                                        }
                                    }

                                    override fun onPageFinished(view: WebView?, url: String?) {
                                        super.onPageFinished(view, url)
                                        url?.let { newUrl ->
                                            updateUrlIfChanged(newUrl)
                                        }
                                        
                                        // í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„ MP4 ê°ì§€
                                        Handler(Looper.getMainLooper()).postDelayed({
                                            analyzePageForMp4()
                                        }, 1000)
                                    }
                                }
                                webChromeClient = object : WebChromeClient() {
                                    override fun onReceivedTitle(view: WebView?, title: String?) {
                                        super.onReceivedTitle(view, title)
                                        // íƒ­ ì œëª© ì—…ë°ì´íŠ¸
                                        title?.let { 
                                            currentTab?.let { tab ->
                                                tabs = tabs.map { 
                                                    if (it.id == tab.id) it.copy(title = title.take(15)) 
                                                    else it 
                                                }
                                            }
                                        }
                                    }
                                }
                                settings.javaScriptEnabled = true
                                settings.domStorageEnabled = true
                                settings.loadWithOverviewMode = true
                                settings.useWideViewPort = true
                                
                                // ì¼ë°˜ ëª¨ë“œ WebView ì°¸ì¡° ì„¤ì •
                                webView = this
                                
                                // ì €ì¥ëœ WebView ìƒíƒœ ë³µì› (íˆìŠ¤í† ë¦¬ í¬í•¨)
                                webViewState?.let { bundle ->
                                    restoreState(bundle)
                                } ?: run {
                                    // ì €ì¥ëœ ìƒíƒœê°€ ì—†ìœ¼ë©´ í˜„ì¬ URLë¡œ ë¡œë“œ
                                    val syncUrl = fullscreenWebView?.url ?: currentUrl
                                    if (syncUrl.isNotEmpty()) {
                                        this.loadUrl(syncUrl)
                                    }
                                }
                            }
                        },
                        update = { view ->
                            if (currentUrl.isNotEmpty() && view.url != currentUrl) {
                                view.loadUrl(currentUrl)
                            }
                        },
                        modifier = Modifier.fillMaxSize()
                    )
                }
            }

            // ë„¤ë¹„ê²Œì´ì…˜ ë°” (WebViewê°€ ë¡œë“œëœ ê²½ìš°ì—ë§Œ í‘œì‹œ)
            if (currentUrl.isNotEmpty()) {
                Card(
                    modifier = Modifier
                        .align(Alignment.BottomCenter)
                        .fillMaxWidth()
                        .windowInsetsPadding(WindowInsets.systemBars.only(WindowInsetsSides.Bottom))
                        .padding(horizontal = 16.dp, vertical = 20.dp),  // vertical íŒ¨ë”© ì¦ê°€ (12dp â†’ 20dp)
                    elevation = CardDefaults.cardElevation(defaultElevation = 6.dp),
                    shape = androidx.compose.foundation.shape.RoundedCornerShape(16.dp),
                    colors = CardDefaults.cardColors(
                        containerColor = MaterialTheme.colorScheme.surfaceContainer
                    )
                ) {
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(horizontal = 16.dp, vertical = 8.dp),
                        horizontalArrangement = Arrangement.SpaceEvenly,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
                        FloatingActionButton(
                            onClick = { 
                                Log.d("Navigation", "ì¼ë°˜ëª¨ë“œ ë’¤ë¡œê°€ê¸° í´ë¦­ - canGoBack: $canGoBack, webView: ${webView != null}")
                                webView?.let { view ->
                                    Log.d("Navigation", "ì¼ë°˜ëª¨ë“œ WebView canGoBack: ${view.canGoBack()}")
                                    if (view.canGoBack()) {
                                        view.goBack()
                                        // ì¦‰ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                                        Handler(Looper.getMainLooper()).postDelayed({
                                            updateNavigationState()
                                            Log.d("Navigation", "ì¼ë°˜ëª¨ë“œ ë’¤ë¡œê°€ê¸° í›„ ìƒíƒœ - canGoBack: $canGoBack, canGoForward: $canGoForward")
                                        }, 100)
                                    }
                                }
                            },
                            modifier = Modifier.size(44.dp),
                            containerColor = if (canGoBack) 
                                MaterialTheme.colorScheme.secondaryContainer 
                            else 
                                MaterialTheme.colorScheme.surfaceVariant
                        ) {
                            Icon(
                                imageVector = Icons.Default.ArrowBack,
                                contentDescription = "ë’¤ë¡œê°€ê¸°",
                                modifier = Modifier.size(20.dp),
                                tint = if (canGoBack) 
                                    MaterialTheme.colorScheme.onSecondaryContainer 
                                else 
                                    MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.5f)
                            )
                        }

                        // ìƒˆë¡œê³ ì¹¨ + MP4 ê°ì§€ ë²„íŠ¼
                        FloatingActionButton(
                            onClick = { 
                                webView?.reload()
                                Handler(Looper.getMainLooper()).postDelayed({
                                    analyzePageForMp4()
                                }, 1500)
                            },
                            modifier = Modifier.size(44.dp),
                            containerColor = MaterialTheme.colorScheme.tertiaryContainer
                        ) {
                            if (isAnalyzing) {
                                CircularProgressIndicator(
                                    modifier = Modifier.size(18.dp),
                                    color = MaterialTheme.colorScheme.onTertiaryContainer
                                )
                            } else {
                                Icon(
                                    imageVector = Icons.Default.Refresh,
                                    contentDescription = "ìƒˆë¡œê³ ì¹¨",
                                    modifier = Modifier.size(20.dp),
                                    tint = MaterialTheme.colorScheme.onTertiaryContainer
                                )
                            }
                        }

                        // ì•ìœ¼ë¡œê°€ê¸° ë²„íŠ¼
                        FloatingActionButton(
                            onClick = { 
                                Log.d("Navigation", "ì¼ë°˜ëª¨ë“œ ì•ìœ¼ë¡œê°€ê¸° í´ë¦­ - canGoForward: $canGoForward, webView: ${webView != null}")
                                webView?.let { view ->
                                    Log.d("Navigation", "ì¼ë°˜ëª¨ë“œ WebView canGoForward: ${view.canGoForward()}")
                                    if (view.canGoForward()) {
                                        view.goForward()
                                        // ì¦‰ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                                        Handler(Looper.getMainLooper()).postDelayed({
                                            updateNavigationState()
                                            Log.d("Navigation", "ì¼ë°˜ëª¨ë“œ ì•ìœ¼ë¡œê°€ê¸° í›„ ìƒíƒœ - canGoBack: $canGoBack, canGoForward: $canGoForward")
                                        }, 100)
                                    }
                                }
                            },
                            modifier = Modifier.size(44.dp),
                            containerColor = if (canGoForward) 
                                MaterialTheme.colorScheme.secondaryContainer 
                            else 
                                MaterialTheme.colorScheme.surfaceVariant
                        ) {
                            Icon(
                                imageVector = Icons.Default.ArrowForward,
                                contentDescription = "ì•ìœ¼ë¡œê°€ê¸°",
                                modifier = Modifier.size(20.dp),
                                tint = if (canGoForward) 
                                    MaterialTheme.colorScheme.onSecondaryContainer 
                                else 
                                    MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.5f)
                            )
                        }

                        // ì „ì²´í™”ë©´ ë²„íŠ¼
                        FloatingActionButton(
                            onClick = { 
                                // ì¼ë°˜ ëª¨ë“œ WebViewì˜ ìƒíƒœ ì €ì¥
                                webView?.let { mainWebView ->
                                    val bundle = Bundle()
                                    mainWebView.saveState(bundle)
                                    webViewState = bundle
                                    
                                    // í˜„ì¬ URLë„ ì—…ë°ì´íŠ¸
                                    mainWebView.url?.let { url ->
                                        if (url != currentUrl && 
                                            !url.startsWith("data:") && 
                                            !url.startsWith("about:") &&
                                            url != "about:blank") {
                                            currentUrl = url
                                            urlText = url
                                        }
                                    }
                                }
                                isWebViewFullscreen = true 
                            },
                            modifier = Modifier.size(44.dp),
                            containerColor = MaterialTheme.colorScheme.primaryContainer
                        ) {
                            Text(
                                text = "â›¶",
                                style = MaterialTheme.typography.headlineSmall,
                                color = MaterialTheme.colorScheme.onPrimaryContainer
                            )
                        }
                    }
                }
            }
        }
        
        // ë‹¤ìš´ë¡œë“œ ê²°ê³¼ ì•Œë¦¼ íŒì—… (ì¼ë°˜ ëª¨ë“œ)
        if (showDownloadResult && downloadResultMessage != null) {
            DownloadResultDialog(
                message = downloadResultMessage!!,
                onDismiss = { 
                    showDownloadResult = false
                    downloadResultMessage = null
                }
            )
        }
    }
}
</file>

<file path="app/build.gradle.kts">
plugins {
    alias(libs.plugins.android.application)
    alias(libs.plugins.kotlin.android)
    alias(libs.plugins.kotlin.compose)
}

android {
    namespace = "com.swvd.simplewebvideodownloader"
    compileSdk = 35

    defaultConfig {
        applicationId = "com.swvd.simplewebvideodownloader"
        minSdk = 24
        targetSdk = 35
        versionCode = 58
        versionName = "5.8"

        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        release {
            isMinifyEnabled = false
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
    }
    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_11
        targetCompatibility = JavaVersion.VERSION_11
    }
    kotlinOptions {
        jvmTarget = "11"
    }
    buildFeatures {
        compose = true
    }
}

dependencies {

    implementation(libs.androidx.core.ktx)
    implementation(libs.androidx.lifecycle.runtime.ktx)
    implementation(libs.androidx.activity.compose)
    implementation(platform(libs.androidx.compose.bom))
    implementation(libs.androidx.ui)
    implementation(libs.androidx.ui.graphics)
    implementation(libs.androidx.ui.tooling.preview)
    implementation(libs.androidx.material3)

    // HTML íŒŒì‹±ì„ ìœ„í•œ Jsoup ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
    implementation("org.jsoup:jsoup:1.17.2")

    testImplementation(libs.junit)
    androidTestImplementation(libs.androidx.junit)
    androidTestImplementation(libs.androidx.espresso.core)
    androidTestImplementation(platform(libs.androidx.compose.bom))
    androidTestImplementation(libs.androidx.ui.test.junit4)
    debugImplementation(libs.androidx.ui.tooling)
    debugImplementation(libs.androidx.ui.test.manifest)
}
</file>

</files>
</file>

<file path=".cursor/rules/android-development-best-practices.mdc">
---
description: 
globs: 
alwaysApply: false
---
# Android Development Best Practices & Error Prevention

## Critical Function Context Awareness

### 1. Function Reference vs Lambda Distinction
**ALWAYS** verify function signature compatibility when using function references (`::functionName`):
- âŒ WRONG: `onLoadUrl = ::loadUrl` when loadUrl() takes no parameters but callback expects (String) -> Unit
- âœ… CORRECT: `onLoadUrl = { url -> loadUrl(url) }` or implement proper parameter handling

**Rule**: Before using `::` function reference, verify parameter count and types match exactly.

### 2. Composable Context Validation
**NEVER** call @Composable functions outside of @Composable context:
- âŒ WRONG: Calling Composable functions inside AndroidView factory lambdas
- âœ… CORRECT: Use WebView.loadUrl() method explicitly with `this.loadUrl(url)`

**Template for WebView factory**:
```kotlin
AndroidView(
    factory = { context ->
        WebView(context).apply {
            // Use this.loadUrl() for WebView method
            // NOT loadUrl() which might reference @Composable function
        }
    }
)
```

## Build System & Import Management

### 3. Progressive Import Addition
When adding new UI components, add imports incrementally:
1. First add core UI imports (BorderStroke, icons)
2. Test compilation after each major component addition
3. Never add all imports at once without verification

**Required imports checklist for new UI components**:
- `androidx.compose.foundation.BorderStroke` for Card borders
- `androidx.compose.material.icons.filled.*` for specific icons
- `androidx.compose.foundation.lazy.grid.*` for grid layouts

### 4. Version Management Strategy
**ALWAYS** increment version numbers when adding major features:
- Minor UI changes: patch version (5.2.1)
- New feature components: minor version (5.3.0)
- Major UI overhauls: major version (6.0.0)

## UI Component Architecture

### 5. Component Parameter Validation
When creating new @Composable functions with many parameters:
1. **ALWAYS** verify all callback functions are properly typed
2. Use explicit lambda syntax for complex callbacks
3. Test component isolation before integration

**Template for complex UI components**:
```kotlin
@Composable
fun ComplexUI(
    // State parameters first
    state: UIState,
    // Simple callbacks second  
    onSimpleAction: () -> Unit,
    // Complex callbacks with explicit types
    onComplexAction: (param: Type) -> Unit,
    // Content composables last
    content: @Composable () -> Unit
)
```

### 6. State Management Validation
Before implementing new UI features:
1. Identify ALL state variables needed
2. Define state update functions explicitly
3. Verify state synchronization between components

**State checklist for tabbed UI**:
- Tab list state
- Current tab index
- Tab overview visibility
- URL editing state
- History dropdown state

## Error Recovery Patterns

### 7. Compilation Error Debugging Process
When compilation fails:
1. **STOP** and read error messages completely
2. Identify error categories: type mismatch, context issues, missing imports
3. Fix ONE category at a time
4. Test compilation after each fix category

### 8. WebView Integration Safety
**ALWAYS** distinguish between:
- WebView native methods (use `this.methodName()`)
- Custom Composable functions (use proper context)
- State management functions (verify @Composable context)

## Code Review Checklist

Before committing new UI features:
- [ ] All function references use correct syntax
- [ ] No @Composable functions called outside @Composable context  
- [ ] All required imports are present
- [ ] Version number is incremented appropriately
- [ ] Build succeeds without errors
- [ ] UI components are properly isolated and testable

## Emergency Rollback Protocol

If major UI changes cause compilation issues:
1. **IMMEDIATELY** test build after each significant change
2. Use git tags for stable versions (`v5.1`, `v5.2`)
3. Keep incremental commits for easy rollback
4. Never combine multiple major changes in single commit

**Rollback command template**:
```bash
git reset --hard v[last-working-version]
git checkout -b fix/[issue-description]
# Implement changes incrementally
```

## Learning Integration

### Apply Error Analysis
1. **Document** each error type encountered
2. **Categorize** errors: syntax, context, architecture
3. **Create** specific rules for each error category
4. **Review** rules before similar development tasks

This rule system ensures systematic error prevention and promotes clean, maintainable Android Compose code architecture.
</file>

<file path=".cursor/rules/kotlin-compose-safety.mdc">
---
description: 
globs: 
alwaysApply: true
---
# Kotlin Compose Safety Guidelines & Error Prevention

## Function Reference Safety Patterns

### 1. Method Reference Validation Protocol
**CRITICAL**: Always verify parameter signatures before using `::` syntax

**Safe Pattern**:
```kotlin
// âŒ DANGEROUS - Parameter mismatch
onCallback = ::functionWithNoParams  // when callback expects (String) -> Unit

// âœ… SAFE - Explicit lambda with proper parameters
onCallback = { param -> functionWithNoParams() }
// OR implement function to accept parameters
onCallback = ::functionWithCorrectSignature
```

**Verification Checklist**:
- [ ] Count parameters: callback signature vs function signature
- [ ] Check parameter types: exact type matching required
- [ ] Verify return types: Unit vs specific return types
- [ ] Test with simple lambda first, then optimize to method reference

### 2. Composable Context Isolation
**NEVER** mix Android View methods with Composable functions

**Reference pattern in [MainActivity.kt](mdc:app/src/main/java/com/swvd/simplewebvideodownloader/MainActivity.kt)**:
```kotlin
AndroidView(
    factory = { context ->
        WebView(context).apply {
            // âœ… CORRECT - Use Android View methods explicitly
            this.loadUrl(url)
            
            // âŒ WRONG - Don't call Composable functions here
            // loadUrl(url)  // This might reference @Composable function
        }
    }
)
```

## State Management Safety

### 3. State Synchronization Validation
When managing complex UI state, ensure all state variables are properly initialized:

**Required state variables for complex UI (based on FullscreenUI implementation)**:
```kotlin
// Tab management state
var tabs by remember { mutableStateOf(listOf(Tab())) }
var currentTabIndex by remember { mutableIntStateOf(0) }

// UI mode state  
var showTabOverview by remember { mutableStateOf(false) }
var isEditingUrl by remember { mutableStateOf(false) }

// Content state
var urlText by remember { mutableStateOf("") }
var currentUrl by remember { mutableStateOf("") }
```

### 4. Lambda Parameter Handling
For complex callback implementations, use explicit parameter handling:

**Template from successful FullscreenUI implementation**:
```kotlin
onLoadUrl = { url ->
    // Step 1: Input validation and URL formatting
    val finalUrl = if (!url.startsWith("http://") && !url.startsWith("https://")) {
        "https://$url"
    } else {
        url
    }
    
    // Step 2: State updates
    currentUrl = finalUrl
    urlText = finalUrl
    
    // Step 3: Complex state synchronization
    currentTab?.let { tab ->
        tabs = tabs.map {
            if (it.id == tab.id) it.copy(url = finalUrl)
            else it
        }
    }
    
    // Step 4: Side effects (WebView, history, etc.)
    fullscreenWebView?.loadUrl(finalUrl)
    
    // Step 5: Async operations
    Handler(Looper.getMainLooper()).postDelayed({
        analyzePageForMp4()
    }, 1000)
}
```

## Import Management Safety

### 5. Progressive Import Strategy
Add imports in dependency order to avoid missing import errors:

**Phase 1 - Foundation**:
```kotlin
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
```

**Phase 2 - Layout**:
```kotlin
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
```

**Phase 3 - Material**:
```kotlin
import androidx.compose.material.icons.filled.Check
import androidx.compose.material.icons.filled.Info
import androidx.compose.material3.*
```

### 6. Icon Compatibility Safety
**WARNING**: Some Material Icons are deprecated. Use safe alternatives:

```kotlin
// âš ï¸  DEPRECATED (causes warnings)
Icons.Filled.ArrowBack
Icons.Filled.ArrowForward

// âœ… SAFE ALTERNATIVES
Icons.Default.ArrowBack  // Generic version
Icons.AutoMirrored.Filled.ArrowBack  // New recommended version
```

## Component Architecture Safety

### 7. Large Component Parameter Validation
For components with many parameters (like FullscreenUI), group parameters logically:

**Safe parameter grouping pattern**:
```kotlin
@Composable
fun ComplexComponent(
    // Group 1: Core state
    tabs: List<Tab>,
    currentTabIndex: Int,
    currentUrl: String,
    
    // Group 2: UI state  
    showOverview: Boolean,
    isEditing: Boolean,
    
    // Group 3: Simple callbacks
    onSimpleAction: () -> Unit,
    onStateChange: (Boolean) -> Unit,
    
    // Group 4: Complex callbacks with explicit types
    onComplexAction: (String) -> Unit,
    onMultiParamAction: (Int, String) -> Unit,
    
    // Group 5: Composable content
    content: @Composable () -> Unit
)
```

### 8. WebView Integration Safety
**ALWAYS** distinguish between WebView instance methods and app functions:

```kotlin
// âœ… SAFE - WebView instance method
webView.loadUrl(url)
this.loadUrl(url)  // Inside WebView.apply block

// âŒ DANGEROUS - Might reference wrong function
loadUrl(url)  // Could be Composable function

// âœ… SAFE - App function with proper context
loadUrlInApp(url)  // Clear naming prevents confusion
```

## Error Recovery Patterns

### 9. Compilation Error Triage
When build fails, fix errors in this priority order:

1. **Import errors** - Missing or incorrect imports
2. **Type mismatch errors** - Function signature incompatibilities  
3. **Context errors** - @Composable function calls in wrong context
4. **Scope errors** - Variable access outside proper scope

### 10. Git Safety for Complex UI Changes
Before implementing complex UI features:

```bash
# Create feature branch
git checkout -b feature/new-ui-component

# Commit working state first
git add .
git commit -m "Working state before UI changes"

# Tag for easy rollback
git tag before-ui-changes

# Implement changes incrementally with frequent commits
git commit -m "Add basic component structure"
git commit -m "Add state management"  
git commit -m "Add interactions"
```

## Testing & Validation Safety

### 11. Incremental Build Validation
After each major change:
- [ ] Clean build: `./gradlew clean`
- [ ] Compile check: `./gradlew compileDebugKotlin`
- [ ] Full build: `./gradlew assembleDebug`
- [ ] Runtime test: Install and basic functionality check

### 12. Component Isolation Testing
Before integrating complex components:
1. Create minimal test implementation
2. Verify basic rendering
3. Test state changes
4. Validate callbacks
5. Check error conditions

This safety framework prevents common Kotlin Compose errors and ensures reliable development progression.
</file>

<file path=".cursor/rules/prompt-engineering-guidelines.mdc">
---
description: 
globs: 
alwaysApply: true
---
# Prompt Engineering Guidelines for AI-Assisted Development

## Structured Communication Patterns

### 1. Requirement Specification Template
When requesting new features, ALWAYS use this structure:

```
CONTEXT: [Current state/version]
GOAL: [Specific desired outcome]
CONSTRAINTS: [Technical limitations, existing architecture]
ACCEPTANCE CRITERIA: [Measurable success conditions]
PRIORITY: [Critical/High/Medium/Low]
```

**Example**:
```
CONTEXT: v5.2 with basic tab functionality
GOAL: Full-screen UI with 5-button navigation layout
CONSTRAINTS: Must preserve existing WebView functionality
ACCEPTANCE CRITERIA: URL editing, tab overview, 5 navigation buttons working
PRIORITY: High
```

### 2. Progressive Feature Development Protocol
**NEVER** request complex features in single iteration:

1. **Phase 1**: Core structure and basic UI
2. **Phase 2**: State management and interactions  
3. **Phase 3**: Advanced features and polish
4. **Phase 4**: Testing and optimization

### 3. Error Context Enrichment
When reporting errors, provide:
- **Exact error messages** (copy-paste)
- **File location** (line numbers)
- **Expected behavior** vs actual behavior
- **Recent changes** that might be related

## AI Collaboration Optimization

### 4. Code Review Request Format
Structure code review requests with specific focus areas:

```
REVIEW FOCUS:
- [ ] Function signature compatibility
- [ ] @Composable context safety
- [ ] Import completeness
- [ ] State management patterns
- [ ] Error handling coverage

SPECIFIC CONCERNS:
[List specific areas of uncertainty]
```

### 5. Incremental Validation Strategy
**ALWAYS** request AI to:
1. Validate approach BEFORE implementation
2. Break complex changes into reviewable chunks
3. Provide checkpoint verification steps
4. Include rollback instructions for each phase

### 6. Knowledge Transfer Documentation
When AI provides solutions, request:
- **Why** this approach was chosen
- **What** alternatives were considered
- **How** to modify for similar future cases
- **When** this pattern should/shouldn't be used

## Quality Assurance Integration

### 7. Pre-Implementation Verification
Before requesting implementation, AI should confirm:
- [ ] Understanding of current architecture (reference [MainActivity.kt](mdc:app/src/main/java/com/swvd/simplewebvideodownloader/MainActivity.kt))
- [ ] Compatibility with existing build system (reference [build.gradle.kts](mdc:app/build.gradle.kts))
- [ ] Import requirements identification
- [ ] Testing strategy for new features

### 8. Build Verification Protocol
After each significant change, request AI to:
1. Predict potential compilation issues
2. Verify all required imports are present
3. Check function signature compatibility
4. Validate @Composable context usage

## Learning & Adaptation Patterns

### 9. Error Pattern Recognition
Maintain ongoing dialogue about:
- **Recurring error types** and their root causes
- **Successful patterns** that prevented errors
- **Architecture decisions** that simplified development
- **Tool usage** that improved efficiency

### 10. Contextual Memory Management
Help AI maintain context by:
- **Referencing** previous successful solutions
- **Linking** current issues to past similar problems
- **Updating** AI on project evolution and changes
- **Confirming** AI's understanding before complex operations

## Communication Efficiency Rules

### 11. Clarity Over Brevity
- Use specific technical terms correctly
- Provide complete context rather than assuming knowledge
- Ask for clarification when requirements are ambiguous
- Confirm understanding before proceeding with implementation

### 12. Iterative Refinement Process
Structure conversations for continuous improvement:
1. **Initial request** with clear requirements
2. **AI proposal** with approach explanation
3. **Human feedback** with specific adjustments
4. **Refined solution** with implementation plan
5. **Validation** of results and lessons learned

## Meta-Learning Integration

### 13. Rule Evolution Protocol
Regularly update these rules based on:
- **New error patterns** discovered in development
- **Successful collaboration** techniques that emerge
- **Tool capabilities** that improve over time
- **Project complexity** changes requiring adaptation

### 14. Knowledge Consolidation
After major development phases:
- Document successful patterns for reuse
- Identify ineffective approaches to avoid
- Update architectural guidelines based on experience
- Create project-specific rule extensions

This prompt engineering framework ensures efficient, error-free AI-assisted development while building cumulative knowledge for future projects.
</file>

<file path="app/src/androidTest/java/com/swvd/simplewebvideodownloader/ExampleInstrumentedTest.kt">
package com.swvd.simplewebvideodownloader

import androidx.test.platform.app.InstrumentationRegistry
import androidx.test.ext.junit.runners.AndroidJUnit4

import org.junit.Test
import org.junit.runner.RunWith

import org.junit.Assert.*

/**
 * Instrumented test, which will execute on an Android device.
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
@RunWith(AndroidJUnit4::class)
class ExampleInstrumentedTest {
    @Test
    fun useAppContext() {
        // Context of the app under test.
        val appContext = InstrumentationRegistry.getInstrumentation().targetContext
        assertEquals("com.swvd.simplewebvideodownloader", appContext.packageName)
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/download/DownloadHandler.kt">
package com.swvd.simplewebvideodownloader.download

import android.Manifest
import android.app.DownloadManager
import android.content.Context
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Environment
import android.widget.Toast
import androidx.core.content.ContextCompat

/**
 * íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬ í´ë˜ìŠ¤
 * MP4 ë¹„ë””ì˜¤ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì„ ë‹´ë‹¹
 */
class DownloadHandler(private val context: Context) {
    
    /**
     * ì €ì¥ì†Œ ê¶Œí•œ í™•ì¸
     * Android 10 ì´í•˜ì—ì„œë§Œ WRITE_EXTERNAL_STORAGE ê¶Œí•œ í•„ìš”
     */
    fun checkStoragePermissions(): List<String> {
        val permissions = mutableListOf<String>()
        
        // Android 10 (API 29) ì´í•˜ì—ì„œë§Œ WRITE_EXTERNAL_STORAGE ê¶Œí•œ í•„ìš”
        if (android.os.Build.VERSION.SDK_INT <= android.os.Build.VERSION_CODES.P) {
            if (ContextCompat.checkSelfPermission(context, Manifest.permission.WRITE_EXTERNAL_STORAGE)
                != PackageManager.PERMISSION_GRANTED) {
                permissions.add(Manifest.permission.WRITE_EXTERNAL_STORAGE)
            }
        }
        
        return permissions
    }
    
    /**
     * íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
     * @param url ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ URL
     * @param filename ì €ì¥í•  íŒŒì¼ëª…
     */
    fun downloadFile(url: String, filename: String) {
        try {
            // íŒŒì¼ëª…ì—ì„œ íŠ¹ìˆ˜ë¬¸ì ì œê±°
            val safeFilename = filename.replace(Regex("[^a-zA-Z0-9._-]"), "_")

            val request = DownloadManager.Request(Uri.parse(url))
                .setTitle("ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ")
                .setDescription("$safeFilename ë‹¤ìš´ë¡œë“œ ì¤‘...")
                .setNotificationVisibility(DownloadManager.Request.VISIBILITY_VISIBLE_NOTIFY_COMPLETED)
                .setAllowedOverMetered(true)
                .setAllowedOverRoaming(true)

            // Android 10 ì´ìƒì—ì„œëŠ” Downloads í´ë”ì— ì €ì¥
            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.Q) {
                request.setDestinationInExternalPublicDir(Environment.DIRECTORY_DOWNLOADS, safeFilename)
            } else {
                request.setDestinationInExternalPublicDir(Environment.DIRECTORY_DOWNLOADS, safeFilename)
            }

            val downloadManager = context.getSystemService(Context.DOWNLOAD_SERVICE) as DownloadManager
            val downloadId = downloadManager.enqueue(request)

            Toast.makeText(context, "ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤\níŒŒì¼: $safeFilename\nDownloads í´ë”ì— ì €ì¥ë©ë‹ˆë‹¤", Toast.LENGTH_LONG).show()

        } catch (e: Exception) {
            Toast.makeText(context, "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${e.message}", Toast.LENGTH_LONG).show()
        }
    }
    
    /**
     * URL ìœ íš¨ì„± ê²€ì‚¬
     * @param url ê²€ì‚¬í•  URL
     * @return ìœ íš¨í•œ URLì¸ì§€ ì—¬ë¶€
     */
    fun isValidUrl(url: String): Boolean {
        val cleanUrl = url.trim()
        return cleanUrl.startsWith("http://") || cleanUrl.startsWith("https://")
    }
    
    /**
     * íŒŒì¼ëª… ìƒì„±
     * URLì—ì„œ ì ì ˆí•œ íŒŒì¼ëª…ì„ ìƒì„±
     */
    fun generateFilename(url: String): String {
        return try {
            val uri = Uri.parse(url.trim())
            val pathSegment = uri.lastPathSegment
            when {
                pathSegment != null && pathSegment.contains(".mp4") -> pathSegment
                pathSegment != null -> "${pathSegment}.mp4"
                else -> "video_${System.currentTimeMillis()}.mp4"
            }
        } catch (e: Exception) {
            "video_${System.currentTimeMillis()}.mp4"
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/models/Tab.kt">
package com.swvd.simplewebvideodownloader.models

import java.util.UUID

/**
 * íƒ­ ë°ì´í„° ëª¨ë¸
 * ë¸Œë¼ìš°ì € íƒ­ì˜ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ë°ì´í„° í´ë˜ìŠ¤
 */
data class Tab(
    val id: String = UUID.randomUUID().toString(),
    var title: String = "ìƒˆ íƒ­",
    var url: String = "https://www.google.com"
)
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/components/DialogComponents.kt">
package com.swvd.simplewebvideodownloader.ui.components

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.interaction.MutableInteractionSource
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.itemsIndexed
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Check
import androidx.compose.material.icons.filled.Close
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp

/**
 * MP4 ëª©ë¡ ë‹¤ì´ì–¼ë¡œê·¸
 * ê°ì§€ëœ MP4 ë¹„ë””ì˜¤ ëª©ë¡ì„ í‘œì‹œí•˜ê³  ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆëŠ” ë‹¤ì´ì–¼ë¡œê·¸
 */
@Composable
fun Mp4ListDialog(
    mp4Links: List<String>,
    downloadingUrls: Set<String>,
    onDownload: (String) -> Unit,
    onDismiss: () -> Unit
) {
    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.Black.copy(alpha = 0.5f))
            .clickable(
                interactionSource = remember { MutableInteractionSource() },
                indication = null
            ) { onDismiss() },
        contentAlignment = Alignment.Center
    ) {
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp)
                .heightIn(max = 400.dp),
            shape = RoundedCornerShape(16.dp),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surface
            ),
            elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)
        ) {
            Column(
                modifier = Modifier.padding(16.dp)
            ) {
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(
                        text = "MP4 ë¹„ë””ì˜¤ ëª©ë¡",
                        style = MaterialTheme.typography.titleMedium,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                    Text(
                        text = "(${mp4Links.size}ê°œ)",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.7f)
                    )
                }
                
                Spacer(modifier = Modifier.height(16.dp))
                
                if (mp4Links.isEmpty()) {
                    Text(
                        text = "MP4 ë¹„ë””ì˜¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë‹¤ë¥¸ í˜ì´ì§€ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.7f),
                        modifier = Modifier.padding(vertical = 16.dp)
                    )
                } else {
                    LazyColumn(
                        verticalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        itemsIndexed(mp4Links) { index, url ->
                            val isDownloading = downloadingUrls.contains(url)
                            
                            Card(
                                modifier = Modifier.fillMaxWidth(),
                                colors = CardDefaults.cardColors(
                                    containerColor = if (isDownloading) 
                                        MaterialTheme.colorScheme.primaryContainer.copy(alpha = 0.3f)
                                    else 
                                        MaterialTheme.colorScheme.surfaceVariant
                                )
                            ) {
                                Column(
                                    modifier = Modifier.padding(12.dp)
                                ) {
                                    Text(
                                        text = "ë¹„ë””ì˜¤ ${index + 1}",
                                        style = MaterialTheme.typography.titleSmall,
                                        color = MaterialTheme.colorScheme.onSurfaceVariant,
                                        modifier = Modifier.padding(bottom = 4.dp)
                                    )
                                    
                                    Text(
                                        text = url.let { 
                                            when {
                                                it.length <= 50 -> it
                                                else -> "${it.take(25)}...${it.takeLast(22)}"
                                            }
                                        },
                                        style = MaterialTheme.typography.bodySmall,
                                        color = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.8f),
                                        maxLines = 2,
                                        overflow = TextOverflow.Ellipsis,
                                        modifier = Modifier.padding(bottom = 8.dp)
                                    )
                                    
                                    Button(
                                        onClick = { onDownload(url) },
                                        enabled = !isDownloading,
                                        modifier = Modifier.fillMaxWidth()
                                    ) {
                                        if (isDownloading) {
                                            CircularProgressIndicator(
                                                modifier = Modifier.size(16.dp),
                                                color = MaterialTheme.colorScheme.onPrimary
                                            )
                                            Spacer(modifier = Modifier.width(8.dp))
                                            Text("ë‹¤ìš´ë¡œë“œ ì¤‘...")
                                        } else {
                                            Text("ë‹¤ìš´ë¡œë“œ")
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                Spacer(modifier = Modifier.height(16.dp))
                
                Button(
                    onClick = onDismiss,
                    modifier = Modifier.fillMaxWidth()
                ) {
                    Text("ë‹«ê¸°")
                }
            }
        }
    }
}

/**
 * ë‹¤ìš´ë¡œë“œ ê²°ê³¼ ì•Œë¦¼ ë‹¤ì´ì–¼ë¡œê·¸
 * ë‹¤ìš´ë¡œë“œ ì„±ê³µ/ì‹¤íŒ¨ ê²°ê³¼ë¥¼ í‘œì‹œí•˜ëŠ” ë‹¤ì´ì–¼ë¡œê·¸
 */
@Composable
fun DownloadResultDialog(
    message: String,
    onDismiss: () -> Unit
) {
    // ìë™ìœ¼ë¡œ ì‚¬ë¼ì§€ë„ë¡ LaunchedEffect ì‚¬ìš©
    LaunchedEffect(message) {
        kotlinx.coroutines.delay(if (message.contains("ì‹¤íŒ¨")) 5000 else 3000)
        onDismiss()
    }

    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.Black.copy(alpha = 0.4f))
            .clickable(
                interactionSource = remember { MutableInteractionSource() },
                indication = null
            ) { onDismiss() },
        contentAlignment = Alignment.Center
    ) {
        Card(
            modifier = Modifier
                .padding(32.dp)
                .widthIn(min = 280.dp, max = 400.dp)
                .clickable(
                    interactionSource = remember { MutableInteractionSource() },
                    indication = null
                ) { /* ì¹´ë“œ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€ */ },
            shape = RoundedCornerShape(16.dp),
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.surface
            ),
            elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)
        ) {
            Column(
                modifier = Modifier.padding(24.dp),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                // ì•„ì´ì½˜ (ì„±ê³µ/ì‹¤íŒ¨ì— ë”°ë¼)
                Icon(
                    imageVector = if (message.contains("ì‹¤íŒ¨")) Icons.Default.Close else Icons.Default.Check,
                    contentDescription = null,
                    modifier = Modifier.size(48.dp),
                    tint = if (message.contains("ì‹¤íŒ¨")) 
                        MaterialTheme.colorScheme.error 
                    else 
                        MaterialTheme.colorScheme.primary
                )
                
                Spacer(modifier = Modifier.height(16.dp))
                
                // ë©”ì‹œì§€
                Text(
                    text = message,
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurface,
                    textAlign = TextAlign.Center,
                    lineHeight = 20.sp
                )
                
                Spacer(modifier = Modifier.height(20.dp))
                
                // í™•ì¸ ë²„íŠ¼
                Button(
                    onClick = onDismiss,
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.buttonColors(
                        containerColor = if (message.contains("ì‹¤íŒ¨")) 
                            MaterialTheme.colorScheme.error 
                        else 
                            MaterialTheme.colorScheme.primary
                    )
                ) {
                    Text("í™•ì¸")
                }
            }
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/screens/FullscreenScreen.kt">
package com.swvd.simplewebvideodownloader.ui.screens

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.KeyboardActions
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.input.ImeAction
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import com.swvd.simplewebvideodownloader.models.Tab
import com.swvd.simplewebvideodownloader.ui.components.TabOverviewScreen

/**
 * ì „ì²´í™”ë©´ UI ì»´í¬ë„ŒíŠ¸
 * ì›¹ë·°ë¥¼ ì „ì²´í™”ë©´ìœ¼ë¡œ í‘œì‹œí•  ë•Œ ì‚¬ìš©í•˜ëŠ” UI
 */
@Composable
fun FullscreenUI(
    tabs: List<Tab>,
    currentTabIndex: Int,
    currentUrl: String,
    urlText: String,
    onUrlTextChange: (String) -> Unit,
    onLoadUrl: (String) -> Unit,
    showTabOverview: Boolean,
    onShowTabOverview: (Boolean) -> Unit,
    onAddNewTab: () -> Unit,
    canGoBack: Boolean,
    canGoForward: Boolean,
    isAnalyzing: Boolean,
    mp4Links: List<String>,
    downloadingUrls: Set<String>,
    urlHistory: List<String>,
    onGoBack: () -> Unit,
    onGoForward: () -> Unit,
    onRefresh: () -> Unit,
    onShowMp4List: () -> Unit,
    onSwitchTab: (Int) -> Unit,
    onCloseTab: (Int) -> Unit,
    onDownloadVideo: (String) -> Unit,
    onExitFullscreen: () -> Unit,
    webViewContent: @Composable () -> Unit
) {
    var isEditingUrl by remember { mutableStateOf(false) }
    var editUrlText by remember { mutableStateOf("") }
    var showHistoryDropdown by remember { mutableStateOf(false) }

    Box(modifier = Modifier.fillMaxSize()) {
        if (showTabOverview) {
            // íƒ­ ì˜¤ë²„ë·° í™”ë©´
            TabOverviewScreen(
                tabs = tabs,
                currentTabIndex = currentTabIndex,
                onTabSelected = { index ->
                    onSwitchTab(index)
                    onShowTabOverview(false)
                },
                onTabClosed = { index ->
                    onCloseTab(index)
                    if (tabs.size == 1) {
                        onShowTabOverview(false)
                    }
                },
                onAddNewTab = {
                    onAddNewTab()
                    onShowTabOverview(false)
                },
                onBackToWebView = { onShowTabOverview(false) }
            )
        } else {
            // ì›¹ë·° í™”ë©´
            Column(modifier = Modifier.fillMaxSize()) {
                // ìƒë‹¨ ë°”
                FullscreenTopBar(
                    currentUrl = currentUrl,
                    isEditingUrl = isEditingUrl,
                    editUrlText = editUrlText,
                    tabs = tabs,
                    urlHistory = urlHistory,
                    showHistoryDropdown = showHistoryDropdown,
                    onEditUrlTextChange = { editUrlText = it },
                    onStartEditingUrl = { 
                        editUrlText = currentUrl
                        isEditingUrl = true 
                    },
                    onStopEditingUrl = { isEditingUrl = false },
                    onShowHistoryDropdown = { showHistoryDropdown = it },
                    onLoadUrl = onLoadUrl,
                    onAddNewTab = onAddNewTab,
                    onShowTabOverview = { onShowTabOverview(true) },
                    onExitFullscreen = onExitFullscreen
                )

                // ì›¹ë·° ì½˜í…ì¸ 
                Box(modifier = Modifier.weight(1f)) {
                    webViewContent()
                }

                // í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°”
                FullscreenBottomBar(
                    canGoBack = canGoBack,
                    canGoForward = canGoForward,
                    isAnalyzing = isAnalyzing,
                    urlHistory = urlHistory,
                    onGoBack = onGoBack,
                    onGoForward = onGoForward,
                    onRefresh = onRefresh,
                    onShowMp4List = onShowMp4List,
                    onShowHistory = { showHistoryDropdown = !showHistoryDropdown }
                )
            }
        }
    }
}

/**
 * ì „ì²´í™”ë©´ ìƒë‹¨ ë°”
 */
@Composable
private fun FullscreenTopBar(
    currentUrl: String,
    isEditingUrl: Boolean,
    editUrlText: String,
    tabs: List<Tab>,
    urlHistory: List<String>,
    showHistoryDropdown: Boolean,
    onEditUrlTextChange: (String) -> Unit,
    onStartEditingUrl: () -> Unit,
    onStopEditingUrl: () -> Unit,
    onShowHistoryDropdown: (Boolean) -> Unit,
    onLoadUrl: (String) -> Unit,
    onAddNewTab: () -> Unit,
    onShowTabOverview: () -> Unit,
    onExitFullscreen: () -> Unit
) {
    Surface(
        modifier = Modifier
            .fillMaxWidth()
            .windowInsetsPadding(WindowInsets.systemBars.only(WindowInsetsSides.Top)),
        color = MaterialTheme.colorScheme.surface.copy(alpha = 0.95f),
        tonalElevation = 4.dp
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp, vertical = 12.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            // ì¢Œì¸¡: URL í‘œì‹œ/í¸ì§‘
            if (isEditingUrl) {
                OutlinedTextField(
                    value = editUrlText,
                    onValueChange = onEditUrlTextChange,
                    modifier = Modifier.weight(1f),
                    placeholder = { Text("URL ì…ë ¥") },
                    keyboardOptions = KeyboardOptions(imeAction = ImeAction.Go),
                    keyboardActions = KeyboardActions(
                        onGo = {
                            if (editUrlText.isNotBlank()) {
                                val url = if (!editUrlText.startsWith("http")) {
                                    "https://$editUrlText"
                                } else {
                                    editUrlText
                                }
                                onLoadUrl(url)
                            }
                            onStopEditingUrl()
                        }
                    ),
                    trailingIcon = {
                        Row {
                            IconButton(
                                onClick = {
                                    if (editUrlText.isNotBlank()) {
                                        val url = if (!editUrlText.startsWith("http")) {
                                            "https://$editUrlText"
                                        } else {
                                            editUrlText
                                        }
                                        onLoadUrl(url)
                                    }
                                    onStopEditingUrl()
                                }
                            ) {
                                Icon(Icons.Default.Check, "í™•ì¸")
                            }
                            IconButton(onClick = onStopEditingUrl) {
                                Icon(Icons.Default.Close, "ì·¨ì†Œ")
                            }
                            IconButton(onClick = { onShowHistoryDropdown(!showHistoryDropdown) }) {
                                Icon(Icons.Default.Info, "ê¸°ë¡")
                            }
                        }
                    },
                    singleLine = true
                )
            } else {
                Surface(
                    modifier = Modifier
                        .weight(1f)
                        .clickable { onStartEditingUrl() },
                    shape = RoundedCornerShape(8.dp),
                    color = MaterialTheme.colorScheme.surfaceVariant
                ) {
                    Text(
                        text = currentUrl.takeIf { it.isNotEmpty() } ?: "URLì„ ì…ë ¥í•˜ì„¸ìš”",
                        modifier = Modifier.padding(12.dp),
                        style = MaterialTheme.typography.bodyMedium,
                        maxLines = 1,
                        overflow = TextOverflow.Ellipsis
                    )
                }
            }

            Spacer(modifier = Modifier.width(16.dp))

            // ìš°ì¸¡: ìƒˆ íƒ­ ì¶”ê°€, íƒ­ ê°œìˆ˜, ì „ì²´í™”ë©´ ì¢…ë£Œ (3ê°œ ë²„íŠ¼)
            Row(
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                // 1. ìƒˆ íƒ­ ì¶”ê°€ ë²„íŠ¼
                IconButton(onClick = onAddNewTab) {
                    Icon(
                        Icons.Default.Add, 
                        contentDescription = "ìƒˆ íƒ­",
                        tint = MaterialTheme.colorScheme.onSurface
                    )
                }
                
                // 2. íƒ­ ê°œìˆ˜ (íƒ­ ì˜¤ë²„ë·°ë¡œ ì´ë™)
                Surface(
                    modifier = Modifier.clickable { onShowTabOverview() },
                    shape = RoundedCornerShape(16.dp),
                    color = MaterialTheme.colorScheme.primary
                ) {
                    Text(
                        text = tabs.size.toString(),
                        modifier = Modifier.padding(horizontal = 12.dp, vertical = 6.dp),
                        style = MaterialTheme.typography.labelLarge,
                        color = MaterialTheme.colorScheme.onPrimary
                    )
                }
                
                // 3. ì „ì²´í™”ë©´ ì¢…ë£Œ ë²„íŠ¼
                IconButton(onClick = onExitFullscreen) {
                    Icon(
                        Icons.Default.Close,
                        contentDescription = "ì „ì²´í™”ë©´ ì¢…ë£Œ",
                        tint = MaterialTheme.colorScheme.error
                    )
                }
            }
        }

        // URL íˆìŠ¤í† ë¦¬ ë“œë¡­ë‹¤ìš´
        if (showHistoryDropdown && urlHistory.isNotEmpty()) {
            LazyColumn(
                modifier = Modifier
                    .fillMaxWidth()
                    .heightIn(max = 200.dp)
                    .background(MaterialTheme.colorScheme.surfaceVariant)
                    .padding(8.dp)
            ) {
                items(urlHistory.reversed()) { url ->
                    Text(
                        text = url,
                        modifier = Modifier
                            .fillMaxWidth()
                            .clickable {
                                onLoadUrl(url)
                                onShowHistoryDropdown(false)
                            }
                            .padding(12.dp),
                        style = MaterialTheme.typography.bodySmall,
                        maxLines = 1,
                        overflow = TextOverflow.Ellipsis
                    )
                }
            }
        }
    }
}

/**
 * ì „ì²´í™”ë©´ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°”
 */
@Composable
private fun FullscreenBottomBar(
    canGoBack: Boolean,
    canGoForward: Boolean,
    isAnalyzing: Boolean,
    urlHistory: List<String>,
    onGoBack: () -> Unit,
    onGoForward: () -> Unit,
    onRefresh: () -> Unit,
    onShowMp4List: () -> Unit,
    onShowHistory: () -> Unit
) {
    Surface(
        modifier = Modifier
            .fillMaxWidth()
            .windowInsetsPadding(WindowInsets.systemBars.only(WindowInsetsSides.Bottom)),
        color = MaterialTheme.colorScheme.surface.copy(alpha = 0.95f),
        tonalElevation = 4.dp
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp, vertical = 12.dp),
            horizontalArrangement = Arrangement.SpaceEvenly,
            verticalAlignment = Alignment.CenterVertically
        ) {
            // 1. ë’¤ë¡œê°€ê¸°
            IconButton(
                onClick = onGoBack,
                enabled = canGoBack
            ) {
                Icon(
                    Icons.Default.ArrowBack,
                    "ë’¤ë¡œê°€ê¸°",
                    tint = if (canGoBack) 
                        MaterialTheme.colorScheme.onSurface 
                    else 
                        MaterialTheme.colorScheme.onSurface.copy(alpha = 0.3f)
                )
            }

            // 2. ìƒˆë¡œê³ ì¹¨ ë° MP4 ê°ì§€
            IconButton(
                onClick = onRefresh
            ) {
                if (isAnalyzing) {
                    CircularProgressIndicator(
                        modifier = Modifier.size(24.dp),
                        color = MaterialTheme.colorScheme.primary
                    )
                } else {
                    Icon(Icons.Default.Refresh, "ìƒˆë¡œê³ ì¹¨")
                }
            }

            // 3. MP4 ëª©ë¡ ë³´ê¸°
            IconButton(
                onClick = onShowMp4List
            ) {
                Icon(Icons.Default.PlayArrow, "MP4 ëª©ë¡")
            }

            // 4. ìµœê·¼ ë°©ë¬¸í•œ í˜ì´ì§€ ëª©ë¡
            IconButton(
                onClick = onShowHistory,
                enabled = urlHistory.isNotEmpty()
            ) {
                Icon(
                    Icons.Default.Info,
                    "ë°©ë¬¸ ê¸°ë¡",
                    tint = if (urlHistory.isNotEmpty()) 
                        MaterialTheme.colorScheme.onSurface 
                    else 
                        MaterialTheme.colorScheme.onSurface.copy(alpha = 0.3f)
                )
            }

            // 5. ì•ìœ¼ë¡œê°€ê¸°
            IconButton(
                onClick = onGoForward,
                enabled = canGoForward
            ) {
                Icon(
                    Icons.Default.ArrowForward,
                    "ì•ìœ¼ë¡œê°€ê¸°",
                    tint = if (canGoForward) 
                        MaterialTheme.colorScheme.onSurface 
                    else 
                        MaterialTheme.colorScheme.onSurface.copy(alpha = 0.3f)
                )
            }
        }
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/theme/Color.kt">
package com.swvd.simplewebvideodownloader.ui.theme

import androidx.compose.ui.graphics.Color

val Purple80 = Color(0xFFD0BCFF)
val PurpleGrey80 = Color(0xFFCCC2DC)
val Pink80 = Color(0xFFEFB8C8)

val Purple40 = Color(0xFF6650a4)
val PurpleGrey40 = Color(0xFF625b71)
val Pink40 = Color(0xFF7D5260)
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/theme/Theme.kt">
package com.swvd.simplewebvideodownloader.ui.theme

import android.app.Activity
import android.os.Build
import androidx.compose.foundation.isSystemInDarkTheme
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.darkColorScheme
import androidx.compose.material3.dynamicDarkColorScheme
import androidx.compose.material3.dynamicLightColorScheme
import androidx.compose.material3.lightColorScheme
import androidx.compose.runtime.Composable
import androidx.compose.ui.platform.LocalContext

private val DarkColorScheme = darkColorScheme(
    primary = Purple80,
    secondary = PurpleGrey80,
    tertiary = Pink80
)

private val LightColorScheme = lightColorScheme(
    primary = Purple40,
    secondary = PurpleGrey40,
    tertiary = Pink40

    /* Other default colors to override
    background = Color(0xFFFFFBFE),
    surface = Color(0xFFFFFBFE),
    onPrimary = Color.White,
    onSecondary = Color.White,
    onTertiary = Color.White,
    onBackground = Color(0xFF1C1B1F),
    onSurface = Color(0xFF1C1B1F),
    */
)

@Composable
fun SimpleWebVideoDownloaderTheme(
    darkTheme: Boolean = isSystemInDarkTheme(),
    // Dynamic color is available on Android 12+
    dynamicColor: Boolean = true,
    content: @Composable () -> Unit
) {
    val colorScheme = when {
        dynamicColor && Build.VERSION.SDK_INT >= Build.VERSION_CODES.S -> {
            val context = LocalContext.current
            if (darkTheme) dynamicDarkColorScheme(context) else dynamicLightColorScheme(context)
        }

        darkTheme -> DarkColorScheme
        else -> LightColorScheme
    }

    MaterialTheme(
        colorScheme = colorScheme,
        typography = Typography,
        content = content
    )
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/ui/theme/Type.kt">
package com.swvd.simplewebvideodownloader.ui.theme

import androidx.compose.material3.Typography
import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.font.FontFamily
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.sp

// Set of Material typography styles to start with
val Typography = Typography(
    bodyLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = 16.sp,
        lineHeight = 24.sp,
        letterSpacing = 0.5.sp
    )
    /* Other default text styles to override
    titleLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = 22.sp,
        lineHeight = 28.sp,
        letterSpacing = 0.sp
    ),
    labelSmall = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Medium,
        fontSize = 11.sp,
        lineHeight = 16.sp,
        letterSpacing = 0.5.sp
    )
    */
)
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/utils/FullscreenManager.kt">
package com.swvd.simplewebvideodownloader.utils

import android.app.Activity
import android.view.View
import android.view.WindowInsetsController
import androidx.core.view.WindowCompat
import androidx.core.view.WindowInsetsCompat

/**
 * ì „ì²´í™”ë©´ ëª¨ë“œ ê´€ë¦¬ ìœ í‹¸ë¦¬í‹°
 * ëª°ì…í˜• ì „ì²´í™”ë©´ ëª¨ë“œ ì„¤ì •ì„ ë‹´ë‹¹
 */
object FullscreenManager {
    
    /**
     * ì „ì²´í™”ë©´ ëª°ì…í˜• ëª¨ë“œ ì„¤ì •/í•´ì œ
     * @param activity ëŒ€ìƒ ì•¡í‹°ë¹„í‹°
     * @param enable ì „ì²´í™”ë©´ ëª¨ë“œ í™œì„±í™” ì—¬ë¶€
     */
    fun setFullscreenMode(activity: Activity, enable: Boolean) {
        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.R) {
            if (enable) {
                // Android 11+ ì—ì„œ ëª°ì…í˜• ëª¨ë“œ
                activity.window.insetsController?.let { controller ->
                    controller.hide(WindowInsetsCompat.Type.systemBars())
                    controller.systemBarsBehavior = WindowInsetsController.BEHAVIOR_SHOW_TRANSIENT_BARS_BY_SWIPE
                }
            } else {
                // ëª°ì…í˜• ëª¨ë“œ í•´ì œ
                activity.window.insetsController?.show(WindowInsetsCompat.Type.systemBars())
            }
        } else {
            @Suppress("DEPRECATION")
            if (enable) {
                // Android 10 ì´í•˜ì—ì„œ ëª°ì…í˜• ëª¨ë“œ
                activity.window.decorView.systemUiVisibility = (
                    View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY
                    or View.SYSTEM_UI_FLAG_LAYOUT_STABLE
                    or View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
                    or View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
                    or View.SYSTEM_UI_FLAG_HIDE_NAVIGATION
                    or View.SYSTEM_UI_FLAG_FULLSCREEN
                )
            } else {
                // ëª°ì…í˜• ëª¨ë“œ í•´ì œ
                activity.window.decorView.systemUiVisibility = View.SYSTEM_UI_FLAG_VISIBLE
            }
        }
    }
    
    /**
     * Edge-to-Edge ëª¨ë“œ í™œì„±í™”
     * @param activity ëŒ€ìƒ ì•¡í‹°ë¹„í‹°
     */
    fun enableEdgeToEdge(activity: Activity) {
        WindowCompat.setDecorFitsSystemWindows(activity.window, false)
    }
}
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/webview/Mp4Analyzer.kt">
package com.swvd.simplewebvideodownloader.webview

import android.util.Log
import android.webkit.WebView

/**
 * MP4 ë¹„ë””ì˜¤ ë¶„ì„ í´ë˜ìŠ¤
 * ì›¹í˜ì´ì§€ì—ì„œ MP4 ë¹„ë””ì˜¤ ë§í¬ë¥¼ ê°ì§€í•˜ëŠ” ê¸°ëŠ¥ì„ ë‹´ë‹¹
 */
class Mp4Analyzer {
    
    /**
     * JavaScript ì½”ë“œë¡œ í˜ì´ì§€ì—ì„œ MP4 ë§í¬ ì¶”ì¶œ
     * ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ MP4 URLì„ ì°¾ì•„ì„œ ë°˜í™˜
     */
    private val mp4DetectionScript = """
        (function() {
            var results = [];
            var uniqueUrls = new Set();
            
            try {
                // 1. ëª¨ë“  video íƒœê·¸ì˜ src í™•ì¸
                var videos = document.querySelectorAll('video');
                videos.forEach(function(v) {
                    if (v.src && v.src.includes('.mp4')) {
                        uniqueUrls.add(v.src);
                    }
                    if (v.currentSrc && v.currentSrc.includes('.mp4')) {
                        uniqueUrls.add(v.currentSrc);
                    }
                });
                
                // 2. ëª¨ë“  source íƒœê·¸ì˜ src í™•ì¸
                var sources = document.querySelectorAll('source');
                sources.forEach(function(s) {
                    if (s.src && s.src.includes('.mp4')) {
                        uniqueUrls.add(s.src);
                    }
                });
                
                // 3. ëª¨ë“  a íƒœê·¸ì˜ href í™•ì¸ (ë§í¬)
                var links = document.querySelectorAll('a[href]');
                links.forEach(function(a) {
                    if (a.href && a.href.includes('.mp4')) {
                        uniqueUrls.add(a.href);
                    }
                });
                
                // 4. í˜ì´ì§€ HTMLì—ì„œ MP4 URL ì •ê·œì‹ ê²€ìƒ‰
                var html = document.documentElement.outerHTML;
                var mp4Regex = /https?:\/\/[^\s"'<>()]+\.mp4[^\s"'<>()]*/gi;
                var matches = html.match(mp4Regex);
                if (matches) {
                    matches.forEach(function(match) {
                        // URL ì •ë¦¬
                        var cleanUrl = match.replace(/['"<>()]+${'$'}/, '');
                        if (cleanUrl.length > 20) { // ë„ˆë¬´ ì§§ì€ URL ì œì™¸
                            uniqueUrls.add(cleanUrl);
                        }
                    });
                }
                
                // 5. ëª¨ë“  img íƒœê·¸ì˜ data ì†ì„± í™•ì¸ (ë•Œë¡œëŠ” ë¹„ë””ì˜¤ ì¸ë„¤ì¼ì´ data ì†ì„±ì— ìˆìŒ)
                var imgs = document.querySelectorAll('img[data-src], img[data-url]');
                imgs.forEach(function(img) {
                    var dataSrc = img.getAttribute('data-src') || img.getAttribute('data-url');
                    if (dataSrc && dataSrc.includes('.mp4')) {
                        uniqueUrls.add(dataSrc);
                    }
                });
                
                // 6. ëª¨ë“  divì˜ data ì†ì„± í™•ì¸
                var divs = document.querySelectorAll('div[data-video], div[data-src], div[data-url]');
                divs.forEach(function(div) {
                    var dataVideo = div.getAttribute('data-video') || div.getAttribute('data-src') || div.getAttribute('data-url');
                    if (dataVideo && dataVideo.includes('.mp4')) {
                        uniqueUrls.add(dataVideo);
                    }
                });
                
                // ê²°ê³¼ ì •ë¦¬
                uniqueUrls.forEach(function(url) {
                    results.push(url);
                });
                
                return JSON.stringify(results);
                
            } catch (e) {
                return JSON.stringify(['JavaScript ì˜¤ë¥˜: ' + e.message]);
            }
        })();
    """.trimIndent()
    
    /**
     * WebViewì—ì„œ MP4 ë§í¬ ë¶„ì„ ì‹¤í–‰
     * @param webView ë¶„ì„í•  WebView
     * @param onResult ê²°ê³¼ë¥¼ ë°›ì„ ì½œë°± í•¨ìˆ˜
     */
    fun analyzePageForMp4(
        webView: WebView?,
        onResult: (List<String>) -> Unit
    ) {
        if (webView == null) {
            Log.d("Mp4Analyzer", "WebViewê°€ ì—†ìŒ")
            onResult(emptyList())
            return
        }
        
        Log.d("Mp4Analyzer", "MP4 ê°ì§€ ì‹œì‘: ${webView.url}")
        
        webView.evaluateJavascript(mp4DetectionScript) { result ->
            try {
                val cleanResult = result?.replace("\\\"", "\"")?.removeSurrounding("\"") ?: "[]"
                Log.d("Mp4Analyzer", "MP4 ê²€ìƒ‰ ê²°ê³¼: $cleanResult")

                val videoLinks = if (cleanResult.startsWith("[")) {
                    cleanResult.removeSurrounding("[", "]")
                        .split(",")
                        .map { it.trim().removeSurrounding("\"") }
                        .filter { it.isNotEmpty() && it.contains(".mp4") && !it.contains("JavaScript ì˜¤ë¥˜") }
                } else {
                    emptyList()
                }

                Log.d("Mp4Analyzer", "ìµœì¢… MP4 ë§í¬ ${videoLinks.size}ê°œ ë°œê²¬")
                onResult(videoLinks)

            } catch (e: Exception) {
                Log.e("Mp4Analyzer", "MP4 ë¶„ì„ ì˜¤ë¥˜: ${e.message}")
                onResult(listOf("ë¶„ì„ ì˜¤ë¥˜: ${e.message}"))
            }
        }
    }
}
</file>

<file path="app/src/main/res/drawable/ic_launcher_background.xml">
<?xml version="1.0" encoding="utf-8"?>
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="108dp"
    android:height="108dp"
    android:viewportWidth="108"
    android:viewportHeight="108">
    <path
        android:fillColor="#3DDC84"
        android:pathData="M0,0h108v108h-108z" />
    <path
        android:fillColor="#00000000"
        android:pathData="M9,0L9,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,0L19,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M29,0L29,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M39,0L39,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M49,0L49,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M59,0L59,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M69,0L69,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M79,0L79,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M89,0L89,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M99,0L99,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,9L108,9"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,19L108,19"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,29L108,29"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,39L108,39"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,49L108,49"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,59L108,59"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,69L108,69"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,79L108,79"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,89L108,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,99L108,99"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,29L89,29"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,39L89,39"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,49L89,49"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,59L89,59"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,69L89,69"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,79L89,79"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M29,19L29,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M39,19L39,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M49,19L49,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M59,19L59,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M69,19L69,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M79,19L79,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
</vector>
</file>

<file path="app/src/main/res/drawable/ic_launcher_foreground.xml">
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:aapt="http://schemas.android.com/aapt"
    android:width="108dp"
    android:height="108dp"
    android:viewportWidth="108"
    android:viewportHeight="108">
    <path android:pathData="M31,63.928c0,0 6.4,-11 12.1,-13.1c7.2,-2.6 26,-1.4 26,-1.4l38.1,38.1L107,108.928l-32,-1L31,63.928z">
        <aapt:attr name="android:fillColor">
            <gradient
                android:endX="85.84757"
                android:endY="92.4963"
                android:startX="42.9492"
                android:startY="49.59793"
                android:type="linear">
                <item
                    android:color="#44000000"
                    android:offset="0.0" />
                <item
                    android:color="#00000000"
                    android:offset="1.0" />
            </gradient>
        </aapt:attr>
    </path>
    <path
        android:fillColor="#FFFFFF"
        android:fillType="nonZero"
        android:pathData="M65.3,45.828l3.8,-6.6c0.2,-0.4 0.1,-0.9 -0.3,-1.1c-0.4,-0.2 -0.9,-0.1 -1.1,0.3l-3.9,6.7c-6.3,-2.8 -13.4,-2.8 -19.7,0l-3.9,-6.7c-0.2,-0.4 -0.7,-0.5 -1.1,-0.3C38.8,38.328 38.7,38.828 38.9,39.228l3.8,6.6C36.2,49.428 31.7,56.028 31,63.928h46C76.3,56.028 71.8,49.428 65.3,45.828zM43.4,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2c-0.3,-0.7 -0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C45.3,56.528 44.5,57.328 43.4,57.328L43.4,57.328zM64.6,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2s-0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C66.5,56.528 65.6,57.328 64.6,57.328L64.6,57.328z"
        android:strokeWidth="1"
        android:strokeColor="#00000000" />
</vector>
</file>

<file path="app/src/main/res/values/colors.xml">
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="purple_200">#FFBB86FC</color>
    <color name="purple_500">#FF6200EE</color>
    <color name="purple_700">#FF3700B3</color>
    <color name="teal_200">#FF03DAC5</color>
    <color name="teal_700">#FF018786</color>
    <color name="black">#FF000000</color>
    <color name="white">#FFFFFFFF</color>
</resources>
</file>

<file path="app/src/main/res/values/strings.xml">
<resources>
    <string name="app_name">SimpleWebVideoDownloader</string>
</resources>
</file>

<file path="app/src/main/res/values/themes.xml">
<?xml version="1.0" encoding="utf-8"?>
<resources>

    <style name="Theme.SimpleWebVideoDownloader" parent="android:Theme.Material.Light.NoActionBar" />
</resources>
</file>

<file path="app/src/main/res/xml/backup_rules.xml">
<?xml version="1.0" encoding="utf-8"?><!--
   Sample backup rules file; uncomment and customize as necessary.
   See https://developer.android.com/guide/topics/data/autobackup
   for details.
   Note: This file is ignored for devices older than API 31
   See https://developer.android.com/about/versions/12/backup-restore
-->
<full-backup-content>
    <!--
   <include domain="sharedpref" path="."/>
   <exclude domain="sharedpref" path="device.xml"/>
-->
</full-backup-content>
</file>

<file path="app/src/main/res/xml/data_extraction_rules.xml">
<?xml version="1.0" encoding="utf-8"?><!--
   Sample data extraction rules file; uncomment and customize as necessary.
   See https://developer.android.com/about/versions/12/backup-restore#xml-changes
   for details.
-->
<data-extraction-rules>
    <cloud-backup>
        <!-- TODO: Use <include> and <exclude> to control what is backed up.
        <include .../>
        <exclude .../>
        -->
    </cloud-backup>
    <!--
    <device-transfer>
        <include .../>
        <exclude .../>
    </device-transfer>
    -->
</data-extraction-rules>
</file>

<file path="app/src/test/java/com/swvd/simplewebvideodownloader/ExampleUnitTest.kt">
package com.swvd.simplewebvideodownloader

import org.junit.Test

import org.junit.Assert.*

/**
 * Example local unit test, which will execute on the development machine (host).
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
class ExampleUnitTest {
    @Test
    fun addition_isCorrect() {
        assertEquals(4, 2 + 2)
    }
}
</file>

<file path="app/.gitignore">
/build
</file>

<file path="app/proguard-rules.pro">
# Add project specific ProGuard rules here.
# You can control the set of applied configuration files using the
# proguardFiles setting in build.gradle.
#
# For more details, see
#   http://developer.android.com/guide/developing/tools/proguard.html

# If your project uses WebView with JS, uncomment the following
# and specify the fully qualified class name to the JavaScript interface
# class:
#-keepclassmembers class fqcn.of.javascript.interface.for.webview {
#   public *;
#}

# Uncomment this to preserve the line number information for
# debugging stack traces.
#-keepattributes SourceFile,LineNumberTable

# If you keep the line number information, uncomment this to
# hide the original source file name.
#-renamesourcefileattribute SourceFile
</file>

<file path="gradle/wrapper/gradle-wrapper.properties">
#Thu Jun 12 16:09:15 KST 2025
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.11.1-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
</file>

<file path="gradle/libs.versions.toml">
[versions]
agp = "8.10.1"
kotlin = "2.0.21"
coreKtx = "1.16.0"
junit = "4.13.2"
junitVersion = "1.2.1"
espressoCore = "3.6.1"
lifecycleRuntimeKtx = "2.9.1"
activityCompose = "1.10.1"
composeBom = "2024.09.00"

[libraries]
androidx-core-ktx = { group = "androidx.core", name = "core-ktx", version.ref = "coreKtx" }
junit = { group = "junit", name = "junit", version.ref = "junit" }
androidx-junit = { group = "androidx.test.ext", name = "junit", version.ref = "junitVersion" }
androidx-espresso-core = { group = "androidx.test.espresso", name = "espresso-core", version.ref = "espressoCore" }
androidx-lifecycle-runtime-ktx = { group = "androidx.lifecycle", name = "lifecycle-runtime-ktx", version.ref = "lifecycleRuntimeKtx" }
androidx-activity-compose = { group = "androidx.activity", name = "activity-compose", version.ref = "activityCompose" }
androidx-compose-bom = { group = "androidx.compose", name = "compose-bom", version.ref = "composeBom" }
androidx-ui = { group = "androidx.compose.ui", name = "ui" }
androidx-ui-graphics = { group = "androidx.compose.ui", name = "ui-graphics" }
androidx-ui-tooling = { group = "androidx.compose.ui", name = "ui-tooling" }
androidx-ui-tooling-preview = { group = "androidx.compose.ui", name = "ui-tooling-preview" }
androidx-ui-test-manifest = { group = "androidx.compose.ui", name = "ui-test-manifest" }
androidx-ui-test-junit4 = { group = "androidx.compose.ui", name = "ui-test-junit4" }
androidx-material3 = { group = "androidx.compose.material3", name = "material3" }

[plugins]
android-application = { id = "com.android.application", version.ref = "agp" }
kotlin-android = { id = "org.jetbrains.kotlin.android", version.ref = "kotlin" }
kotlin-compose = { id = "org.jetbrains.kotlin.plugin.compose", version.ref = "kotlin" }
</file>

<file path=".gitignore">
# Android Studio and Gradle files
*.iml
.gradle
/local.properties
/.idea/caches
/.idea/libraries
/.idea/modules.xml
/.idea/workspace.xml
/.idea/navEditor.xml
/.idea/assetWizardSettings.xml
.DS_Store
/build
/captures
.externalNativeBuild
.cxx
local.properties

# Android APK files
*.apk
*.aab

# Keystore files
*.jks
*.keystore

# Log files
*.log

# Android Studio Navigation editor temp files
.navigation/

# Android Studio captures folder
captures/

# IntelliJ
*.iws
/out/

# User-specific configurations
.idea/libraries/
.idea/workspace.xml
.idea/tasks.xml
.idea/.name
.idea/compiler.xml
.idea/copyright/profiles_settings.xml
.idea/encodings.xml
.idea/misc.xml
.idea/modules.xml
.idea/scopes/scope_settings.xml
.idea/dictionaries
.idea/vcs.xml
.idea/jsLibraryMappings.xml
.idea/datasources.xml
.idea/dataSources.ids
.idea/sqlDataSources.xml
.idea/dynamic.xml
.idea/uiDesigner.xml

# OS-specific files
Thumbs.db
ehthumbs.db
Desktop.ini
$RECYCLE.BIN/
*~

# Gradle Wrapper
!gradle/wrapper/gradle-wrapper.jar

# Maven
target/
pom.xml.tag
pom.xml.releaseBackup
pom.xml.versionsBackup
pom.xml.next
release.properties
dependency-reduced-pom.xml
buildNumber.properties
.mvn/timing.properties

# Avoid ignoring Maven wrapper jar file (.jar files are usually ignored)
!/.mvn/wrapper/maven-wrapper.jar
</file>

<file path="build.gradle.kts">
// Top-level build file where you can add configuration options common to all sub-projects/modules.
plugins {
    alias(libs.plugins.android.application) apply false
    alias(libs.plugins.kotlin.android) apply false
    alias(libs.plugins.kotlin.compose) apply false
}
</file>

<file path="CLAUDE.md">
# Basic Rules
- You are a senior coding expert.

## General Guidelines
- Make a step-by-step plan and work it out.
- At the top of the file, include its role and brief description.
- Please include comments when writing the code.
- Please write the variable name so that the meaning is clear.
- Please include the error handling.
- Put readability and maintenance first.

## Description
- Please add an explanation to the complex logic.
- Please briefly explain the purpose of the code and how it works.
</file>

<file path="gradle.properties">
# Project-wide Gradle settings.
# IDE (e.g. Android Studio) users:
# Gradle settings configured through the IDE *will override*
# any settings specified in this file.
# For more details on how to configure your build environment visit
# http://www.gradle.org/docs/current/userguide/build_environment.html
# Specifies the JVM arguments used for the daemon process.
# The setting is particularly useful for tweaking memory settings.
org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
# When configured, Gradle will run in incubating parallel mode.
# This option should only be used with decoupled projects. For more details, visit
# https://developer.android.com/r/tools/gradle-multi-project-decoupled-projects
# org.gradle.parallel=true
# AndroidX package structure to make it clearer which packages are bundled with the
# Android operating system, and which are packaged with your app's APK
# https://developer.android.com/topic/libraries/support-library/androidx-rn
android.useAndroidX=true
# Kotlin code style for this project: "official" or "obsolete":
kotlin.code.style=official
# Enables namespacing of each library's R class so that its R class includes only the
# resources declared in the library itself and none from the library's dependencies,
# thereby reducing the size of the R class for that library
android.nonTransitiveRClass=true
</file>

<file path="gradlew">
#!/usr/bin/env sh

#
# Copyright 2015 the original author or authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

##############################################################################
##
##  Gradle start up script for UN*X
##
##############################################################################

# Attempt to set APP_HOME
# Resolve links: $0 may be a link
PRG="$0"
# Need this for relative symlinks.
while [ -h "$PRG" ] ; do
    ls=`ls -ld "$PRG"`
    link=`expr "$ls" : '.*-> \(.*\)$'`
    if expr "$link" : '/.*' > /dev/null; then
        PRG="$link"
    else
        PRG=`dirname "$PRG"`"/$link"
    fi
done
SAVED="`pwd`"
cd "`dirname \"$PRG\"`/" >/dev/null
APP_HOME="`pwd -P`"
cd "$SAVED" >/dev/null

APP_NAME="Gradle"
APP_BASE_NAME=`basename "$0"`

# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'

# Use the maximum available, or set MAX_FD != -1 to use that value.
MAX_FD="maximum"

warn () {
    echo "$*"
}

die () {
    echo
    echo "$*"
    echo
    exit 1
}

# OS specific support (must be 'true' or 'false').
cygwin=false
msys=false
darwin=false
nonstop=false
case "`uname`" in
  CYGWIN* )
    cygwin=true
    ;;
  Darwin* )
    darwin=true
    ;;
  MINGW* )
    msys=true
    ;;
  NONSTOP* )
    nonstop=true
    ;;
esac

CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar


# Determine the Java command to use to start the JVM.
if [ -n "$JAVA_HOME" ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
        # IBM's JDK on AIX uses strange locations for the executables
        JAVACMD="$JAVA_HOME/jre/sh/java"
    else
        JAVACMD="$JAVA_HOME/bin/java"
    fi
    if [ ! -x "$JAVACMD" ] ; then
        die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
    fi
else
    JAVACMD="java"
    which java >/dev/null 2>&1 || die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
fi

# Increase the maximum file descriptors if we can.
if [ "$cygwin" = "false" -a "$darwin" = "false" -a "$nonstop" = "false" ] ; then
    MAX_FD_LIMIT=`ulimit -H -n`
    if [ $? -eq 0 ] ; then
        if [ "$MAX_FD" = "maximum" -o "$MAX_FD" = "max" ] ; then
            MAX_FD="$MAX_FD_LIMIT"
        fi
        ulimit -n $MAX_FD
        if [ $? -ne 0 ] ; then
            warn "Could not set maximum file descriptor limit: $MAX_FD"
        fi
    else
        warn "Could not query maximum file descriptor limit: $MAX_FD_LIMIT"
    fi
fi

# For Darwin, add options to specify how the application appears in the dock
if $darwin; then
    GRADLE_OPTS="$GRADLE_OPTS \"-Xdock:name=$APP_NAME\" \"-Xdock:icon=$APP_HOME/media/gradle.icns\""
fi

# For Cygwin or MSYS, switch paths to Windows format before running java
if [ "$cygwin" = "true" -o "$msys" = "true" ] ; then
    APP_HOME=`cygpath --path --mixed "$APP_HOME"`
    CLASSPATH=`cygpath --path --mixed "$CLASSPATH"`

    JAVACMD=`cygpath --unix "$JAVACMD"`

    # We build the pattern for arguments to be converted via cygpath
    ROOTDIRSRAW=`find -L / -maxdepth 1 -mindepth 1 -type d 2>/dev/null`
    SEP=""
    for dir in $ROOTDIRSRAW ; do
        ROOTDIRS="$ROOTDIRS$SEP$dir"
        SEP="|"
    done
    OURCYGPATTERN="(^($ROOTDIRS))"
    # Add a user-defined pattern to the cygpath arguments
    if [ "$GRADLE_CYGPATTERN" != "" ] ; then
        OURCYGPATTERN="$OURCYGPATTERN|($GRADLE_CYGPATTERN)"
    fi
    # Now convert the arguments - kludge to limit ourselves to /bin/sh
    i=0
    for arg in "$@" ; do
        CHECK=`echo "$arg"|egrep -c "$OURCYGPATTERN" -`
        CHECK2=`echo "$arg"|egrep -c "^-"`                                 ### Determine if an option

        if [ $CHECK -ne 0 ] && [ $CHECK2 -eq 0 ] ; then                    ### Added a condition
            eval `echo args$i`=`cygpath --path --ignore --mixed "$arg"`
        else
            eval `echo args$i`="\"$arg\""
        fi
        i=`expr $i + 1`
    done
    case $i in
        0) set -- ;;
        1) set -- "$args0" ;;
        2) set -- "$args0" "$args1" ;;
        3) set -- "$args0" "$args1" "$args2" ;;
        4) set -- "$args0" "$args1" "$args2" "$args3" ;;
        5) set -- "$args0" "$args1" "$args2" "$args3" "$args4" ;;
        6) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" ;;
        7) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" ;;
        8) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" ;;
        9) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" "$args8" ;;
    esac
fi

# Escape application args
save () {
    for i do printf %s\\n "$i" | sed "s/'/'\\\\''/g;1s/^/'/;\$s/\$/' \\\\/" ; done
    echo " "
}
APP_ARGS=`save "$@"`

# Collect all arguments for the java command, following the shell quoting and substitution rules
eval set -- $DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS "\"-Dorg.gradle.appname=$APP_BASE_NAME\"" -classpath "\"$CLASSPATH\"" org.gradle.wrapper.GradleWrapperMain "$APP_ARGS"

exec "$JAVACMD" "$@"
</file>

<file path="gradlew.bat">
@rem
@rem Copyright 2015 the original author or authors.
@rem
@rem Licensed under the Apache License, Version 2.0 (the "License");
@rem you may not use this file except in compliance with the License.
@rem You may obtain a copy of the License at
@rem
@rem      https://www.apache.org/licenses/LICENSE-2.0
@rem
@rem Unless required by applicable law or agreed to in writing, software
@rem distributed under the License is distributed on an "AS IS" BASIS,
@rem WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@rem See the License for the specific language governing permissions and
@rem limitations under the License.
@rem

@if "%DEBUG%" == "" @echo off
@rem ##########################################################################
@rem
@rem  Gradle startup script for Windows
@rem
@rem ##########################################################################

@rem Set local scope for the variables with windows NT shell
if "%OS%"=="Windows_NT" setlocal

set DIRNAME=%~dp0
if "%DIRNAME%" == "" set DIRNAME=.
set APP_BASE_NAME=%~n0
set APP_HOME=%DIRNAME%

@rem Resolve any "." and ".." in APP_HOME to make it shorter.
for %%i in ("%APP_HOME%") do set APP_HOME=%%~fi

@rem Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
set DEFAULT_JVM_OPTS="-Xmx64m" "-Xms64m"

@rem Find java.exe
if defined JAVA_HOME goto findJavaFromJavaHome

set JAVA_EXE=java.exe
%JAVA_EXE% -version >NUL 2>&1
if "%ERRORLEVEL%" == "0" goto execute

echo.
echo ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:findJavaFromJavaHome
set JAVA_HOME=%JAVA_HOME:"=%
set JAVA_EXE=%JAVA_HOME%/bin/java.exe

if exist "%JAVA_EXE%" goto execute

echo.
echo ERROR: JAVA_HOME is set to an invalid directory: %JAVA_HOME%
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:execute
@rem Setup the command line

set CLASSPATH=%APP_HOME%\gradle\wrapper\gradle-wrapper.jar


@rem Execute Gradle
"%JAVA_EXE%" %DEFAULT_JVM_OPTS% %JAVA_OPTS% %GRADLE_OPTS% "-Dorg.gradle.appname=%APP_BASE_NAME%" -classpath "%CLASSPATH%" org.gradle.wrapper.GradleWrapperMain %*

:end
@rem End local scope for the variables with windows NT shell
if "%ERRORLEVEL%"=="0" goto mainEnd

:fail
rem Set variable GRADLE_EXIT_CONSOLE if you need the _script_ return code instead of
rem the _cmd.exe /c_ return code!
if  not "" == "%GRADLE_EXIT_CONSOLE%" exit 1
exit /b 1

:mainEnd
if "%OS%"=="Windows_NT" endlocal

:omega
</file>

<file path="LICENSE">
MIT License

Copyright (c) 2025 JaemyeongBae

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</file>

<file path="README.md">
# ğŸ¬ Simple Web Video Downloader

Android ì›¹ ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë” ì•±ìœ¼ë¡œ, ì›¹ í˜ì´ì§€ì—ì„œ MP4 ë¹„ë””ì˜¤ë¥¼ ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³  ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆëŠ” ì‚¬ìš©ì ì¹œí™”ì ì¸ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

## âœ¨ ì£¼ìš” ê¸°ëŠ¥

- ğŸŒ **ë‚´ì¥ ì›¹ ë¸Œë¼ìš°ì €**: ì™„ì „í•œ ì›¹ ë¸Œë¼ìš°ì§• ê²½í—˜
- ğŸ” **ìë™ MP4 ê°ì§€**: í˜ì´ì§€ì˜ ëª¨ë“  MP4 ë¹„ë””ì˜¤ ë§í¬ë¥¼ ìë™ìœ¼ë¡œ íƒì§€
- â¬‡ï¸ **ê°„í¸í•œ ë‹¤ìš´ë¡œë“œ**: ì›í´ë¦­ìœ¼ë¡œ ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
- ğŸ“± **ë°˜ì‘í˜• UI**: ë‹¤ì–‘í•œ Android ê¸°ê¸°ì—ì„œ ìµœì í™”ëœ ì‚¬ìš©ì ê²½í—˜
- ğŸ¯ **ì „ì²´í™”ë©´ ëª¨ë“œ**: ëª°ì…í˜• ë¸Œë¼ìš°ì§• ê²½í—˜
- ğŸ“œ **ë¸Œë¼ìš°ì§• íˆìŠ¤í† ë¦¬**: ìµœê·¼ ë°©ë¬¸í•œ URL ê´€ë¦¬
- ğŸ¨ **Material Design 3**: í˜„ëŒ€ì ì´ê³  ì§ê´€ì ì¸ UI

## ğŸ“± ìŠ¤í¬ë¦°ìƒ·

> ìŠ¤í¬ë¦°ìƒ·ì€ ì¶”í›„ ì¶”ê°€ ì˜ˆì •

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ

- **ì–¸ì–´**: Kotlin
- **UI í”„ë ˆì„ì›Œí¬**: Jetpack Compose
- **ì•„í‚¤í…ì²˜**: MVVM with Compose State Management
- **ì›¹ë·°**: Android WebView with JavaScript injection
- **HTML íŒŒì‹±**: Jsoup
- **ìµœì†Œ SDK**: API 24 (Android 7.0)
- **íƒ€ê²Ÿ SDK**: API 35 (Android 15)

## ğŸ“‹ ìš”êµ¬ì‚¬í•­

- Android 7.0 (API 24) ì´ìƒ
- ì¸í„°ë„· ì—°ê²°
- ì €ì¥ì†Œ ê¶Œí•œ (ë‹¤ìš´ë¡œë“œìš©)

## ğŸš€ ì„¤ì¹˜ ë°©ë²•

### APK ë‹¤ìš´ë¡œë“œ (ì¶”í›„ ì œê³µ)
1. [Releases](https://github.com/JaemyeongBae/SimpleWebVideoDownloader/releases) í˜ì´ì§€ì—ì„œ ìµœì‹  APK ë‹¤ìš´ë¡œë“œ
2. Android ê¸°ê¸°ì—ì„œ "ì•Œ ìˆ˜ ì—†ëŠ” ì†ŒìŠ¤" í—ˆìš©
3. APK íŒŒì¼ ì„¤ì¹˜

### ì†ŒìŠ¤ ì½”ë“œì—ì„œ ë¹Œë“œ
```bash
# ì €ì¥ì†Œ ë³µì œ
git clone https://github.com/JaemyeongBae/SimpleWebVideoDownloader.git

# í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd SimpleWebVideoDownloader

# Android Studioì—ì„œ í”„ë¡œì íŠ¸ ì—´ê¸°
# ë˜ëŠ” ëª…ë ¹ì¤„ì—ì„œ ë¹Œë“œ
./gradlew assembleDebug
```

## ğŸ¯ ì‚¬ìš© ë°©ë²•

1. **URL ì…ë ¥**: ìƒë‹¨ URL ì…ë ¥ì°½ì— ì›¹ì‚¬ì´íŠ¸ ì£¼ì†Œ ì…ë ¥
2. **í˜ì´ì§€ íƒìƒ‰**: ë‚´ì¥ ë¸Œë¼ìš°ì €ë¡œ ì›í•˜ëŠ” í˜ì´ì§€ ë°©ë¬¸
3. **ë¹„ë””ì˜¤ ê°ì§€**: ì•±ì´ ìë™ìœ¼ë¡œ MP4 ë¹„ë””ì˜¤ ë§í¬ íƒì§€
4. **ë‹¤ìš´ë¡œë“œ**: ê°ì§€ëœ ë¹„ë””ì˜¤ ëª©ë¡ì—ì„œ ì›í•˜ëŠ” ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
5. **ì „ì²´í™”ë©´**: ì „ì²´í™”ë©´ ëª¨ë“œë¡œ ë” ë‚˜ì€ ë¸Œë¼ìš°ì§• ê²½í—˜

## ğŸ”§ ê°œë°œ í™˜ê²½ ì„¤ì •

### í•„ìˆ˜ ë„êµ¬
- Android Studio Hedgehog | 2023.1.1 ì´ìƒ
- JDK 11 ì´ìƒ
- Android SDK 35

### í”„ë¡œì íŠ¸ ì„¤ì •
```bash
# ì˜ì¡´ì„± ë™ê¸°í™”
./gradlew sync

# ë””ë²„ê·¸ ë¹Œë“œ
./gradlew assembleDebug

# ë¦´ë¦¬ì¦ˆ ë¹Œë“œ
./gradlew assembleRelease
```

## ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
app/
â”œâ”€â”€ src/main/
â”‚   â”œâ”€â”€ java/com/swvd/simplewebvideodownloader/
â”‚   â”‚   â”œâ”€â”€ MainActivity.kt          # ë©”ì¸ ì•¡í‹°ë¹„í‹°
â”‚   â”‚   â””â”€â”€ ui/theme/               # UI í…Œë§ˆ ì„¤ì •
â”‚   â”œâ”€â”€ res/                        # ë¦¬ì†ŒìŠ¤ íŒŒì¼
â”‚   â””â”€â”€ AndroidManifest.xml         # ì•± ë§¤ë‹ˆí˜ìŠ¤íŠ¸
â”œâ”€â”€ build.gradle.kts                # ì•± ë ˆë²¨ ë¹Œë“œ ì„¤ì •
â””â”€â”€ proguard-rules.pro             # ProGuard ì„¤ì •
```

## ğŸ¤ ê¸°ì—¬í•˜ê¸°

í”„ë¡œì íŠ¸ì— ê¸°ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¼ì£¼ì„¸ìš”:

1. ì´ ì €ì¥ì†Œë¥¼ Forkí•©ë‹ˆë‹¤
2. ìƒˆë¡œìš´ ê¸°ëŠ¥ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤ (`git checkout -b feature/AmazingFeature`)
3. ë³€ê²½ì‚¬í•­ì„ ì»¤ë°‹í•©ë‹ˆë‹¤ (`git commit -m 'Add some AmazingFeature'`)
4. ë¸Œëœì¹˜ì— Pushí•©ë‹ˆë‹¤ (`git push origin feature/AmazingFeature`)
5. Pull Requestë¥¼ ìƒì„±í•©ë‹ˆë‹¤

### ê°œë°œ ê°€ì´ë“œë¼ì¸
- Kotlin ì½”ë”© ì»¨ë²¤ì…˜ ì¤€ìˆ˜
- Jetpack Compose ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ ì ìš©
- ëª¨ë“  ìƒˆ ê¸°ëŠ¥ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì‘ì„±
- ì»¤ë°‹ ë©”ì‹œì§€ëŠ” ëª…í™•í•˜ê³  ì„¤ëª…ì ìœ¼ë¡œ ì‘ì„±

## ğŸ“ ë¼ì´ì„ ìŠ¤

ì´ í”„ë¡œì íŠ¸ëŠ” MIT ë¼ì´ì„ ìŠ¤ í•˜ì— ë°°í¬ë©ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ [LICENSE](LICENSE) íŒŒì¼ì„ ì°¸ì¡°í•˜ì„¸ìš”.

## ğŸ› ë²„ê·¸ ë¦¬í¬íŠ¸ ë° ê¸°ëŠ¥ ìš”ì²­

ë²„ê·¸ë¥¼ ë°œê²¬í•˜ê±°ë‚˜ ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì œì•ˆí•˜ê³  ì‹¶ìœ¼ì‹œë©´ [Issues](https://github.com/JaemyeongBae/SimpleWebVideoDownloader/issues) í˜ì´ì§€ì—ì„œ ìƒˆë¡œìš´ ì´ìŠˆë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

### ë²„ê·¸ ë¦¬í¬íŠ¸ ì‹œ í¬í•¨í•  ì •ë³´
- Android ë²„ì „
- ê¸°ê¸° ëª¨ë¸
- ì•± ë²„ì „
- ì¬í˜„ ë‹¨ê³„
- ì˜ˆìƒ ë™ì‘ vs ì‹¤ì œ ë™ì‘

## ğŸ“ ì—°ë½ì²˜

í”„ë¡œì íŠ¸ì— ëŒ€í•œ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ì—°ë½ì£¼ì„¸ìš”:

- GitHub: [@JaemyeongBae](https://github.com/JaemyeongBae)
- ì´ìŠˆ: [GitHub Issues](https://github.com/JaemyeongBae/SimpleWebVideoDownloader/issues)

## ğŸ™ ê°ì‚¬ì˜ ë§

- [Jsoup](https://jsoup.org/) - HTML íŒŒì‹± ë¼ì´ë¸ŒëŸ¬ë¦¬
- [Jetpack Compose](https://developer.android.com/jetpack/compose) - í˜„ëŒ€ì ì¸ Android UI íˆ´í‚·
- [Material Design 3](https://m3.material.io/) - ë””ìì¸ ì‹œìŠ¤í…œ

---

â­ ì´ í”„ë¡œì íŠ¸ê°€ ìœ ìš©í•˜ë‹¤ë©´ ë³„í‘œë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!
</file>

<file path="settings.gradle.kts">
pluginManagement {
    repositories {
        google {
            content {
                includeGroupByRegex("com\\.android.*")
                includeGroupByRegex("com\\.google.*")
                includeGroupByRegex("androidx.*")
            }
        }
        mavenCentral()
        gradlePluginPortal()
    }
}
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}

rootProject.name = "SimpleWebVideoDownloader"
include(":app")
</file>

<file path="app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml">
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
  <background android:drawable="@mipmap/ic_launcher_adaptive_back"/>
  <foreground android:drawable="@mipmap/ic_launcher_adaptive_fore"/>
</adaptive-icon>
</file>

<file path="app/src/main/AndroidManifest.xml">
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">

    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <!-- ë‹¤ìš´ë¡œë“œ ê¶Œí•œ ì¶”ê°€ -->
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"
        android:maxSdkVersion="28" />
    <!-- Android 13+ ì—ì„œëŠ” ì´ ê¶Œí•œì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ -->
    <uses-permission android:name="android.permission.READ_MEDIA_VIDEO" />

    <application
        android:allowBackup="true"
        android:dataExtractionRules="@xml/data_extraction_rules"
        android:fullBackupContent="@xml/backup_rules"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher"
        android:supportsRtl="true"
        android:theme="@style/Theme.SimpleWebVideoDownloader"
        android:usesCleartextTraffic="true"
        android:requestLegacyExternalStorage="true"
        tools:targetApi="31">
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:label="@string/app_name"
            android:theme="@style/Theme.SimpleWebVideoDownloader"
            android:configChanges="orientation|screenSize|keyboardHidden"
            android:hardwareAccelerated="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>

</manifest>
</file>

<file path="app/src/main/java/com/swvd/simplewebvideodownloader/MainActivity.kt">
package com.swvd.simplewebvideodownloader

import android.os.Bundle
import android.os.Handler
import android.os.Looper
import android.util.Log
import android.webkit.WebView
import android.webkit.WebViewClient
import android.webkit.WebChromeClient
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.enableEdgeToEdge
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.animation.AnimatedVisibility
import androidx.compose.animation.expandVertically
import androidx.compose.animation.shrinkVertically
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.itemsIndexed
import androidx.compose.foundation.text.KeyboardActions
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Search
import androidx.compose.material.icons.filled.Close
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.ArrowForward
import androidx.compose.material.icons.filled.Refresh
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.foundation.background
import androidx.compose.ui.platform.LocalClipboardManager
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalSoftwareKeyboardController
import androidx.compose.ui.text.input.ImeAction
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.viewinterop.AndroidView
import androidx.activity.compose.BackHandler
import androidx.core.view.WindowCompat


// Import separated components and utilities
import com.swvd.simplewebvideodownloader.models.Tab
import com.swvd.simplewebvideodownloader.download.DownloadHandler
import com.swvd.simplewebvideodownloader.download.HlsDownloader
import com.swvd.simplewebvideodownloader.webview.Mp4Analyzer
import com.swvd.simplewebvideodownloader.webview.VideoAnalyzer
import com.swvd.simplewebvideodownloader.utils.FullscreenManager
import com.swvd.simplewebvideodownloader.ui.components.*
import com.swvd.simplewebvideodownloader.ui.screens.FullscreenUI

/**
 * MainActivity - ë¶„ë¦¬ëœ êµ¬ì¡°ë¡œ ë¦¬íŒ©í† ë§
 * ê° ê¸°ëŠ¥ì´ ë³„ë„ í´ë˜ìŠ¤/ì»´í¬ë„ŒíŠ¸ë¡œ ë¶„ë¦¬ë˜ì–´ ê´€ë¦¬ê°€ ìš©ì´í•¨
 */
class MainActivity : ComponentActivity() {

    // ë‹¤ìš´ë¡œë“œ ê´€ë ¨ ê¸°ëŠ¥ì„ ë‹´ë‹¹í•˜ëŠ” í•¸ë“¤ëŸ¬
    private lateinit var downloadHandler: DownloadHandler
    
    // HLS ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì„ ë‹´ë‹¹í•˜ëŠ” í•¸ë“¤ëŸ¬
    private lateinit var hlsDownloader: HlsDownloader
    
    // MP4 ë¶„ì„ ê¸°ëŠ¥ì„ ë‹´ë‹¹í•˜ëŠ” ì• ë„ë¼ì´ì € (ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€)
    private val mp4Analyzer = Mp4Analyzer()
    
    // í–¥ìƒëœ ë¹„ë””ì˜¤ ë¶„ì„ ê¸°ëŠ¥ì„ ë‹´ë‹¹í•˜ëŠ” ì• ë„ë¼ì´ì €
    private val videoAnalyzer = VideoAnalyzer()

    // ê¶Œí•œ ìš”ì²­ ì²˜ë¦¬
    private val requestPermissionLauncher = registerForActivityResult(
        ActivityResultContracts.RequestMultiplePermissions()
    ) { permissions ->
        val allGranted = permissions.values.all { it }
        if (!allGranted && this::downloadHandler.isInitialized) {
            // ê¶Œí•œ ìš”ì²­ ê²°ê³¼ë¥¼ DownloadHandlerì—ê²Œ ìœ„ì„í•  ìˆ˜ ìˆë„ë¡ ì¶”í›„ í™•ì¥ ê°€ëŠ¥
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()
        
        // ë¶„ë¦¬ëœ FullscreenManager ì‚¬ìš©
        FullscreenManager.enableEdgeToEdge(this)
        
        // DownloadHandler ì´ˆê¸°í™”
        downloadHandler = DownloadHandler(this)
        
        // HlsDownloader ì´ˆê¸°í™”
        hlsDownloader = HlsDownloader(this)
        
        setContent {
            MaterialTheme {
                Surface(
                    modifier = Modifier
                        .fillMaxSize()
                        .windowInsetsPadding(WindowInsets.systemBars.only(WindowInsetsSides.Top))
                ) {
                    MainScreen(
                        downloadHandler = downloadHandler,
                        hlsDownloader = hlsDownloader,
                        mp4Analyzer = mp4Analyzer,
                        videoAnalyzer = videoAnalyzer,
                        onRequestPermissions = { requestStoragePermissions() },
                        onFullscreenModeChange = { isFullscreen -> 
                            FullscreenManager.setFullscreenMode(this@MainActivity, isFullscreen) 
                        }
                    )
                }
            }
        }
    }

    /**
     * ì €ì¥ì†Œ ê¶Œí•œ ìš”ì²­
     * DownloadHandlerë¡œ ê¶Œí•œ í™•ì¸ ë¡œì§ ìœ„ì„
     */
    private fun requestStoragePermissions() {
        val permissions = downloadHandler.checkStoragePermissions()
        if (permissions.isNotEmpty()) {
            requestPermissionLauncher.launch(permissions.toTypedArray())
        }
    }
}

/**
 * ë©”ì¸ í™”ë©´ ì»´í¬ì €ë¸”
 * ë¶„ë¦¬ëœ ì»´í¬ë„ŒíŠ¸ë“¤ì„ ì¡°í•©í•˜ì—¬ ì „ì²´ í™”ë©´ì„ êµ¬ì„±
 */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MainScreen(
    modifier: Modifier = Modifier,
    downloadHandler: DownloadHandler,
    hlsDownloader: HlsDownloader,
    mp4Analyzer: Mp4Analyzer,
    videoAnalyzer: VideoAnalyzer,
    onRequestPermissions: () -> Unit,
    onFullscreenModeChange: (Boolean) -> Unit
) {
    // íƒ­ ê´€ë ¨ ìƒíƒœ
    var tabs by remember { mutableStateOf(listOf(Tab())) }
    var currentTabIndex by remember { mutableIntStateOf(0) }
    var showTabOverview by remember { mutableStateOf(false) }
    
    var urlText by remember { mutableStateOf("") }
    var currentUrl by remember { mutableStateOf("") }
    var webView by remember { mutableStateOf<WebView?>(null) }
    var fullscreenWebView by remember { mutableStateOf<WebView?>(null) }
    var mp4Links by remember { mutableStateOf<List<String>>(emptyList()) }
    var videoList by remember { mutableStateOf<List<VideoAnalyzer.VideoInfo>>(emptyList()) }
    var isAnalyzing by remember { mutableStateOf(false) }
    var hasAnalyzed by remember { mutableStateOf(false) }
    var downloadingUrls by remember { mutableStateOf<Set<String>>(emptySet()) }
    var urlSectionExpanded by remember { mutableStateOf(true) }
    
    // ë‹¤ìš´ë¡œë“œ ê²°ê³¼ ì•Œë¦¼ ìƒíƒœ
    var downloadResultMessage by remember { mutableStateOf<String?>(null) }
    var showDownloadResult by remember { mutableStateOf(false) }
    var mp4SectionExpanded by remember { mutableStateOf(true) }
    var isWebViewFullscreen by remember { mutableStateOf(false) }
    var canGoBack by remember { mutableStateOf(false) }
    var canGoForward by remember { mutableStateOf(false) }
    var webViewState by remember { mutableStateOf<Bundle?>(null) }
    var urlHistory by remember { mutableStateOf<List<String>>(emptyList()) }
    var showMp4List by remember { mutableStateOf(false) }
    val clipboardManager = LocalClipboardManager.current
    val keyboardController = LocalSoftwareKeyboardController.current
    val context = LocalContext.current
    val currentTab = if (tabs.isNotEmpty() && currentTabIndex in tabs.indices) tabs[currentTabIndex] else null

    // íƒ­ ê´€ë¦¬ í•¨ìˆ˜ë“¤
    fun addNewTab() {
        val newTab = Tab()
        tabs = tabs + newTab
        currentTabIndex = tabs.size - 1
    }
    
    fun closeTab(index: Int) {
        if (tabs.size <= 1) return // ìµœì†Œ 1ê°œ íƒ­ ìœ ì§€
        
        tabs = tabs.filterIndexed { i, _ -> i != index }
        if (index <= currentTabIndex && currentTabIndex > 0) {
            currentTabIndex--
        }
        if (currentTabIndex >= tabs.size) {
            currentTabIndex = tabs.size - 1
        }
    }
    
    fun switchTab(index: Int) {
        if (index in tabs.indices) {
            currentTabIndex = index
            // íƒ­ ì „í™˜ì‹œ URL ë™ê¸°í™”
            currentTab?.let { tab ->
                urlText = tab.url
                currentUrl = tab.url
            }
        }
    }

    // ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    fun updateNavigationState() {
        val activeWebView = if (isWebViewFullscreen) fullscreenWebView else webView
        val oldCanGoBack = canGoBack
        val oldCanGoForward = canGoForward
        
        canGoBack = activeWebView?.canGoBack() ?: false
        canGoForward = activeWebView?.canGoForward() ?: false
        
        Log.d("Navigation", "ìƒíƒœ ì—…ë°ì´íŠ¸ - ì „ì²´í™”ë©´: $isWebViewFullscreen")
        Log.d("Navigation", "í™œì„± WebView: ${activeWebView != null}")
        Log.d("Navigation", "ë’¤ë¡œê°€ê¸°: $oldCanGoBack â†’ $canGoBack")
        Log.d("Navigation", "ì•ìœ¼ë¡œê°€ê¸°: $oldCanGoForward â†’ $canGoForward")
    }

    // ì „ì²´í™”ë©´ ëª¨ë“œì—ì„œ ë’¤ë¡œê°€ê¸° ì²˜ë¦¬ ë° ìƒíƒœ ë™ê¸°í™”
    BackHandler(enabled = isWebViewFullscreen) {
        // ì „ì²´í™”ë©´ WebViewì˜ ìƒíƒœ ì €ì¥
        fullscreenWebView?.let { fsWebView ->
            val bundle = Bundle()
            fsWebView.saveState(bundle)
            webViewState = bundle
            
            // í˜„ì¬ URLë„ ì—…ë°ì´íŠ¸
            fsWebView.url?.let { url ->
                if (url != currentUrl && 
                    !url.startsWith("data:") && 
                    !url.startsWith("about:") &&
                    url != "about:blank") {
                    currentUrl = url
                    urlText = url
                }
            }
        }
        
        // ì „ì²´í™”ë©´ ëª¨ë“œ ì¢…ë£Œ í›„ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
        isWebViewFullscreen = false
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì§€ì—° ì‹¤í–‰
        Handler(Looper.getMainLooper()).postDelayed({
            updateNavigationState()
        }, 100)
    }

    fun analyzePageForMp4() {
        if (isAnalyzing) return
        
        // í˜„ì¬ í™œì„±í™”ëœ WebView ì‚¬ìš© (ì „ì²´í™”ë©´ ëª¨ë“œì¼ ë•ŒëŠ” fullscreenWebView ìš°ì„ )
        val activeWebView = if (isWebViewFullscreen) {
            fullscreenWebView ?: webView
        } else {
            webView ?: fullscreenWebView
        }
        
        Log.d("WebView", "ë¹„ë””ì˜¤ ê°ì§€ ì‹œì‘ (ì „ì²´í™”ë©´: $isWebViewFullscreen)")
        
        isAnalyzing = true
        hasAnalyzed = true
        
        // ìƒˆë¡œìš´ VideoAnalyzer ì‚¬ìš©
        videoAnalyzer.analyzeVideos(activeWebView) { videos ->
            videoList = videos
            // ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•´ MP4 ë§í¬ë„ ìœ ì§€
            mp4Links = videos.filter { it.type == VideoAnalyzer.VideoType.MP4 }
                .map { it.url }
            isAnalyzing = false
            
            Log.d("WebView", "ê°ì§€ ì™„ë£Œ - ì´ ${videos.size}ê°œ ë¹„ë””ì˜¤ (MP4: ${mp4Links.size}ê°œ)")
        }
    }

    fun loadUrl() {
        if (urlText.isNotBlank()) {
            val url = if (!urlText.startsWith("http://") && !urlText.startsWith("https://")) {
                "https://$urlText"
            } else {
                urlText
            }
            currentUrl = url
            
            // í˜„ì¬ íƒ­ì˜ URL ì—…ë°ì´íŠ¸
            currentTab?.let { tab ->
                tabs = tabs.map { if (it.id == tab.id) it.copy(url = url) else it }
            }
            
            // íˆìŠ¤í† ë¦¬ì— URL ì¶”ê°€ (ì¤‘ë³µ ì œê±°)
            if (!urlHistory.contains(url)) {
                urlHistory = urlHistory + url
            }
            
            webView?.loadUrl(url)
            keyboardController?.hide()
            urlSectionExpanded = false  // ë¡œë“œ í›„ ì ‘ê¸°
            
            // URL ë¡œë“œ í›„ 1íšŒ MP4 ê°ì§€ (1ì´ˆ ë”œë ˆì´)
            Handler(Looper.getMainLooper()).postDelayed({
                analyzePageForMp4()
            }, 1000)
        }
    }

    fun downloadVideo(url: String) {
        val cleanUrl = url.trim()

        // URL ìœ íš¨ì„± ê²€ì‚¬
        if (!downloadHandler.isValidUrl(cleanUrl)) {
            downloadResultMessage = "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨!\nìœ íš¨í•˜ì§€ ì•Šì€ URLì…ë‹ˆë‹¤"
            showDownloadResult = true
            
            Handler(Looper.getMainLooper()).postDelayed({
                showDownloadResult = false
                downloadResultMessage = null
            }, 3000)
            return
        }

        // ê¶Œí•œ í™•ì¸
        val permissions = downloadHandler.checkStoragePermissions()
        if (permissions.isNotEmpty()) {
            downloadResultMessage = "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨!\nì €ì¥ì†Œ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤"
            showDownloadResult = true
            
            Handler(Looper.getMainLooper()).postDelayed({
                showDownloadResult = false
                downloadResultMessage = null
            }, 3000)
            
            onRequestPermissions()
            return
        }

        // íŒŒì¼ëª… ìƒì„±
        val filename = downloadHandler.generateFilename(cleanUrl)

        try {
            downloadingUrls = downloadingUrls + cleanUrl
            downloadHandler.downloadFile(cleanUrl, filename)
            
            // ë‹¤ìš´ë¡œë“œ ì„±ê³µ ì•Œë¦¼
            downloadResultMessage = "ë‹¤ìš´ë¡œë“œ ì‹œì‘!\níŒŒì¼: $filename\nDownloads í´ë”ì— ì €ì¥ë©ë‹ˆë‹¤"
            showDownloadResult = true
            
            Handler(Looper.getMainLooper()).postDelayed({
                showDownloadResult = false
                downloadResultMessage = null
            }, 3000)
            
        } catch (e: Exception) {
            // ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ì—ëŸ¬ ì•Œë¦¼
            downloadingUrls = downloadingUrls - cleanUrl
            downloadResultMessage = "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨!\nì˜¤ë¥˜: ${e.message}"
            showDownloadResult = true
            
            Handler(Looper.getMainLooper()).postDelayed({
                showDownloadResult = false
                downloadResultMessage = null
            }, 5000)
            
            Log.e("Download", "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${e.message}")
        }
    }

    // URL ë³€ê²½ ë° 1íšŒ MP4 ê°ì§€ í•¨ìˆ˜
    fun updateUrlIfChanged(newUrl: String) {
        if (newUrl != currentUrl && 
            !newUrl.startsWith("data:") && 
            !newUrl.startsWith("about:") &&
            newUrl != "about:blank") {
            currentUrl = newUrl
            urlText = newUrl
            
            // íˆìŠ¤í† ë¦¬ì— URL ì¶”ê°€ (ì¤‘ë³µ ì œê±°)
            if (!urlHistory.contains(newUrl)) {
                urlHistory = urlHistory + newUrl
            }
            
            // ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateNavigationState()
            
            // URL ë³€ê²½ ì‹œ 1íšŒ MP4 ê°ì§€ (1ì´ˆ ë”œë ˆì´)
            Handler(Looper.getMainLooper()).postDelayed({
                analyzePageForMp4()
            }, 1000)
        }
    }

    // ë„¤ë¹„ê²Œì´ì…˜ í›„ URL ë™ê¸°í™” ë° 1íšŒ MP4 ê°ì§€
    fun handleNavigation(targetWebView: WebView?) {
        // ì¦‰ì‹œ URL ì²´í¬ ë° ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
        targetWebView?.url?.let { newUrl ->
            updateUrlIfChanged(newUrl)
        }
        updateNavigationState()
        
        // 500ms í›„ ë‹¤ì‹œ ì²´í¬ (í˜ì´ì§€ ë¡œë”© ì™„ë£Œ ëŒ€ê¸°)
        Handler(Looper.getMainLooper()).postDelayed({
            targetWebView?.url?.let { newUrl ->
                updateUrlIfChanged(newUrl)
            }
            updateNavigationState()
        }, 500)
        
        // ë„¤ë¹„ê²Œì´ì…˜ í›„ ì¶”ê°€ MP4 ê°ì§€ (í˜ì´ì§€ ì™„ì „ ë¡œë”© í›„)
        Handler(Looper.getMainLooper()).postDelayed({
            analyzePageForMp4()
        }, 2000)
    }

    // ë‹¤ìš´ë¡œë”© ìƒíƒœ ê´€ë¦¬
    LaunchedEffect(downloadingUrls) {
        if (downloadingUrls.isNotEmpty()) {
            kotlinx.coroutines.delay(3000)
            downloadingUrls = emptySet()
        }
    }

    // ì „ì²´í™”ë©´ ëª¨ë“œ ë³€ê²½ ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
    LaunchedEffect(isWebViewFullscreen) {
        updateNavigationState()
        // ì „ì²´í™”ë©´ ëª¨ë“œ ì‹œ ëª°ì…í˜• ëª¨ë“œ í™œì„±í™”
        onFullscreenModeChange(isWebViewFullscreen)
        
        // ì „ì²´í™”ë©´ ëª¨ë“œ ì „í™˜ í›„ ì¶”ê°€ì ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸ (WebView ë¡œë”© ëŒ€ê¸°)
        kotlinx.coroutines.delay(500)
        updateNavigationState()
        kotlinx.coroutines.delay(1000)
        updateNavigationState()
    }

    // íƒ­ ì „í™˜ì‹œ URL ë™ê¸°í™”
    LaunchedEffect(currentTabIndex) {
        currentTab?.let { tab ->
            urlText = tab.url
            currentUrl = tab.url
        }
    }

    // URL ë³€ê²½ ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
    LaunchedEffect(currentUrl) {
        if (currentUrl.isNotEmpty()) {
            kotlinx.coroutines.delay(1000) // í˜ì´ì§€ ë¡œë”© ëŒ€ê¸°
            updateNavigationState()
        }
    }

            // ì „ì²´í™”ë©´ ëª¨ë“œì¼ ë•Œ ë¶„ë¦¬ëœ FullscreenUI ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©
        if (isWebViewFullscreen) {
            FullscreenUI(
            tabs = tabs,
            currentTabIndex = currentTabIndex,
            currentUrl = currentUrl,
            urlText = urlText,
            onUrlTextChange = { urlText = it },
            onLoadUrl = { url ->
                val finalUrl = if (!url.startsWith("http://") && !url.startsWith("https://")) {
                    "https://$url"
                } else {
                    url
                }
                currentUrl = finalUrl
                urlText = finalUrl
                
                // í˜„ì¬ íƒ­ì˜ URLë„ ì—…ë°ì´íŠ¸
                currentTab?.let { tab ->
                    tabs = tabs.map {
                        if (it.id == tab.id) it.copy(url = finalUrl)
                        else it
                    }
                }
                
                // íˆìŠ¤í† ë¦¬ì— URL ì¶”ê°€ (ì¤‘ë³µ ì œê±°)
                if (!urlHistory.contains(finalUrl)) {
                    urlHistory = urlHistory + finalUrl
                }
                
                // WebViewì— URL ë¡œë“œ
                fullscreenWebView?.loadUrl(finalUrl)
                
                // URL ë³€ê²½ í›„ MP4 ê°ì§€
                Handler(Looper.getMainLooper()).postDelayed({
                    analyzePageForMp4()
                }, 1000)
            },
            showTabOverview = showTabOverview,
            onShowTabOverview = { showTabOverview = it },
            onAddNewTab = ::addNewTab,
            canGoBack = canGoBack,
            canGoForward = canGoForward,
            isAnalyzing = isAnalyzing,
            mp4Links = mp4Links,
            downloadingUrls = downloadingUrls,
            urlHistory = urlHistory,
            onGoBack = {
                Log.d("Navigation", "ë’¤ë¡œê°€ê¸° í´ë¦­ - canGoBack: $canGoBack, fullscreenWebView: ${fullscreenWebView != null}")
                fullscreenWebView?.let { webView ->
                    Log.d("Navigation", "WebView canGoBack: ${webView.canGoBack()}")
                    if (webView.canGoBack()) {
                        webView.goBack()
                        // ì¦‰ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                        Handler(Looper.getMainLooper()).postDelayed({
                            updateNavigationState()
                            Log.d("Navigation", "ë’¤ë¡œê°€ê¸° í›„ ìƒíƒœ - canGoBack: $canGoBack, canGoForward: $canGoForward")
                        }, 100)
                    }
                }
            },
            onGoForward = {
                Log.d("Navigation", "ì•ìœ¼ë¡œê°€ê¸° í´ë¦­ - canGoForward: $canGoForward, fullscreenWebView: ${fullscreenWebView != null}")
                fullscreenWebView?.let { webView ->
                    Log.d("Navigation", "WebView canGoForward: ${webView.canGoForward()}")
                    if (webView.canGoForward()) {
                        webView.goForward()
                        // ì¦‰ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                        Handler(Looper.getMainLooper()).postDelayed({
                            updateNavigationState()
                            Log.d("Navigation", "ì•ìœ¼ë¡œê°€ê¸° í›„ ìƒíƒœ - canGoBack: $canGoBack, canGoForward: $canGoForward")
                        }, 100)
                    }
                }
            },
            onRefresh = {
                fullscreenWebView?.reload()
                Handler(Looper.getMainLooper()).postDelayed({
                    analyzePageForMp4()
                }, 1500)
            },
            onShowMp4List = { showMp4List = !showMp4List },
            onSwitchTab = ::switchTab,
            onCloseTab = ::closeTab,
            onDownloadVideo = ::downloadVideo,
            onExitFullscreen = { 
                // ì „ì²´í™”ë©´ WebViewì˜ ìƒíƒœ ì €ì¥
                fullscreenWebView?.let { fsWebView ->
                    val bundle = Bundle()
                    fsWebView.saveState(bundle)
                    webViewState = bundle
                    
                    // í˜„ì¬ URLë„ ì—…ë°ì´íŠ¸
                    fsWebView.url?.let { url ->
                        if (url != currentUrl && 
                            !url.startsWith("data:") && 
                            !url.startsWith("about:") &&
                            url != "about:blank") {
                            currentUrl = url
                            urlText = url
                        }
                    }
                }
                
                // ì „ì²´í™”ë©´ ëª¨ë“œ ì¢…ë£Œ í›„ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                isWebViewFullscreen = false
                
                // ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì§€ì—° ì‹¤í–‰
                Handler(Looper.getMainLooper()).postDelayed({
                    updateNavigationState()
                }, 100)
            },
            webViewContent = {
                // ì „ì²´í™”ë©´ WebView
                if (currentUrl.isNotEmpty()) {
                    AndroidView(
                        factory = { context ->
                            WebView(context).apply {
                                webViewClient = object : WebViewClient() {
                                    override fun shouldOverrideUrlLoading(view: WebView?, url: String?): Boolean {
                                        url?.let { newUrl ->
                                            updateUrlIfChanged(newUrl)
                                        }
                                        return false
                                    }

                                    override fun onPageStarted(view: WebView?, url: String?, favicon: android.graphics.Bitmap?) {
                                        super.onPageStarted(view, url, favicon)
                                        url?.let { newUrl ->
                                            updateUrlIfChanged(newUrl)
                                        }
                                    }

                                    override fun onPageFinished(view: WebView?, url: String?) {
                                        super.onPageFinished(view, url)
                                        url?.let { newUrl ->
                                            updateUrlIfChanged(newUrl)
                                        }
                                        
                                        // í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„ MP4 ê°ì§€
                                        Handler(Looper.getMainLooper()).postDelayed({
                                            analyzePageForMp4()
                                        }, 1000)
                                    }
                                }
                                webChromeClient = object : WebChromeClient() {
                                    override fun onReceivedTitle(view: WebView?, title: String?) {
                                        super.onReceivedTitle(view, title)
                                        // íƒ­ ì œëª© ì—…ë°ì´íŠ¸
                                        title?.let { 
                                            currentTab?.let { tab ->
                                                tabs = tabs.map { 
                                                    if (it.id == tab.id) it.copy(title = title.take(15)) 
                                                    else it 
                                                }
                                            }
                                        }
                                    }
                                }
                                settings.javaScriptEnabled = true
                                settings.domStorageEnabled = true
                                settings.loadWithOverviewMode = true
                                settings.useWideViewPort = true
                                
                                // ì „ì²´í™”ë©´ WebView ì°¸ì¡° ì„¤ì •
                                fullscreenWebView = this
                                
                                // ì €ì¥ëœ WebView ìƒíƒœ ë³µì› (íˆìŠ¤í† ë¦¬ í¬í•¨)
                                webViewState?.let { bundle ->
                                    restoreState(bundle)
                                    // ìƒíƒœ ë³µì› í›„ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                                    Handler(Looper.getMainLooper()).postDelayed({
                                        updateNavigationState()
                                    }, 500)
                                } ?: run {
                                    // ì €ì¥ëœ ìƒíƒœê°€ ì—†ìœ¼ë©´ í˜„ì¬ URLë¡œ ë¡œë“œ
                                    val syncUrl = webView?.url ?: currentUrl
                                    if (syncUrl.isNotEmpty()) {
                                        this.loadUrl(syncUrl)
                                        // URL ë¡œë“œ í›„ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                                        Handler(Looper.getMainLooper()).postDelayed({
                                            updateNavigationState()
                                        }, 1000)
                                    }
                                }
                            }
                        },
                        update = { view ->
                            if (currentUrl.isNotEmpty() && view.url != currentUrl) {
                                view.loadUrl(currentUrl)
                            }
                        },
                        modifier = Modifier.fillMaxSize()
                    )
                } else {
                    Box(
                        modifier = Modifier.fillMaxSize(),
                        contentAlignment = Alignment.Center
                    ) {
                        Text(
                            text = "ì›¹ í˜ì´ì§€ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
            }
        )
        
        // MP4 ëª©ë¡ í‘œì‹œ ë‹¤ì´ì–¼ë¡œê·¸
        if (showMp4List) {
            Mp4ListDialog(
                mp4Links = mp4Links,
                downloadingUrls = downloadingUrls,
                onDownload = { url -> downloadVideo(url) },
                onDismiss = { showMp4List = false }
            )
        }
        
        // ë‹¤ìš´ë¡œë“œ ê²°ê³¼ ì•Œë¦¼ íŒì—…
        if (showDownloadResult && downloadResultMessage != null) {
            DownloadResultDialog(
                message = downloadResultMessage!!,
                onDismiss = { 
                    showDownloadResult = false
                    downloadResultMessage = null
                }
            )
        }
        
        return
    }

    // ì¼ë°˜ ëª¨ë“œ ë ˆì´ì•„ì›ƒ
    Column(
        modifier = modifier
            .fillMaxSize()
            .windowInsetsPadding(WindowInsets.systemBars)
            .padding(16.dp),
        verticalArrangement = Arrangement.Top
    ) {
        // íƒ­ë°”
        TabBar(
            tabs = tabs,
            currentTabIndex = currentTabIndex,
            onNewTab = ::addNewTab,
            onCloseTab = ::closeTab,
            onSwitchTab = ::switchTab,
            modifier = Modifier.padding(bottom = 8.dp)
        )

        // ì•± ì œëª©
        Text(
                            text = "Simple Web Video Downloader v5.8",
            style = MaterialTheme.typography.titleMedium,
            modifier = Modifier.padding(bottom = 12.dp),
            maxLines = 1,
            overflow = androidx.compose.ui.text.style.TextOverflow.Ellipsis
        )

        // URL ì…ë ¥ ì„¹ì…˜
        Card(
            modifier = Modifier.fillMaxWidth(),
            elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
        ) {
            Column(
                modifier = Modifier.padding(12.dp)
            ) {
                // ì„¹ì…˜ í—¤ë” (í´ë¦­ ê°€ëŠ¥)
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .clickable { urlSectionExpanded = !urlSectionExpanded },
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(
                        text = "ì›¹ í˜ì´ì§€ URL ì…ë ¥",
                        style = MaterialTheme.typography.titleMedium
                    )
                    Text(
                        text = if (urlSectionExpanded) "â–²" else "â–¼",
                        style = MaterialTheme.typography.titleMedium
                    )
                }

                // ë¡œë“œëœ URLì´ ìˆê³  ì„¹ì…˜ì´ ì ‘í˜€ìˆì„ ë•Œ ê°„ë‹¨íˆ í‘œì‹œ
                if (!urlSectionExpanded && currentUrl.isNotEmpty()) {
                    Spacer(modifier = Modifier.height(8.dp))
                    Text(
                        text = currentUrl.let { url ->
                            if (url.length > 40) "...${url.takeLast(37)}" else url
                        },
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.primary,
                        maxLines = 1,
                        overflow = androidx.compose.ui.text.style.TextOverflow.Ellipsis
                    )
                }

                // ì ‘í ìˆ˜ ìˆëŠ” ë‚´ìš©
                AnimatedVisibility(
                    visible = urlSectionExpanded,
                    enter = expandVertically(),
                    exit = shrinkVertically()
                ) {
                    Column {
                        Spacer(modifier = Modifier.height(6.dp))

                        // URL ì…ë ¥ í•„ë“œ
                        OutlinedTextField(
                            value = urlText,
                            onValueChange = { urlText = it },
                            label = { Text("URLì„ ì…ë ¥í•˜ì„¸ìš”") },
                            placeholder = { Text("https://example.com") },
                            modifier = Modifier.fillMaxWidth(),
                            maxLines = 3,
                            keyboardOptions = KeyboardOptions(
                                keyboardType = KeyboardType.Uri,
                                imeAction = ImeAction.Go
                            ),
                            keyboardActions = KeyboardActions(
                                onGo = { loadUrl() }
                            ),
                            trailingIcon = {
                                TextButton(
                                    onClick = {
                                        clipboardManager.getText()?.text?.let { clipText ->
                                            if (clipText.contains(".")) {
                                                urlText = clipText
                                            }
                                        }
                                    }
                                ) {
                                    Text("ë¶™ì—¬ë„£ê¸°")
                                }
                            }
                        )

                        Spacer(modifier = Modifier.height(12.dp))

                        // ë²„íŠ¼ë“¤
                        Column(
                            verticalArrangement = Arrangement.spacedBy(8.dp)
                        ) {
                            // ì²« ë²ˆì§¸ ì¤„: í˜ì´ì§€ ë¡œë“œ, ì´ˆê¸°í™”
                            Row(
                                modifier = Modifier.fillMaxWidth(),
                                horizontalArrangement = Arrangement.spacedBy(8.dp)
                            ) {
                                Button(
                                    onClick = { loadUrl() },
                                    modifier = Modifier.weight(1f),
                                    enabled = urlText.isNotBlank() && !isAnalyzing
                                ) {
                                    if (isAnalyzing) {
                                        CircularProgressIndicator(
                                            modifier = Modifier.size(18.dp),
                                            color = MaterialTheme.colorScheme.onPrimary
                                        )
                                        Spacer(modifier = Modifier.width(8.dp))
                                        Text("MP4 ê°ì§€ ì¤‘...")
                                    } else {
                                        Icon(
                                            imageVector = Icons.Default.Search,
                                            contentDescription = null,
                                            modifier = Modifier.size(18.dp)
                                        )
                                        Spacer(modifier = Modifier.width(8.dp))
                                        Text("í˜ì´ì§€ ë¡œë“œ")
                                    }
                                }

                                Button(
                                                                    onClick = { 
                                    // ì´ˆê¸°í™” ê¸°ëŠ¥
                                    urlText = ""
                                    currentUrl = ""
                                    mp4Links = emptyList()
                                    webView = null
                                    fullscreenWebView = null
                                    urlSectionExpanded = true
                                    mp4SectionExpanded = true
                                    isAnalyzing = false
                                    hasAnalyzed = false
                                    downloadingUrls = emptySet()
                                },
                                    modifier = Modifier.weight(1f),
                                    colors = ButtonDefaults.buttonColors(
                                        containerColor = MaterialTheme.colorScheme.secondary
                                    )
                                ) {
                                    Icon(
                                        imageVector = Icons.Default.Close,
                                        contentDescription = null,
                                        modifier = Modifier.size(18.dp)
                                    )
                                    Spacer(modifier = Modifier.width(8.dp))
                                    Text("ì´ˆê¸°í™”")
                                }
                            }

                            // ë‘ ë²ˆì§¸ ì¤„: ìƒˆë¡œê³ ì¹¨ & MP4 ê°ì§€ (í˜„ì¬ URLì´ ìˆì„ ë•Œë§Œ í‘œì‹œ)
                            if (currentUrl.isNotEmpty()) {
                                Button(
                                    onClick = { 
                                        webView?.reload()
                                        Handler(Looper.getMainLooper()).postDelayed({
                                            analyzePageForMp4()
                                        }, 1000)
                                    },
                                    modifier = Modifier.fillMaxWidth(),
                                    enabled = !isAnalyzing,
                                    colors = ButtonDefaults.buttonColors(
                                        containerColor = MaterialTheme.colorScheme.tertiary
                                    )
                                ) {
                                    if (isAnalyzing) {
                                        CircularProgressIndicator(
                                            modifier = Modifier.size(18.dp),
                                            color = MaterialTheme.colorScheme.onTertiary
                                        )
                                        Spacer(modifier = Modifier.width(8.dp))
                                        Text("ìƒˆë¡œê³ ì¹¨ ì¤‘...")
                                    } else {
                                        Text("ğŸ”„ ìƒˆë¡œê³ ì¹¨ & MP4 ê°ì§€")
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        Spacer(modifier = Modifier.height(12.dp))

        // ê°ì§€ëœ MP4 ëª©ë¡ ë° ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
        if (hasAnalyzed) {
            Card(
                modifier = Modifier.fillMaxWidth(),
                elevation = CardDefaults.cardElevation(defaultElevation = 2.dp),
                colors = CardDefaults.cardColors(
                    containerColor = MaterialTheme.colorScheme.primaryContainer
                )
            ) {
                Column(modifier = Modifier.padding(12.dp)) {
                    // ì„¹ì…˜ í—¤ë” (í´ë¦­ ê°€ëŠ¥)
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .clickable { mp4SectionExpanded = !mp4SectionExpanded },
                        horizontalArrangement = Arrangement.SpaceBetween,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Text(
                            text = if (mp4Links.isEmpty()) {
                                "ğŸ¯ ê°ì§€ëœ MP4 ë¹„ë””ì˜¤ (ì—†ìŒ)"
                            } else {
                                "ğŸ¯ ê°ì§€ëœ MP4 ë¹„ë””ì˜¤ (${mp4Links.size}ê°œ)"
                            },
                            style = MaterialTheme.typography.titleMedium,
                            color = MaterialTheme.colorScheme.onPrimaryContainer
                        )
                        Text(
                            text = if (mp4SectionExpanded) "â–²" else "â–¼",
                            style = MaterialTheme.typography.titleMedium,
                            color = MaterialTheme.colorScheme.onPrimaryContainer
                        )
                    }

                    // ì ‘íŒ ìƒíƒœì—ì„œ ê°„ë‹¨í•œ ìš”ì•½ í‘œì‹œ
                    if (!mp4SectionExpanded) {
                        Spacer(modifier = Modifier.height(8.dp))
                        if (mp4Links.isEmpty()) {
                            Text(
                                text = "ì´ í˜ì´ì§€ì—ì„œ MP4 ë¹„ë””ì˜¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
                                style = MaterialTheme.typography.bodySmall,
                                color = MaterialTheme.colorScheme.onPrimaryContainer
                            )
                        } else {
                            val downloadableCount = mp4Links.count { it.contains(".mp4") && it.contains("http") }
                            Text(
                                text = "ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ ë¹„ë””ì˜¤: ${downloadableCount}ê°œ",
                                style = MaterialTheme.typography.bodySmall,
                                color = MaterialTheme.colorScheme.onPrimaryContainer
                            )
                        }
                    }

                    // ì ‘í ìˆ˜ ìˆëŠ” ëª©ë¡ ë‚´ìš©
                    AnimatedVisibility(
                        visible = mp4SectionExpanded,
                        enter = expandVertically(),
                        exit = shrinkVertically()
                    ) {
                        Column {
                            Spacer(modifier = Modifier.height(12.dp))

                            if (mp4Links.isEmpty()) {
                                // MP4ê°€ ì—†ì„ ë•Œ í‘œì‹œ
                                Text(
                                    text = "ì´ í˜ì´ì§€ì—ì„œ MP4 ë¹„ë””ì˜¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¹„ë””ì˜¤ê°€ iframeì´ë‚˜ ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ êµ¬í˜„ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                                    style = MaterialTheme.typography.bodyMedium,
                                    color = MaterialTheme.colorScheme.onPrimaryContainer,
                                    modifier = Modifier.padding(vertical = 16.dp)
                                )
                            } else {
                                LazyColumn(
                                    modifier = Modifier.height(200.dp),
                                    verticalArrangement = Arrangement.spacedBy(8.dp)
                                ) {
                                    itemsIndexed(mp4Links) { index, link ->
                                    if (link.contains(".mp4") && link.contains("http")) {
                                        Card(
                                            modifier = Modifier.fillMaxWidth(),
                                            colors = CardDefaults.cardColors(
                                                containerColor = MaterialTheme.colorScheme.surface
                                            )
                                        ) {
                                            Column(modifier = Modifier.padding(12.dp)) {
                                                Text(
                                                    text = "${index + 1}. ${if (link.length > 50) "...${link.takeLast(50)}" else link}",
                                                    style = MaterialTheme.typography.bodySmall,
                                                    modifier = Modifier.padding(bottom = 8.dp)
                                                )

                                                Button(
                                                    onClick = { downloadVideo(link) },
                                                    modifier = Modifier.fillMaxWidth(),
                                                    enabled = !downloadingUrls.contains(link),
                                                    colors = ButtonDefaults.buttonColors(
                                                        containerColor = MaterialTheme.colorScheme.tertiary
                                                    )
                                                ) {
                                                    if (downloadingUrls.contains(link)) {
                                                        CircularProgressIndicator(
                                                            modifier = Modifier.size(16.dp),
                                                            color = MaterialTheme.colorScheme.onTertiary
                                                        )
                                                        Spacer(modifier = Modifier.width(8.dp))
                                                        Text("ë‹¤ìš´ë¡œë“œ ì¤‘...")
                                                    } else {
                                                        Text("â¬‡ï¸ ë‹¤ìš´ë¡œë“œ")
                                                    }
                                                }
                                            }
                                        }
                                    } else {
                                        Text(
                                            text = "${index + 1}. $link",
                                            style = MaterialTheme.typography.bodySmall,
                                            color = MaterialTheme.colorScheme.onPrimaryContainer,
                                            modifier = Modifier.padding(vertical = 2.dp)
                                        )
                                    }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            // MP4ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ì„ ë•ŒëŠ” í•˜ë‹¨ ì—¬ë°± ì—†ìŒ
            if (mp4Links.isNotEmpty()) {
                Spacer(modifier = Modifier.height(12.dp))
            }
        }

        // WebView ì˜ì—­ - ê°œì„ ëœ ë ˆì´ì•„ì›ƒ
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .weight(1f)
        ) {
            // WebView ì¹´ë“œ
            Card(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(bottom = if (currentUrl.isNotEmpty()) 100.dp else 0.dp), // ë„¤ë¹„ê²Œì´ì…˜ ë°”ë¥¼ ìœ„í•œ í•˜ë‹¨ ì—¬ë°± ì¦ê°€ (80dp â†’ 100dp)
                elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
            ) {
                if (currentUrl.isEmpty()) {
                    Box(
                        modifier = Modifier
                            .fillMaxSize()
                            .padding(16.dp),
                        contentAlignment = Alignment.Center
                    ) {
                        Text(
                            text = "ì›¹ í˜ì´ì§€ë¥¼ ë¡œë“œí•˜ë©´ ì—¬ê¸°ì— ë¸Œë¼ìš°ì €ê°€ í‘œì‹œë©ë‹ˆë‹¤",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                } else {
                    AndroidView(
                        factory = { context ->
                            // ì¼ë°˜ ëª¨ë“œ WebView ìƒì„± ë˜ëŠ” ì¬ì‚¬ìš©
                            webView ?: WebView(context).apply {
                                webViewClient = object : WebViewClient() {
                                    override fun shouldOverrideUrlLoading(view: WebView?, url: String?): Boolean {
                                        url?.let { newUrl ->
                                            updateUrlIfChanged(newUrl)
                                        }
                                        return false
                                    }

                                    override fun onPageStarted(view: WebView?, url: String?, favicon: android.graphics.Bitmap?) {
                                        super.onPageStarted(view, url, favicon)
                                        url?.let { newUrl ->
                                            updateUrlIfChanged(newUrl)
                                        }
                                    }

                                    override fun onPageFinished(view: WebView?, url: String?) {
                                        super.onPageFinished(view, url)
                                        url?.let { newUrl ->
                                            updateUrlIfChanged(newUrl)
                                        }
                                        
                                        // í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„ MP4 ê°ì§€
                                        Handler(Looper.getMainLooper()).postDelayed({
                                            analyzePageForMp4()
                                        }, 1000)
                                    }
                                }
                                webChromeClient = object : WebChromeClient() {
                                    override fun onReceivedTitle(view: WebView?, title: String?) {
                                        super.onReceivedTitle(view, title)
                                        // íƒ­ ì œëª© ì—…ë°ì´íŠ¸
                                        title?.let { 
                                            currentTab?.let { tab ->
                                                tabs = tabs.map { 
                                                    if (it.id == tab.id) it.copy(title = title.take(15)) 
                                                    else it 
                                                }
                                            }
                                        }
                                    }
                                }
                                settings.javaScriptEnabled = true
                                settings.domStorageEnabled = true
                                settings.loadWithOverviewMode = true
                                settings.useWideViewPort = true
                                
                                // ì¼ë°˜ ëª¨ë“œ WebView ì°¸ì¡° ì„¤ì •
                                webView = this
                                
                                // ì €ì¥ëœ WebView ìƒíƒœ ë³µì› (íˆìŠ¤í† ë¦¬ í¬í•¨)
                                webViewState?.let { bundle ->
                                    restoreState(bundle)
                                } ?: run {
                                    // ì €ì¥ëœ ìƒíƒœê°€ ì—†ìœ¼ë©´ í˜„ì¬ URLë¡œ ë¡œë“œ
                                    val syncUrl = fullscreenWebView?.url ?: currentUrl
                                    if (syncUrl.isNotEmpty()) {
                                        this.loadUrl(syncUrl)
                                    }
                                }
                            }
                        },
                        update = { view ->
                            if (currentUrl.isNotEmpty() && view.url != currentUrl) {
                                view.loadUrl(currentUrl)
                            }
                        },
                        modifier = Modifier.fillMaxSize()
                    )
                }
            }

            // ë„¤ë¹„ê²Œì´ì…˜ ë°” (WebViewê°€ ë¡œë“œëœ ê²½ìš°ì—ë§Œ í‘œì‹œ)
            if (currentUrl.isNotEmpty()) {
                Card(
                    modifier = Modifier
                        .align(Alignment.BottomCenter)
                        .fillMaxWidth()
                        .windowInsetsPadding(WindowInsets.systemBars.only(WindowInsetsSides.Bottom))
                        .padding(horizontal = 16.dp, vertical = 20.dp),  // vertical íŒ¨ë”© ì¦ê°€ (12dp â†’ 20dp)
                    elevation = CardDefaults.cardElevation(defaultElevation = 6.dp),
                    shape = androidx.compose.foundation.shape.RoundedCornerShape(16.dp),
                    colors = CardDefaults.cardColors(
                        containerColor = MaterialTheme.colorScheme.surfaceContainer
                    )
                ) {
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(horizontal = 16.dp, vertical = 8.dp),
                        horizontalArrangement = Arrangement.SpaceEvenly,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
                        FloatingActionButton(
                            onClick = { 
                                Log.d("Navigation", "ì¼ë°˜ëª¨ë“œ ë’¤ë¡œê°€ê¸° í´ë¦­ - canGoBack: $canGoBack, webView: ${webView != null}")
                                webView?.let { view ->
                                    Log.d("Navigation", "ì¼ë°˜ëª¨ë“œ WebView canGoBack: ${view.canGoBack()}")
                                    if (view.canGoBack()) {
                                        view.goBack()
                                        // ì¦‰ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                                        Handler(Looper.getMainLooper()).postDelayed({
                                            updateNavigationState()
                                            Log.d("Navigation", "ì¼ë°˜ëª¨ë“œ ë’¤ë¡œê°€ê¸° í›„ ìƒíƒœ - canGoBack: $canGoBack, canGoForward: $canGoForward")
                                        }, 100)
                                    }
                                }
                            },
                            modifier = Modifier.size(44.dp),
                            containerColor = if (canGoBack) 
                                MaterialTheme.colorScheme.secondaryContainer 
                            else 
                                MaterialTheme.colorScheme.surfaceVariant
                        ) {
                            Icon(
                                imageVector = Icons.Default.ArrowBack,
                                contentDescription = "ë’¤ë¡œê°€ê¸°",
                                modifier = Modifier.size(20.dp),
                                tint = if (canGoBack) 
                                    MaterialTheme.colorScheme.onSecondaryContainer 
                                else 
                                    MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.5f)
                            )
                        }

                        // ìƒˆë¡œê³ ì¹¨ + MP4 ê°ì§€ ë²„íŠ¼
                        FloatingActionButton(
                            onClick = { 
                                webView?.reload()
                                Handler(Looper.getMainLooper()).postDelayed({
                                    analyzePageForMp4()
                                }, 1500)
                            },
                            modifier = Modifier.size(44.dp),
                            containerColor = MaterialTheme.colorScheme.tertiaryContainer
                        ) {
                            if (isAnalyzing) {
                                CircularProgressIndicator(
                                    modifier = Modifier.size(18.dp),
                                    color = MaterialTheme.colorScheme.onTertiaryContainer
                                )
                            } else {
                                Icon(
                                    imageVector = Icons.Default.Refresh,
                                    contentDescription = "ìƒˆë¡œê³ ì¹¨",
                                    modifier = Modifier.size(20.dp),
                                    tint = MaterialTheme.colorScheme.onTertiaryContainer
                                )
                            }
                        }

                        // ì•ìœ¼ë¡œê°€ê¸° ë²„íŠ¼
                        FloatingActionButton(
                            onClick = { 
                                Log.d("Navigation", "ì¼ë°˜ëª¨ë“œ ì•ìœ¼ë¡œê°€ê¸° í´ë¦­ - canGoForward: $canGoForward, webView: ${webView != null}")
                                webView?.let { view ->
                                    Log.d("Navigation", "ì¼ë°˜ëª¨ë“œ WebView canGoForward: ${view.canGoForward()}")
                                    if (view.canGoForward()) {
                                        view.goForward()
                                        // ì¦‰ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                                        Handler(Looper.getMainLooper()).postDelayed({
                                            updateNavigationState()
                                            Log.d("Navigation", "ì¼ë°˜ëª¨ë“œ ì•ìœ¼ë¡œê°€ê¸° í›„ ìƒíƒœ - canGoBack: $canGoBack, canGoForward: $canGoForward")
                                        }, 100)
                                    }
                                }
                            },
                            modifier = Modifier.size(44.dp),
                            containerColor = if (canGoForward) 
                                MaterialTheme.colorScheme.secondaryContainer 
                            else 
                                MaterialTheme.colorScheme.surfaceVariant
                        ) {
                            Icon(
                                imageVector = Icons.Default.ArrowForward,
                                contentDescription = "ì•ìœ¼ë¡œê°€ê¸°",
                                modifier = Modifier.size(20.dp),
                                tint = if (canGoForward) 
                                    MaterialTheme.colorScheme.onSecondaryContainer 
                                else 
                                    MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.5f)
                            )
                        }

                        // ì „ì²´í™”ë©´ ë²„íŠ¼
                        FloatingActionButton(
                            onClick = { 
                                // ì¼ë°˜ ëª¨ë“œ WebViewì˜ ìƒíƒœ ì €ì¥
                                webView?.let { mainWebView ->
                                    val bundle = Bundle()
                                    mainWebView.saveState(bundle)
                                    webViewState = bundle
                                    
                                    // í˜„ì¬ URLë„ ì—…ë°ì´íŠ¸
                                    mainWebView.url?.let { url ->
                                        if (url != currentUrl && 
                                            !url.startsWith("data:") && 
                                            !url.startsWith("about:") &&
                                            url != "about:blank") {
                                            currentUrl = url
                                            urlText = url
                                        }
                                    }
                                }
                                isWebViewFullscreen = true 
                            },
                            modifier = Modifier.size(44.dp),
                            containerColor = MaterialTheme.colorScheme.primaryContainer
                        ) {
                            Text(
                                text = "â›¶",
                                style = MaterialTheme.typography.headlineSmall,
                                color = MaterialTheme.colorScheme.onPrimaryContainer
                            )
                        }
                    }
                }
            }
        }
        
        // ë‹¤ìš´ë¡œë“œ ê²°ê³¼ ì•Œë¦¼ íŒì—… (ì¼ë°˜ ëª¨ë“œ)
        if (showDownloadResult && downloadResultMessage != null) {
            DownloadResultDialog(
                message = downloadResultMessage!!,
                onDismiss = { 
                    showDownloadResult = false
                    downloadResultMessage = null
                }
            )
        }
    }
}
</file>

<file path="app/build.gradle.kts">
plugins {
    alias(libs.plugins.android.application)
    alias(libs.plugins.kotlin.android)
    alias(libs.plugins.kotlin.compose)
}

android {
    namespace = "com.swvd.simplewebvideodownloader"
    compileSdk = 35

    defaultConfig {
        applicationId = "com.swvd.simplewebvideodownloader"
        minSdk = 24
        targetSdk = 35
        versionCode = 58
        versionName = "5.8"

        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        release {
            isMinifyEnabled = false
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
    }
    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_11
        targetCompatibility = JavaVersion.VERSION_11
    }
    kotlinOptions {
        jvmTarget = "11"
    }
    buildFeatures {
        compose = true
    }
}

dependencies {

    implementation(libs.androidx.core.ktx)
    implementation(libs.androidx.lifecycle.runtime.ktx)
    implementation(libs.androidx.activity.compose)
    implementation(platform(libs.androidx.compose.bom))
    implementation(libs.androidx.ui)
    implementation(libs.androidx.ui.graphics)
    implementation(libs.androidx.ui.tooling.preview)
    implementation(libs.androidx.material3)

    // HTML íŒŒì‹±ì„ ìœ„í•œ Jsoup ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
    implementation("org.jsoup:jsoup:1.17.2")
    
    // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤
    testImplementation("io.mockk:mockk:1.13.8")
    testImplementation("org.robolectric:robolectric:4.11.1")
    testImplementation("androidx.arch.core:core-testing:2.2.0")
    testImplementation("org.jetbrains.kotlinx:kotlinx-coroutines-test:1.7.3")
    
    // ì½”ë£¨í‹´ ì§€ì›
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3")

    testImplementation(libs.junit)
    androidTestImplementation(libs.androidx.junit)
    androidTestImplementation(libs.androidx.espresso.core)
    androidTestImplementation(platform(libs.androidx.compose.bom))
    androidTestImplementation(libs.androidx.ui.test.junit4)
    debugImplementation(libs.androidx.ui.tooling)
    debugImplementation(libs.androidx.ui.test.manifest)
}
</file>

</files>
